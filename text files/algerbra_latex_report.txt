\input{preamble}

% OK, start here.
%
\begin{document}

\title{Commutative Algebra}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents




\section{Introduction}
\label{section-introduction}

\noindent
Basic commutative algebra will be explained in this document.
A reference is \cite{MatCA}.






\section{Conventions}
\label{section-conventions}

\noindent
A ring is commutative with $1$. The zero ring is a ring. In fact it is
the only ring that does not have a prime ideal. The Kronecker
symbol $\delta_{ij}$ will be used. If $R \to S$ is a ring map and
$\mathfrak q$ a prime of $S$, then we use the notation
``$\mathfrak p = R \cap \mathfrak q$''
to indicate the prime which is the inverse image of $\mathfrak q$ under
$R \to S$ even if $R$ is not a subring of $S$ and even if $R \to S$
is not injective.






\section{Basic notions}
\label{section-rings-basic}

\noindent
The following is a list of basic notions in commutative algebra. Some of these
notions are discussed in more detail in the text that follows and some are
defined in the list, but others are considered basic and will not be defined.
If you are not familiar with most of the italicized concepts, then we suggest
looking at an introductory text on algebra before continuing.

\begin{enumerate}
\item $R$ is a {\it ring},
\label{item-ring}
\item $x\in R$ is {\it nilpotent},
\label{item-ring-element-nilpotent}
\item $x\in R$ is a {\it zerodivisor},
\label{item-ring-element-zerodivisor}
\item $x\in R$ is a {\it unit},
\label{item-ring-element-unit}
\item $e \in R$ is an {\it idempotent},
\label{item-ring-element-idempotent}
\item an idempotent $e \in R$ is called {\it trivial} if $e = 1$ or $e = 0$,
\label{item-idempotent-trivial}
\item $\varphi : R_1 \to R_2$ is a {\it ring homomorphism},
\label{item-ring-homomorphism}
\item
\label{item-ring-homomorphism-finite-presentation}
$\varphi : R_1 \to R_2$ is {\it of finite presentation}, or
{\it $R_2$ is a finitely presented $R_1$-algebra},
see Definition \ref{definition-finite-type},
\item
\label{item-ring-homomorphism-finite-type}
$\varphi : R_1 \to R_2$ is {\it of finite type}, or
{\it $R_2$ is a finite type $R_1$-algebra},
see Definition \ref{definition-finite-type},
\item
\label{item-ring-homomorphism-finite}
$\varphi : R_1 \to R_2$ is {\it finite}, or
{\it $R_2$ is a finite $R_1$-algebra},
\item $R$ is a {\it (integral) domain},
\label{item-ring-domain}
\item $R$ is {\it reduced},
\label{item-ring-reduced}
\item $R$ is {\it Noetherian},
\label{item-ring-Noetherian}
\item $R$ is a {\it principal ideal domain} or a {\it PID},
\label{item-ring-PID}
\item $R$ is a {\it Euclidean domain},
\label{item-ring-Euclidean}
\item $R$ is a {\it unique factorization domain} or a {\it UFD},
\label{item-ring-UFD}
\item $R$ is a {\it discrete valuation ring} or a {\it dvr},
\label{item-ring-dvr}
\item $K$ is a {\it field},
\label{item-field}
\item $L/K$ is a {\it field extension},
\label{item-field-extension}
\item $L/K$ is an {\it algebraic field extension},
\label{item-field-extension-algebraic}
\item $\{t_i\}_{i\in I}$ is a {\it transcendence basis} for $L$ over $K$,
\label{item-transcendence-basis}
\item the {\it transcendence degree} $\text{trdeg}(L/K)$ of $L$ over $K$,
\label{item-transcendence-degree}
\item the field $k$ is {\it algebraically closed},
\label{item-algebraically-closed}
\item
\label{item-extend-into-algebraically-closed}
if $L/K$ is algebraic, and $\Omega/K$ an extension with $\Omega$
algebraically closed,
then there exists a ring map $L \to \Omega$ extending the map on $K$,
\item $I \subset R$ is an {\it ideal},
\label{item-ideal}
\item $I \subset R$ is {\it radical},
\label{item-ideal-radical}
\item if $I$ is an ideal then we have its {\it radical} $\sqrt{I}$,
\label{item-radical-ideal}
\item
\label{item-ideal-nilpotent}
$I \subset R$ is {\it nilpotent} means that $I^n = 0$ for
some $n \in \mathbf{N}$,
\item
\label{item-ideal-locally-nilpotent}
$I \subset R$ is {\it locally nilpotent} means that every
element of $I$ is nilpotent,
\item $\mathfrak p \subset R$ is a {\it prime ideal},
\label{item-prime-ideal}
\item
\label{item-prime-product-ideals}
if $\mathfrak p \subset R$ is prime and if $I, J \subset R$
are ideal, and if $IJ\subset \mathfrak p$, then
$I \subset \mathfrak p$ or $J \subset \mathfrak p$.
\item $\mathfrak m \subset R$ is a {\it maximal ideal},
\label{item-maximal-ideal}
\item any nonzero ring has a maximal ideal,
\label{item-exists-maximal-ideal}
\item
\label{item-jacobson-radical}
the {\it Jacobson radical} of $R$ is $\text{rad}(R) =
\bigcap_{\mathfrak m \subset R} \mathfrak m$ the intersection
of all the maximal ideals of $R$,
\item the ideal $(T)$ {\it generated} by a subset $T \subset R$,
\label{item-ideal-generated-by}
\item the {\it quotient ring} $R/I$,
\label{item-quotient-ring}
\item an ideal $I$ in the ring $R$ is prime if and only if $R/I$ is a domain,
\label{item-characterize-prime-ideal}
\item
\label{item-characterize-maximal-ideal}
an ideal $I$ in the ring $R$ is maximal if and only if the
ring $R/I$ is a field,
\item
\label{item-inverse-image-ideal}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_2$ is an ideal, then $\varphi^{-1}(I)$ is an
ideal of $R_1$,
\item
\label{item-image-ideal}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$I \subset R_1$ is an ideal, then $\varphi(I) \cdot R_2$ (sometimes
denoted $I \cdot R_2$, or $IR_2$) is the ideal of $R_2$ generated
by $\varphi(I)$,
\item
\label{item-inverse-image-prime}
if $\varphi : R_1 \to R_2$ is a ring homomorphism, and if
$\mathfrak p \subset R_2$ is a prime ideal, then
$\varphi^{-1}(\mathfrak p)$ is a prime ideal of $R_1$,
\item $M$ is an {\it $R$-module},
\label{item-module}
\item
\label{item-annihilator}
for $m \in M$ the {\it annihilator}
$I = \{f \in R \mid fm = 0\}$ of $m$ in $R$,
\item $N \subset M$ is an {\it $R$-submodule},
\label{item-submodule}
\item $M$ is an {\it Noetherian $R$-module},
\label{item-Noetherian-module}
\item $M$ is a {\it finite $R$-module},
\label{item-finite-module}
\item $M$ is a {\it finitely generated $R$-module},
\label{item-finitely-generated-module}
\item $M$ is a {\it finitely presented $R$-module},
\label{item-finitely-presented-module}
\item $M$ is a {\it free $R$-module},
\label{item-free-module}
\item
\label{item-extension-free}
if $0 \to K \to L \to M \to 0$ is a short exact sequence
of $R$-modules and $K$, $M$ are free, then $L$ is free,
\item if $N \subset M \subset L$ are $R$-modules, then $L/M = (L/N)/(M/N)$,
\label{item-isomorphism-theorem}
\item $S$ is a {\it multiplicative subset of $R$},
\label{item-multiplicative-subset}
\item the {\it localization} $R \to S^{-1}R$ of $R$,
\label{item-localization-ring}
\item
\label{item-localization-zero}
if $R$ is a ring and $S$ is a multiplicative subset
of $R$ then $S^{-1}R$ is the zero ring if and only if $S$ contains $0$,
\item
\label{item-localize-nonzerodivisors}
if $R$ is a ring and if the multiplicative subset $S$
consists completely of nonzerodivisors, then $R \to S^{-1}R$
is injective,
\item if $\varphi : R_1 \to R_2$ is a ring homomorphism, and
$S$ is a multiplicative subset of $R_1$, then $\varphi(S)$ is
a multiplicative subset of $R_2$,
\item
\label{item-products-multiplicative-subsets}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $SS'$ denotes the set of products $SS' =
\{r \in R \mid \exists s\in S, \exists s' \in S', r = ss'\}$
then $SS'$ is a multiplicative subset of $R$,
\item
\label{item-localization-localization}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $\overline{S}$ denotes the image of $S$ in $(S')^{-1}R$,
then $(SS')^{-1}R = \overline{S}^{-1}((S')^{-1}R)$,
\item the {\it localization} $S^{-1}M$ of the $R$-module $M$,
\label{item-localization-module}
\item
\label{item-localization-exact}
the functor $M \mapsto S^{-1}M$ preserves injective maps,
surjective maps, and exactness,
\item
\label{item-localization-localization-module}
if $S$, $S'$ are multiplicative subsets of $R$,
and if $M$ is an $R$-module, then
$(SS')^{-1}M = S^{-1}((S')^{-1}M)$,
\item
\label{item-localize-ideal}
if $R$ is a ring, $I$ an ideal of $R$, and $S$ a multiplicative
subset of $R$, then $S^{-1}I$ is an ideal of $S^{-1}R$, and we have
$S^{-1}R/S^{-1}I = \overline{S}^{-1}(R/I)$, where $\overline{S}$
is the image of $S$ in $R/I$,
\item
\label{item-ideal-in-localization}
if $R$ is a ring, and $S$ a multiplicative
subset of $R$, then any ideal $I'$ of $S^{-1}R$ is
of the form $S^{-1}I$, where one can take $I$ to be
the inverse image of $I'$ in $R$,
\item
\label{item-submodule-in-localization}
if $R$ is a ring, $M$ an $R$-module, and $S$ a multiplicative
subset of $R$, then any submodule $N'$ of $S^{-1}M$ is of the form
$S^{-1}N$ for some submodule $N \subset M$, where
one can take $N$ to be the inverse image of $N'$ in $M$,
\item if $S = \{1, f, f^2, \ldots\}$ then $R_f = S^{-1}R$ and $M_f = S^{-1}M$,
\label{item-localize-f}
\item
\label{item-localize-p}
if $S = R \setminus \mathfrak p = \{x\in R \mid x\not\in \mathfrak p\}$
for some prime ideal $\mathfrak p$,
then it is customary to denote $R_{\mathfrak p} = S^{-1}R$
and $M_{\mathfrak p} = S^{-1}M$,
\item a {\it local ring} is a ring with exactly one maximal ideal,
\label{item-local-ring}
\item a {\it semi-local ring} is a ring with finitely many maximal ideals,
\label{item-semi-local-ring}
\item
\label{item-localize-p-local-ring}
if $\mathfrak p$ is a prime in $R$, then $R_{\mathfrak p}$ is
a local ring with maximal ideal $\mathfrak p R_{\mathfrak p}$,
\item
\label{item-residue-field}
the {\it residue field}, denoted $\kappa(\mathfrak p)$,
of the prime $\mathfrak p$ in the ring $R$ is the
field of fractions of the domain $R/\mathfrak p$;
it is equal to $R_\mathfrak p/\mathfrak pR_\mathfrak p
= (R \setminus \mathfrak p)^{-1}R/\mathfrak p$,
\item given $R$ and $M_1$, $M_2$ the {\it tensor product} $M_1 \otimes_R M_2$,
\label{item-tensor-product}
\item
\label{item-cauchy-binet}
given matrices $A$ and $B$ in a ring $R$ of sizes $m \times n$ and
$n \times m$ we have $\det(AB) = \sum \det(A_S)\det({}_SB)$ in $R$ where
the sum is over subsets $S \subset \{1, \ldots, n\}$ of size $m$
and $A_S$ is the $m \times m$ submatrix of $A$ with columns
corresponding to $S$ and ${}_SB$ is the $m \times m$ submatrix of $B$
with rows corresponding to $S$,
\item etc.
\end{enumerate}




\section{Snake lemma}
\label{section-snake}

\noindent
The snake lemma and its variants are discussed in the setting of
abelian categories in
Homology, Section \ref{homology-section-abelian-categories}.

\begin{lemma}
\label{lemma-snake}
\begin{reference}
\cite[III, Lemma 3.3]{Cartan-Eilenberg}
\end{reference}
Given a commutative diagram
$$
\xymatrix{
& X \ar[r] \ar[d]^\alpha &
Y \ar[r] \ar[d]^\beta &
Z \ar[r] \ar[d]^\gamma &
0 \\
0 \ar[r] & U \ar[r] & V \ar[r] & W
}
$$
of abelian groups with exact rows, there is a canonical exact sequence
$$
\Ker(\alpha) \to \Ker(\beta) \to \Ker(\gamma)
\to
\Coker(\alpha) \to \Coker(\beta) \to \Coker(\gamma)
$$
Moreover: if $X \to Y$ is injective, then the first map is
injective; if $V \to W$ is surjective, then the last
map is surjective.
\end{lemma}

\begin{proof}
The map $\partial : \Ker(\gamma) \to \Coker(\alpha)$ is defined
as follows. Take $z \in \Ker(\gamma)$. Choose $y \in Y$ mapping to $z$.
Then $\beta(y) \in V$ maps to zero in $W$. Hence $\beta(y)$ is the image of
some $u \in U$. Set $\partial z = \overline{u}$, the class of $u$ in the
cokernel of $\alpha$. Proof of exactness is omitted.
\end{proof}







\section{Finite modules and finitely presented modules}
\label{section-module-finite-type}

\noindent
Just some basic notation and lemmas.

\begin{definition}
\label{definition-module-finite-type}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item We say $M$ is a {\it finite $R$-module}, or a {\it finitely generated
$R$-module} if there exist $n \in \mathbf{N}$ and $x_1, \ldots, x_n \in M$
such that every element of $M$ is an $R$-linear combination of the $x_i$.
Equivalently, this means there exists a surjection
$R^{\oplus n} \to M$ for some $n \in \mathbf{N}$.
\item We say $M$ is a {\it finitely presented $R$-module} or an
{\it $R$-module of finite presentation} if there exist integers
$n, m \in \mathbf{N}$ and an exact sequence
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \longrightarrow 0
$$
\end{enumerate}
\end{definition}

\noindent
Informally, $M$ is a finitely presented $R$-module if and only if
it is finitely generated and the module of relations among these
generators is finitely generated as well.
A choice of an exact sequence as in the definition is called a
{\it presentation} of $M$.

\begin{lemma}
\label{lemma-lift-map}
Let $R$ be a ring. Let $\alpha : R^{\oplus n} \to M$ and $\beta : N \to M$ be
module maps. If $\Im(\alpha) \subset \Im(\beta)$, then there
exists an $R$-module map $\gamma : R^{\oplus n} \to N$ such that
$\alpha = \beta \circ \gamma$.
\end{lemma}

\begin{proof}
Let $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ be the $i$th basis vector
of $R^{\oplus n}$. Let $x_i \in N$ be an element with
$\alpha(e_i) = \beta(x_i)$ which exists by assumption. Set
$\gamma(a_1, \ldots, a_n) = \sum a_i x_i$. By construction
$\alpha = \beta \circ \gamma$.
\end{proof}

\begin{lemma}
\label{lemma-extension}
Let $R$ be a ring.
Let
$$
0 \to M_1 \to M_2 \to M_3 \to 0
$$
be a short exact sequence of $R$-modules.
\begin{enumerate}
\item If $M_1$ and $M_3$ are finite $R$-modules, then $M_2$ is a finite
$R$-module.
\item If $M_1$ and $M_3$ are finitely presented $R$-modules, then $M_2$
is a finitely presented $R$-module.
\item If $M_2$ is a finite $R$-module, then $M_3$ is a finite $R$-module.
\item If $M_2$ is a finitely presented $R$-module and $M_1$ is a
finite $R$-module, then $M_3$ is a finitely presented $R$-module.
\item If $M_3$ is a finitely presented $R$-module and $M_2$ is a finite
$R$-module, then $M_1$ is a finite $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). If $x_1, \ldots, x_n$ are generators of $M_1$ and
$y_1, \ldots, y_m \in M_2$ are elements whose images in $M_3$ are
generators of $M_3$, then $x_1, \ldots, x_n, y_1, \ldots, y_m$
generate $M_2$.

\medskip\noindent
Part (3) is immediate from the definition.

\medskip\noindent
Proof of (5). Assume $M_3$ is finitely presented and $M_2$ finite.
Choose a presentation
$$
R^{\oplus m} \to R^{\oplus n} \to M_3 \to 0
$$
By Lemma \ref{lemma-lift-map} there exists a map
$R^{\oplus n} \to M_2$ such that
the solid diagram
$$
\xymatrix{
& R^{\oplus m} \ar[r] \ar@{..>}[d] & R^{\oplus n} \ar[r] \ar[d] &
M_3 \ar[r] \ar[d]^{\text{id}} & 0 \\
0 \ar[r] & M_1 \ar[r] & M_2 \ar[r] & M_3 \ar[r] & 0
}
$$
commutes. This produces the dotted arrow. By the snake lemma
(Lemma \ref{lemma-snake}) we see that we get an isomorphism
$$
\Coker(R^{\oplus m} \to M_1)
\cong
\Coker(R^{\oplus n} \to M_2)
$$
In particular we conclude that $\Coker(R^{\oplus m} \to M_1)$
is a finite $R$-module. Since $\Im(R^{\oplus m} \to M_1)$
is finite by (3), we see that $M_1$ is finite by part (1).

\medskip\noindent
Proof of (4). Assume $M_2$ is finitely presented and $M_1$ is finite.
Choose a presentation $R^{\oplus m} \to R^{\oplus n} \to M_2 \to 0$.
Choose a surjection $R^{\oplus k} \to M_1$. By Lemma \ref{lemma-lift-map}
there exists a factorization $R^{\oplus k} \to R^{\oplus n} \to M_2$
of the composition $R^{\oplus k} \to M_1 \to M_2$. Then
$R^{\oplus k + m} \to R^{\oplus n} \to M_3 \to 0$
is a presentation.

\medskip\noindent
Proof of (2). Assume that $M_1$ and $M_3$ are finitely presented.
The argument in the proof of part (1) produces a commutative diagram
$$
\xymatrix{
0 \ar[r] & R^{\oplus n} \ar[d] \ar[r] & R^{\oplus n + m} \ar[d] \ar[r] &
R^{\oplus m} \ar[d] \ar[r] & 0 \\
0 \ar[r] & M_1 \ar[r] & M_2 \ar[r] & M_3 \ar[r] & 0
}
$$
with surjective vertical arrows. By the snake lemma we obtain a short
exact sequence
$$
0 \to \Ker(R^{\oplus n} \to M_1) \to
\Ker(R^{\oplus n + m} \to M_2) \to
\Ker(R^{\oplus m} \to M_3) \to 0
$$
By part (5) we see that the outer two modules are finite. Hence the
middle one is finite too. By (4) we see that $M_2$ is of finite presentation.
\end{proof}

\begin{lemma}
\label{lemma-trivial-filter-finite-module}
\begin{slogan}
Finite modules have filtrations such that successive quotients are
cyclic modules.
\end{slogan}
Let $R$ be a ring, and let $M$ be a finite $R$-module.
There exists a filtration by finite $R$-submodules
$$
0 = M_0 \subset M_1 \subset \ldots \subset M_n = M
$$
such that each quotient $M_i/M_{i - 1}$ is isomorphic
to $R/I_i$ for some ideal $I_i$ of $R$.
\end{lemma}

\begin{proof}
By induction on the number of generators of $M$. Let
$x_1, \ldots, x_r \in M$ be generators.
Let $M' = Rx_1 \subset M$. Then $M/M'$ has $r - 1$ generators
and the induction hypothesis applies. And clearly $M' \cong R/I_1$
with $I_1 = \{f \in R \mid fx_1 = 0\}$.
\end{proof}

\begin{lemma}
\label{lemma-finite-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
If $M$ is finite as an $R$-module, then $M$ is finite as an $S$-module.
\end{lemma}

\begin{proof}
In fact, any $R$-generating set of $M$ is also an $S$-generating set of
$M$, since the $R$-module structure is induced by the image of $R$ in $S$.
\end{proof}



\section{Ring maps of finite type and of finite presentation}
\label{section-finite-type}

\begin{definition}
\label{definition-finite-type}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item We say $R \to S$ is of {\it finite type}, or that {\it $S$ is a finite
type $R$-algebra} if there exist an $n \in \mathbf{N}$ and an surjection
of $R$-algebras $R[x_1, \ldots, x_n] \to S$.
\item We say $R \to S$ is of {\it finite presentation} if there
exist integers $n, m \in \mathbf{N}$ and polynomials
$f_1, \ldots, f_m \in R[x_1, \ldots, x_n]$
and an isomorphism of $R$-algebras
$R[x_1, \ldots, x_n]/(f_1, \ldots, f_m) \cong S$.
\end{enumerate}
\end{definition}

\noindent
Informally, $R \to S$ is of finite presentation if and only if
$S$ is finitely generated as an $R$-algebra
and the ideal of relations among the generators is finitely generated.
A choice of a surjection $R[x_1, \ldots, x_n] \to S$ as in the definition
is sometimes called a {\it presentation} of $S$.

\begin{lemma}
\label{lemma-compose-finite-type}
The notions finite type and finite presentation have the following
permanence properties.
\begin{enumerate}
\item A composition of ring maps of finite type is of finite type.
\item A composition of ring maps of finite presentation is of finite
presentation.
\item Given $R \to S' \to S$ with $R \to S$ of finite type,
then $S' \to S$ is of finite type.
\item Given $R \to S' \to S$, with $R \to S$ of finite presentation,
and $R \to S'$ of finite type, then $S' \to S$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
We only prove the last assertion.
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$
and $S' = R[y_1, \ldots, y_a]/I$. Say that the class
$\bar y_i$ of $y_i$ maps
to $h_i \bmod (f_1, \ldots, f_m)$ in $S$.
Then it is clear that
$S = S'[x_1, \ldots, x_n]/(f_1, \ldots, f_m,
h_1 - \bar y_1, \ldots, h_a - \bar y_a)$.
\end{proof}

\begin{lemma}
\label{lemma-finite-presentation-independent}
Let $R \to S$ be a ring map of finite presentation.
For any surjection $\alpha : R[x_1, \ldots, x_n] \to S$ the
kernel of $\alpha$ is a finitely generated ideal in $R[x_1, \ldots, x_n]$.
\end{lemma}

\begin{proof}
Write $S = R[y_1, \ldots, y_m]/(f_1, \ldots, f_k)$.
Choose $g_i \in R[y_1, \ldots, y_m]$ which are lifts
of $\alpha(x_i)$. Then we see that $S = R[x_i, y_j]/(f_l, x_i - g_i)$.
Choose $h_j \in R[x_1, \ldots, x_n]$ such that $\alpha(h_j)$
corresponds to $y_j \bmod (f_1, \ldots, f_k)$. Consider
the map $\psi : R[x_i, y_j] \to R[x_i]$, $x_i \mapsto x_i$,
$y_j \mapsto h_j$. Then the kernel of $\alpha$
is the image of $(f_l, x_i - g_i)$ under $\psi$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-finitely-presented-over-subring}
Let $R \to S$ be a ring map.
Let $M$ be an $S$-module.
Assume $R \to S$ is of finite type and
$M$ is finitely presented as an $R$-module.
Then $M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
This is similar to the proof of part (4) of
Lemma \ref{lemma-compose-finite-type}.
We may assume $S = R[x_1, \ldots, x_n]/J$.
Choose $y_1, \ldots, y_m \in M$ which generate $M$ as an $R$-module
and choose relations $\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ which
generate the kernel of $R^{\oplus m} \to M$. For any
$i = 1, \ldots, n$ and $j = 1, \ldots, m$ write
$$
x_i y_j = \sum a_{ijk} y_k
$$
for some $a_{ijk} \in R$. Consider the $S$-module $N$ generated by
$y_1, \ldots, y_m$ subject to the relations
$\sum a_{ij} y_j = 0$, $i = 1, \ldots, t$ and
$x_i y_j = \sum a_{ijk} y_k$, $i = 1, \ldots, n$ and $j = 1, \ldots, m$.
Then $N$ has a presentation
$$
S^{\oplus nm + t} \longrightarrow S^{\oplus m} \longrightarrow N
\longrightarrow 0
$$
By construction there is a surjective map $\varphi : N \to M$.
To finish the proof we show $\varphi$ is injective.
Suppose $z = \sum b_j y_j \in N$ for some $b_j \in S$.
We may think of $b_j$ as a polynomial in $x_1, \ldots, x_n$
with coefficients in $R$.
By applying the relations of the form $x_i y_j = \sum a_{ijk} y_k$
we can inductively lower the degree of the polynomials.
Hence we see that $z = \sum c_j y_j$ for some $c_j \in R$.
Hence if $\varphi(z) = 0$ then the vector $(c_1, \ldots, c_m)$
is an $R$-linear combination of the vectors $(a_{i1}, \ldots, a_{im})$
and we conclude that $z = 0$ as desired.
\end{proof}





\section{Finite ring maps}
\label{section-finite}

\noindent
Here is the definition.

\begin{definition}
\label{definition-finite-ring-map}
Let $\varphi : R \to S$ be a ring map. We say $\varphi : R \to S$ is
{\it finite} if $S$ is finite as an $R$-module.
\end{definition}

\begin{lemma}
\label{lemma-finite-module-over-finite-extension}
Let $R \to S$ be a finite ring map.
Let $M$ be an $S$-module.
Then $M$ is finite as an $R$-module if and only if $M$ is finite
as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finite-over-subring}.
To see the other assume that $M$ is finite as an $S$-module.
Pick $x_1, \ldots, x_n \in S$ which generate $S$ as an $R$-module.
Pick $y_1, \ldots, y_m \in M$ which generate $M$ as an $S$-module.
Then $x_i y_j$ generate $M$ as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-finite-transitive}
Suppose that $R \to S$ and $S \to T$ are finite ring maps.
Then $R \to T$ is finite.
\end{lemma}

\begin{proof}
If $t_i$ generate $T$ as an $S$-module and $s_j$ generate $S$ as an
$R$-module, then $t_i s_j$ generate $T$ as an $R$-module.
(Also follows from
Lemma \ref{lemma-finite-module-over-finite-extension}.)
\end{proof}

\begin{lemma}
\label{lemma-finite-finite-type}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item If $\varphi$ is finite, then $\varphi$ is of finite type.
\item If $S$ is of finite presentation as an $R$-module, then
$\varphi$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
For (1) if $x_1, \ldots, x_n \in S$ generate $S$ as an $R$-module,
then $x_1, \ldots, x_n$ generate $S$ as an $R$-algebra. For (2),
suppose that $\sum r_j^ix_i = 0$, $j = 1, \ldots, m$ is a set
of generators of the relations among the $x_i$ when viewed as
$R$-module generators of $S$. Furthermore, write
$1 = \sum r_ix_i$ for some $r_i \in R$ and
$x_ix_j = \sum r_{ij}^k x_k$ for some $r_{ij}^k \in R$.
Then
$$
S = R[t_1, \ldots, t_n]/
(\sum r_j^it_i,\ 1 - \sum r_it_i,\ t_it_j - \sum r_{ij}^k t_k)
$$
as an $R$-algebra which proves (2).
\end{proof}

\noindent
For more information on finite ring maps, please see
Section \ref{section-finite-ring-extensions}.


\section{Colimits}
\label{section-colimits}

\noindent
Some of the material in this section overlaps with the general
discussion on colimits in
Categories, Sections \ref{categories-section-limits} --
\ref{categories-section-posets-limits}.
The notion of a preordered set is defined in
Categories, Definition \ref{categories-definition-directed-set}.
It is a slightly weaker notion than a partially ordered set.

\begin{definition}
\label{definition-directed-system}
Let $(I, \leq)$ be a preordered set.
A {\it system $(M_i, \mu_{ij})$ of $R$-modules over $I$}
consists of a family of $R$-modules $\{M_i\}_{i\in I}$ indexed
by $I$ and a family of $R$-module maps $\{\mu_{ij} : M_i \to M_j\}_{i \leq j}$
such that for all $i \leq j \leq k$
$$
\mu_{ii} = \text{id}_{M_i}\quad
\mu_{ik} = \mu_{jk}\circ \mu_{ij}
$$
We say $(M_i, \mu_{ij})$ is a {\it directed system} if $I$ is a directed set.
\end{definition}

\noindent
This is the same as the notion defined in Categories,
Definition \ref{categories-definition-system-over-poset}
and Section \ref{categories-section-posets-limits}.
We refer to Categories, Definition \ref{categories-definition-colimit}
for the definition of a colimit of a diagram/system in any
category.

\begin{lemma}
\label{lemma-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the preordered set $I$.
The colimit of the system $(M_i, \mu_{ij})$ is the quotient $R$-module
$(\bigoplus_{i\in I} M_i) /Q$ where $Q$ is the
$R$-submodule generated by all elements
$$
\iota_i(x_i) - \iota_j(\mu_{ij}(x_i))
$$
where $\iota_i : M_i \to \bigoplus_{i\in I} M_i$
is the natural inclusion. We denote the colimit
$M = \colim_i M_i$. We denote
$\pi : \bigoplus_{i\in I} M_i \to M$ the
projection map and
$\phi_i = \pi \circ \iota_i : M_i \to M$.
\end{lemma}

\begin{proof}
This lemma is a special case of
Categories, Lemma \ref{categories-lemma-colimits-coproducts-coequalizers}
but we will also prove it directly in this case.
Namely, note that $\phi_i = \phi_j\circ \mu_{ij}$ in the above
construction. To show the pair $(M, \phi_i)$ is the colimit we have
to show it satisfies the universal property: for any other such pair
$(Y, \psi_i)$ with $\psi_i : M_i \to
Y$, $\psi_i = \psi_j\circ \mu_{ij}$, there is a unique $R$-module
homomorphism $g : M \to Y$ such that the
following diagram commutes:
$$
\xymatrix{
M_i \ar[rr]^{\mu_{ij}} \ar[dr]^{\phi_i} \ar[ddr]_{\psi_i} & &
M_j\ar[dl]_{\phi_j} \ar[ddl]^{\psi_j} \\
& M \ar[d]^{g}\\
& Y
}
$$
And this is clear because we can define $g$ by taking the
map $\psi_i$ on the summand $M_i$ in the direct sum
$\bigoplus M_i$.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit}
Let $(M_i, \mu_{ij})$ be a system of $R$-modules over the
preordered set $I$. Assume that $I$ is directed.
The colimit of the system $(M_i, \mu_{ij})$ is canonically
isomorphic to the module $M$ defined as follows:
\begin{enumerate}
\item as a set let
$$
M = \left(\coprod\nolimits_{i \in I} M_i\right)/\sim
$$
where for $m \in M_i$ and $m' \in M_{i'}$ we have
$$
m \sim m' \Leftrightarrow
\mu_{ij}(m) = \mu_{i'j}(m')\text{ for some }j \geq i, i'
$$
\item as an abelian group for $m \in M_i$ and $m' \in M_{i'}$
we define the sum of the classes of $m$ and $m'$ in $M$
to be the class of $\mu_{ij}(m) + \mu_{i'j}(m')$ where
$j \in I$ is any index with $i \leq j$ and $i' \leq j$, and
\item as an $R$-module define for $m \in M_i$ and $x \in R$
the product of $x$ and the class of $m$ in $M$ to be the
class of $xm$ in $M$.
\end{enumerate}
The canonical maps $\phi_i : M_i \to M$ are induced by the canonical
maps $M_i \to \coprod_{i \in I} M_i$.
\end{lemma}

\begin{proof}
Omitted. Compare with
Categories, Section \ref{categories-section-directed-colimits}.
\end{proof}

\begin{lemma}
\label{lemma-zero-directed-limit}
Let $(M_i, \mu_{ij})$ be a directed system.
Let $M = \colim M_i$ with $\mu_i : M_i \to M$.
Then, $\mu_i(x_i) = 0$ for $x_i \in M_i$ if and only if
there exists $j \geq i$ such that $\mu_{ij}(x_i) = 0$.
\end{lemma}

\begin{proof}
This is clear from the description of the directed colimit
in Lemma \ref{lemma-directed-colimit}.
\end{proof}

\begin{example}
\label{example-zero-colimit-different}
Consider the partially ordered set $I = \{a, b, c\}$ with
$a < b$ and $a < c$ and no other strict inequalities.
A system $(M_a, M_b, M_c, \mu_{ab}, \mu_{ac})$
over $I$ consists of three $R$-modules $M_a, M_b, M_c$
and two $R$-module homomorphisms $\mu_{ab} : M_a \to M_b$ and
$\mu_{ac} : M_a \to M_c$.
The colimit of the system is just
$$
M := \colim_{i \in I} M_i = \Coker(M_a \to M_b \oplus M_c)
$$
where the map is $\mu_{ab} \oplus -\mu_{ac}$. Thus the kernel of the
canonical map $M_a \to M$ is $\Ker(\mu_{ab}) + \Ker(\mu_{ac})$.
And the kernel of the canonical map $M_b \to M$ is the image of
$\Ker(\mu_{ac})$ under the map $\mu_{ab}$. Hence clearly
the result of Lemma \ref{lemma-zero-directed-limit} is false for
general systems.
\end{example}

\begin{definition}
\label{definition-homomorphism-directed-systems}
Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be
systems of $R$-modules over the same preordered set $I$.
A {\it homomorphism of systems} $\Phi$ from $(M_i, \mu_{ij})$ to
$(N_i, \nu_{ij})$ is by definition a family of $R$-module homomorphisms
$\phi_i : M_i \to N_i$
such that $\phi_j \circ \mu_{ij} = \nu_{ij} \circ \phi_i$
for all $i \leq j$.
\end{definition}

\noindent
This is the same notion as a transformation of functors
between the associated diagrams $M : I \to \text{Mod}_R$
and $N : I \to \text{Mod}_R$, in the language of
categories.
The following lemma is a special case of
Categories, Lemma \ref{categories-lemma-functorial-colimit}.

\begin{lemma}
\label{lemma-homomorphism-limit}
Let $(M_i, \mu_{ij})$, $(N_i, \nu_{ij})$ be
systems of $R$-modules over the same preordered set.
A morphism of systems $\Phi = (\phi_i)$ from $(M_i, \mu_{ij})$ to
$(N_i, \nu_{ij})$ induces a unique homomorphism
$$
\colim \phi_i : \colim M_i \longrightarrow \colim N_i
$$
such that
$$
\xymatrix{
M_i \ar[r] \ar[d]_{\phi_i} & \colim M_i \ar[d]^{\colim \phi_i} \\
N_i \ar[r] & \colim N_i
}
$$
commutes for all $i \in I$.
\end{lemma}

\begin{proof}
Write $M = \colim M_i$ and $N = \colim N_i$ and $\phi = \colim \phi_i$
(as yet to be constructed). We will use the explicit description of $M$
and $N$ in Lemma \ref{lemma-colimit} without further mention.
The condition of the lemma is equivalent to the condition that
$$
\xymatrix{
\bigoplus_{i\in I} M_i \ar[r] \ar[d]_{\bigoplus\phi_i} & M \ar[d]^\phi \\
\bigoplus_{i\in I} N_i \ar[r] & N
}
$$
commutes. Hence it is clear that if $\phi$ exists, then it is unique.
To see that $\phi$ exists, it suffices to show that the kernel of the
upper horizontal arrow is mapped by $\bigoplus \phi_i$ to the kernel
of the lower horizontal arrow. To see this, let $j \leq k$ and
$x_j \in M_j$. Then
$$
(\bigoplus \phi_i)(x_j - \mu_{jk}(x_j))
=
\phi_j(x_j) - \phi_k(\mu_{jk}(x_j))
=
\phi_j(x_j) - \nu_{jk}(\phi_j(x_j))
$$
which is in the kernel of the lower horizontal arrow as required.
\end{proof}

\begin{lemma}
\label{lemma-directed-colimit-exact}
\begin{slogan}
Filtered colimits are exact. Directed colimits are exact.
\end{slogan}
Let $I$ be a directed set.
Let $(L_i, \lambda_{ij})$, $(M_i, \mu_{ij})$, and
$(N_i, \nu_{ij})$ be systems of $R$-modules over $I$.
Let $\varphi_i : L_i \to M_i$ and $\psi_i : M_i \to N_i$ be
morphisms of systems over $I$. Assume that for all $i \in I$ the
sequence of $R$-modules
$$
\xymatrix{
L_i \ar[r]^{\varphi_i} &
M_i \ar[r]^{\psi_i} &
N_i
}
$$
is a complex with homology $H_i$.
Then the $R$-modules $H_i$ form a system over $I$,
the sequence of $R$-modules
$$
\xymatrix{
\colim_i L_i \ar[r]^\varphi &
\colim_i M_i \ar[r]^\psi &
\colim_i N_i
}
$$
is a complex as well, and denoting $H$ its homology we have
$$
H = \colim_i H_i.
$$
\end{lemma}

\begin{proof}
It is clear that
$
\xymatrix{
\colim_i L_i \ar[r]^\varphi &
\colim_i M_i \ar[r]^\psi &
\colim_i N_i
}
$
is a complex. For each $i \in I$, there is a canonical
$R$-module morphism $H_i \to H$ (sending each
$[m] \in H_i = \Ker(\psi_i) / \Im(\varphi_i)$ to the
residue class in $H = \Ker(\psi) / \Im(\varphi)$
of the image of $m$ in $\colim_i M_i$). These give rise
to a morphism $\colim_i H_i \to H$. It remains to
show that this morphism is surjective and injective.

\medskip\noindent
We are going to repeatedly use the description of colimits over $I$
as in Lemma \ref{lemma-directed-colimit} without further mention.
Let $h \in H$.
Since $H = \Ker(\psi)/\Im(\varphi)$ we see that
$h$ is the class mod $\Im(\varphi)$ of an element $[m]$
in $\Ker(\psi) \subset \colim_i M_i$. Choose an
$i$ such that $[m]$ comes from an element $m \in M_i$. Choose
a $j \geq i$ such that $\nu_{ij}(\psi_i(m)) = 0$ which is possible
since $[m] \in \Ker(\psi)$. After replacing $i$ by $j$ and
$m$ by $\mu_{ij}(m)$ we see that we may assume $m \in \Ker(\psi_i)$.
This shows that the map $\colim_i H_i \to H$ is surjective.

\medskip\noindent
Suppose that $h_i \in H_i$ has image zero on $H$. Since
$H_i = \Ker(\psi_i)/\Im(\varphi_i)$ we may represent
$h_i$ by an element $m \in \Ker(\psi_i) \subset M_i$.
The assumption on the vanishing of $h_i$ in $H$ means that
the class of $m$ in $\colim_i M_i$ lies in the image
of $\varphi$. Hence there exists a $j \geq i$ and an $l \in L_j$
such that $\varphi_j(l) = \mu_{ij}(m)$. Clearly this shows that
the image of $h_i$ in $H_j$ is zero. This proves the
injectivity of $\colim_i H_i \to H$.
\end{proof}

\begin{example}
\label{example-colimit-not-exact}
Taking colimits is not exact in general.
Consider the partially ordered set $I = \{a, b, c\}$ with
$a < b$ and $a < c$ and no other strict inequalities,
as in Example \ref{example-zero-colimit-different}.
Consider the map of systems
$(0, \mathbf{Z}, \mathbf{Z}, 0, 0) \to
(\mathbf{Z}, \mathbf{Z}, \mathbf{Z}, 1, 1)$.
From the description of the colimit in
Example \ref{example-zero-colimit-different}
we see that the associated map of colimits is not injective,
even though the map of systems is injective on each object.
Hence the result of Lemma \ref{lemma-directed-colimit-exact}
is false for general systems.
\end{example}

\begin{lemma}
\label{lemma-almost-directed-colimit-exact}
Let $\mathcal{I}$ be an index category satisfying the assumptions of
Categories, Lemma \ref{categories-lemma-split-into-directed}.
Then taking colimits of diagrams of abelian groups over $\mathcal{I}$
is exact (i.e., the analogue of
Lemma \ref{lemma-directed-colimit-exact}
holds in this situation).
\end{lemma}

\begin{proof}
By
Categories, Lemma \ref{categories-lemma-split-into-directed}
we may write $\mathcal{I} = \coprod_{j \in J} \mathcal{I}_j$ with each
$\mathcal{I}_j$ a filtered category, and $J$ possibly empty. By
Categories, Lemma \ref{categories-lemma-directed-category-system}
taking colimits over the index categories $\mathcal{I}_j$ is
the same as taking the colimit over some directed set. Hence
Lemma \ref{lemma-directed-colimit-exact}
applies to these colimits. This reduces the problem to showing that
coproducts in the category of $R$-modules over the set $J$ are exact.
In other words, exact sequences
$L_j \to M_j \to N_j$ of $R$ modules we have to show that
$$
\bigoplus\nolimits_{j \in J} L_j
\longrightarrow
\bigoplus\nolimits_{j \in J} M_j
\longrightarrow
\bigoplus\nolimits_{j \in J} N_j
$$
is exact. This can be verified by hand, and holds even if $J$ is empty.
\end{proof}






\section{Localization}
\label{section-localization}

\begin{definition}
\label{definition-multiplicative-subset}
Let $R$ be a ring, $S$ a subset of $R$.
We say $S$ is a {\it multiplicative subset of $R$} if
$1\in S$ and $S$ is closed
under multiplication, i.e., $s, s' \in S \Rightarrow ss' \in S$.
\end{definition}

\noindent
Given a ring $A$ and a multiplicative subset $S$, we
define a relation on $A \times S$ as follows:
$$
(x, s) \sim (y, t)
\Leftrightarrow
\exists u \in S \text{ such that } (xt-ys)u = 0
$$
It is easily checked that this is an equivalence relation.
Let $x/s$ (or $\frac{x}{s}$) be the equivalence class of $(x, s)$ and
$S^{-1}A$ be the set of all equivalence classes. Define addition
and multiplication in $S^{-1}A$ as follows:
$$
x/s + y/t = (xt + ys)/st, \quad
x/s \cdot y/t = xy/st
$$
One can check that $S^{-1}A$ becomes a ring under these operations.

\begin{definition}
\label{definition-localization}
This ring is called the {\it localization of $A$ with respect to $S$}.
\end{definition}

\noindent
We have a natural ring map from $A$ to its localization $S^{-1}A$,
$$
A \longrightarrow S^{-1}A, \quad x \longmapsto x/1
$$
which is sometimes called the {\it localization map}. In general the
localization map is not injective, unless $S$ contains no zerodivisors.
For, if $x/1 = 0$, then there is a $u\in S$ such that $xu = 0$ in $A$ and
hence $x = 0$ since there are no zerodivisors in $S$.
The localization of a ring has the following universal property.

\begin{proposition}
\label{proposition-universal-property-localization}
Let $f : A \to B$ be a ring map that sends every element in $S$ to a unit
of $B$. Then there is a unique homomorphism $g : S^{-1}A \to B$ such
that the following diagram commutes.
$$
\xymatrix{
A \ar[rr]^{f} \ar[dr] & & B \\
& S^{-1}A \ar[ur]_g
}
$$
\end{proposition}

\begin{proof}
Existence. We define a map $g$ as follows. For $x/s\in S^{-1}A$, let
$g(x/s) = f(x)f(s)^{-1}\in B$. It is easily checked from the definition
that this is a well-defined ring map. And it is also clear that
this makes the diagram commutative.

\medskip\noindent
Uniqueness. We now show that if $g' : S^{-1}A \to B$
satisfies $g'(x/1) = f(x)$, then $g = g'$. Hence $f(s) = g'(s/1)$ for
$s \in S$ by the commutativity of the diagram. But then $g'(1/s)f(s) = 1$
in $B$, which implies that $g'(1/s) = f(s)^{-1}$ and hence
$g'(x/s) = g'(x/1)g'(1/s) = f(x)f(s)^{-1} = g(x/s)$.
\end{proof}

\begin{lemma}
\label{lemma-localization-zero}
The localization $S^{-1}A$ is the zero ring if and only if $0\in S$.
\end{lemma}

\begin{proof}
If $0\in S$, any pair $(a, s)\sim (0, 1)$ by definition.
If $0\not \in S$, then clearly $1/1 \neq 0/1$ in $S^{-1}A$.
\end{proof}

\begin{lemma}
\label{lemma-localization-and-modules}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The category of $S^{-1}R$-modules is equivalent to the category
of $R$-modules $N$ with the property that every $s \in S$ acts as
an automorphism on $N$.
\end{lemma}

\begin{proof}
The functor which defines the equivalence associates to an $S^{-1}R$-module
$M$ the same module but now viewed as an $R$-module via the localization
map $R \to S^{-1}R$. Conversely, if $N$ is an $R$-module, such that every
$s \in S$ acts via an automorphism $s_N$, then we can think of $N$ as an
$S^{-1}R$-module by letting $x/s$ act via $x_N  \circ s_N^{-1}$.
We omit the verification that these two functors are quasi-inverse to
each other.
\end{proof}

\noindent
The notion of localization of a ring can be generalized to the
localization of a module. Let $A$ be a ring, $S$ a multiplicative
subset of $A$ and $M$ an $A$-module. We define a relation on
$M \times S$ as follows
$$
(m, s) \sim (n, t)
\Leftrightarrow
\exists u\in S \text{ such that } (mt-ns)u = 0
$$
This is clearly an equivalence relation. Denote by $m/s$ (or
$\frac{m}{s}$) be the equivalence class of $(m, s)$ and $S^{-1}M$ be
the set of all equivalence classes. Define the addition and scalar
multiplication as follows
$$
m/s + n/t = (mt + ns)/st,\quad
m/s\cdot n/t = mn/st
$$
It is clear that this makes $S^{-1}M$ an $S^{-1}A$-module.

\begin{definition}
\label{definition-localization-module}
The $S^{-1}A$-module $S^{-1}M$ is called the {\it localization} of $M$ at $S$.
\end{definition}

\noindent
Note that there is an $A$-module map $M \to S^{-1}M$, $m \mapsto m/1$
which is sometimes
called the {\it localization map}. It satisfies the following universal
property.

\begin{lemma}
\label{lemma-universal-property-localization-module}
Let $R$ be a ring. Let $S \subset R$ a multiplicative subset. Let $M$, $N$
be $R$-modules. Assume all the elements of $S$ act as automorphisms on $N$.
Then the canonical map
$$
\Hom_R(S^{-1}M, N) \longrightarrow \Hom_R(M, N)
$$
induced by the localization map, is an isomorphism.
\end{lemma}

\begin{proof}
It is clear that the map is well-defined and $R$-linear.
Injectivity: Let $\alpha \in \Hom_R(S^{-1}M, N)$ and take an arbitrary
element $m/s \in S^{-1}M$. Then, since $s \cdot \alpha(m/s) = \alpha(m/1)$,
we have $ \alpha(m/s) =s^{-1}(\alpha (m/1))$, so $\alpha$ is completely
determined by what it does on the image of $M$ in $S^{-1}M$.
Surjectivity: Let $\beta : M \rightarrow N$ be a given R-linear map.
We need to show that it can be "extended" to $S^{-1}M$. Define a map of
sets
$$
M \times S \rightarrow N,\quad
(m,s) \mapsto s^{-1}\beta(m)
$$
Clearly, this map respects the equivalence relation from above, so it
descends to a well-defined map $\alpha : S^{-1}M \rightarrow N$.
It remains to show that this map is $R$-linear, so take
$r, r' \in R$ as well as $s, s' \in S$ and
$m, m' \in M$. Then
\begin{align*}
\alpha(r \cdot m/s + r' \cdot m' /s')
& =
\alpha((r \cdot s' \cdot m + r' \cdot s \cdot m') /(ss')) \\
& =
(ss')^{-1}\beta(r \cdot s' \cdot m + r' \cdot s \cdot m') \\
& =
(ss')^{-1} (r \cdot s' \beta (m) + r' \cdot s \beta (m')) \\
& =
r \alpha (m/s) + r' \alpha (m' /s')
\end{align*}
and we win.
\end{proof}

\begin{example}
\label{example-localize-at-prime}
Let $A$ be a ring and let $M$ be an $A$-module.
Here are some important examples of localizations.
\begin{enumerate}
\item Given $\mathfrak p$ a prime ideal of $A$ consider
$S = A\setminus\mathfrak p$. It is
immediately checked that $S$ is a multiplicative set. In this case
we denote $A_\mathfrak p$ and $M_\mathfrak p$ the localization of
$A$ and $M$ with respect to $S$ respectively. These are
called the {\it localization of $A$, resp.\ $M$ at $\mathfrak p$}.
\item Let $f\in A$. Consider $S = \{1, f, f^2, \ldots\}$.
This is clearly a multiplicative subset of $A$.
In this case we denote $A_f$
(resp. $M_f$) the localization $S^{-1}A$ (resp. $S^{-1}M$).
This is called the {\it localization of $A$, resp.\ $M$ with
respect to $f$}.
Note that $A_f = 0$ if and only if $f$ is nilpotent in $A$.
\item Let $S = \{f \in A \mid f \text{ is not a zerodivisor in }A\}$.
This is a multiplicative subset of $A$. In this case the
ring $Q(A) = S^{-1}A$ is called either the
{\it total quotient ring}, or the {\it total ring of fractions}
of $A$.
\item If $A$ is a domain, then the total quotient ring $Q(A)$ is
the field of fractions of $A$. Please see
Fields, Example \ref{fields-example-quotient-field}.
\end{enumerate}
\end{example}

\begin{lemma}
\label{lemma-localization-colimit}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset.
Let $M$ be an $R$-module.
Then
$$
S^{-1}M = \colim_{f \in S} M_f
$$
where the preorder on $S$ is given by
$f \geq f' \Leftrightarrow f = f'f''$ for some $f'' \in R$
in which case the map $M_{f'} \to M_f$ is given
by $m/(f')^e \mapsto m(f'')^e/f^e$.
\end{lemma}

\begin{proof}
Omitted. Hint: Use the universal property of
Lemma \ref{lemma-universal-property-localization-module}.
\end{proof}

\noindent
In the following paragraph,
let $A$ denote a ring,
and $M, N$ denote modules over $A$.

\medskip\noindent
If $S$ and $S'$ are multiplicative sets of $A$, then it is
clear that
$$
SS' = \{ss' : s\in S, \ s'\in S'\}
$$
is also a multiplicative set of $A$. Then the following holds.

\begin{proposition}
\label{proposition-localize-twice}
Let $\overline{S}$ be the image of $S$ in $S'^{-1}A$, then
$(SS')^{-1}A$ is isomorphic to $\overline{S}^{-1}(S'^{-1}A)$.
\end{proposition}

\begin{proof}
The map sending $x\in A$ to $x/1\in (SS')^{-1}A$ induces a map
sending $x/s\in S'^{-1}A$ to $x/s \in (SS')^{-1}A$, by universal
property. The image of the elements in $\overline{S}$ are invertible
in $(SS')^{-1}A$. By the universal property we get a map
$f : \overline{S}^{-1}(S'^{-1}A) \to (SS')^{-1}A$ which maps
$(x/s')/(s/1)$ to $x/ss'$.

\medskip\noindent
On the other hand, the map from $A$ to $\overline{S}^{-1}(S'^{-1}A)$
sending $x\in A$ to $(x/1)/(1/1)$ also induces a map
$g : (SS')^{-1}A \to \overline{S}^{-1}(S'^{-1}A)$ which sends $x/ss'$
to $(x/s')/(s/1)$, by the universal property again. It is
immediately checked that $f$ and $g$ are inverse to each other,
hence they are both isomorphisms.
\end{proof}

\noindent
For the module $M$ we have

\begin{proposition}
\label{proposition-localize-twice-module}
View $S'^{-1}M$ as an $A$-module, then $S^{-1}(S'^{-1}M)$ is
isomorphic to $(SS')^{-1}M$.
\end{proposition}

\begin{proof}
Note that given a $A$-module M, we have not proved any
universal property for $S^{-1}M$. Hence we cannot reason
as in the preceding proof; we have to construct the isomorphism explicitly.

\medskip\noindent
We define the maps as follows
\begin{align*}
& f : S^{-1}(S'^{-1}M) \longrightarrow (SS')^{-1}M, \quad \frac{x/s'}{s}\mapsto
x/ss'\\
& g : (SS')^{-1}M \longrightarrow S^{-1}(S'^{-1}M), \quad x/t\mapsto
\frac{x/s'}{s}\ \text{for some }s\in S, s'\in S', \text{ and }
t = ss'
\end{align*}
We have to check that these homomorphisms are well-defined, that is,
independent the choice of the fraction. This is easily checked and it is also
straightforward to show that they are inverse to each other.
\end{proof}

\noindent
If $u : M \to N$ is an $A$ homomorphism, then the localization indeed
induces a well-defined $S^{-1}A$ homomorphism $S^{-1}u : S^{-1}M \to
S^{-1}N$ which sends $x/s$ to $u(x)/s$. It is immediately checked that
this construction is functorial, so that $S^{-1}$
is actually a functor from the category of $A$-modules to the
category of $S^{-1}A$-modules. Moreover this functor is exact,
as we show in the following proposition.

\begin{proposition}
\label{proposition-localization-exact}
\begin{slogan}
Localization is exact.
\end{slogan}
Let $L\xrightarrow{u} M\xrightarrow{v} N$ be an exact sequence
of $R$-modules. Then
$S^{-1}L \to S^{-1}M \to S^{-1}N$ is also exact.
\end{proposition}

\begin{proof}
First it is clear that $S^{-1}L \to S^{-1}M \to S^{-1}N$ is a complex
since localization is a functor. Next suppose that $x/s$ maps to zero
in $S^{-1}N$ for some $x/s \in S^{-1}M$. Then by definition there is a
$t\in S$ such that $v(xt) = v(x)t = 0$ in $M$, which means
$xt \in \Ker(v)$. By the exactness of $L \to M \to N$ we have
$xt = u(y)$ for some $y$ in $L$. Then $x/s$ is the image of $y/st$.
This proves the exactness.
\end{proof}

\begin{lemma}
\label{lemma-localize-quotient-modules}
Localization respects quotients, i.e. if $N$ is a submodule of
$M$, then $S^{-1}(M/N)\simeq (S^{-1}M)/(S^{-1}N)$.
\end{lemma}

\begin{proof}
From the exact sequence
$$
0 \longrightarrow N \longrightarrow M \longrightarrow M/N \longrightarrow 0
$$
we have
$$
0 \longrightarrow S^{-1}N \longrightarrow S^{-1}M
\longrightarrow S^{-1}(M/N) \longrightarrow 0
$$
The corollary then follows.
\end{proof}

\noindent
If, in the preceding Corollary, we take $N = I$ and $M = A$ for an ideal $I$ of
$A$, we see that $S^{-1}A/S^{-1}I \simeq S^{-1}(A/I)$ as $A$-modules. The next
proposition shows that they are isomorphic as rings.

\begin{proposition}
\label{proposition-localize-quotient}
Let $I$ be an ideal of $A$, $S$ a multiplicative set of $A$. Then
$S^{-1}I$ is an ideal of $S^{-1}A$ and $\overline{S}^{-1}(A/I)$ is
isomorphic to $S^{-1}A/S^{-1}I$, where $\overline{S}$ is
the image of $S$ in $A/I$.
\end{proposition}

\begin{proof}
The fact that $S^{-1}I$ is an ideal is clear since $I$ itself is an
ideal. Define
$$
f : S^{-1}A\longrightarrow \overline{S}^{-1}(A/I), \quad x/s\mapsto
\overline{x}/\overline{s}
$$
where $\overline{x}$ and $\overline{s}$ are the images of $x$ and
$s$ in $A/I$. We shall keep similar notations in this proof.
This map is well-defined by the universal property of
$S^{-1}A$, and $S^{-1}I$ is contained in the kernel of it,
therefore it induces a map
$$
\overline{f} : S^{-1}A/S^{-1}I \longrightarrow \overline{S}^{-1}(A/I), \quad
\overline{x/s}\mapsto \overline{x}/\overline{s}
$$

\medskip\noindent
On the other hand, the map $A \to S^{-1}A/S^{-1}I$ sending $x$ to
$\overline{x/1}$ induces a map $A/I \to S^{-1}A/S^{-1}I$ sending
$\overline{x}$ to $\overline{x/1}$. The image of $\overline{S}$ is
invertible in $S^{-1}A/S^{-1}I$, thus induces a map
$$
g : \overline{S}^{-1}(A/I) \longrightarrow S^{-1}A/S^{-1}I, \quad
\frac{\overline{x}}{\overline{s}}\mapsto \overline{x/s}
$$
by the universal property. It is then clear that $\overline{f}$ and $g$
are inverse to each other, hence are both isomorphisms.
\end{proof}

\noindent
We now consider how submodules behave in localization.

\begin{lemma}
\label{lemma-submodule-localization}
Any submodule $N'$ of $S^{-1}M$ is of the form $S^{-1}N$ for some
$N\subset M$. Indeed one can take $N$ to be the inverse image of
$N'$ in $M$.
\end{lemma}

\begin{proof}
Let $N$ be the inverse image of $N'$ in $M$. Then one can see that
$S^{-1}N\supset N'$. To show they are equal, take $x/s$ in
$S^{-1}N$, where $s\in S$ and $x\in N$. This yields that $x/1\in
N'$. Since $N'$ is an $S^{-1}R$-submodule we have
$x/s = x/1\cdot 1/s\in N'$. This finishes the proof.
\end{proof}

\noindent
Taking $M = A$ and $N = I$ an ideal of $A$, we have the following
corollary, which can be viewed as a converse of the first part of
Proposition \ref{proposition-localize-quotient}.

\begin{lemma}
\label{lemma-ideal-in-localization}
\begin{slogan}
Ideals in the localization of a ring are localizations of ideals.
\end{slogan}
Each ideal $I'$ of $S^{-1}A$ takes the form $S^{-1}I$, where one can
take $I$ to be the inverse image of $I'$ in $A$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-submodule-localization}.
\end{proof}










\section{Internal Hom}
\label{section-hom}

\noindent
If $R$ is a ring, and $M$, $N$ are $R$-modules, then
$$
\Hom_R(M, N) = \{ \varphi : M \to N\}
$$
is the set of $R$-linear maps from $M$ to $N$. This set comes with
the structure of an abelian group by setting
$(\varphi + \psi)(m) = \varphi(m) + \psi(m)$, as usual.
In fact, $\Hom_R(M, N)$ is also an $R$-module via the rule
$(x \varphi)(m) = x \varphi(m) = \varphi(xm)$.

\medskip\noindent
Given maps $a : M \to M'$ and $b : N \to N'$ of $R$-modules, we can
pre-compose and post-compose homomorphisms by $a$ and $b$. This leads
to the following commutative diagram
$$
\xymatrix{
\Hom_R(M', N) \ar[d]_{- \circ a} \ar[r]_{b \circ -} &
\Hom_R(M', N') \ar[d]^{- \circ a} \\
\Hom_R(M, N) \ar[r]^{b \circ -} &
\Hom_R(M, N')
}
$$
In fact, the maps in this diagram are $R$-module maps.
Thus $\Hom_R$ defines an additive functor
$$
\text{Mod}_R^{opp} \times \text{Mod}_R \longrightarrow \text{Mod}_R, \quad
(M, N) \longmapsto \Hom_R(M, N)
$$

\begin{lemma}
\label{lemma-hom-exact}
Exactness and $\Hom_R$. Let $R$ be a ring.
\begin{enumerate}
\item Let $M_1 \to M_2 \to M_3 \to 0$ be a complex of $R$-modules.
Then $M_1 \to M_2 \to M_3 \to 0$ is exact if and only if
$0 \to \Hom_R(M_3, N) \to \Hom_R(M_2, N) \to \Hom_R(M_1, N)$
is exact for all $R$-modules $N$.
\item  Let $0 \to M_1 \to M_2 \to M_3$ be a complex of $R$-modules.
Then $0 \to M_1 \to M_2 \to M_3$ is exact if and only if
$0 \to \Hom_R(N, M_1) \to \Hom_R(N, M_2) \to \Hom_R(N, M_3)$
is exact for all $R$-modules $N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-finitely-presented}
Let $R$ be a ring. Let $M$ be a finitely presented $R$-module.
Let $N$ be an $R$-module.
\begin{enumerate}
\item For $f \in R$ we have
$\Hom_R(M, N)_f = \Hom_{R_f}(M_f, N_f) = \Hom_R(M_f, N_f)$,
\item for a multiplicative subset $S$ of $R$ we have
$$
S^{-1}\Hom_R(M, N) = \Hom_{S^{-1}R}(S^{-1}M, S^{-1}N) =
\Hom_R(S^{-1}M, S^{-1}N).
$$
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a special case of part (2).
The second equality in (2) follows from
Lemma \ref{lemma-localization-and-modules}.
Choose a presentation
$$
\bigoplus\nolimits_{j = 1, \ldots, m} R
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} R
\to M \to 0.
$$
By
Lemma \ref{lemma-hom-exact}
this gives an exact sequence
$$
0 \to
\Hom_R(M, N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} N.
$$
Inverting $S$ and using Proposition \ref{proposition-localization-exact}
we get an exact sequence
$$
0 \to
S^{-1}\Hom_R(M, N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}N
$$
and the result follows since $S^{-1}M$ sits in
an exact sequence
$$
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}R
\longrightarrow
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}R \to S^{-1}M \to 0
$$
which induces (by Lemma \ref{lemma-hom-exact})
the exact sequence
$$
0 \to
\Hom_{S^{-1}R}(S^{-1}M, S^{-1}N) \to
\bigoplus\nolimits_{i = 1, \ldots, n} S^{-1}N
\longrightarrow
\bigoplus\nolimits_{j = 1, \ldots, m} S^{-1}N
$$
which is the same as the one above.
\end{proof}




\section{Characterizing finite and finitely presented modules}
\label{section-colim-and-hom}

\noindent
Given a module $N$ over a ring $R$, you can characterize whether or not
$N$ is a finite module or a finitely presented module
in terms of the functor $\Hom_R(N, -)$.

\begin{lemma}
\label{lemma-characterize-finite-module-hom}
Let $R$ be a ring. Let $N$ be an $R$-module. The following are equivalent
\begin{enumerate}
\item $N$ is a finite $R$-module,
\item for any filtered colimit $M = \colim M_i$ of $R$-modules the map
$\colim \Hom_R(N, M_i) \to \Hom_R(N, M)$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and choose generators $x_1, \ldots, x_m$ for $N$.
If $N \to M_i$ is a module map and the composition
$N \to M_i \to M$ is zero, then because $M = \colim_{i' \geq i} M_{i'}$
for each $j \in \{1, \ldots, m\}$ we can find a $i' \geq i$ such that
$x_j$ maps to zero in $M_{i'}$. Since there are finitely many
$x_j$ we can find a single $i'$ which works for all of them.
Then the composition $N \to M_i \to M_{i'}$ is zero and we conclude
the map is injective, i.e., part (2) holds.

\medskip\noindent
Assume (2). For a finite subset $E \subset N$ denote $N_E \subset N$
the $R$-submodule generated by the elements of $E$. Then
$0 = \colim N/N_E$ is a filtered colimit. Hence we see that
$\text{id} : N \to N$ maps into $N_E$ for some $E$, i.e., $N$
is finitely generated.
\end{proof}

\noindent
For purposes of reference, we define what it means to have a relation
between elements of a module.

\begin{definition}
\label{definition-relation}
Let $R$ be a ring. Let $M$ be an $R$-module.
Let $n \geq 0$ and $x_i \in M$ for $i = 1, \ldots, n$.
A {\it relation} between $x_1, \ldots, x_n$ in $M$ is a
sequence of elements $f_1, \ldots, f_n \in R$ such that
$\sum_{i = 1, \ldots, n} f_i x_i = 0$.
\end{definition}

\begin{lemma}
\label{lemma-module-colimit-fp}
Let $R$ be a ring and let $M$ be an $R$-module.
Then $M$ is the colimit of a directed system
$(M_i, \mu_{ij})$ of $R$-modules
with all $M_i$ finitely presented $R$-modules.
\end{lemma}

\begin{proof}
Consider any finite subset $S \subset M$ and any finite
collection of relations $E$ among the elements
of $S$. So each $s \in S$ corresponds to $x_s \in M$ and
each $e \in E$ consists of a vector
of elements $f_{e, s} \in R$ such that $\sum f_{e, s} x_s = 0$.
Let $M_{S, E}$ be the cokernel of the map
$$
R^{\# E} \longrightarrow R^{\# S}, \quad
(g_e)_{e\in E} \longmapsto (\sum g_e f_{e, s})_{s\in S}.
$$
There are canonical maps $M_{S, E} \to M$.
If $S \subset S'$ and if the elements of
$E$ correspond, via this map, to relations
in $E'$, then there is an obvious map
$M_{S, E} \to M_{S', E'}$ commuting with the
maps to $M$. Let $I$ be the set of pairs
$(S, E)$ with ordering by inclusion as above.
It is clear that the colimit of this directed system is $M$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finitely-presented-module-hom}
Let $R$ be a ring. Let $N$ be an $R$-module. The following are equivalent
\begin{enumerate}
\item $N$ is a finitely presented $R$-module,
\item for any filtered colimit $M = \colim M_i$ of $R$-modules the map
$\colim \Hom_R(N, M_i) \to \Hom_R(N, M)$ is bijective.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume (1) and choose an exact sequence $F_{-1} \to F_0 \to N \to 0$
with $F_i$ finite free. Then we have an exact sequence
$$
0 \to \Hom_R(N, M) \to \Hom_R(F_0, M) \to \Hom_R(F_{-1}, M)
$$
functorial in the $R$-module $M$. The functors $\Hom_R(F_i, M)$ commute
with filtered colimits as $\Hom_R(R^{\oplus n}, M) = M^{\oplus n}$.
Since filtered colimits are exact
(Lemma \ref{lemma-directed-colimit-exact})
we see that (2) holds.

\medskip\noindent
Assume (2). By Lemma \ref{lemma-module-colimit-fp}
we can write $N = \colim N_i$ as a filtered
colimit such that $N_i$ is of finite presentation for all $i$.
Thus $\text{id}_N$ factors through $N_i$ for some $i$.
This means that $N$ is a direct summand of a finitely
presented $R$-module (namely $N_i$) and hence finitely presented.
\end{proof}














\section{Tensor products}
\label{section-tensor-product}

\begin{definition}
\label{definition-bilinear}
Let $R$ be a ring, $M, N, P$ be three $R$-modules.
A mapping $f : M \times N \to P$ (where $M \times N$
is viewed only as Cartesian product of two $R$-modules) is said to be
{\it $R$-bilinear} if for each $x \in M$
the mapping $y\mapsto f(x, y)$ of $N$ into $P$ is $R$-linear, and for each
$y\in N$ the mapping $x\mapsto f(x, y)$ is also $R$-linear.
\end{definition}

\begin{lemma}
\label{lemma-tensor-product}
Let $M, N$ be $R$-modules. Then there exists a pair $(T, g)$
where $T$ is an $R$-module, and
$g : M \times N \to T$ an $R$-bilinear
mapping, with the following universal property:
For any $R$-module $P$ and any $R$-bilinear mapping
$f : M \times N \to P$, there
exists a unique $R$-linear
mapping $\tilde{f} : T \to P$ such that $f = \tilde{f} \circ g$.
In other words, the following diagram commutes:
$$
\xymatrix{
M \times N \ar[rr]^f \ar[dr]_g & & P\\
& T \ar[ur]_{\tilde f}
}
$$
Moreover, if $(T, g)$ and $(T', g')$
are two pairs with this property, then there
exists a unique isomorphism
$j : T \to T'$ such that $j\circ g = g'$.
\end{lemma}

\noindent
The $R$-module $T$ which satisfies the above universal property is called
the  {\it tensor product} of $R$-modules $M$ and $N$, denoted as
$M \otimes_R N$.

\begin{proof}
We first prove the existence of such $R$-module $T$.
Let $M, N$ be $R$-modules.
Let $T$ be the quotient module
$P/Q$, where $P$ is the free $R$-module $R^{(M \times N)}$ and $Q$ is the
$R$-module generated by all elements of
the following types: ($x\in M, y\in N$)
\begin{align*}
(x + x', y) - (x, y) - (x', y), \\
(x, y + y') - (x, y) - (x, y'), \\
(ax, y) - a(x, y), \\
(x, ay) - a(x, y)
\end{align*}
Let $\pi : M \times N \to T$ denote the natural map.
This map is $R$-bilinear, as
implied by the above relations
when we check the bilinearity conditions. Denote the image
$\pi(x, y) = x \otimes
y$, then these elements generate
$T$. Now let $f : M \times N \to P$ be an $R$-bilinear map,
then we can define
$f' : T \to P$ by extending the mapping
$f'(x \otimes y) = f(x, y)$. Clearly $f = f'\circ \pi$. Moreover, $f'$ is
uniquely determined by the value on the
generating sets $\{x \otimes y : x\in M, y\in N\}$.
Suppose there is another pair $(T', g')$ satisfying the same properties.
Then there is a unique $j : T \to T'$ and
also $j' : T' \to T$ such that $g' = j\circ g$, $g = j'\circ g'$.
But then both the maps $(j\circ j') \circ g$ and $g$
satisfies the universal properties, so by uniqueness they are equal,
and hence $j'\circ j$ is identity on $T$.
Similarly $(j'\circ j) \circ g' = g'$ and $j\circ j'$ is identity on $T'$.
So $j$ is an isomorphism.
\end{proof}

\begin{lemma}
\label{lemma-flip-tensor-product}
Let $M, N, P$ be $R$-modules, then the bilinear maps
\begin{align*}
(x, y) & \mapsto y \otimes x\\
(x + y, z) & \mapsto x \otimes z + y \otimes z\\
(r, x) & \mapsto rx
\end{align*}
induce unique isomorphisms
\begin{align*}
M \otimes_R N & \to N \otimes_R M, \\
(M\oplus N)\otimes_R P & \to (M \otimes_R P)\oplus(N \otimes_R P),  \\
R \otimes_R M & \to M
\end{align*}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
We may generalize the tensor product of two $R$-modules to finitely many
$R$-modules, and set up a
correspondence between the multi-tensor product with multilinear mappings.
Using almost the same construction
one can prove that:

\begin{lemma}
\label{lemma-multilinear}
Let $M_1, \ldots, M_r$ be $R$-modules. Then there exists a pair $(T, g)$
consisting of an $R$-module T and an $R$-multilinear mapping
$g : M_1\times \ldots \times M_r \to T$ with the universal
property: For any $R$-multilinear mapping
$f : M_1\times \ldots \times M_r \to P$ there exists a unique $R$-module
homomorphism $f' : T \to P$ such that $f'\circ g = f$.
Such a module $T$ is unique up to unique isomorphism. We denote it
$M_1\otimes_R \ldots \otimes_R M_r$ and we denote the universal
multilinear map $(m_1, \ldots, m_r) \mapsto m_1 \otimes \ldots \otimes m_r$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-transitive}
The homomorphisms
$$
(M \otimes_R N)\otimes_R P \to
M \otimes_R N \otimes_R P \to
M \otimes_R (N \otimes_R P)
$$
such that
$f((x \otimes y)\otimes z) = x \otimes y \otimes z$
and $g(x \otimes y \otimes z) = x \otimes (y \otimes z)$,
$x\in M, y\in N, z\in P$ are well-defined and are isomorphisms.
\end{lemma}

\begin{proof}
We shall prove $f$ is well-defined and is an isomorphism, and this proof
carries analogously to $g$. Fix any
$z\in P$, then the mapping $(x, y)\mapsto x \otimes y \otimes z$,
$x\in M, y\in N$, is $R$-bilinear in $x$ and $y$,
and hence induces homomorphism $f_z : M \otimes N \to M \otimes N \otimes P$
which sends
$f_z(x \otimes y) = x \otimes y \otimes z$.
Then consider $(M \otimes N)\times P \to M \otimes N \otimes P$ given by
$(w, z)\mapsto f_z(w)$. The map is
$R$-bilinear and thus induces
$f : (M \otimes_R N)\otimes_R P \to M \otimes_R N \otimes_R P$
and $f((x \otimes y)\otimes z) = x \otimes y \otimes z$.
To construct the inverse, we note that the map
$\pi : M \times N \times P \to (M \otimes N)\otimes P$ is
$R$-trilinear.
Therefore, it induces an $R$-linear map
$h : M \otimes N \otimes P \to (M \otimes N)\otimes P$ which
agrees with the universal property. Here we see that
$h(x \otimes y \otimes z) = (x \otimes y)\otimes z$.
From the explicit expression of $f$ and $h$, $f\circ h$ and $h\circ f$ are
identity maps of $M \otimes N \otimes
P$ and $(M \otimes N)\otimes P$ respectively, hence $f$ is our desired
isomorphism.
\end{proof}

\noindent
Doing induction we see that this extends to multi-tensor products. Combined
with Lemma \ref{lemma-flip-tensor-product} we see that
the tensor product operation on the category of $R$-modules is associative,
commutative and distributive.

\begin{definition}
\label{definition-bimodule}
An abelian group $N$ is called an {\it $(A, B)$-bimodule} if it is both an
$A$-module and a $B$-module and for all $a \in A$ and $b \in B$ the
multiplication by $a$ and $b$ commute, so $b(an) = a(bn)$ for all $n \in N$.
In this situation we usually write the $B$-action on the right: so
for $b \in B$ and $n \in N$ the result of multiplying $n$ by $b$
is denoted $nb$. With this convention the compatibility above is
that $(ax)b = a(xb)$ for all $a\in A, b\in B, x\in N$.
The shorthand $_AN_B$ is used to denote an $(A, B)$-bimodule $N$.
\end{definition}

\begin{lemma}
\label{lemma-tensor-with-bimodule}
For $A$-module $M$, $B$-module $P$ and $(A, B)$-bimodule $N$, the modules
$(M \otimes_A N)\otimes_B P$ and $M \otimes_A(N \otimes_B P)$ can both be
given $(A, B)$-bimodule structure,
and moreover
$$
(M \otimes_A N)\otimes_B P \cong M \otimes_A(N \otimes_B P).
$$
\end{lemma}

\begin{proof}
A priori $M \otimes_A N$ is an $A$-module, but we can give it a
$B$-module structure by letting
$$
(x \otimes y)b = x \otimes yb, \quad x\in M, y\in N, b\in B
$$
Thus $M \otimes_A N$ becomes an $(A, B)$-bimodule. Similarly for
$N \otimes_B P$, and thus for
$(M \otimes_A N)\otimes_B P$ and $M \otimes_A(N \otimes_B P)$. By
Lemma \ref{lemma-transitive}, these two
modules are isomorphic as both as $A$-module and $B$-module via the same
mapping.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-tensor-product}
For any three $R$-modules $M, N, P$,
$$
\Hom_R(M \otimes_R N, P) \cong \Hom_R(M, \Hom_R(N, P))
$$
\end{lemma}

\begin{proof}
An $R$-linear map $\hat{f}\in \Hom_R(M \otimes_R N, P)$ corresponds to an
$R$-bilinear map $f : M \times N \to P$. For
each $x\in M$ the mapping $y\mapsto f(x, y)$ is $R$-linear by the universal
property. Thus $f$ corresponds to a
map $\phi_f : M \to \Hom_R(N, P)$. This map is $R$-linear since
$$
\phi_f(ax + y)(z) =
f(ax + y, z) = af(x, z)+f(y, z) =
(a\phi_f(x)+\phi_f(y))(z),
$$
for all $a \in R$, $x \in M$, $y \in M$ and
$z \in N$. Conversely, any
$f \in \Hom_R(M, \Hom_R(N, P))$ defines an $R$-bilinear
map $M \times N \to P$, namely $(x, y)\mapsto f(x)(y)$.
So this is a natural one-to-one correspondence between the
two modules
$\Hom_R(M \otimes_R N, P)$ and $\Hom_R(M, \Hom_R(N, P))$.
\end{proof}

\begin{lemma}[Tensor products commute with colimits]
\label{lemma-tensor-products-commute-with-limits}
Let $(M_i, \mu_{ij})$ be a system over the preordered set $I$.
Let $N$ be an $R$-module. Then
$$
\colim (M_i \otimes N) \cong (\colim M_i)\otimes N.
$$
Moreover, the isomorphism is induced by the homomorphisms
$\mu_i \otimes 1: M_i \otimes N \to M \otimes N$
where $M = \colim_i M_i$ with natural maps $\mu_i : M_i \to M$.
\end{lemma}

\begin{proof}
First proof. The functor $M' \mapsto M' \otimes_R N$ is left adjoint
to the functor $N' \mapsto \Hom_R(N, N')$ by
Lemma \ref{lemma-hom-from-tensor-product}. Thus $M' \mapsto M' \otimes_R N$
commutes with all colimits, see
Categories, Lemma \ref{categories-lemma-adjoint-exact}.

\medskip\noindent
Second direct proof. Let $P = \colim (M_i \otimes N)$ with coprojections
$\lambda_i : M_i \otimes N \to P$. Let $M = \colim M_i$ with coprojections
$\mu_i : M_i \to M$. Then for all $i\leq j$, the following diagram commutes:
$$
\xymatrix{
M_i \otimes N \ar[r]_{\mu_i \otimes 1} \ar[d]_{\mu_{ij} \otimes 1} &
M \otimes N \ar[d]^{\text{id}} \\
M_j \otimes N \ar[r]^{\mu_j \otimes 1} &
M \otimes N
}
$$
By Lemma \ref{lemma-homomorphism-limit} these maps induce a unique homomorphism
$\psi : P \to M \otimes N$ such that
$\mu_i \otimes 1 = \psi \circ \lambda_i$.

\medskip\noindent
To construct the inverse map, for each $i\in I$, there is the canonical
$R$-bilinear mapping $g_i : M_i \times N \to
M_i \otimes N$. This induces a unique mapping
$\widehat{\phi} : M \times N \to P$
such that $\widehat{\phi} \circ (\mu_i \times 1) = \lambda_i \circ g_i$.
It is $R$-bilinear. Thus it induces an
$R$-linear mapping $\phi : M \otimes N \to P$.
From the commutative diagram below:
$$
\xymatrix{
M_i \times N \ar[r]^{g_i} \ar[d]^{\mu_i \times \text{id}} &
M_i \otimes N\ar[r]_{\text{id}} \ar[d]_{\lambda_i} &
M_i \otimes N \ar[d]_{\mu_i \otimes \text{id}} \ar[rd]^{\lambda_i} \\
M \times N \ar[r]^{\widehat{\phi}} &
P \ar[r]^{\psi} & M \otimes N \ar[r]^{\phi} & P
}
$$
we see that $\psi\circ\widehat{\phi} = g$, the canonical $R$-bilinear mapping
$g : M \times N \to M \otimes N$. So
$\psi\circ\phi$ is identity on $M \otimes N$. From the right-hand square and
triangle, $\phi\circ\psi$ is also
identity on $P$.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-exact}
Let
\begin{align*}
M_1\xrightarrow{f} M_2\xrightarrow{g} M_3 \to 0
\end{align*}
be an exact sequence of $R$-modules and homomorphisms, and let $N$ be any
$R$-module. Then the sequence
\begin{equation}
\label{equation-2ndex}
M_1\otimes N\xrightarrow{f \otimes 1} M_2\otimes N \xrightarrow{g \otimes 1}
M_3\otimes N \to 0
\end{equation}
is exact. In other words, the functor $- \otimes_R N$ is
{\it right exact}, in the sense that tensoring
each term in the original right exact sequence preserves the exactness.
\end{lemma}

\begin{proof}
We apply the functor $\Hom(-, \Hom(N, P))$ to the first exact
sequence. We obtain
$$
0 \to
\Hom(M_3, \Hom(N, P)) \to
\Hom(M_2, \Hom(N, P)) \to
\Hom(M_1, \Hom(N, P))
$$
By Lemma \ref{lemma-hom-from-tensor-product}, we have
$$
0 \to \Hom(M_3 \otimes N, P) \to
\Hom(M_2 \otimes N, P) \to \Hom(M_1 \otimes N, P)
$$
Using the pullback property again, we arrive at the desired exact sequence.
\end{proof}

\begin{remark}
\label{remark-tensor-product-not-exact}
However, tensor product does NOT preserve exact sequences in general.
In other words, if $M_1 \to M_2 \to M_3$ is
exact, then it is not necessarily true that
$M_1 \otimes N \to M_2 \otimes N \to M_3 \otimes N$
is exact for arbitrary $R$-module $N$.
\end{remark}

\begin{example}
\label{example-tensor-product-not-exact}
Consider the injective map $2 : \mathbf{Z}\to \mathbf{Z}$
viewed as a map of $\mathbf{Z}$-modules.
Let $N = \mathbf{Z}/2$. Then the induced map
$\mathbf{Z} \otimes \mathbf{Z}/2 \to \mathbf{Z} \otimes \mathbf{Z}/2$
is NOT injective. This is because for
$x \otimes y\in \mathbf{Z} \otimes \mathbf{Z}/2$,
$$
(2 \otimes 1)(x \otimes y) = 2x \otimes y = x \otimes 2y = x \otimes 0 = 0
$$
Therefore the induced map is the zero map while $\mathbf{Z} \otimes N\neq 0$.
\end{example}

\begin{remark}
\label{remark-flat-module}
For $R$-modules $N$, if the
functor $-\otimes_R N$ is exact, i.e. tensoring
with $N$ preserves all exact
sequences, then $N$ is said to be {\it flat} $R$-module.
We will discuss this later in Section \ref{section-flat}.
\end{remark}

\begin{lemma}
\label{lemma-tensor-finiteness}
Let $R$ be a ring. Let $M$ and $N$ be $R$-modules.
\begin{enumerate}
\item If $N$ and $M$ are finite, then so is $M \otimes_R N$.
\item If $N$ and $M$ are finitely presented, then so is $M \otimes_R N$.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $M$ is finite. Then choose a presentation
$0 \to K \to R^{\oplus n} \to M \to 0$. This gives an exact sequence
$K \otimes_R N \to N^{\oplus n} \to M \otimes_R N \to 0$ by
Lemma \ref{lemma-tensor-product-exact}.
We conclude that if $N$ is finite too then $M \otimes_R N$
is a quotient of a finite module, hence finite, see
Lemma \ref{lemma-extension}.
Similarly, if both $N$ and $M$ are finitely presented, then
we see that $K$ is finite and that $M \otimes_R N$
is a quotient of the finitely presented module $N^{\oplus n}$ by
a finite module, namely $K \otimes_R N$, and hence finitely presented, see
Lemma \ref{lemma-extension}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-localization}
Let $M$ be an $R$-module. Then the $S^{-1}R$-modules $S^{-1}M$
and $S^{-1}R \otimes_R M$ are canonically isomorphic, and the
canonical isomorphism $f : S^{-1}R \otimes_R M \to S^{-1}M$
is given by
$$
f((a/s) \otimes m) = am/s, \forall a \in R, m \in M, s \in S
$$
\end{lemma}

\begin{proof}
Obviously, the map
$f' : S^{-1}R \times M \to S^{-1}M$ given by $f'(a/s, m) = am/s$ is
bilinear, and thus by the
universal property, this map induces a unique $S^{-1}R$-module homomorphism
$f : S^{-1}R \otimes_R M \to S^{-1}M$ as in the statement of the lemma.
Actually every element in $S^{-1}M$ is of the form $m/s$, $m\in M, s\in S$ and
every element in
$S^{-1}R \otimes_R M$ is of the form $1/s \otimes m$. To see the latter fact,
write an element in
$S^{-1}R \otimes_R M$ as
$$
\sum_k \frac{a_k}{s_k} \otimes m_k =
\sum_k \frac{a_k t_k}{s} \otimes m_k =
\frac{1}{s} \otimes \sum_k {a_k t_k}m_k = \frac{1}{s} \otimes m
$$
Where $m = \sum_k {a_k t_k}m_k$. Then it is obvious that $f$ is surjective,
and if $f(\frac{1}{s} \otimes m) = m/s = 0$ then there exists $t'\in S$ with
$tm = 0$ in $M$. Then we have
$$
\frac{1}{s} \otimes m = \frac{1}{st} \otimes tm = \frac{1}{st} \otimes 0 = 0
$$
Therefore $f$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-tensor-product-localization}
Let $M, N$ be $R$-modules, then there is a canonical
$S^{-1}R$-module isomorphism
$f : S^{-1}M \otimes_{S^{-1}R}S^{-1}N \to S^{-1}(M \otimes_R N)$,
given by
$$
f((m/s)\otimes(n/t)) = (m \otimes n)/st
$$
\end{lemma}

\begin{proof}
We may use Lemma \ref{lemma-tensor-with-bimodule}
and Lemma \ref{lemma-tensor-localization} repeatedly to
see that these two
$S^{-1}R$-modules are isomorphic, noting that $S^{-1}R$ is an
$(R, S^{-1}R)$-bimodule:
\begin{align*}
S^{-1}(M \otimes_R N) & \cong S^{-1}R \otimes_R (M \otimes_R N)\\
 & \cong S^{-1}M \otimes_R N\\
 & \cong (S^{-1}M \otimes_{S^{-1}R}S^{-1}R)\otimes_R N\\
 & \cong S^{-1}M \otimes_{S^{-1}R}(S^{-1}R \otimes_R N)\\
 & \cong S^{-1}M \otimes_{S^{-1}R}S^{-1}N
\end{align*}
This isomorphism is easily seen to be the one stated in the lemma.
\end{proof}















\section{Tensor algebra}
\label{section-tensor-algebra}

\noindent
Let $R$ be a ring. Let $M$ be an $R$-module.
We define the {\it tensor algebra of $M$ over $R$} to
be the noncommutative $R$-algebra
$$
\text{T}(M) = \text{T}_R(M) =
\bigoplus\nolimits_{n \geq 0} \text{T}^n(M)
$$
with
$\text{T}^0(M) = R$,
$\text{T}^1(M) = M$,
$\text{T}^2(M) = M \otimes_R M$,
$\text{T}^3(M) = M \otimes_R M \otimes_R M$, and so on.
Multiplication is defined by the rule that on pure tensors we have
$$
(x_1 \otimes x_2 \otimes \ldots \otimes x_n)
\cdot
(y_1 \otimes y_2 \otimes \ldots \otimes y_m)
=
x_1 \otimes x_2 \otimes \ldots \otimes x_n \otimes
y_1 \otimes y_2 \otimes \ldots \otimes y_m
$$
and we extend this by linearity.

\medskip\noindent
We define the {\it exterior algebra $\wedge(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\wedge^n(M)$ is denoted $x_1 \wedge \ldots \wedge x_n$.
These elements generate $\wedge^n(M)$, they are $R$-linear
in each $x_i$ and they are zero when two of the $x_i$ are equal
(i.e., they are alternating as functions of
$x_1, x_2, \ldots, x_n$). The multiplication on $\wedge(M)$ is
graded commutative, i.e., every $x \in M$ and $y \in M$
satisfy $x \wedge y = - y \wedge x$.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case $\wedge(M)$ is free over
$R$ with basis the elements
$$
x_{i_1} \wedge \ldots \wedge x_{i_r}
$$
with $0 \leq r \leq n$ and $1 \leq i_1 < i_2 < \ldots < i_r \leq n$.

\medskip\noindent
We define the {\it symmetric algebra $\text{Sym}(M)$ of $M$ over $R$}
to be the quotient of $\text{T}(M)$ by the two sided
ideal generated by the elements $x \otimes y - y \otimes x \in \text{T}^2(M)$.
The image of a pure tensor $x_1 \otimes \ldots \otimes x_n$
in $\text{Sym}^n(M)$ is denoted just $x_1 \ldots x_n$.
These elements generate $\text{Sym}^n(M)$, these are $R$-linear
in each $x_i$ and $x_1 \ldots x_n = x_1' \ldots x_n'$ if the
sequence of elements $x_1, \ldots, x_n$ is a permutation of the
sequence $x_1', \ldots, x_n'$. Thus we see that $\text{Sym}(M)$
is commutative.

\medskip\noindent
An example of this is when $M = Rx_1 \oplus \ldots \oplus Rx_n$
is a finite free module. In this case
$\text{Sym}(M) = R[x_1, \ldots, x_n]$ is a polynomial algebra.

\begin{lemma}
\label{lemma-free-tensor-algebra}
Let $R$ be a ring. Let $M$ be an $R$-module.
If $M$ is a free $R$-module, so is each symmetric and exterior power.
\end{lemma}

\begin{proof}
Omitted, but see above for the finite free case.
\end{proof}

\begin{lemma}
\label{lemma-presentation-sym-exterior}
Let $R$ be a ring.
Let $M_2 \to M_1 \to M \to 0$ be an exact sequence of $R$-modules.
There are exact sequences
$$
M_2 \otimes_R \text{Sym}^{n - 1}(M_1)
\to
\text{Sym}^n(M_1)
\to
\text{Sym}^n(M)
\to
0
$$
and similarly
$$
M_2 \otimes_R \wedge^{n - 1}(M_1)
\to
\wedge^n(M_1)
\to
\wedge^n(M)
\to
0
$$
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-present-sym-wedge}
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $x_i$, $i \in I$ be a given system of generators of
$M$ as an $R$-module. Let $n \geq 2$.
There exists a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\oplus
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\wedge^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ in the first
summand maps to
\begin{align*}
\underbrace{
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_1} \text{ and } x_{i_2}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}} \\
+
\underbrace{
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_2} \text{ and } x_{i_1}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
\end{align*}
and $m_1 \otimes \ldots \otimes m_{n - 2}$ in the second
summand maps to
$$
\underbrace{
m_1 \otimes \ldots \otimes x_i \otimes \ldots
\otimes x_i \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i} \text{ and } x_{i}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
$$
There is also a canonical exact sequence
$$
\bigoplus_{1 \leq j_1 < j_2 \leq n}
\bigoplus_{i_1, i_2 \in I}
\text{T}^{n - 2}(M)
\to
\text{T}^n(M)
\to
\text{Sym}^n(M)
\to
0
$$
where the pure tensor $m_1 \otimes \ldots \otimes m_{n - 2}$ maps to
\begin{align*}
\underbrace{
m_1 \otimes \ldots \otimes x_{i_1} \otimes \ldots
\otimes x_{i_2} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_1} \text{ and } x_{i_2}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}} \\
-
\underbrace{
m_1 \otimes \ldots \otimes x_{i_2} \otimes \ldots
\otimes x_{i_1} \otimes \ldots \otimes m_{n - 2}
}_{\text{with } x_{i_2} \text{ and } x_{i_1}
\text{ occupying slots } j_1 \text{ and } j_2
\text{ in the tensor}}
\end{align*}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-present-wedge}
Let $A \to B$ be a ring map. Let $M$ be a $B$-module.
Let $n > 1$. The kernel of the $A$-linear map
$M \otimes_A \ldots \otimes_A M \to \wedge^n_B(M)$
is generated as an $A$-module by the elements
$m_1 \otimes \ldots \otimes m_n$ with $m_i = m_j$
for $i \not = j$, $m_1, \ldots, m_n \in M$ and the elements
$m_1 \otimes \ldots \otimes bm_i \otimes \ldots \otimes m_n -
m_1 \otimes \ldots \otimes bm_j \otimes \ldots \otimes m_n$
for $i \not = j$, $m_1, \ldots, m_n \in M$, and $b \in B$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-colimit-tensor-algebra}
\begin{slogan}
Taking tensor algebras commutes with filtered colimits.
\end{slogan}
Let $R$ be a ring. Let $M_i$ be a directed system of
$R$-modules. Then
$\colim_i \text{T}(M_i) = \text{T}(\colim_i M_i)$
and similarly for the symmetric and exterior algebras.
\end{lemma}

\begin{proof}
Omitted. Hint: Apply Lemma \ref{lemma-tensor-products-commute-with-limits}.
\end{proof}

\begin{lemma}
\label{lemma-tensor-algebra-localization}
Let $R$ be a ring and let $S \subset R$ be a multiplicative subset.
Then $S^{-1}T_R(M) = T_{S^{-1}R}(S^{-1}M)$ for any $R$-module $M$.
Similar for symmetric and exterior algebras.
\end{lemma}

\begin{proof}
Omitted. Hint: Apply Lemma \ref{lemma-tensor-product-localization}.
\end{proof}









\section{Base change}
\label{section-base-change}

\noindent
We formally introduce base change in algebra as follows.

\begin{definition}
\label{definition-base-change}
Let $\varphi : R \to S$ be a ring map. Let $M$ be an $S$-module.
Let $R \to R'$ be any ring map. The {\it base change} of $\varphi$
by $R \to R'$ is the ring map $R' \to S \otimes_R R'$. In this situation
we often write $S' = S \otimes_R R'$.
The {\it base change} of the $S$-module $M$ is the $S'$-module
$M \otimes_R R'$.
\end{definition}

\noindent
If $S = R[x_i]/(f_j)$ for some collection of variables $x_i$, $i \in I$
and some collection of polynomials $f_j \in R[x_i]$, $j \in J$, then
$S \otimes_R R' = R'[x_i]/(f'_j)$, where $f'_j \in R'[x_i]$ is the image
of $f_j$ under the map $R[x_i] \to R'[x_i]$ induced by $R \to R'$.
This simple remark is the key to understanding base change.

\begin{lemma}
\label{lemma-base-change-finiteness}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
Let $R \to R'$ be a ring map and let $S' = S \otimes_R R'$ and
$M' = M \otimes_R R'$ be the base changes.
\begin{enumerate}
\item If $M$ is a finite $S$-module, then the base change
$M'$ is a finite $S'$-module.
\item If $M$ is an $S$-module of finite presentation, then
the base change $M'$ is an $S'$-module of finite presentation.
\item If $R \to S$ is of finite type, then the base change
$R' \to S'$ is of finite type.
\item If $R \to S$ is of finite presentation, then
the base change $R' \to S'$ is of finite presentation.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1). Take a surjective, $S$-linear map
$S^{\oplus n} \to M \to 0$.
By Lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact}
the result after tensoring with $R^\prime$ is a surjection
${S^\prime}^{\oplus n} \to M^\prime \rightarrow 0$,
so $M^\prime$ is a finitely generated $S^\prime$-module.
Proof of (2). Take a presentation
$S^{\oplus m} \to S^{\oplus n} \to M \to 0$.
By Lemma \ref{lemma-flip-tensor-product} and \ref{lemma-tensor-product-exact}
the result after tensoring with $R^\prime$ gives a finite presentation
${S^\prime}^{\oplus m} \to {S^\prime}^{\oplus n} \to M^\prime \to 0$, of
the $S^\prime$-module $M^\prime$. Proof of (3). This follows by the remark
preceding the lemma as we can take $I$ to be finite by assumption.
Proof of (4). This follows by the remark preceding the lemma
as we can take $I$ and $J$ to be finite by assumption.
\end{proof}

\noindent
Let $\varphi : R \to S$ be a ring map. Given an $S$-module $N$ we
obtain an $R$-module $N_R$ by the rule $r \cdot n = \varphi(r)n$.
This is sometimes called the {\it restriction} of $N$ to $R$.

\begin{lemma}
\label{lemma-adjoint-tensor-restrict}
Let $R \to S$ be a ring map. The functors
$\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction)
and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto M \otimes_R S$
(base change) are adjoint functors. In a formula
$$
\Hom_R(M, N_R) = \Hom_S(M \otimes_R S, N)
$$
\end{lemma}

\begin{proof}
If $\alpha : M \to N_R$ is an $R$-module map, then we define
$\alpha' : M \otimes_R S \to N$ by the rule
$\alpha'(m \otimes s) = s\alpha(m)$. If $\beta : M \otimes_R S \to N$
is an $S$-module map, we define $\beta' : M \to N_R$ by the rule
$\beta'(m) = \beta(m \otimes 1)$.
We omit the verification that these constructions are mutually inverse.
\end{proof}

\noindent
The lemma above tells us that restriction has a left adjoint, namely
base change. It also has a right adjoint.

\begin{lemma}
\label{lemma-adjoint-hom-restrict}
Let $R \to S$ be a ring map. The functors
$\text{Mod}_S \to \text{Mod}_R$, $N \mapsto N_R$ (restriction)
and $\text{Mod}_R \to \text{Mod}_S$, $M \mapsto \Hom_R(S, M)$
are adjoint functors. In a formula
$$
\Hom_R(N_R, M) = \Hom_S(N, \Hom_R(S, M))
$$
\end{lemma}

\begin{proof}
If $\alpha : N_R \to M$ is an $R$-module map, then we define
$\alpha' : N \to \Hom_R(S, M)$ by the rule
$\alpha'(n) = (s \mapsto \alpha(sn))$. If $\beta : N \to \Hom_R(S, M)$
is an $S$-module map, we define $\beta' : N_R \to M$ by the rule
$\beta'(n) = \beta(n)(1)$.
We omit the verification that these constructions are mutually inverse.
\end{proof}

\begin{lemma}
\label{lemma-hom-from-tensor-product-variant}
Let $R \to S$ be a ring map. Given $S$-modules $M, N$ and an $R$-module $P$
we have
$$
\Hom_R(M \otimes_S N, P) = \Hom_S(M, \Hom_R(N, P))
$$
\end{lemma}

\begin{proof}
This can be proved directly, but it is also a consequence of
Lemmas \ref{lemma-adjoint-hom-restrict} and \ref{lemma-hom-from-tensor-product}.
Namely, we have
\begin{align*}
\Hom_R(M \otimes_S N, P)
& =
\Hom_S(M \otimes_S N, \Hom_R(S, P)) \\
& =
\Hom_S(M, \Hom_S(N, \Hom_R(S, P))) \\
& =
\Hom_S(M, \Hom_R(N, P))
\end{align*}
as desired.
\end{proof}








\section{Miscellany}
\label{section-miscellany}

\noindent
The proofs in this section should not refer to any results except
those from the section on basic notions, Section \ref{section-rings-basic}.

\begin{lemma}
\label{lemma-product-ideals-in-prime}
Let $R$ be a ring, $I$ and $J$ two ideals and $\mathfrak p$ a prime ideal
containing the product $IJ$. Then $\mathfrak{p}$ contains $I$ or $J$.
\end{lemma}

\begin{proof}
Assume the contrary and take $x \in I \setminus \mathfrak p$ and
$y \in J \setminus \mathfrak p$. Their product is an element of
$IJ \subset \mathfrak p$, which contradicts the assumption that
$\mathfrak p$ was prime.
\end{proof}

\begin{lemma}[Prime avoidance]
\label{lemma-silly}
\begin{slogan}
1. In an affine scheme if a finite number of points are contained in an
open subset then they are contained in a smaller principal open subset.
2. Affine opens are cofinal among the neighborhoods of a given finite set
of an affine scheme
\end{slogan}
Let $R$ be a ring. Let $I_i \subset R$, $i = 1, \ldots, r$,
and $J \subset R$ be ideals. Assume
\begin{enumerate}
\item $J \not\subset I_i$ for $i = 1, \ldots, r$, and
\item all but two of $I_i$ are prime ideals.
\end{enumerate}
Then there exists an $x \in J$, $x\not\in I_i$ for all $i$.
\end{lemma}

\begin{proof}
The result is true for $r = 1$. If $r = 2$, then let $x, y \in J$ with
$x \not \in I_1$ and $y \not \in I_2$. We are done unless $x \in I_2$
and $y \in I_1$. Then the element $x + y$ cannot be in $I_1$ (since that
would mean $x + y - y \in I_1$) and it also cannot be in $I_2$.

\medskip\noindent
For $r \geq 3$, assume the result holds for $r - 1$. After renumbering
we may assume that $I_r$ is prime. We may also assume there are no
inclusions among the $I_i$. Pick $x \in J$, $x \not \in I_i$ for all
$i = 1, \ldots, r - 1$. If $x \not\in I_r$ we are done. So assume
$x \in I_r$. If $J I_1 \ldots I_{r - 1} \subset I_r$ then
$J \subset I_r$ (by Lemma \ref{lemma-product-ideals-in-prime}) a contradiction.
Pick $y \in J I_1 \ldots I_{r - 1}$, $y \not \in I_r$. Then $x + y$ works.
\end{proof}

\begin{lemma}
\label{lemma-silly-silly}
Let $R$ be a ring. Let $x \in R$, $I \subset R$ an ideal, and
$\mathfrak p_i$, $i = 1, \ldots, r$ be prime ideals.
Suppose that $x + I \not \subset \mathfrak p_i$ for
$i = 1, \ldots, r$. Then there exists a $y \in I$
such that $x + y \not \in \mathfrak p_i$ for all $i$.
\end{lemma}

\begin{proof}
We may assume there are no inclusions among the $\mathfrak p_i$.
After reordering we may assume $x \not \in \mathfrak p_i$ for $i < s$
and $x \in \mathfrak p_i$ for $i \geq s$. If $s = r + 1$ then we are done.
If not, then we can find $y \in I$ with $y \not \in \mathfrak p_s$.
Choose $f \in \bigcap_{i < s} \mathfrak p_i$ with $f \not \in \mathfrak p_s$.
Then $x + fy$ is not contained in $\mathfrak p_1, \ldots, \mathfrak p_s$.
Thus we win by induction on $s$.
\end{proof}

\begin{lemma}[Chinese remainder]
\label{lemma-chinese-remainder}
Let $R$ be a ring.
\begin{enumerate}
\item If $I_1, \ldots, I_r$ are ideals such that $I_a + I_b = R$
when $a \not = b$, then $I_1 \cap \ldots \cap I_r =
I_1I_2\ldots I_r$ and $R/(I_1I_2\ldots I_r)
\cong R/I_1 \times \ldots \times R/I_r$.
\item If $\mathfrak m_1, \ldots, \mathfrak m_r$ are pairwise distinct maximal
ideals then $\mathfrak m_a + \mathfrak m_b = R$ for $a \not = b$ and the
above applies.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us first prove $I_1 \cap \ldots \cap I_r = I_1 \ldots I_r$
as this will also imply the injectivity of the induced ring
homomorphism $R/(I_1 \ldots I_r) \rightarrow R/I_1 \times \ldots \times R/I_r$.
The inclusion $I_1 \cap \ldots \cap I_r \supset I_1 \ldots I_r$ is always
fulfilled since ideals are closed under multiplication with arbitrary ring
elements. To prove the other inclusion, we claim that the ideals
$$
I_1 \ldots \hat I_i \ldots I_r,\quad i = 1, \ldots, r
$$
generate the ring $R$. We prove this by induction on $r$. It holds when
$r = 2$. If $r > 2$, then we see that $R$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_{r - 1}$, $i = 1, \ldots, r - 1$.
Hence $I_r$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_r$, $i = 1, \ldots, r - 1$.
Applying the same argument with the reverse ordering on the ideals
we see that $I_1$ is the sum of the ideals
$I_1 \ldots \hat I_i \ldots I_r$, $i = 2, \ldots, r$.
Since $R = I_1 + I_r$ by assumption we see that $R$ is the sum of the
ideals displayed above. Therefore we can find elements
$a_i \in I_1 \ldots \hat I_i \ldots I_r$
such that their sum is one. Multiplying this equation by an element
of $I_1 \cap \ldots \cap I_r$ gives the other inclusion.
It remains to show that the canonical map
$R/(I_1 \ldots I_r) \rightarrow R/I_1 \times \ldots \times R/I_r$
is surjective. For this, consider its action on the equation
$1 = \sum_{i=1}^r a_i$ we derived above. On the one hand, a
ring morphism sends 1 to 1 and on the other hand, the image of any
$a_i$ is zero in $R/I_j$ for $j \neq i$. Therefore, the image of $a_i$
in $R/I_i$ is the identity. So given any element
$(\bar{b_1}, \ldots, \bar{b_r}) \in R/I_1 \times \ldots \times R/I_r$,
the element $\sum_{i=1}^r a_i \cdot b_i$ is an inverse image in $R$.

\medskip\noindent
To see (2), by the very definition of being distinct maximal ideals, we have
$\mathfrak{m}_a + \mathfrak{m}_b = R$ for $a \neq b$ and so the above applies.
\end{proof}

\begin{lemma}
\label{lemma-matrix-left-inverse}
Let $R$ be a ring. Let $n \geq m$. Let $A$ be an
$n \times m$ matrix with coefficients in $R$. Let $J \subset R$
be the ideal generated by the $m \times m$ minors of $A$.
\begin{enumerate}
\item For any $f \in J$ there exists a $m \times n$ matrix $B$
such that $BA = f 1_{m \times m}$.
\item If $f \in R$ and $BA = f 1_{m \times m}$ for some $m \times n$ matrix
$B$, then $f^m \in J$.
\end{enumerate}
\end{lemma}

\begin{proof}
For $I \subset \{1, \ldots, n\}$ with $|I| = m$, we denote
by $E_I$ the $m \times n$ matrix of the projection
$$
R^{\oplus n} = \bigoplus\nolimits_{i \in \{1, \ldots, n\}} R
\longrightarrow \bigoplus\nolimits_{i \in I} R
$$
and set $A_I = E_I A$, i.e., $A_I$ is the $m \times m$ matrix
whose rows are the rows of $A$ with indices in $I$.
Let $B_I$ be the adjugate (transpose of
cofactor) matrix to $A_I$, i.e., such that
$A_I B_I = B_I A_I = \det(A_I) 1_{m \times m}$.
The $m \times m$ minors of $A$ are the determinants $\det A_I$
for all the $I \subset \{1, \ldots, n\}$ with $|I| = m$.
If $f \in J$ then we can write $f = \sum c_I \det(A_I)$ for some
$c_I \in R$. Set $B = \sum c_I B_I E_I$ to see that (1) holds.

\medskip\noindent
If $f 1_{m \times m} = BA$ then by the
Cauchy-Binet formula (\ref{item-cauchy-binet}) we
have $f^m = \sum b_I \det(A_I)$ where $b_I$ is the determinant
of the $m \times m$ matrix whose columns are the columns of $B$ with
indices in $I$.
\end{proof}

\begin{lemma}
\label{lemma-matrix-right-inverse}
Let $R$ be a ring. Let $n \geq m$. Let $A = (a_{ij})$ be an
$n \times m$ matrix with coefficients in $R$, written in block form
as
$$
A =
\left(
\begin{matrix}
A_1 \\
A_2
\end{matrix}
\right)
$$
where $A_1$ has size $m \times m$. Let $B$ be the adjugate (transpose of
cofactor) matrix to $A_1$. Then
$$
AB = 
\left(
\begin{matrix}
f 1_{m \times m} \\
C
\end{matrix}
\right)
$$
where $f = \det(A_1)$ and $c_{ij}$ is (up to sign) the determinant of the
$m \times m$ minor of $A$ corresponding to the rows
$1, \ldots, \hat j, \ldots, m, i$.
\end{lemma}

\begin{proof}
Since the adjugate has the property $A_1B = B A_1 = f$ the first block
of the expression for $AB$ is correct. Note that
$$
c_{ij} = \sum\nolimits_k a_{ik}b_{kj} = \sum (-1)^{j + k}a_{ik} \det(A_1^{jk})
$$
where $A_1^{ij}$ means $A_1$ with the $j$th row and $k$th column removed.
This last expression is the row expansion of the determinant of the matrix
in the statement of the lemma.
\end{proof}

\begin{lemma}
\label{lemma-map-cannot-be-injective}
\begin{slogan}
A map of finite free modules cannot be injective if the source has
rank bigger than the target.
\end{slogan}
Let $R$ be a nonzero ring. Let $n \geq 1$. Let $M$ be an $R$-module generated
by $< n$ elements. Then any $R$-module map $f : R^{\oplus n} \to M$ has a
nonzero kernel.
\end{lemma}

\begin{proof}
Choose a surjection $R^{\oplus n - 1} \to M$.
We may lift the map $f$ to a map $f' : R^{\oplus n} \to R^{\oplus n - 1}$
(Lemma \ref{lemma-lift-map}).
It suffices to prove $f'$ has a nonzero kernel.
The map $f' : R^{\oplus n} \to R^{\oplus n - 1}$ is given by a
matrix $A = (a_{ij})$. If one of the $a_{ij}$ is not nilpotent, say
$a = a_{ij}$ is not, then we can replace $R$ by the localization $R_a$
and we may assume $a_{ij}$ is a unit. Since if we find a nonzero kernel
after localization then there was a nonzero kernel to start with as
localization is exact, see Proposition \ref{proposition-localization-exact}.
In this case we can do a base change on both $R^{\oplus n}$
and $R^{\oplus n - 1}$ and reduce to the case where
$$
A =
\left(
\begin{matrix}
1 & 0 & 0 & \ldots \\
0 & a_{22} & a_{23} & \ldots \\
0 & a_{32} & \ldots \\
\ldots & \ldots
\end{matrix}
\right)
$$
Hence in this case we win by induction on $n$. If not then each
$a_{ij}$ is nilpotent. Set $I = (a_{ij}) \subset R$. Note that
$I^{m + 1} = 0$ for some $m \geq 0$. Let $m$ be the largest integer
such that $I^m \not = 0$. Then we see that $(I^m)^{\oplus n}$ is
contained in the kernel of the map and we win.
\end{proof}

\begin{lemma}
\label{lemma-rank}
\begin{slogan}
The rank of a finite free module is well defined.
\end{slogan}
Let $R$ be a nonzero ring. Let $n, m \geq 0$ be integers.
If $R^{\oplus n}$ is isomorphic to $R^{\oplus m}$ as
$R$-modules, then $n = m$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-map-cannot-be-injective}.
\end{proof}





\section{Cayley-Hamilton}
\label{section-cayley-hamilton}

\begin{lemma}
\label{lemma-charpoly}
Let $R$ be a ring. Let $A = (a_{ij})$ be an $n \times n$
matrix with coefficients in $R$. Let $P(x) \in R[x]$
be the characteristic polynomial of $A$ (defined
as $\det(x\text{id}_{n \times n} - A)$).
Then $P(A) = 0$ in $\text{Mat}(n \times n, R)$.
\end{lemma}

\begin{proof}
We reduce the question to the well-known Cayley-Hamilton
theorem from linear algebra in several steps:
\begin{enumerate}
\item If $\phi :S \rightarrow R$ is a ring morphism and $b_{ij}$
are inverse images of the $a_{ij}$ under this map, then it suffices
to show the statement for $S$ and $(b_{ij})$ since $\phi$ is a ring morphism.
\item If $\psi :R \hookrightarrow S$ is an injective ring morphism, it
clearly suffices to show the result for $S$ and the $a_{ij}$ considered as
elements of $S$. 
\item Thus we may first reduce to the case $R = \mathbf{Z}[X_{ij}]$,
$a_{ij} = X_{ij}$ of a polynomial ring and then further to
the case $R = \mathbf{Q}(X_{ij})$ where we may finally apply Cayley-Hamilton.
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lemma-charpoly-module}
Let $R$ be a ring.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be an endomorphism.
Then there exists a monic polynomial $P \in R[T]$ such that
$P(\varphi) = 0$ as an endomorphism of $M$.
\end{lemma}

\begin{proof}
Choose a surjective $R$-module map $R^{\oplus n} \to M$, given by
$(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in M$.
Choose $(a_{i1}, \ldots, a_{in}) \in R^{\oplus n}$ such that
$\varphi(x_i) = \sum a_{ij} x_j$. In other words the diagram
$$
\xymatrix{
R^{\oplus n} \ar[d]_A \ar[r] & M \ar[d]^\varphi \\
R^{\oplus n} \ar[r] & M
}
$$
is commutative where $A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
there exists a monic polynomial $P$ such that $P(A) = 0$.
Then it follows that $P(\varphi) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-charpoly-module-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be an endomorphism such
that $\varphi(M) \subset IM$.
Then there exists a monic polynomial
$P = t^n + a_1 t^{n - 1} + \ldots + a_n \in R[T]$
such that $a_j \in I^j$ and $P(\varphi) = 0$ as an endomorphism of $M$.
\end{lemma}

\begin{proof}
Choose a surjective $R$-module map $R^{\oplus n} \to M$, given by
$(a_1, \ldots, a_n) \mapsto \sum a_ix_i$ for some generators $x_i \in M$.
Choose $(a_{i1}, \ldots, a_{in}) \in I^{\oplus n}$ such that
$\varphi(x_i) = \sum a_{ij} x_j$. In other words the diagram
$$
\xymatrix{
R^{\oplus n} \ar[d]_A \ar[r] & M \ar[d]^\varphi \\
I^{\oplus n} \ar[r] & M
}
$$
is commutative where $A = (a_{ij})$. By
Lemma \ref{lemma-charpoly}
the polynomial
$P(t) = \det(t\text{id}_{n \times n} - A)$
has all the desired properties.
\end{proof}

\noindent
As a fun example application we prove the following surprising lemma.

\begin{lemma}
\label{lemma-fun}
Let $R$ be a ring.
Let $M$ be a finite $R$-module.
Let $\varphi : M \to M$ be a surjective $R$-module map.
Then $\varphi$ is an isomorphism.
\end{lemma}

\begin{proof}[First proof]
Write $R' = R[x]$ and think of $M$ as a finite $R'$-module with
$x$ acting via $\varphi$. Set $I = (x) \subset R'$. By our assumption that
$\varphi$ is surjective we have $IM = M$. Hence we may apply
Lemma \ref{lemma-charpoly-module-ideal}
to $M$ as an $R'$-module, the ideal $I$ and the endomorphism $\text{id}_M$.
We conclude that
$(1 + a_1 + \ldots + a_n)\text{id}_M = 0$ with $a_j \in I$.
Write $a_j = b_j(x)x$ for some $b_j(x) \in R[x]$.
Translating back into $\varphi$ we see that
$\text{id}_M = -(\sum_{j = 1, \ldots, n} b_j(\varphi)) \varphi$, and hence
$\varphi$ is invertible.
\end{proof}

\begin{proof}[Second proof]
We perform induction on the number of generators of $M$ over $R$. If
$M$ is generated by one element, then $M \cong R/I$ for some ideal
$I \subset R$. In this case we may replace $R$ by $R/I$ so that $M = R$.
In this case $\varphi : R \to R$ is given by multiplication on $M$ by an
element $r \in R$. The surjectivity of $\varphi$ forces $r$ invertible,
since $\varphi$ must hit $1$, which implies that $\varphi$ is
invertible.

\medskip\noindent
Now assume that we have proven the lemma in the case of modules
generated by $n - 1$ elements, and are examining a module $M$ generated
by $n$ elements. Let $A$ mean the ring $R[t]$, and regard the module
$M$ as an $A$-module by letting $t$ act via $\varphi$; since $M$ is
finite over $R$, it is finite over $R[t]$ as well, and since we're
trying to prove $\varphi$ injective, a set-theoretic property, we might
as well prove the endomorphism $t : M \to M$ over $A$ injective. We have
reduced our problem to the case our endomorphism is multiplication by
an element of the ground ring. Let $M' \subset M$ denote the
sub-$A$-module generated by the first $n - 1$ of the generators of $M$,
and consider the diagram
$$
\xymatrix{
0 \ar[r] & M' \ar[r]\ar[d]^{\varphi\mid_{M'}} & M\ar[d]^\varphi \ar[r] &
M/M' \ar[d]^{\varphi \bmod M'} \ar[r] & 0 \\
0 \ar[r] & M' \ar[r]                                  & M \ar[r]
           & M/M' \ar[r]                                  & 0,
}
$$
where the restriction of $\varphi$ to $M'$ and the map induced by $\varphi$
on the quotient $M/M'$ are well-defined since $\varphi$ is multiplication
by an element in the base, and $M'$ and $M/M'$ are $A$-modules in
their own right. By the case $n = 1$ the map $M/M' \to M/M'$ is an
isomorphism. A diagram chase implies that $\varphi|_{M'}$ is surjective
hence by induction $\varphi|_{M'}$ is an isomorphism. This forces the
middle column to be an isomorphism by the snake lemma.
\end{proof}













\section{The spectrum of a ring}
\label{section-spectrum-ring}

\noindent
We arbitrarily decide that the spectrum of a ring as a topological space
is part of the algebra chapter, whereas an affine scheme is part of the
chapter on schemes.

\begin{definition}
\label{definition-spectrum-ring}
Let $R$ be a ring.
\begin{enumerate}
\item The {\it spectrum} of $R$ is the set of prime ideals of $R$.
It is usually denoted $\Spec(R)$.
\item Given a subset $T \subset R$ we let $V(T) \subset \Spec(R)$
be the set of primes containing $T$, i.e., $V(T) = \{ \mathfrak p \in
\Spec(R) \mid \forall f\in T, f\in \mathfrak p\}$.
\item Given an element $f \in R$ we let $D(f) \subset \Spec(R)$
be the set of primes not containing $f$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-Zariski-topology}
Let $R$ be a ring.
\begin{enumerate}
\item The spectrum of a ring $R$ is empty if and only if $R$
is the zero ring.
\item Every nonzero ring has a maximal ideal.
\item Every nonzero ring has a minimal prime ideal.
\item Given an ideal $I \subset R$ and a prime ideal
$I \subset \mathfrak p$ there exists a prime
$I \subset \mathfrak q \subset \mathfrak p$ such
that $\mathfrak q$ is minimal over $I$.
\item If $T \subset R$, and if $(T)$ is the ideal generated by
$T$ in $R$, then $V((T)) = V(T)$.
\item If $I$ is an ideal and $\sqrt{I}$ is its radical,
see basic notion (\ref{item-radical-ideal}), then $V(I) = V(\sqrt{I})$.
\item Given an ideal $I$ of $R$ we have $\sqrt{I} =
\bigcap_{I \subset \mathfrak p} \mathfrak p$.
\item If $I$ is an ideal then $V(I) = \emptyset$ if and only
if $I$ is the unit ideal.
\item If $I$, $J$ are ideals of $R$ then $V(I) \cup V(J) =
V(I \cap J)$.
\item If $(I_a)_{a\in A}$ is a set of ideals of $R$ then
$\bigcap_{a\in A} V(I_a) = V(\bigcup_{a\in A} I_a)$.
\item If $f \in R$, then $D(f) \amalg V(f) = \Spec(R)$.
\item If $f \in R$ then $D(f) = \emptyset$ if and only if $f$
is nilpotent.
\item If $f = u f'$ for some unit $u \in R$, then $D(f) = D(f')$.
\item If $I \subset R$ is an ideal, and $\mathfrak p$ is a prime of
$R$ with $\mathfrak p \not\in V(I)$, then there exists an $f \in R$
such that $\mathfrak p \in D(f)$, and $D(f) \cap V(I) = \emptyset$.
\item If $f, g \in R$, then $D(fg) = D(f) \cap D(g)$.
\item If $f_i \in R$ for $i \in I$, then
$\bigcup_{i\in I} D(f_i)$ is the complement of $V(\{f_i \}_{i\in I})$
in $\Spec(R)$.
\item If $f \in R$ and $D(f) = \Spec(R)$, then $f$ is a unit.
\end{enumerate}
\end{lemma}

\begin{proof}
We address each part in the corresponding item below.
\begin{enumerate}
\item This is a direct consequence of (2) or (3).
\item Let $\mathfrak{A}$ be the set of all proper ideals of $R$. This set is
ordered by inclusion and is non-empty, since $(0) \in \mathfrak{A}$ is a proper
ideal. Let $A$ be a totally ordered subset of $\mathfrak A$.
Then $\bigcup_{I \in A} I$ is in
fact an ideal. Since 1 $\notin I$ for all $I \in A$, the union does not contain
1 and thus is proper. Hence $\bigcup_{I \in A} I$ is in $\mathfrak{A}$ and is
an upper bound for the set $A$. Thus by Zorn's lemma $\mathfrak{A}$ has a
maximal element, which is the sought-after maximal ideal.
\item Since $R$ is nonzero, it contains a maximal ideal which is a prime ideal.
Thus the set $\mathfrak{A}$ of all prime ideals of $R$ is nonempty.
$\mathfrak{A}$ is ordered by reverse-inclusion. Let $A$ be a totally ordered
subset of $\mathfrak{A}$. It's pretty clear that $J = \bigcap_{I \in A} I$ is
in fact an ideal. Not so clear, however, is that it is prime. Let $xy \in J$.
Then $xy \in I$ for all $I \in A$. Now let $B = \{I \in A | y \in I\}$. Let $K
= \bigcap_{I \in B} I$. Since $A$ is totally ordered, either $K = J$ (and we're
done, since then $y \in J$) or $K \supset J$ and for all $I \in A$ such that
$I$ is properly contained in $K$, we have $y \notin I$. But that means that for
all those $I, x \in I$, since they are prime. Hence $x \in J$. In either case,
$J$ is prime as desired. Hence by Zorn's lemma we get a maximal element which
in this case is a minimal prime ideal.
\item This is the same exact argument as (3) except you only consider prime
ideals contained in $\mathfrak{p}$ and containing $I$.
\item $(T)$ is the smallest ideal containing $T$. Hence if $T \subset I$, some
ideal, then $(T) \subset I$ as well. Hence if $I \in V(T)$, then $I \in V((T))$
as well. The other inclusion is obvious.
\item Since $I \subset \sqrt{I}, V(\sqrt{I}) \subset V(I)$. Now let
$\mathfrak{p} \in V(I)$. Let $x \in \sqrt{I}$. Then $x^n \in I$ for some $n$.
Hence $x^n \in \mathfrak{p}$. But since $\mathfrak{p}$ is prime, a boring
induction argument gets you that $x \in \mathfrak{p}$. Hence $\sqrt{I} \subset
\mathfrak{p}$ and $\mathfrak{p} \in V(\sqrt{I})$.
\item Let $f \in R \setminus \sqrt{I}$. Then $f^n \notin I$ for all $n$. Hence
$S = \{1, f, f^2, \ldots\}$ is a multiplicative subset, not containing $0$.
Take a
prime ideal $\bar{\mathfrak{p}} \subset S^{-1}R$ containing $S^{-1}I$. Then the
pull-back $\mathfrak{p}$ in $R$ of $\bar{\mathfrak{p}}$ is a prime ideal
containing $I$ that does not intersect $S$. This shows that $\bigcap_{I \subset
\mathfrak p} \mathfrak p \subset \sqrt{I}$. Now if $a \in \sqrt{I}$, then $a^n
\in I$ for some $n$. Hence if $I \subset \mathfrak{p}$, then $a^n \in
\mathfrak{p}$. But since $\mathfrak{p}$ is prime, we have $a \in \mathfrak{p}$.
Thus the equality is shown.
\item $I$ is not the unit ideal if and only if $I$
is contained in some maximal ideal (to
see this, apply (2) to the ring $R/I$) which is therefore prime.
\item If $\mathfrak{p} \in V(I) \cup V(J)$, then $I \subset \mathfrak{p}$ or $J
\subset \mathfrak{p}$ which means that $I \cap J \subset \mathfrak{p}$. Now if
$I \cap J \subset \mathfrak{p}$, then $IJ \subset \mathfrak{p}$ and hence
either $I$ of $J$ is in $\mathfrak{p}$, since $\mathfrak{p}$ is prime.
\item $\mathfrak{p} \in \bigcap_{a \in A} V(I_a) \Leftrightarrow
I_a \subset \mathfrak{p}, \forall a \in A \Leftrightarrow
\mathfrak{p} \in V(\bigcup_{a\in A} I_a)$
\item If $\mathfrak{p}$ is a prime ideal and $f \in R$, then either $f \in
\mathfrak{p}$ or $f \notin \mathfrak{p}$ (strictly) which is what the disjoint
union says.
\item If $a \in R$ is nilpotent, then $a^n = 0$ for some $n$. Hence $a^n \in
\mathfrak{p}$ for any prime ideal. Thus $a \in \mathfrak{p}$ as can be shown by
induction and $D(a) = \emptyset$. Now, as shown in (7), if $a \in R$ is not
nilpotent, then there is a prime ideal that does not contain it.
\item $f \in \mathfrak{p} \Leftrightarrow uf \in \mathfrak{p}$, since $u$ is
invertible.
\item If $\mathfrak{p} \notin V(I)$, then $\exists f \in I \setminus
\mathfrak{p}$. Then $f \notin \mathfrak{p}$ so $\mathfrak{p} \in D(f)$. Also if
$\mathfrak{q} \in D(f)$, then $f \notin \mathfrak{q}$ and thus $I$ is not
contained in $\mathfrak{q}$. Thus $D(f) \cap V(I) = \emptyset$.
\item If $fg \in \mathfrak{p}$, then $f \in \mathfrak{p}$ or $g \in
\mathfrak{p}$. Hence if $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$,
then $fg \notin \mathfrak{p}$. Since $\mathfrak{p}$ is an ideal, if $fg \notin
\mathfrak{p}$, then $f \notin \mathfrak{p}$ and $g \notin \mathfrak{p}$.
\item $\mathfrak{p} \in \bigcup_{i \in I} D(f_i) \Leftrightarrow \exists i \in
I, f_i \notin \mathfrak{p} \Leftrightarrow \mathfrak{p} \in \Spec(R)
\setminus V(\{f_i\}_{i \in I})$
\item If $D(f) = \Spec(R)$, then $V(f) = \emptyset$ and
hence $fR = R$, so $f$ is a unit.
\end{enumerate}
\end{proof}

\noindent
The lemma implies that the subsets $V(T)$ from
Definition \ref{definition-spectrum-ring} form the closed
subsets of a topology on $\Spec(R)$. And it also shows that
the sets $D(f)$ are open and form a basis for this
topology.

\begin{definition}
\label{definition-Zariski-topology}
Let $R$ be a ring.
The topology on $\Spec(R)$ whose closed sets are the
sets $V(T)$ is called the {\it Zariski} topology. The open
subsets $D(f)$ are called the {\it standard opens} of $\Spec(R)$.
\end{definition}

\noindent
It should be clear from context whether we consider $\Spec(R)$
just as a set or as a topological space.

\begin{lemma}
\label{lemma-spec-functorial}
\begin{slogan}
Functoriality of the spectrum
\end{slogan}
Suppose that $\varphi : R \to R'$ is a ring homomorphism.
The induced map
$$
\Spec(\varphi) : \Spec(R') \longrightarrow \Spec(R),
\quad
\mathfrak p' \longmapsto \varphi^{-1}(\mathfrak p')
$$
is continuous for the Zariski topologies. In fact, for any
element $f \in R$ we have
$\Spec(\varphi)^{-1}(D(f)) = D(\varphi(f))$.
\end{lemma}

\begin{proof}
It is basic notion (\ref{item-inverse-image-prime}) that
$\mathfrak p := \varphi^{-1}(\mathfrak p')$
is indeed a prime ideal of $R$. The last assertion
of the lemma follows directly from the definitions,
and implies the first.
\end{proof}

\noindent
If $\varphi' : R' \to R''$ is a second ring homomorphism
then the composition
$$
\Spec(R'')
\longrightarrow
\Spec(R')
\longrightarrow
\Spec(R)
$$
equals $\Spec(\varphi' \circ \varphi)$. In other
words, $\Spec$ is a contravariant functor from the
category of rings to the category of topological spaces.

\begin{lemma}
\label{lemma-spec-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
The map $R \to S^{-1}R$ induces via the functoriality of $\Spec$
a homeomorphism
$$
\Spec(S^{-1}R)
\longrightarrow
\{\mathfrak p \in \Spec(R) \mid S \cap \mathfrak p = \emptyset \}
$$
where the topology on the right hand side is that induced from the
Zariski topology on $\Spec(R)$. The inverse map is given
by $\mathfrak p \mapsto S^{-1}\mathfrak p = \mathfrak p(S^{-1}R)$.
\end{lemma}

\begin{proof}
Denote the right hand side of the arrow of the lemma by $D$.
Choose a prime $\mathfrak p' \subset S^{-1}R$ and let $\mathfrak p$
the inverse image of $\mathfrak p'$ in $R$. Since $\mathfrak p'$
does not contain $1$ we see that $\mathfrak p$ does not contain
any element of $S$. Hence $\mathfrak p \in D$ and we see that
the image is contained in $D$. Let $\mathfrak p \in D$.
By assumption the image $\overline{S}$ does not contain $0$.
By basic notion (\ref{item-localization-zero})
$\overline{S}^{-1}(R/\mathfrak p)$ is not the zero ring.
By basic notion (\ref{item-localize-ideal}) we see
$S^{-1}R / S^{-1}\mathfrak p = \overline{S}^{-1}(R/\mathfrak p)$
is a domain, and hence $S^{-1}\mathfrak p$ is a prime.
The equality of rings also shows that the inverse image of
$S^{-1}\mathfrak p$ in $R$ is equal to $\mathfrak p$,
because $R/\mathfrak p \to \overline{S}^{-1}(R/\mathfrak p)$
is injective by basic notion (\ref{item-localize-nonzerodivisors}).
This proves that the map $\Spec(S^{-1}R) \to \Spec(R)$
is bijective onto $D$ with inverse as given.
It is continuous by Lemma \ref{lemma-spec-functorial}.
Finally, let $D(g) \subset \Spec(S^{-1}R)$ be a standard
open. Write $g = h/s$ for some $h\in R$ and $s\in S$.
Since $g$ and $h/1$ differ by a unit we have $D(g) =
D(h/1)$ in $\Spec(S^{-1}R)$.
Hence by Lemma \ref{lemma-spec-functorial} and the bijectivity
above the image of $D(g) = D(h/1)$ is $D \cap D(h)$.
This proves the map is open as well.
\end{proof}

\begin{lemma}
\label{lemma-standard-open}
Let $R$ be a ring. Let $f \in R$.
The map $R \to R_f$ induces via the functoriality of
$\Spec$ a homeomorphism
$$
\Spec(R_f) \longrightarrow D(f) \subset \Spec(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p \cdot R_f$.
\end{lemma}

\begin{proof}
This is a special case of Lemma \ref{lemma-spec-localization}.
\end{proof}

\noindent
It is not the case that every ``affine open'' of a
spectrum is a standard open. See
Example \ref{example-affine-open-not-standard}.

\begin{lemma}
\label{lemma-spec-closed}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
The map $R \to R/I$ induces via the functoriality of
$\Spec$ a homeomorphism
$$
\Spec(R/I) \longrightarrow V(I) \subset \Spec(R).
$$
The inverse is given by $\mathfrak p \mapsto \mathfrak p / I$.
\end{lemma}

\begin{proof}
It is immediate that the image is contained in $V(I)$.
On the other hand, if $\mathfrak p \in V(I)$
then $\mathfrak p \supset I$ and we may consider
the ideal $\mathfrak p /I \subset R/I$. Using
basic notion (\ref{item-isomorphism-theorem}) we see that
$(R/I)/(\mathfrak p/I) = R/\mathfrak p$ is a domain
and hence $\mathfrak p/I$ is a prime ideal. From this
it is immediately clear that the image of $D(f + I)$
is $D(f) \cap V(I)$, and hence the map is a homeomorphism.
\end{proof}



\begin{lemma}
\label{lemma-quasi-compact}
\begin{slogan}
The spectrum of a ring is quasi-compact
\end{slogan}
Let $R$ be a ring. The space $\Spec(R)$ is quasi-compact.
\end{lemma}

\begin{proof}
It suffices to prove that any covering of $\Spec(R)$
by standard opens can be refined by a finite covering.
Thus suppose that $\Spec(R) = \cup D(f_i)$
for a set of elements $\{f_i\}_{i\in I}$ of $R$. This means that
$\cap V(f_i) = \emptyset$. According to Lemma
\ref{lemma-Zariski-topology} this means that
$V(\{f_i \}) = \emptyset$. According to the
same lemma this means that the ideal generated
by the $f_i$ is the unit ideal of $R$. This means
that we can write $1$ as a {\it finite} sum:
$1 = \sum_{i \in J} r_i f_i$ with $J \subset I$ finite.
And then it follows that $\Spec(R)
= \cup_{i \in J} D(f_i)$.
\end{proof}

\begin{lemma}
\label{lemma-topology-spec}
Let $R$ be a ring.
The topology on $X = \Spec(R)$ has the following properties:
\begin{enumerate}
\item $X$ is quasi-compact,
\item $X$ has a basis for the topology consisting of quasi-compact opens, and
\item the intersection of any two quasi-compact opens is quasi-compact.
\end{enumerate}
\end{lemma}

\begin{proof}
The spectrum of a ring is quasi-compact, see
Lemma \ref{lemma-quasi-compact}.
It has a basis for the topology consisting of the standard opens
$D(f) = \Spec(R_f)$
(Lemma \ref{lemma-standard-open})
which are quasi-compact by the first remark.
The intersection of two standard opens is quasi-compact
as $D(f) \cap D(g) = D(fg)$. Given any two quasi-compact opens
$U, V \subset X$ we may write $U = D(f_1) \cup \ldots \cup D(f_n)$
and $V = D(g_1) \cup \ldots \cup D(g_m)$. Then
$U \cap V = \bigcup D(f_ig_j)$ which is quasi-compact.
\end{proof}






\section{Local rings}
\label{section-local-rings}

\noindent
Local rings are the bread and butter of algebraic geometry.

\begin{definition}
\label{definition-local-ring}
A {\it local ring} is a ring with exactly one maximal ideal.
If $R$ is a local ring, then the maximal ideal is often denoted
$\mathfrak m_R$ and the field $R/\mathfrak m_R$ is called the
{\it residue field} of the local ring $R$.
We often say ``let $(R, \mathfrak m)$ be a local ring''
or ``let $(R, \mathfrak m, \kappa)$ be a local ring''
to indicate that $R$ is local, $\mathfrak m$ is its unique
maximal ideal and $\kappa = R/\mathfrak m$ is its residue field.
A {\it local homomorphism of local rings} is a ring map
$\varphi : R \to S$ such that $R$ and $S$ are local rings and such
that $\varphi(\mathfrak m_R) \subset \mathfrak m_S$.
If it is given that $R$ and $S$ are local rings, then the phrase
``{\it local ring map $\varphi : R \to S$}'' means that $\varphi$
is a local homomorphism of local rings.
\end{definition}

\noindent
A field is a local ring. Any ring map between fields is a local
homomorphism of local rings.

\medskip\noindent
The localization $R_\mathfrak p$ of a ring $R$ at a prime $\mathfrak p$
is a local ring with maximal ideal $\mathfrak p R_\mathfrak p$. Namely, by
Lemma \ref{lemma-spec-localization} every prime ideal of $R_\mathfrak p$
is contained in the prime ideal $\mathfrak p R_\mathfrak p$
(hence this is a maximal ideal and the only maximal ideal of $R_\mathfrak p$).
The residue field of $R_\mathfrak p$ is denoted $\kappa(\mathfrak p)$;
we call it the {\it residue field of $\mathfrak p$}; by
Proposition \ref{proposition-localize-quotient} we may identify
$\kappa(\mathfrak p)$ with the field of fractions of the domain $R/\mathfrak p$.
Via the composition
$$
\Spec(\kappa(\mathfrak p)) \to \Spec(R_\mathfrak p) \to \Spec(R)
$$
the unique point of the source maps to the point $\mathfrak p$ of the target.

\medskip\noindent
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak q \subset S$ be a prime
and consider the prime $\mathfrak p = \varphi^{-1}(\mathfrak q)$ of $R$.
Since $\varphi(\mathfrak p) \subset \mathfrak q$ the induced ring map
$$
R_\mathfrak p \to S_\mathfrak q,\quad r/g \mapsto \varphi(r)/\varphi(g)
$$
is a local ring map and we obtain an induced map of residue fields
$\kappa(\mathfrak p) \to \kappa(\mathfrak q)$.


\begin{example}
\label{example-not-local}
If $R$ is a local ring and $\mathfrak p \subset R$ is a non-maximal
prime ideal, then $R \to R_\mathfrak p$ is not a local homomorphism.
\end{example}

\begin{lemma}
\label{lemma-characterize-local-ring}
Let $R$ be a ring. The following are equivalent:
\begin{enumerate}
\item $R$ is a local ring,
\item $\Spec(R)$ has exactly one closed point,
\item $R$ has a maximal ideal $\mathfrak m$
and every element of $R \setminus \mathfrak m$
is a unit, and
\item $R$ is not the zero ring and for every $x \in R$ either $x$
or $1 - x$ is invertible or both.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $R$ be a ring, and $\mathfrak m$ a maximal ideal.
If $x \in R \setminus \mathfrak m$, and $x$ is not a unit
then there is a maximal ideal $\mathfrak m'$ containing $x$.
Hence $R$ has at least two maximal ideals. Conversely,
if $\mathfrak m'$ is another maximal ideal, then choose
$x \in \mathfrak m'$, $x \not \in \mathfrak m$. Clearly
$x$ is not a unit. This proves the equivalence of (1) and (3).
The equivalence (1) and (2) is tautological.
If $R$ is local then (4) holds since $x$ is either in $\mathfrak m$
or not. If (4) holds, and $\mathfrak m$, $\mathfrak m'$ are distinct
maximal ideals then we may choose $x \in R$ such that
$x \bmod \mathfrak m' = 0$ and $x \bmod \mathfrak m = 1$
by the Chinese remainder theorem
(Lemma \ref{lemma-chinese-remainder}).
This element $x$ is not invertible and neither is $1 - x$ which is
a contradiction. Thus (4) and (1) are equivalent.
\end{proof}

\begin{lemma}
\label{lemma-characterize-local-ring-map}
Let $\varphi : R \to S$ be a ring map. Assume $R$ and $S$ are local rings.
The following are equivalent:
\begin{enumerate}
\item $\varphi$ is a local ring map,
\item $\varphi(\mathfrak m_R) \subset \mathfrak m_S$, and
\item $\varphi^{-1}(\mathfrak m_S) = \mathfrak m_R$.
\item For any $x \in R$, if $\varphi(x)$ is invertible in $S$, then $x$
is invertible in $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Conditions (1) and (2) are equivalent by definition.
If (3) holds then (2) holds. Conversely, if (2) holds, then
$\varphi^{-1}(\mathfrak m_S)$ is a prime ideal containing
the maximal ideal $\mathfrak m_R$, hence
$\varphi^{-1}(\mathfrak m_S) = \mathfrak m_R$. Finally, (4) is the
contrapositive of (2) by Lemma \ref{lemma-characterize-local-ring}.
\end{proof}

\begin{remark}
\label{remark-fundamental-diagram}
A fundamental commutative diagram associated to a ring map
$\varphi : R \to S$ and a prime $\mathfrak p \subset R$ is the following
$$
\xymatrix{
\kappa(\mathfrak p) \otimes_R S =
S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p}
&
S_{\mathfrak p} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak pS \ar[r]
&
(R \setminus \mathfrak p)^{-1}S/\mathfrak pS
\\
\kappa(\mathfrak p) =
R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) \ar[u]
}
$$
In this diagram the outer left and outer right columns are identical.
On spectra the horizontal maps induce homeomorphisms
onto their images and the squares induce fibre squares of topological spaces
(see Lemmas \ref{lemma-spec-localization} and \ref{lemma-spec-closed}).
This shows that $\mathfrak p$ is in the image of the map on Spec if and
only if $S \otimes_R \kappa(\mathfrak p)$ is not the zero ring.
If there does exist a prime $\mathfrak q \subset S$ lying over
$\mathfrak p$, i.e., with $\mathfrak p = \varphi^{-1}(\mathfrak q)$
then we can extend the diagram to the following diagram
$$
\xymatrix{
\kappa(\mathfrak q) = S_{\mathfrak q}/{\mathfrak q}S_{\mathfrak q}
&
S_{\mathfrak q} \ar[l]
&
S \ar[r] \ar[l]
&
S/\mathfrak q \ar[r]
&
\kappa(\mathfrak q)
\\
\kappa(\mathfrak p) \otimes_R S =
S_{\mathfrak p}/{\mathfrak p}S_{\mathfrak p} \ar[u]
&
S_{\mathfrak p} \ar[u] \ar[l]
&
S \ar[u] \ar[r] \ar[l]
&
S/\mathfrak pS \ar[u] \ar[r]
&
(R \setminus \mathfrak p)^{-1}S/\mathfrak pS \ar[u]
\\
\kappa(\mathfrak p) =
R_{\mathfrak p}/{\mathfrak p}R_{\mathfrak p} \ar[u]
&
R_{\mathfrak p} \ar[u] \ar[l]
&
R \ar[u] \ar[r] \ar[l]
&
R/\mathfrak p \ar[u] \ar[r]
&
\kappa(\mathfrak p) \ar[u]
}
$$
In this diagram it is still the case that the outer left and outer right
columns are identical and that on spectra the horizontal maps induce
homeomorphisms onto their image.
\end{remark}

\begin{lemma}
\label{lemma-in-image}
Let $\varphi : R \to S$ be a ring map. Let $\mathfrak p$
be a prime of $R$. The following are equivalent
\begin{enumerate}
\item $\mathfrak p$ is in the image of
$\Spec(S) \to \Spec(R)$,
\item $S \otimes_R \kappa(\mathfrak p) \not = 0$,
\item $S_{\mathfrak p}/\mathfrak p S_{\mathfrak p} \not = 0$,
\item $(S/\mathfrak pS)_{\mathfrak p} \not = 0$, and
\item $\mathfrak p = \varphi^{-1}(\mathfrak pS)$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have already seen the equivalence of the first two
in Remark \ref{remark-fundamental-diagram}. The others
are just reformulations of this.
\end{proof}










\section{The Jacobson radical of a ring}
\label{section-radical}

\noindent
We recall that the {\it Jacobson radical} $\text{rad}(R)$ of a ring $R$
is the intersection of all maximal ideals of $R$. If $R$ is local
then $\text{rad}(R)$ is the maximal ideal of $R$.

\begin{lemma}
\label{lemma-contained-in-radical}
Let $R$ be a ring with Jacobson radical $\text{rad}(R)$.
Let $I \subset R$ be an ideal. The following are
equivalent
\begin{enumerate}
\item $I \subset \text{rad}(R)$, and
\item every element of $1 + I$ is a unit in $R$.
\end{enumerate}
In this case every element of $R$ which maps to a unit of $R/I$ is a unit.
\end{lemma}

\begin{proof}
If $f \in \text{rad}(R)$, then $f \in \mathfrak m$ for all
maximal ideals $\mathfrak m$ of $R$. Hence $1 + f \not \in \mathfrak m$
for all maximal ideals $\mathfrak m$ of $R$. Thus the closed
subset $V(1 + f)$ of $\Spec(R)$ is empty. This implies
that $1 + f$ is a unit, see Lemma \ref{lemma-Zariski-topology}.

\medskip\noindent
Conversely, assume that $1 + f$ is a unit for all $f \in I$.
If $\mathfrak m$ is a maximal ideal and $I \not \subset \mathfrak m$,
then $I + \mathfrak m = R$. Hence $1 = f + g$ for some $g \in \mathfrak m$
and $f \in I$. Then $g = 1 + (-f)$ is not a unit, contradiction.

\medskip\noindent
For the final statement let $f \in R$ map to a unit in $R/I$.
Then we can find $g \in R$ mapping to the multiplicative inverse
of $f \bmod I$. Then $fg = 1 \bmod I$. Hence $fg$ is a unit of $R$
by (2) which implies that $f$ is a unit.
\end{proof}

\begin{lemma}
\label{lemma-surjective-on-spec-units}
Let $\varphi : R \to S$ be a ring map such that the induced map
$\Spec(S) \to \Spec(R)$ is surjective. Then an element $x \in R$
is a unit if and only if $\varphi(x) \in S$ is a unit.
\end{lemma}

\begin{proof}
If $x$ is a unit, then so is $\varphi(x)$. Conversely, if $\varphi(x)$
is a unit, then $\varphi(x) \not \in \mathfrak q$ for all
$\mathfrak q \in \Spec(S)$. Hence
$x \not \in \varphi^{-1}(\mathfrak q) = \Spec(\varphi)(\mathfrak q)$
for all $\mathfrak q \in \Spec(S)$. Since $\Spec(\varphi)$ is surjective
we conclude that $x$ is a unit by
part (17) of Lemma \ref{lemma-Zariski-topology}.
\end{proof}




\section{Nakayama's lemma}
\label{section-nakayama}

\noindent
We quote from \cite{MatCA}: ``This simple but
important lemma is due to T.~Nakayama, G.~Azumaya and W.~Krull. Priority
is obscure, and although it is usually called the Lemma of Nakayama, late
Prof.~Nakayama did not like the name.''

\begin{lemma}[Nakayama's lemma]
\label{lemma-NAK}
\begin{reference}
\cite[1.M Lemma (NAK) page 11]{MatCA}
\end{reference}
\begin{history}
We quote from \cite{MatCA}: ``This simple but
important lemma is due to T.~Nakayama, G.~Azumaya and W.~Krull. Priority
is obscure, and although it is usually called the Lemma of Nakayama, late
Prof.~Nakayama did not like the name.''
\end{history}
Let $R$ be a ring with Jacobson radical $\text{rad}(R)$.
Let $M$ be an $R$-module. Let $I \subset R$
be an ideal.
\begin{enumerate}
\item
\label{item-nakayama}
If $IM = M$ and $M$ is finite, then there exists an $f \in 1 + I$ such that
$fM = 0$.
\item If $IM = M$, $M$ is finite, and $I \subset \text{rad}(R)$, then $M = 0$.
\item If $N, N' \subset M$, $M = N + IN'$, and $N'$ is finite,
then there exists an $f \in 1 + I$ such that $fM \subset N$ and $M_f = N_f$.
\item If $N, N' \subset M$, $M = N + IN'$, $N'$ is finite, and
$I \subset \text{rad}(R)$, then $M = N$.
\item If $N \to M$ is a module map, $N/IN \to M/IM$ is
surjective, and $M$ is finite, then there exists an $f \in 1 + I$
such that $N_f \to M_f$ is surjective.
\item If $N \to M$ is a module map, $N/IN \to M/IM$ is
surjective, $M$ is finite, and $I \subset \text{rad}(R)$,
then $N \to M$ is surjective.
\item If $x_1, \ldots, x_n \in M$ generate $M/IM$ and $M$ is finite,
then there exists an $f \in 1 + I$ such that $x_1, \ldots, x_n$
generate $M_f$ over $R_f$.
\item If $x_1, \ldots, x_n \in M$ generate $M/IM$, $M$ is finite, and
$I \subset \text{rad}(R)$, then $M$ is generated by $x_1, \ldots, x_n$.
\item If $IM = M$, $I$ is nilpotent, then $M = 0$.
\item If $N, N' \subset M$, $M = N + IN'$, and $I$ is nilpotent then $M = N$.
\item If $N \to M$ is a module map, $I$ is nilpotent, and $N/IN \to M/IM$
is surjective, then $N \to M$ is surjective.
\item If $\{x_\alpha\}_{\alpha \in A}$ is a set of elements of $M$
which generate $M/IM$ and $I$ is nilpotent, then $M$ is generated
by the $x_\alpha$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (\ref{item-nakayama}). Choose generators $y_1, \ldots, y_m$ of $M$
over $R$. For each $i$ we can write $y_i = \sum z_{ij} y_j$ with
$z_{ij} \in I$ (since $M = IM$).
In other words $\sum_j (\delta_{ij} - z_{ij})y_j = 0$.
Let $f$ be the determinant of the $m \times m$ matrix
$A = (\delta_{ij} - z_{ij})$. Note that $f \in 1 + I$
(since the matrix $A$ is entrywise congruent to the
$m \times m$ identity matrix modulo $I$).
By Lemma \ref{lemma-matrix-left-inverse} (1),
there exists an $m \times m$
matrix $B$ such that $BA = f 1_{m \times m}$. Writing out we see that
$\sum_{i} b_{hi} a_{ij} = f \delta_{hj}$ for all
$h$ and $j$; hence, $\sum_{i, j} b_{hi} a_{ij} y_j
= \sum_{j} f \delta_{hj} y_j = f y_h$ for every $h$.
In other words, $0 = f y_h$ for every $h$ (since each
$i$ satisfies $\sum_j a_{ij} y_j = 0$).
This implies that $f$ annihilates $M$.

\medskip\noindent
By Lemma \ref{lemma-contained-in-radical} an element of $1 + \text{rad}(R)$ is
invertible element of $R$. Hence we see that (\ref{item-nakayama}) implies
(2). We obtain (3) by applying (1) to $M/N$ which is finite as $N'$ is finite.
We obtain (4) by applying (2) to $M/N$ which is finite as $N'$ is finite.
We obtain (5) by applying (3) to $M$ and the submodules $\Im(N \to M)$
and $M$. We obtain (6) by applying (4) to $M$ and the submodules
$\Im(N \to M)$ and $M$.
We obtain (7) by applying (5) to the map $R^{\oplus n} \to M$,
$(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$.
We obtain (8) by applying (6) to the map $R^{\oplus n} \to M$,
$(a_1, \ldots, a_n) \mapsto a_1x_1 + \ldots + a_nx_n$.

\medskip\noindent
Part (9) holds because if $M = IM$ then $M = I^nM$ for all $n \geq 0$
and $I$ being nilpotent means $I^n = 0$ for some $n \gg 0$. Parts
(10), (11), and (12) follow from (9) by the arguments used above.
\end{proof}

\begin{lemma}
\label{lemma-NAK-localization}
Let $R$ be a ring, let $S \subset R$ be a multiplicative subset,
let $I \subset R$ be an ideal, and let $M$ be a finite $R$-module.
If $x_1, \ldots, x_r \in M$ generate $S^{-1}(M/IM)$
as an $S^{-1}(R/I)$-module, then there exists an $f \in S + I$
such that $x_1, \ldots, x_r$ generate $M_f$ as an
$R_f$-module.\footnote{Special cases: (I) $I = 0$. The lemma says
if $x_1, \ldots, x_r$ generate $S^{-1}M$, then $x_1, \ldots, x_r$
generate $M_f$ for some $f \in S$. (II) $I = \mathfrak p$ is
a prime ideal and $S = R \setminus \mathfrak p$. The lemma says if
$x_1, \ldots, x_r$ generate $M \otimes_R \kappa(\mathfrak p)$
then $x_1, \ldots, x_r$ generate $M_f$ for some
$f \in R$, $f \not \in \mathfrak p$.}
\end{lemma}

\begin{proof}
Special case $I = 0$. Let $y_1, \ldots, y_s$ be generators for $M$ over $R$.
Since $S^{-1}M$ is generated by $x_1, \ldots, x_r$, for each $i$
we can write $y_i = \sum (a_{ij}/s_{ij})x_j$ for some $a_{ij} \in R$
and $s_{ij} \in S$. Let $s \in S$ be the product
of all of the $s_{ij}$. Then we see that $y_i$ is contained in the
$R_s$-submodule of $M_s$ generated by $x_1, \ldots, x_r$.
Hence $x_1, \ldots, x_r$ generates $M_s$.

\medskip\noindent
General case. By the special case, we can find an $s \in S$
such that $x_1, \ldots, x_r$ generate $(M/IM)_s$ over $(R/I)_s$.
By Lemma \ref{lemma-NAK} we can find a $g \in 1 + I_s \subset R_s$
such that $x_1, \ldots, x_r$ generate $(M_s)_g$ over $(R_s)_g$.
Write $g = 1 + i/s'$. Then $f = ss' + is$ works; details omitted.
\end{proof}

\begin{lemma}
\label{lemma-when-surjective-local}
Let $A \to B$ be a local homomorphism of local rings.
Assume
\begin{enumerate}
\item $B$ is finite as an $A$-module,
\item $\mathfrak m_B$ is a finitely generated ideal,
\item $A \to B$ induces an isomorphism on residue fields, and
\item $\mathfrak m_A/\mathfrak m_A^2 \to \mathfrak m_B/\mathfrak m_B^2$
is surjective.
\end{enumerate}
Then $A \to B$ is surjective.
\end{lemma}

\begin{proof}
To show that $A \to B$ is surjective, we view it as a map of $A$-modules
and apply Lemma \ref{lemma-NAK} (6). We conclude it suffices
to show that $A/\mathfrak m_A \to B/\mathfrak m_AB$ is surjective.
As $A/\mathfrak m_A = B/\mathfrak m_B$ it suffices to show that
$\mathfrak m_AB \to \mathfrak m_B$ is surjective. View
$\mathfrak m_AB \to \mathfrak m_B$ as a map of $B$-modules and apply
Lemma \ref{lemma-NAK} (6). We conclude it suffices to see that
$\mathfrak m_AB/\mathfrak m_A\mathfrak m_B \to \mathfrak m_B/\mathfrak m_B^2$
is surjective. This follows from assumption (4).
\end{proof}







\section{Open and closed subsets of spectra}
\label{section-open-and-closed}

\noindent
It turns out that open and closed subsets of a spectrum correspond to
idempotents of the ring.

\begin{lemma}
\label{lemma-idempotent-spec}
Let $R$ be a ring. Let $e \in R$ be an idempotent.
In this case
$$
\Spec(R) = D(e) \amalg D(1-e).
$$
\end{lemma}

\begin{proof}
Note that an idempotent $e$ of a domain is either $1$ or $0$.
Hence we see that
\begin{eqnarray*}
D(e)
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not = 0\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e = 1\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Similarly we have
\begin{eqnarray*}
D(1-e)
& = &
\{ \mathfrak p \in \Spec(R)
\mid
1 - e \not\in \mathfrak p \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e \not = 1\text{ in }\kappa(\mathfrak p) \} \\
& = &
\{ \mathfrak p \in \Spec(R)
\mid
e = 0\text{ in }\kappa(\mathfrak p) \}
\end{eqnarray*}
Since the image of $e$ in any residue field is either $1$ or $0$
we deduce that $D(e)$ and $D(1-e)$ cover all of $\Spec(R)$.
\end{proof}

\begin{lemma}
\label{lemma-spec-product}
Let $R_1$ and $R_2$ be rings.
Let $R = R_1 \times R_2$.
The maps $R \to R_1$, $(x, y) \mapsto x$ and $R \to R_2$,
$(x, y) \mapsto y$
induce continuous maps $\Spec(R_1) \to \Spec(R)$ and
$\Spec(R_2) \to \Spec(R)$.
The induced map
$$
\Spec(R_1) \amalg \Spec(R_2)
\longrightarrow
\Spec(R)
$$
is a homeomorphism. In other words,
the spectrum of $R = R_1\times R_2$ is the
disjoint union of the spectrum of $R_1$ and the
spectrum of $R_2$.
\end{lemma}

\begin{proof}
Write $1 = e_1 + e_2$ with $e_1 = (1, 0)$ and $e_2 = (0, 1)$.
Note that $e_1$ and $e_2 = 1 - e_1$ are idempotents.
We leave it to the reader to show that
$R_1 = R_{e_1}$ is the localization of $R$ at $e_1$.
Similarly for $e_2$.
Thus the statement of the lemma follows from Lemma
\ref{lemma-idempotent-spec} combined with Lemma
\ref{lemma-standard-open}.
\end{proof}

\noindent
We reprove the following lemma later after introducing
a glueing lemma for functions. See Section
\ref{section-tilde-module-sheaf}.

\begin{lemma}
\label{lemma-disjoint-decomposition}
Let $R$ be a ring. For each $U \subset \Spec(R)$
which is open and closed
there exists a unique idempotent $e \in R$ such that
$U = D(e)$. This induces a 1-1 correspondence between
open and closed subsets $U \subset \Spec(R)$ and
idempotents $e \in R$.
\end{lemma}

\begin{proof}
Let $U \subset \Spec(R)$ be open and closed.
Since $U$ is closed it is quasi-compact by
Lemma \ref{lemma-quasi-compact}, and similarly for
its complement.
Write $U = \bigcup_{i = 1}^n D(f_i)$ as a finite union of standard opens.
Similarly, write $\Spec(R) \setminus U = \bigcup_{j = 1}^m D(g_j)$
as a finite union of standard opens. Since $\emptyset =
D(f_i) \cap D(g_j) = D(f_i g_j)$ we see that $f_i g_j$ is
nilpotent by Lemma \ref{lemma-Zariski-topology}.
Let $I = (f_1, \ldots, f_n) \subset R$ and let
$J = (g_1, \ldots, g_m) \subset R$.
Note that $V(J)$ equals $U$, that $V(I)$
equals the complement of $U$, so $\Spec(R) = V(I) \amalg V(J)$.
By the remark on nilpotency above,
we see that $(IJ)^N = (0)$ for some sufficiently large integer $N$.
Since $\bigcup D(f_i) \cup \bigcup D(g_j) = \Spec(R)$
we see that $I + J = R$, see Lemma \ref{lemma-Zariski-topology}.
By raising this equation to the $2N$th power we conclude that
$I^N + J^N = R$. Write $1 = x + y$ with $x \in I^N$ and $y \in J^N$.
Then $0 = xy = x(1 - x)$ as $I^N J^N = (0)$. Thus $x = x^2$
is idempotent and contained
in $I^N \subset I$. The idempotent $y = 1 - x$ is contained in $J^N \subset J$. 
This shows that the idempotent $x$ maps to $1$ in every residue field
$\kappa(\mathfrak p)$ for $\mathfrak p \in V(J)$ and that $x$ maps to $0$
in $\kappa(\mathfrak p)$ for every $\mathfrak p \in V(I)$.

\medskip\noindent
To see uniqueness suppose that $e_1, e_2$ are
distinct idempotents in $R$. We have to show there
exists a prime $\mathfrak p$ such that $e_1 \in \mathfrak p$
and $e_2 \not \in \mathfrak p$, or conversely.
Write $e_i' = 1 - e_i$. If $e_1 \not = e_2$, then
$0 \not = e_1 - e_2  = e_1(e_2 + e_2') - (e_1 + e_1')e_2
= e_1 e_2' - e_1' e_2$. Hence either the idempotent
$e_1 e_2' \not = 0$ or $e_1' e_2 \not = 0$. An idempotent
is not nilpotent, and hence we find a prime
$\mathfrak p$ such that either $e_1e_2' \not \in \mathfrak p$
or $e_1'e_2 \not \in \mathfrak p$, by Lemma \ref{lemma-Zariski-topology}.
It is easy to see this gives the desired prime.
\end{proof}

\begin{lemma}
\label{lemma-characterize-spec-connected}
Let $R$ be a nonzero ring. Then $\Spec(R)$ is
connected if and only if $R$ has no nontrivial
idempotents.
\end{lemma}

\begin{proof}
Obvious from Lemma \ref{lemma-disjoint-decomposition}
and the definition of a connected topological space.
\end{proof}

\begin{lemma}
\label{lemma-ideal-is-squared-union-connected}
Let $I \subset R$ be a finitely generated ideal of a ring $R$
such that $I = I^2$. Then
\begin{enumerate}
\item there exists an idempotent $e \in R$ such that $I = (e)$,
\item $R/I \cong R_{e'}$ for the idempotent $e' = 1 - e \in R$, and
\item $V(I)$ is open and closed in $\Spec(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Nakayama's Lemma \ref{lemma-NAK} there exists an element
$f = 1 + i$, $i \in I$ such that $fI = 0$. Then $f^2 = f + fi = f$
is an idempotent. Consider the idempotent $e = 1 - f = -i \in I$.
For $j \in I$ we have $ej = j - fj = j$ hence $I = (e)$.
This proves (1).

\medskip\noindent
Parts (2) and (3) follow from (1). Namely, we have
$V(I) = V(e) = \Spec(R) \setminus D(e)$ which is open and
closed by either Lemma \ref{lemma-idempotent-spec} or
Lemma \ref{lemma-disjoint-decomposition}. This proves (3).
For (2) observe that the map $R \to R_{e'}$ is surjective
since $x/(e')^n = x/e' = xe'/(e')^2 = xe'/e' = x/1$ in $R_{e'}$.
The kernel of the map $R \to R_{e'}$ is the set of elements of
$R$ annihilated by a positive power of $e'$. Since $e'$ is
idempotent this is the ideal of elements annihilated by $e'$
which is the ideal $I = (e)$ as $e + e' = 1$ is a pair
of orthogonal idempotents. This proves (2).
\end{proof}






\section{Connected components of spectra}
\label{section-connected-components}

\noindent
Connected components of spectra are not as easy to understand as one
may think at first. This is because we are used to the topology of
locally connected spaces, but the spectrum of a ring is in general
not locally connected.

\begin{lemma}
\label{lemma-closed-union-connected-components}
Let $R$ be a ring. Let $T \subset \Spec(R)$ be a subset of the spectrum.
The following are equivalent
\begin{enumerate}
\item $T$ is closed and is a union of connected components of
$\Spec(R)$,
\item $T$ is an intersection of open and closed subsets of
$\Spec(R)$, and
\item $T = V(I)$ where $I \subset R$ is an ideal generated by idempotents.
\end{enumerate}
Moreover, the ideal in (3) if it exists is unique.
\end{lemma}

\begin{proof}
By
Lemma \ref{lemma-topology-spec}
and
Topology, Lemma \ref{topology-lemma-closed-union-connected-components}
we see that (1) and (2) are equivalent.
Assume (2) and write $T = \bigcap U_\alpha$ with
$U_\alpha \subset \Spec(R)$ open and closed.
Then $U_\alpha = D(e_\alpha)$ for some idempotent $e_\alpha \in R$ by
Lemma \ref{lemma-disjoint-decomposition}.
Then setting $I = (1 - e_\alpha)$ we see that $T = V(I)$, i.e., (3) holds.
Finally, assume (3). Write $T = V(I)$ and $I = (e_\alpha)$ for some
collection of idempotents $e_\alpha$. Then it is clear that
$T = \bigcap V(e_\alpha) = \bigcap D(1 - e_\alpha)$.

\medskip\noindent
Suppose that $I$ is an ideal generated by idempotents.
Let $e \in R$ be an idempotent such that $V(I) \subset V(e)$. Then by
Lemma \ref{lemma-Zariski-topology}
we see that $e^n \in I$ for some $n \geq 1$. As $e$ is an idempotent
this means that $e \in I$. Hence we see that $I$ is generated by
exactly those idempotents $e$ such that $T \subset V(e)$.
In other words, the ideal $I$ is completely determined by the
closed subset $T$ which proves uniqueness.
\end{proof}

\begin{lemma}
\label{lemma-connected-component}
Let $R$ be a ring.
A connected component of
$\Spec(R)$ is of the form $V(I)$,
where $I$ is an ideal generated by idempotents
such that every idempotent of $R$ either maps to
$0$ or $1$ in $R/I$.
\end{lemma}

\begin{proof}
Let $\mathfrak p$ be a prime of $R$. By
Lemma \ref{lemma-topology-spec}
we have see that the hypotheses of
Topology, Lemma \ref{topology-lemma-connected-component-intersection}
are satisfied for the topological space $\Spec(R)$.
Hence the connected component of $\mathfrak p$ in $\Spec(R)$
is the intersection of open and closed subsets of $\Spec(R)$
containing $\mathfrak p$. Hence it equals $V(I)$ where
$I$ is generated by the idempotents $e \in R$ such that $e$ maps to $0$
in $\kappa(\mathfrak p)$, see
Lemma \ref{lemma-disjoint-decomposition}.
Any idempotent $e$ which is not in this collection clearly maps to $1$
in $R/I$.
\end{proof}









\section{Glueing properties}
\label{section-more-glueing}

\noindent
In this section we put a number of standard results of the
form: if something is true for all members of a standard open
covering then it is true. In fact, it often suffices to check
things on the level of local rings as in the following lemma.

\begin{lemma}
\label{lemma-characterize-zero-local}
Let $R$ be a ring.
\begin{enumerate}
\item For an element $x$ of an $R$-module $M$ the following are equivalent
\begin{enumerate}
\item $x = 0$,
\item $x$ maps to zero in $M_\mathfrak p$ for all $\mathfrak p \in \Spec(R)$,
\item $x$ maps to zero in $M_{\mathfrak m}$ for all maximal ideals
$\mathfrak m$ of $R$.
\end{enumerate}
In other words, the map $M \to \prod_{\mathfrak m} M_{\mathfrak m}$
is injective.
\item Given an $R$-module $M$ the following are equivalent
\begin{enumerate}
\item $M$ is zero,
\item $M_{\mathfrak p}$ is zero for all $\mathfrak p \in \Spec(R)$,
\item $M_{\mathfrak m}$ is zero for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a complex $M_1 \to M_2 \to M_3$
of $R$-modules the following are equivalent
\begin{enumerate}
\item $M_1 \to M_2 \to M_3$ is exact,
\item for every prime $\mathfrak p$ of $R$ the localization
$M_{1, \mathfrak p} \to M_{2, \mathfrak p} \to M_{3, \mathfrak p}$
is exact,
\item for every maximal ideal $\mathfrak m$ of $R$ the localization
$M_{1, \mathfrak m} \to M_{2, \mathfrak m} \to M_{3, \mathfrak m}$
is exact.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is injective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is injective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is injective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is surjective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is surjective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is surjective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\item Given a map $f : M \to M'$ of $R$-modules the following are equivalent
\begin{enumerate}
\item $f$ is bijective,
\item $f_{\mathfrak p} : M_\mathfrak p \to M'_\mathfrak p$ is bijective
for all primes $\mathfrak p$ of $R$,
\item $f_{\mathfrak m} : M_\mathfrak m \to M'_\mathfrak m$ is bijective
for all maximal ideals $\mathfrak m$ of $R$.
\end{enumerate}
\end{enumerate}
\end{lemma}

\begin{proof}
Let $x \in M$ as in (1). Let $I = \{f \in R \mid fx = 0\}$.
It is easy to see that $I$ is an ideal (it is the
annihilator of $x$). Condition (1)(c) means that for
all maximal ideals $\mathfrak m$ there exists an
$f \in R \setminus \mathfrak m$ such that $fx =0$.
In other words, $V(I)$ does not contain a closed point.
By Lemma \ref{lemma-Zariski-topology} we see $I$ is the unit ideal.
Hence $x$ is zero, i.e., (1)(a) holds. This proves (1).

\medskip\noindent
Part (2) follows by applying (1) to all elements of $M$ simultaneously.

\medskip\noindent
Proof of (3). Let $H$ be the homology of the sequence, i.e.,
$H = \Ker(M_2 \to M_3)/\Im(M_1 \to M_2)$. By
Proposition \ref{proposition-localization-exact}
we have that $H_\mathfrak p$ is the homology of the sequence
$M_{1, \mathfrak p} \to M_{2, \mathfrak p} \to M_{3, \mathfrak p}$.
Hence (3) is a consequence of (2).

\medskip\noindent
Parts (4) and (5) are special cases of (3). Part (6) follows
formally on combining (4) and (5).
\end{proof}

\begin{lemma}
\label{lemma-cover}
\begin{slogan}
Zariski-local properties of modules and algebras
\end{slogan}
Let $R$ be a ring. Let $M$ be an $R$-module. Let $S$ be an $R$-algebra.
Suppose that $f_1, \ldots, f_n$ is a finite list of
elements of $R$ such that $\bigcup D(f_i) = \Spec(R)$,
in other words $(f_1, \ldots, f_n) = R$.
\begin{enumerate}
\item If each $M_{f_i} = 0$ then $M = 0$.
\item If each $M_{f_i}$ is a finite $R_{f_i}$-module,
then $M$ is a finite $R$-module.
\item If each $M_{f_i}$ is a finitely presented $R_{f_i}$-module,
then $M$ is a finitely presented $R$-module.
\item Let $M \to N$ be a map of $R$-modules. If $M_{f_i} \to N_{f_i}$
is an isomorphism for each $i$ then $M \to N$ is an isomorphism.
\item Let $0 \to M'' \to M \to M' \to 0$ be a complex of $R$-modules.
If $0 \to M''_{f_i} \to M_{f_i} \to M'_{f_i} \to 0$ is exact for each $i$,
then $0 \to M'' \to M \to M' \to 0$ is exact.
\item If each $R_{f_i}$ is Noetherian, then $R$ is Noetherian.
\item If each $S_{f_i}$ is a finite type $R$-algebra, so is $S$.
\item If each $S_{f_i}$ is of finite presentation over $R$, so is $S$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove each of the parts in turn.
\begin{enumerate}
\item By Proposition \ref{proposition-localize-twice}
this implies $M_\mathfrak p = 0$ for all $\mathfrak p \in \Spec(R)$,
so we conclude by Lemma \ref{lemma-characterize-zero-local}.
\item For each $i$ take a finite generating set $X_i$ of $M_{f_i}$.
Without loss of generality, we may assume that the elements of $X_i$ are
in the image of the localization map $M \rightarrow M_{f_i}$, so we take
a finite set $Y_i$ of preimages of the elements of $X_i$ in $M$. Let $Y$
be the union of these sets. This is still a finite set.
Consider the obvious $R$-linear map $R^Y \rightarrow M$ sending the basis
element $e_y$ to $y$. By assumption this map is surjective after localizing
at an arbitrary prime ideal $\mathfrak p$ of $R$, so it is surjective by
Lemma \ref{lemma-characterize-zero-local}
and $M$ is finitely generated.
\item By (2) we have a short exact sequence
$$
0 \rightarrow K \rightarrow R^n \rightarrow M \rightarrow 0
$$
Since localization is an exact functor and $M_{f_i}$ is finitely
presented we see that $K_{f_i}$ is finitely generated for all
$1 \leq i \leq n$ by Lemma \ref{lemma-extension}.
By (2) this implies that $K$ is a finite $R$-module and therefore
$M$ is finitely presented.
\item By Proposition \ref{proposition-localize-twice}
the assumption implies that the induced morphism
on localizations at all prime ideals is an isomorphism, so we conclude
by Lemma \ref{lemma-characterize-zero-local}.
\item By Proposition \ref{proposition-localize-twice} the assumption
implies that the induced
sequence of localizations at all prime ideals is short exact, so we
conclude by Lemma \ref{lemma-characterize-zero-local}.
\item We will show that every ideal of $R$ has a finite generating set:
For this, let $I \subset R$ be an arbitrary ideal. By
Proposition \ref{proposition-localization-exact}
each $I_{f_i} \subset R_{f_i}$ is an ideal. These are all
finitely generated by assumption, so we conclude by (2).
\item For each $i$ take a finite generating set $X_i$ of $S_{f_i}$.
Without loss of generality, we may assume that the elements of $X_i$
are in the image of the localization map $S \rightarrow S_{f_i}$, so
we take a finite set $Y_i$ of preimages of the elements of $X_i$ in
$S$. Let $Y$ be the union of these sets. This is still a finite set.
Consider the algebra homomorphism $R[X_y]_{y \in Y} \rightarrow S$
induced by $Y$. Since it is an algebra homomorphism, the image $T$
is an $R$-submodule of the $R$-module $S$, so we can consider the
quotient module $S/T$. By assumption, this is zero if we localize
at the $f_i$, so it is zero by (1) and therefore $S$ is an
$R$-algebra of finite type.
\item By the previous item, there exists a surjective $R$-algebra
homomorphism $R[X_1, \ldots, X_n] \rightarrow S$. Let $K$ be the kernel
of this map. This is an ideal in $R[X_1, \ldots, X_n]$, finitely generated
in each localization at $f_i$. Since the $f_i$ generate the unit ideal
in $R$, they also generate the unit ideal in $R[X_1, \ldots, X_n]$, so an
application of (2) finishes the proof.
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lemma-cover-upstairs}
Let $R \to S$ be a ring map.
Suppose that $g_1, \ldots, g_n$ is a finite list of
elements of $S$ such that $\bigcup D(g_i) = \Spec(S)$
in other words $(g_1, \ldots, g_n) = S$.
\begin{enumerate}
\item If each $S_{g_i}$ is of finite type over $R$, then $S$ is
of finite type over $R$.
\item If each $S_{g_i}$ is of finite presentation over $R$,
then $S$ is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $h_1, \ldots, h_n \in S$ such that $\sum h_i g_i = 1$.

\medskip\noindent
Proof of (1). For each $i$ choose a finite list of elements
$x_{i, j} \in S_{g_i}$, $j = 1, \ldots, m_i$
which generate $S_{g_i}$ as an $R$-algebra.
Write $x_{i, j} = y_{i, j}/g_i^{n_{i, j}}$ for some $y_{i, j} \in S$ and
some $n_{i, j} \ge 0$. Consider the $R$-subalgebra $S' \subset S$
generated by $g_1, \ldots, g_n$, $h_1, \ldots, h_n$ and
$y_{i, j}$, $i = 1, \ldots, n$, $j = 1, \ldots, m_i$.
Since localization is exact (Proposition \ref{proposition-localization-exact}),
we see that $S'_{g_i} \to S_{g_i}$ is injective.
On the other hand, it is surjective by our choice of $y_{i, j}$.
The elements $g_1, \ldots, g_n$ generate the unit ideal in $S'$
as $h_1, \ldots, h_n \in S'$.
Thus $S' \to S$ viewed as an $S'$-module map is an isomorphism
by Lemma \ref{lemma-cover}.

\medskip\noindent
Proof of (2). We already know that $S$ is of finite type.
Write $S = R[x_1, \ldots, x_m]/J$ for some ideal $J$.
For each $i$ choose a lift $g'_i \in R[x_1, \ldots, x_m]$ of $g_i$
and we choose a lift $h'_i \in R[x_1, \ldots, x_m]$ of $h_i$.
Then we see that
$$
S_{g_i} = R[x_1, \ldots, x_m, y_i]/(J_i + (1 - y_ig'_i))
$$
where $J_i$ is the ideal of $R[x_1, \ldots, x_m, y_i]$
generated by $J$. Small detail omitted. By
Lemma \ref{lemma-finite-presentation-independent}
we may choose a finite list of elements
$f_{i, j} \in J$, $j = 1, \ldots, m_i$
such that the images of $f_{i, j}$ in $J_i$ and $1 - y_ig'_i$
generate the ideal $J_i + (1 - y_ig'_i)$.
Set
$$
S' = R[x_1, \ldots, x_m]/\left(\sum h'_ig'_i - 1, f_{i, j}; 
i = 1, \ldots, n, j = 1, \ldots, m_i\right)
$$
There is a surjective $R$-algebra map $S' \to S$.
The classes of the elements $g'_1, \ldots, g'_n$ in $S'$
generate the unit ideal and by construction the maps
$S'_{g'_i} \to S_{g_i}$ are injective.
Thus we conclude as in part (1).
\end{proof}





\section{Glueing functions}
\label{section-tilde-module-sheaf}

\noindent
In this section we show that given an open covering
$$
\Spec(R) = \bigcup\nolimits_{i = 1}^n D(f_i)
$$
by standard opens, and given an element $h_i \in R_{f_i}$
for each $i$ such that $h_i = h_j$ as elements of $R_{f_i f_j}$
then there exists a unique $h \in R$ such that the image of
$h$ in $R_{f_i}$ is $h_i$. This result can be interpreted
in two ways:
\begin{enumerate}
\item The rule $D(f) \mapsto R_f$ is a sheaf of rings
on the standard opens, see Sheaves, Section \ref{sheaves-section-bases}.
\item If we think of elements of $R_f$ as the ``algebraic''
or ``regular'' functions on $D(f)$, then these glue
as would continuous, resp.\ differentiable functions
on a topological, resp.\ differentiable manifold.
\end{enumerate}

\begin{lemma}
\label{lemma-cover-module}
Let $R$ be a ring. Let $f_1, \ldots, f_n$ be elements of $R$
generating the unit ideal. Let $M$ be an $R$-module.
The sequence
$$
0 \to
M \xrightarrow{\alpha}
\bigoplus\nolimits_{i = 1}^n M_{f_i} \xrightarrow{\beta}
\bigoplus\nolimits_{i, j = 1}^n M_{f_i f_j}
$$
is exact, where $\alpha(m) = (m/1, \ldots, m/1)$
and $\beta(m_1/f_1^{e_1}, \ldots, m_n/f_n^{e_n})
= (m_i/f_i^{e_i} - m_j/f_j^{e_j})_{(i, j)}$.
\end{lemma}

\begin{proof}
It suffices to show that the localization of the sequence at
any maximal ideal $\mathfrak m$ is exact, see
Lemma \ref{lemma-characterize-zero-local}.
Since $f_1, \ldots, f_n$ generate the unit ideal,
there is an $i$ such that $f_i \not \in \mathfrak m$.
After renumbering we may assume $i = 1$.
Note that $(M_{f_i})_\mathfrak m = (M_\mathfrak m)_{f_i}$
and $(M_{f_if_j})_\mathfrak m = (M_\mathfrak m)_{f_if_j}$, see
Proposition \ref{proposition-localize-twice-module}.
In particular $(M_{f_1})_\mathfrak m = M_\mathfrak m$ and
$(M_{f_1 f_i})_\mathfrak m = (M_\mathfrak m)_{f_i}$, because
$f_1$ is a unit.
Note that the maps in the sequence are the canonical ones
coming from
Lemma \ref{lemma-universal-property-localization-module}
and the identity map on $M$.
Having said all of this, after replacing $R$ by $R_\mathfrak m$,
$M$ by $M_\mathfrak m$, and $f_i$ by their image in $R_\mathfrak m$,
and $f_1$ by $1 \in R_\mathfrak m$,
we reduce to the case where $f_1 = 1$.

\medskip\noindent
Assume $f_1 = 1$. Injectivity of $\alpha$ is now trivial. Let
$m = (m_i) \in \bigoplus_{i = 1}^n M_{f_i}$ be in the kernel of $\beta$.
Then $m_1 \in M_{f_1} = M$. Moreover, $\beta(m) = 0$
implies that $m_1$ and $m_i$ map to the same element of
$M_{f_1f_i} = M_{f_i}$. Thus $\alpha(m_1) = m$ and the
proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-standard-covering}
Let $R$ be a ring, and let $f_1, f_2, \ldots f_n\in R$ generate
the unit ideal in $R$.
Then the following sequence is exact:
$$
0 \longrightarrow
R \longrightarrow
\bigoplus\nolimits_i R_{f_i} \longrightarrow
\bigoplus\nolimits_{i, j}R_{f_if_j}
$$
where the maps $\alpha : R \longrightarrow \bigoplus_i R_{f_i}$
and $\beta : \bigoplus_i R_{f_i} \longrightarrow \bigoplus_{i, j} R_{f_if_j}$
are defined as
$$
\alpha(x) = \left(\frac{x}{1}, \ldots, \frac{x}{1}\right)
\text{ and }
\beta\left(\frac{x_1}{f_1^{r_1}}, \ldots, \frac{x_n}{f_n^{r_n}}\right)
=
\left(\frac{x_i}{f_i^{r_i}}-\frac{x_j}{f_j^{r_j}}~\text{in}~R_{f_if_j}\right).
$$
\end{lemma}

\begin{proof}
Special case of Lemma \ref{lemma-cover-module}.
\end{proof}

\noindent
The following we have already seen above, but we state it explicitly here
for convenience.

\begin{lemma}
\label{lemma-disjoint-implies-product}
Let $R$ be a ring.
If $\Spec(R) = U \amalg V$ with both $U$ and $V$ open
then $R \cong R_1 \times R_2$ with $U \cong \Spec(R_1)$
and $V \cong \Spec(R_2)$ via the maps in Lemma \ref{lemma-spec-product}.
Moreover, both $R_1$ and $R_2$ are localizations as well as quotients
of the ring $R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-disjoint-decomposition} we have
$U = D(e)$ and $V = D(1-e)$ for some idempotent $e$.
By Lemma \ref{lemma-standard-covering} we see that
$R \cong R_e \times R_{1 - e}$ (since clearly $R_{e(1-e)} = 0$
so the glueing condition is trivial; of course it is
trivial to prove the product decomposition directly in this
case). The lemma follows.
\end{proof}

\begin{lemma}
\label{lemma-when-injective-covering}
Let $R$ be a ring.
Let $f_1, \ldots, f_n \in R$.
Let $M$ be an $R$-module.
Then $M \to \bigoplus M_{f_i}$ is injective if and only if
$$
M \longrightarrow \bigoplus\nolimits_{i = 1, \ldots, n} M, \quad
m \longmapsto (f_1m, \ldots, f_nm)
$$
is injective.
\end{lemma}

\begin{proof}
The map $M \to \bigoplus M_{f_i}$ is injective if and only if
for all $m \in M$ and $e_1, \ldots, e_n \geq 1$ such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$ we have $m = 0$.
This clearly implies the displayed map is injective.
Conversely, suppose the displayed map is injective and
$m \in M$ and $e_1, \ldots, e_n \geq 1$ are such that
$f_i^{e_i}m = 0$, $i = 1, \ldots, n$. If $e_i = 1$ for all $i$,
then we immediately conclude that $m = 0$ from the injectivity of
the displayed map. Next, we prove this holds for any such data
by induction on $e = \sum e_i$. The base case is $e = n$, and we have
just dealt with this. If some $e_i > 1$, then set $m' = f_im$.
By induction we see that $m' = 0$. Hence we see that $f_i m = 0$,
i.e., we may take $e_i = 1$ which decreases $e$ and we win.
\end{proof}

\noindent
The following lemma is better stated and proved in the more general
context of flat descent. However, it makes sense to state it here
since it fits well with the above.

\begin{lemma}
\label{lemma-glue-modules}
Let $R$ be a ring. Let $f_1, \ldots, f_n \in R$. Suppose we are given
the following data:
\begin{enumerate}
\item For each $i$ an $R_{f_i}$-module $M_i$.
\item For each pair $i, j$ an $R_{f_if_j}$-module isomorphism
$\psi_{ij} : (M_i)_{f_j} \to (M_j)_{f_i}$.
\end{enumerate}
which satisfy the ``cocycle condition'' that all the diagrams
$$
\xymatrix{
(M_i)_{f_jf_k}
\ar[rd]_{\psi_{ij}}
\ar[rr]^{\psi_{ik}}
& &
(M_k)_{f_if_j} \\
&
(M_j)_{f_if_k} \ar[ru]_{\psi_{jk}}
}
$$
commute (for all triples $i, j, k$). Given this data define
$$
M = \Ker\left(
\bigoplus\nolimits_{1 \leq i \leq n} M_i
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n} (M_i)_{f_j}
\right)
$$
where $(m_1, \ldots, m_n)$ maps to the element whose
$(i, j)$th entry is $m_i/1 - \psi_{ji}(m_j/1)$.
Then the natural map $M \to M_i$ induces an isomorphism
$M_{f_i} \to M_i$. Moreover $\psi_{ij}(m/1) = m/1$
for all $m \in M$ (with obvious notation).
\end{lemma}

\begin{proof}
To show that $M_{f_1} \to M_1$ is an isomorphism, it suffices
to show that its localization at every prime $\mathfrak p'$
of $R_{f_1}$ is an isomorphism, see
Lemma \ref{lemma-characterize-zero-local}.
Write $\mathfrak p' = \mathfrak p R_{f_1}$
for some prime $\mathfrak p \subset R$, $f_1 \not \in \mathfrak p$, see
Lemma \ref{lemma-standard-open}.
Since localization is exact
(Proposition \ref{proposition-localization-exact}),
we see that
\begin{align*}
(M_{f_1})_{\mathfrak p'} & =
M_\mathfrak p \\
& =
\Ker\left(
\bigoplus\nolimits_{1 \leq i \leq n} M_{i, \mathfrak p}
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n} ((M_i)_{f_j})_\mathfrak p
\right) \\
& =
\Ker\left(
\bigoplus\nolimits_{1 \leq i \leq n} M_{i, \mathfrak p}
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n} (M_{i, \mathfrak p})_{f_j}
\right)
\end{align*}
Here we also used Proposition \ref{proposition-localize-twice-module}.
Since $f_1$ is a unit in $R_\mathfrak p$, this reduces us to the case
where $f_1 = 1$ by replacing $R$ by $R_\mathfrak p$, $f_i$ by the
image of $f_i$ in $R_\mathfrak p$, $M$ by $M_\mathfrak p$, and
$f_1$ by $1$.

\medskip\noindent
Assume $f_1 = 1$. Then $\psi_{1j} : (M_1)_{f_j} \to M_j$
is an isomorphism for $j = 2, \ldots, n$. If we use these
isomorphisms to identify $M_j = (M_1)_{f_j}$, then we see
that $\psi_{ij} : (M_1)_{f_if_j} \to (M_1)_{f_if_j}$ is
the canonical identification. Thus the complex
$$
0 \to M_1 \to
\bigoplus\nolimits_{1 \leq i \leq n} (M_1)_{f_i}
\longrightarrow
\bigoplus\nolimits_{1 \leq i, j \leq n}
(M_1)_{f_if_j}
$$
is exact by Lemma \ref{lemma-cover-module}.
Thus the first map identifies $M_1$ with $M$ in this case
and everything is clear.
\end{proof}












\section{Zerodivisors and total rings of fractions}
\label{section-total-quotient-ring}

\noindent
The local ring at a minimal prime has the following properties.

\begin{lemma}
\label{lemma-minimal-prime-reduced-ring}
Let $\mathfrak p$ be a minimal prime of a ring $R$.
Every element of the maximal ideal of $R_{\mathfrak p}$
is nilpotent. If $R$ is reduced then $R_{\mathfrak p}$
is a field.
\end{lemma}

\begin{proof}
If some element $x$ of ${\mathfrak p}R_{\mathfrak p}$
is not nilpotent, then $D(x) \not = \emptyset$, see
Lemma \ref{lemma-Zariski-topology}. This contradicts
the minimality of $\mathfrak p$. If $R$ is reduced,
then ${\mathfrak p}R_{\mathfrak p} = 0$ and
hence it is a field.
\end{proof}

\begin{lemma}
\label{lemma-reduced-ring-sub-product-fields}
Let $R$ be a reduced ring. Then
\begin{enumerate}
\item $R$ is a subring of a product of fields,
\item $R \to \prod_{\mathfrak p\text{ minimal}} R_{\mathfrak p}$
is an embedding into a product of fields,
\item $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$ is the set
of zerodivisors of $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-minimal-prime-reduced-ring} each of the rings
$R_\mathfrak p$ is a field. In particular, the kernel of the ring
map $R \to R_\mathfrak p$ is $\mathfrak p$.
By Lemma \ref{lemma-Zariski-topology}
we have $\bigcap_{\mathfrak p} \mathfrak p = (0)$.
Hence (2) and (1) are true. If $x y = 0$ and $y \not = 0$, then
$y \not \in \mathfrak p$ for some minimal prime $\mathfrak p$.
Hence $x \in \mathfrak p$. Thus every zerodivisor of $R$ is contained
in $\bigcup_{\mathfrak p\text{ minimal}} \mathfrak p$.
Conversely, suppose that $x \in \mathfrak p$ for some minimal
prime $\mathfrak p$. Then $x$ maps to zero in $R_\mathfrak p$,
hence there exists $y \in R$, $y \not \in \mathfrak p$ such that
$xy = 0$. In other words, $x$ is a zerodivisor. This finishes the
proof of (3) and the lemma.
\end{proof}

\noindent
The total ring of fractions $Q(R)$ of a ring $R$ was introduced in
Example \ref{example-localize-at-prime}.

\begin{lemma}
\label{lemma-total-ring-fractions}
Let $R$ be a ring.
Let $S \subset R$ be a multiplicative subset consisting of nonzerodivisors.
Then $Q(R) \cong Q(S^{-1}R)$.
In particular $Q(R) \cong Q(Q(R))$.
\end{lemma}

\begin{proof}
If $x \in S^{-1}R$ is a nonzerodivisor, and
$x = r/f$ for some $r \in R$, $f \in S$, then
$r$ is a nonzerodivisor in $R$. Whence the lemma.
\end{proof}

\noindent
We can apply glueing results to prove something about
total rings of fractions $Q(R)$ which we introduced in
Example \ref{example-localize-at-prime}.

\begin{lemma}
\label{lemma-total-ring-fractions-no-embedded-points}
Let $R$ be a ring.
Assume that $R$ has finitely many minimal primes
$\mathfrak q_1, \ldots, \mathfrak q_t$, and that
$\mathfrak q_1 \cup \ldots \cup \mathfrak q_t$ is the set
of zerodivisors of $R$.
Then the total ring of fractions $Q(R)$ is equal to
$R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
\end{lemma}

\begin{proof}
There are natural maps $Q(R) \to R_{\mathfrak q_i}$ since
any nonzerodivisor is contained in $R \setminus \mathfrak q_i$.
Hence a natural map
$Q(R) \to R_{\mathfrak q_1} \times \ldots \times R_{\mathfrak q_t}$.
For any nonminimal prime $\mathfrak p \subset R$ we see that
$\mathfrak p \not \subset \mathfrak q_1 \cup \ldots \cup \mathfrak q_t$
by Lemma \ref{lemma-silly}. Hence
$\Spec(Q(R)) = \{\mathfrak q_1, \ldots, \mathfrak q_t\}$
(as subsets of $\Spec(R)$, see Lemma \ref{lemma-spec-localization}).
Therefore $\Spec(Q(R))$ is a finite discrete set and
it follows that $Q(R) = A_1 \times \ldots \times A_t$
with $\Spec(A_i) = \{\mathfrak{q}_i\}$, see
Lemma \ref{lemma-disjoint-implies-product}.
Moreover $A_i$ is a local ring, which is a localization
of $R$. Hence $A_i \cong R_{\mathfrak q_i}$.
\end{proof}

















\section{Irreducible components of spectra}
\label{section-irreducible}

\noindent
We show that irreducible components of
the spectrum of a ring correspond to the
minimal primes in the ring.

\begin{lemma}
\label{lemma-irreducible}
Let $R$ be a ring.
\begin{enumerate}
\item For a prime $\mathfrak p \subset R$ the closure
of $\{\mathfrak p\}$ in the Zariski topology is $V(\mathfrak p)$.
In a formula $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
\item The irreducible closed subsets of $\Spec(R)$ are
exactly the subsets $V(\mathfrak p)$, with $\mathfrak p \subset R$
a prime.
\item The irreducible components (see Topology,
Definition \ref{topology-definition-irreducible-components})
of $\Spec(R)$ are  exactly the subsets $V(\mathfrak p)$,
with $\mathfrak p \subset R$ a minimal prime.
\end{enumerate}
\end{lemma}

\begin{proof}
Note that if $ \mathfrak p \in V(I)$, then
$I \subset \mathfrak p$. Hence,
clearly $\overline{\{\mathfrak p\}} = V(\mathfrak p)$.
In particular $V(\mathfrak p)$ is the closure of
a singleton and hence irreducible.
The second assertion implies the third.
To show the second, let
$V(I) \subset \Spec(R)$ with $I$ a radical ideal.
If $I$ is not prime, then choose $a, b\in R$, $a, b\not \in I$
with $ab\in I$. In this case $V(I, a) \cup V(I, b) = V(I)$,
but neither $V(I, b) = V(I)$ nor $V(I, a) = V(I)$, by
Lemma \ref{lemma-Zariski-topology}. Hence $V(I)$ is not
irreducible.
\end{proof}

\noindent
In other words, this lemma shows that every irreducible closed
subset of $\Spec(R)$ is of the form $V(\mathfrak p)$ for
some prime $\mathfrak p$. Since $V(\mathfrak p) = \overline{\{\mathfrak p\}}$
we see that each irreducible closed subset has a unique generic point,
see Topology, Definition \ref{topology-definition-generic-point}.
In particular, $\Spec(R)$ is a sober topological space.
We record this fact in the following lemma.

\begin{lemma}
\label{lemma-spec-spectral}
The spectrum of a ring is a spectral space, see Topology, Definition
\ref{topology-definition-spectral-space}.
\end{lemma}

\begin{proof}
Formally this follows from Lemma \ref{lemma-irreducible} and
Lemma \ref{lemma-topology-spec}. See also discussion above.
\end{proof}

\begin{lemma}
\label{lemma-irreducible-components-containing-x}
Let $R$ be a ring. Let $\mathfrak p \subset R$ be a prime.
\begin{enumerate}
\item the set of irreducible closed subsets of $\Spec(R)$
passing through $\mathfrak p$ is in one-to-one correspondence with
primes $\mathfrak q \subset R_{\mathfrak p}$.
\item The set of irreducible components of $\Spec(R)$ passing through
$\mathfrak p$ is in one-to-one correspondence with minimal
primes $\mathfrak q \subset R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Follows from Lemma \ref{lemma-irreducible}
and the description of $\Spec(R_\mathfrak p)$ in
Lemma \ref{lemma-spec-localization} which shows that
$\Spec(R_\mathfrak p)$ corresponds to primes $\mathfrak q$ in $R$
with $\mathfrak q \subset \mathfrak p$.
\end{proof}

\begin{lemma}
\label{lemma-standard-open-containing-maximal-point}
Let $R$ be a ring.
Let $\mathfrak p$ be a minimal prime of $R$.
Let $W \subset \Spec(R)$ be a quasi-compact open
not containing the point $\mathfrak p$. Then there
exists an $f \in R$, $f \not \in \mathfrak p$ such
that $D(f) \cap W = \emptyset$.
\end{lemma}

\begin{proof}
Since $W$ is quasi-compact we may write it as a finite union
of standard affine opens $D(g_i)$, $i = 1, \ldots, n$.
Since $\mathfrak p \not \in W$ we have $g_i \in \mathfrak p$ for
all $i$. By Lemma \ref{lemma-minimal-prime-reduced-ring}
each $g_i$ is nilpotent in $R_{\mathfrak p}$. Hence we can find
an $f \in R$, $f \not \in \mathfrak p$ such that for all $i$ we have
$f g_i^{n_i} = 0$ for some $n_i > 0$. Then $D(f)$ works.
\end{proof}

\begin{lemma}
\label{lemma-ring-with-only-minimal-primes}
Let $R$ be a ring. Let $X = \Spec(R)$ as a topological space.
The following are equivalent
\begin{enumerate}
\item $X$ is profinite,
\item $X$ is Hausdorff,
\item $X$ is totally disconnected.
\item every quasi-compact open of $X$ is closed,
\item there are no nontrivial inclusions between its prime ideals,
\item every prime ideal is a maximal ideal,
\item every prime ideal is minimal,
\item every standard open $D(f) \subset X$ is closed, and
\item add more here.
\end{enumerate}
\end{lemma}

\begin{proof}
First proof. It is clear that (5), (6), and (7) are equivalent.
It is clear that (4) and (8) are equivalent as every quasi-compact
open is a finite union of standard opens.
The implication (7) $\Rightarrow$ (4) follows from
Lemma \ref{lemma-standard-open-containing-maximal-point}.
Assume (4) holds. Let $\mathfrak p, \mathfrak p'$ be distinct
primes of $R$. Choose an $f \in \mathfrak p'$, $f \not \in \mathfrak p$
(if needed switch $\mathfrak p$ with $\mathfrak p'$).
Then $\mathfrak p' \not \in D(f)$ and $\mathfrak p \in D(f)$.
By (4) the open $D(f)$ is also closed.
Hence $\mathfrak p$ and $\mathfrak p'$ are in disjoint open
neighbourhoods whose union is $X$. Thus $X$ is Hausdorff and totally
disconnected. Thus (4) $\Rightarrow$ (2) and (3).
If (3) holds then there cannot be any specializations
between points of $\Spec(R)$ and we see that (5) holds.
If $X$ is Hausdorff then every point is closed, so (2) implies (6).
Thus (2), (3), (4), (5), (6), (7) and (8) are equivalent.
Any profinite space is Hausdorff, so (1) implies (2).
If $X$ satisfies (2) and (3), then $X$ (being quasi-compact by
Lemma \ref{lemma-quasi-compact}) is profinite by
Topology, Lemma \ref{topology-lemma-profinite}.

\medskip\noindent
Second proof. Besides the equivalence of (4) and (8) this follows
from Lemma \ref{lemma-spec-spectral} and purely topological facts, see
Topology, Lemma \ref{topology-lemma-characterize-profinite-spectral}.
\end{proof}













\section{Examples of spectra of rings}
\label{section-examples-spectra}

\noindent
In this section we put some examples of spectra.

\begin{example}
\label{example-spec-Zxmodx2minus4}
In this example we describe $X = \Spec(\mathbf{Z}[x]/(x^2 - 4))$.
Let $\mathfrak{p}$ be an arbitrary prime in $X$.
Let $\phi : \mathbf{Z} \to \mathbf{Z}[x]/(x^2 - 4)$ be the natural ring map.
Then, $ \phi^{-1}(\mathfrak p)$ is a prime in $\mathbf{Z}$.
If $ \phi^{-1}(\mathfrak p) = (2)$, then since $\mathfrak p$ contains $2$,
it corresponds to a prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, 2) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, 2)$.
Any prime in $(\mathbf{Z}/2\mathbf{Z})[x]/(x^2)$ corresponds to a prime
in $(\mathbf{Z}/2\mathbf{Z})[x]$ containing $(x^2)$.  Such primes will
then contain $x$.  Since
$(\mathbf{Z}/2\mathbf{Z}) \cong (\mathbf{Z}/2\mathbf{Z})[x]/(x)$ is a field,
$(x)$ is a maximal ideal.  Since any prime contains $(x)$ and $(x)$ is
maximal, the ring contains only one prime $(x)$.  Thus, in this case,
$\mathfrak p = (2, x)$.  Now, if $ \phi^{-1}(\mathfrak p) = (q)$ for
$q > 2$, then since $\mathfrak p$ contains $q$, it corresponds to a
prime ideal in
$\mathbf{Z}[x]/(x^2 - 4, q) \cong (\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$
via the map $ \mathbf{Z}[x]/(x^2 - 4) \to  \mathbf{Z}[x]/(x^2 - 4, q)$.
Any prime in $(\mathbf{Z}/q\mathbf{Z})[x]/(x^2 - 4)$ corresponds to a
prime in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing $(x^2 - 4) = (x -2)(x + 2)$.
Hence, these primes must contain either $x -2$ or $x + 2$.  Since
$(\mathbf{Z}/q\mathbf{Z})[x]$ is a PID, all nonzero
primes are maximal, and so there
are precisely 2 primes in $(\mathbf{Z}/q\mathbf{Z})[x]$ containing
$(x-2)(x + 2)$, namely $(x-2)$ and $(x + 2)$.  In conclusion, there exist two
primes $(q, x-2)$ and $(q, x + 2)$ since $2 \neq -2 \in \mathbf{Z}/(q)$.
Finally, we treat the case where $\phi^{-1}(\mathfrak p) = (0)$.  Notice
that $\mathfrak p$ corresponds to a prime ideal in $\mathbf{Z}[x]$ that
contains $(x^2 - 4) = (x -2)(x + 2)$.  Hence, $\mathfrak p$ contains either
$(x-2)$ or $(x + 2)$.  Hence, $\mathfrak p$ corresponds to a prime in
$\mathbf{Z}[x]/(x - 2)$ or one in $\mathbf{Z}[x]/(x + 2)$ that intersects
$\mathbf{Z}$ only at $0$, by assumption.  Since
$\mathbf{Z}[x]/(x - 2) \cong \mathbf{Z}$ and
$\mathbf{Z}[x]/(x + 2) \cong \mathbf{Z}$, this means that $\mathfrak p$
must correspond to $0$ in one of these rings.  Thus,
$\mathfrak p = (x - 2)$ or $\mathfrak p = (x + 2)$ in the original ring.
\end{example}

\begin{example}
\label{example-spec-Zx}
In this example we describe $X = \Spec(\mathbf{Z}[x])$.
Fix $\mathfrak p \in X$.
Let $\phi : \mathbf{Z} \to \mathbf{Z}[x]$ and notice
that $\phi^{-1}(\mathfrak p) \in \Spec(\mathbf{Z})$.
If $\phi^{-1}(\mathfrak p) = (q)$ for $q$ a prime number $q > 0$,
then $\mathfrak p$ corresponds to a prime in $(\mathbf{Z}/(q))[x]$,
which must be generated by a polynomial that is irreducible in
$(\mathbf{Z}/(q))[x]$.   If we choose a representative of this polynomial
with minimal degree, then it will also be irreducible in $\mathbf{Z}[x]$.
Hence, in this case $\mathfrak p = (q, f_q)$ where $f_q$ is an irreducible
polynomial in $\mathbf{Z}[x]$ that is irreducible when viewed
in $(\mathbf{Z}/(q) [x])$. Now, assume that $\phi^{-1}(\mathfrak p) = (0)$.
In this case, $\mathfrak p$ must be generated by nonconstant polynomials
which, since $\mathfrak p$ is prime, may be assumed to be irreducible in
$\mathbf{Z}[x]$.  By Gauss' lemma, these polynomials are also irreducible
in $\mathbf{Q}[x]$.  Since $\mathbf{Q}[x]$ is a Euclidean domain, if there
are at least two distinct irreducibles $f, g$ generating $\mathfrak p$,
then $1 = af + bg$ for $a, b \in \mathbf{Q}[x]$.  Multiplying through by
a common denominator, we see that $m = \bar{a}f + \bar{b} g$ for
$\bar{a}, \bar{b} \in \mathbf{Z}[x]$ and nonzero $m \in \mathbf{Z}$.
This is a contradiction.  Hence, $\mathfrak p$ is generated by one
irreducible polynomial in $\mathbf{Z}[x]$.
\end{example}

\begin{example}
\label{example-spec-kxy}
In this example we describe $X = \Spec(k[x, y])$
when $k$ is an arbitrary field.
Clearly $(0)$ is prime, and any principal ideal generated by an
irreducible polynomial will also be a prime since $k[x, y]$ is a
unique factorization domain. Now assume $\mathfrak p$ is an
element of $X$ that is not principal. Since $k[x, y]$ is a
Noetherian UFD, the prime ideal $\mathfrak p$ can be generated
by a finite number of irreducible polynomials $(f_1, \ldots, f_n)$.
Now, I claim that if $f, g$ are irreducible polynomials in $k[x, y]$
that are not associates, then $(f, g) \cap k[x] \neq 0$. To do this,
it is enough to show that $f$ and $g$ are relatively prime when
viewed in $k(x)[y]$. In this case, $k(x)[y]$ is a Euclidean domain,
so by applying the Euclidean algorithm and clearing denominators, we
obtain $p = af + bg$ for $p, a, b \in k[x]$. Thus, assume this is not
the case, that is, that some nonunit $h \in k(x)[y]$ divides both
$f$ and $g$. Then, by Gauss's lemma, for some $a, b \in k(x)$ we
have $ah | f$ and $bh | g$ for $ah, bh \in k[x]$. By
irreducibility, $ah = f$ and
$bh = g$ (since $h \notin k(x)$). So, back in $k(x)[y]$, $f, g $
are associates, as $\frac{a}{b} g = f$. Since
$k(x)$ is the fraction field of $k[x]$, we can write $g = \frac{r}{s} f $
for elements $r , s \in k[x]$ sharing no common factors. This
implies that $sg = rf$ in $k[x, y]$ and so $s$ must divide $f$
since $k[x, y]$ is a UFD. Hence, $s = 1$ or $s = f$. If $s = f$,
then $r = g$, implying $f, g \in k[x]$ and thus must be units in
$k(x)$ and relatively prime in $k(x)[y]$, contradicting our
hypothesis. If $s = 1$, then $g = rf$, another contradiction.
Thus, we must have $f, g$ relatively prime in $k(x)[y]$, a
Euclidean domain. Thus, we have reduced to the case $\mathfrak p$
contains some irreducible polynomial $p \in k[x] \subset k[x, y]$.
By the above, $\mathfrak p$ corresponds to a prime in the ring
$k[x, y]/(p) = k(\alpha)[y]$, where $\alpha$ is an element
algebraic over $k$ with minimum polynomial $p$. This is a
PID, and so any prime ideal corresponds to $(0)$ or an
irreducible polynomial in $k(\alpha)[y]$. Thus, $\mathfrak p$
is of the form $(p)$ or $(p, f)$ where $f$ is a
polynomial in $k[x, y]$ that is irreducible in the quotient
$k[x, y]/(p)$.
\end{example}

\begin{example}
\label{example-affine-open-not-standard}
Consider the ring
$$
R = \{ f \in \mathbf{Q}[z]\text{ with }f(0) = f(1) \}.
$$
Consider the map
$$
\varphi : \mathbf{Q}[A, B] \to R
$$
defined by $\varphi(A) = z^2-z$ and $\varphi(B) = z^3-z^2$.  It is
easily checked that $(A^3 - B^2 + AB) \subset \Ker(\varphi)$ and that
$A^3 - B^2 + AB$ is irreducible. Assume that $\varphi$ is surjective;
then since $R$ is an integral domain (it is a subring of an integral
domain), $\Ker(\varphi)$ must be a prime ideal of $\mathbf{Q}[A, B]$.
The prime ideals which contain $(A^3-B^2 + AB)$ are $(A^3-B^2 + AB)$
itself and any maximal ideal $(f, g)$ with $f, g\in\mathbf{Q}[A, B]$
such that $f$ is irreducible mod $g$. But $R$ is not a field, so the
kernel must be $(A^3-B^2 + AB)$; hence $\varphi$ gives an isomorphism
$R \to \mathbf{Q}[A, B]/(A^3-B^2 + AB)$.

\medskip\noindent
To see that $\varphi$ is surjective, we must express any
$f\in R$ as a $\mathbf{Q}$-coefficient polynomial in $A(z) = z^2-z$
and $B(z) = z^3-z^2$. Note the relation $zA(z) = B(z)$. Let
$a = f(0) = f(1)$. Then $z(z-1)$ must divide $f(z)-a$, so we can write
$f(z) = z(z-1)g(z)+a = A(z)g(z)+a$.  If $\deg(g) < 2$, then
$h(z) = c_1z + c_0$ and $f(z) = A(z)(c_1z + c_0)+a = c_1B(z)+c_0A(z)+a$, so we
are done.  If $\deg(g)\geq 2$, then by the polynomial division
algorithm, we can write $g(z) = A(z)h(z)+b_1z + b_0$
($\deg(h)\leq\deg(g)-2$), so $f(z) = A(z)^2h(z)+b_1B(z)+b_0A(z)$.
Applying division to $h(z)$ and iterating, we obtain an expression
for $f(z)$ as a polynomial in $A(z)$ and $B(z)$; hence $\varphi$ is
surjective.

\medskip\noindent
Now let $a \in \mathbf{Q}$, $a \neq 0, \frac{1}{2}, 1$ and
consider
$$
R_a = \{ f \in \mathbf{Q}[z, \frac{1}{z-a}]\text{ with }f(0) = f(1)
\}.
$$
This is a finitely generated $\mathbf{Q}$-algebra as well: it is
easy to check that the functions $z^2-z$, $z^3-z$, and
$\frac{a^2-a}{z-a}+z$ generate $R_a$ as an $\mathbf{Q}$-algebra.  We
have the following inclusions:
$$
R\subset R_a\subset\mathbf{Q}[z, \frac{1}{z-a}], \quad
R\subset\mathbf{Q}[z]\subset\mathbf{Q}[z, \frac{1}{z-a}].
$$
Recall (Lemma \ref{lemma-spec-localization}) that for a ring T and a
multiplicative subset $S\subset T$, the ring map $T \to S^{-1}T$
induces a map on spectra $\Spec(S^{-1}T) \to \Spec(T)$
which is a homeomorphism onto the subset
$$
\{\mathfrak p \in \Spec(T) \mid S \cap \mathfrak p = \emptyset\}
\subset \Spec(T).
$$
When $S = \{ 1, f, f^2, \ldots\}$ for some $f\in T$, this is
the open set $D(f)\subset T$.  We now verify a corresponding
property for the ring map $R \to R_a$: we will show that the map
$\theta : \Spec(R_a) \to \Spec(R)$ induced by inclusion
$R\subset R_a$ is a homeomorphism onto an open subset of
$\Spec(R)$ by verifying that $\theta$ is an injective local
homeomorphism.  We do so with respect to an open cover of
$\Spec(R_a)$ by two distinguished opens, as we now describe.
For any $r\in\mathbf{Q}$, let $\text{ev}_r : R \to \mathbf{Q}$ be the
homomorphism given by evaluation at $r$.  Note that for $r = 0$ and
$r = 1-a$, this can be extended to a homomorphism
$\text{ev}_r' : R_a \to \mathbf{Q}$ (the latter because $\frac{1}{z-a}$
is well-defined at $z = 1-a$, since $a\neq\frac{1}{2}$).  However,
$\text{ev}_a$ does not extend to $R_a$.  Write
$\mathfrak{m}_r = \Ker(\text{ev}_r)$. We have
$$
\mathfrak{m}_0 = (z^2-z, z^3-z),
$$
$$
\mathfrak{m}_a = ((z-1 + a)(z-a), (z^2-1 + a)(z-a)), \text{ and}
$$
$$
\mathfrak{m}_{1-a} = ((z-1 + a)(z-a), (z-1 + a)(z^2-a)).
$$
To verify this, note that the right-hand sides are clearly contained in
the left-hand sides. Then check that the right-hand sides are
maximal ideals by writing the generators in terms of $A$ and $B$,
and viewing $R$ as $\mathbf{Q}[A, B]/(A^3-B^2 + AB)$. Note that
$\mathfrak{m}_a$ is not in the image of $\theta$: we have
$$
(z^2 - z)^2(z - a)\left(\frac{a^2 - a}{z - a} + z\right) =
(z^2 - z)^2(a^2 - a) + (z^2 - z)^2(z - a)z
$$
The left hand side is in $\mathfrak m_a R_a$ because
$(z^2 - z)(z - a)$ is in $\mathfrak m_a$ and because
$(z^2 - z)(\frac{a^2 - a}{z - a} + z)$ is in $R_a$. Similarly
the element $(z^2 - z)^2(z - a)z$ is in $\mathfrak m_a R_a$
because $(z^2 - z)$ is in $R_a$ and $(z^2 - z)(z - a)$ is in $\mathfrak m_a$.
As $a \not \in \{0, 1\}$ we conclude that
$(z^2 - z)^2 \in \mathfrak m_a R_a$. Hence
no ideal $I$ of $R_a$ can satisfy $I \cap R = \mathfrak m_a$, as such
an $I$ would have to contain $(z^2 - z)^2$, which is in $R$ but not in
$\mathfrak m_a$. The distinguished open set
$D((z-1 + a)(z-a))\subset\Spec(R)$ is equal to the complement of
the closed set $\{\mathfrak{m}_a, \mathfrak{m}_{1-a}\}$.
Then check that $R_{(z-1 + a)(z-a)} = (R_a)_{(z-1 + a)(z-a)}$; calling
this localized ring $R'$, then, it follows that the map $R \to R'$
factors as $R \to R_a \to R'$.  By Lemma
\ref{lemma-spec-localization}, then, these maps express
$\Spec(R') \subset \Spec(R_a)$ and
$\Spec(R') \subset \Spec(R)$ as open subsets; hence
$\theta : \Spec(R_a) \to \Spec(R)$, when restricted to
$D((z-1 + a)(z-a))$, is a homeomorphism onto an open subset.
Similarly, $\theta$ restricted to
$D((z^2 + z + 2a-2)(z-a)) \subset \Spec(R_a)$ is a homeomorphism
onto the open subset $D((z^2 + z + 2a-2)(z-a)) \subset \Spec(R)$.
Depending on whether $z^2 + z + 2a-2$ is irreducible or not over
$\mathbf{Q}$, this former distinguished open set has complement
equal to one or two closed points along with the closed point
$\mathfrak{m}_a$. Furthermore, the ideal in $R_a$ generated by the
elements $(z^2 + z + 2a-a)(z-a)$ and $(z-1 + a)(z-a)$ is all of $R_a$, so
these two distinguished open sets cover $\Spec(R_a)$. Hence in
order to show that $\theta$ is a homeomorphism onto
$\Spec(R)-\{\mathfrak{m}_a\}$, it suffices to show
that these one or two points can never equal $\mathfrak{m}_{1-a}$.
And this is indeed the case, since $1-a$ is a root of $z^2 + z + 2a-2$
if and only if $a = 0$ or $a = 1$, both of which do not occur.

\medskip\noindent
Despite this homeomorphism which mimics the behavior of a
localization at an element of $R$, while
$\mathbf{Q}[z, \frac{1}{z-a}]$ is the localization of $\mathbf{Q}[z]$
at the maximal ideal $(z-a)$, the ring $R_a$ is {\it not} a
localization of $R$: Any localization $S^{-1}R$ results in more
units than the original ring $R$.  The units of $R$ are
$\mathbf{Q}^\times$, the units of $\mathbf{Q}$.  In fact, it is
easy to see that the units of $R_a$ are $\mathbf{Q}^*$.
Namely, the units of $\mathbf{Q}[z, \frac{1}{z - a}]$ are
$c (z - a)^n$ for $c \in \mathbf{Q}^*$ and $n \in \mathbf{Z}$
and it is clear that these are in $R_a$ only if $n = 0$.
Hence $R_a$ has no more units than
$R$ does, and thus cannot be a localization of $R$.

\medskip\noindent
We used the fact that $a\neq 0, 1$ to ensure that
$\frac{1}{z-a}$ makes sense at $z = 0, 1$.  We used the fact that
$a\neq 1/2$ in a few places: (1) In order to be able to talk about
the kernel of $\text{ev}_{1-a}$ on $R_a$, which ensures that
$\mathfrak{m}_{1-a}$ is a point of $R_a$ (i.e., that $R_a$ is
missing just one point of $R$). (2) At the end in order to conclude
that $(z-a)^{k + \ell}$ can only be in $R$ for $k = \ell = 0$; indeed, if
$a = 1/2$, then this is in $R$ as long as $k + \ell$ is even. Hence
there would indeed be more units in $R_a$ than in $R$, and $R_a$
could possibly be a localization of $R$.
\end{example}





\section{A meta-observation about prime ideals}
\label{section-oka-families}

\noindent
This section is taken from the CRing project. Let $R$ be a ring and
let $S \subset R$ be a multiplicative subset.
A consequence of
Lemma \ref{lemma-spec-localization}
is that an ideal $I \subset R$ maximal with respect to the property
of not intersecting $S$ is prime. The reason is that $I = R \cap \mathfrak m$
for some maximal ideal $\mathfrak m$ of the ring $S^{-1}R$.
It turns out that for many properties of ideals, the maximal ones
are prime. A general method of seeing this was developed in \cite{Lam-Reyes}.
In this section, we digress to explain this phenomenon.

\medskip\noindent
Let $R$ be a ring. If $I$ is an ideal of $R$ and $a \in R$, we
define
$$
(I : a) = \left\{ x \in R \mid xa \in I\right\}.
$$
More generally, if $J \subset R$ is an ideal, we define
$$
(I : J) = \left\{ x \in R \mid xJ \subset I\right\}.
$$

\begin{lemma}
\label{lemma-colon}
Let $R$ be a ring. For a principal ideal $J \subset R$, and for any ideal
$I \subset J$ we have $I = J (I : J)$.
\end{lemma}

\begin{proof}
Say $J = (a)$. Then $(I : J) = (I : a)$.
Since $I \subset J$ we see that any $y \in I$ is of the form
$y = xa$ for some $x \in (I : a)$. Hence $I \subset J (I : J)$.
Conversely, if $x \in (I : a)$, then $xJ = (xa) \subset I$, which
proves the other inclusion.
\end{proof}

\noindent
Let $\mathcal{F}$ be a collection of ideals of $R$. We are interested in
conditions that will guarantee that the maximal elements in the complement
of $\mathcal{F}$ are prime.

\begin{definition}
\label{definition-oka-family}
Let $R$ be a ring. Let $\mathcal{F}$ be a set of ideals of $R$. We say
$\mathcal{F}$ is an {\it Oka family} if $R \in \mathcal{F}$ and
whenever $I \subset R$ is an ideal and $(I : a), (I, a) \in \mathcal{F}$
for some $a \in R$, then $I \in \mathcal{F}$.
\end{definition}

\noindent
Let us give some examples of Oka families. The first example is the basic
example discussed in the introduction to this section.

\begin{example}
\label{example-oka-family-not-meet-multiplicative-set}
Let $R$ be a ring and let $S$ be a multiplicative subset of $R$.
We claim that $\mathcal{F} = \{I \subset R \mid I \cap S \not = \emptyset\}$
is an Oka family. Namely, suppose that $(I : a), (I, a) \in \mathcal{F}$
for some $a \in R$. Then pick $s \in (I, a) \cap S$ and
$s' \in (I : a) \cap S$. Then $ss' \in I \cap S$ and hence
$I \in \mathcal{F}$. Thus $\mathcal{F}$ is an Oka family.
\end{example}

\begin{example}
\label{example-oka-family-finitely-generated}
Let $R$ be a ring, $I \subset R$ an ideal, and $a \in R$.
If $(I : a)$ is generated by $a_1, \ldots, a_n$ and $(I, a)$
is generated by $a, b_1, \ldots, b_m$ with
$b_1, \ldots, b_m \in I$, then $I$ is generated by
$aa_1, \ldots, aa_n, b_1, \ldots, b_m$.
To see this, note that if $x \in I$, then $x \in (I, a)$
is a linear combination of $a, b_1, \ldots, b_m$, but the
coefficient of $a$ must lie in $(I:a)$.
As a result, we deduce that
the family of finitely generated ideals is an Oka family.
\end{example}

\begin{example}
\label{example-oka-family-principal}
Let us show that the family of principal ideals of a ring $R$ is an Oka family.
Indeed, suppose $I \subset R$ is an ideal, $a \in R$, and $(I, a)$ and
$(I : a)$ are principal. Note that $(I : a) = (I : (I, a))$.
Setting $J = (I, a)$, we find that $J$ is principal and $(I : J)$ is too. By
Lemma \ref{lemma-colon}
we have $I = J (I : J)$.
Thus we find in our situation that since $J = (I, a)$ and $(I : J)$
are principal, $I$ is principal.
\end{example}

\begin{example}
\label{example-oka-family-bound-cardinality}
Let $R$ be a ring.
Let $\kappa$ be an infinite cardinal.
The family of ideals which can be generated by at most $\kappa$ elements
is an Oka family. The argument is analogous to the argument in
Example \ref{example-oka-family-finitely-generated}
and is omitted.
\end{example}

\begin{example}
\label{example-oka-family-property-modules}
Let $A$ be a ring, $I \subset A$ an ideal, and $a \in A$ an element.
There is a short exact sequence $0 \to A/(I : a) \to A/I \to A/(I, a) \to 0$
where the first arrow is given by multiplication by $a$. Thus if $P$
is a property of $A$-modules that is stable under extensions and holds
for $0$, then the family of ideals $I$ such that $A/I$ has $P$
is an Oka family.
\end{example}

\begin{proposition}
\label{proposition-oka}
If $\mathcal{F}$ is an Oka family of ideals, then any maximal element of
the complement of $\mathcal{F}$ is prime.
\end{proposition}

\begin{proof}
Suppose $I \not \in \mathcal{F}$ is maximal with respect to not being in
$\mathcal{F}$ but $I$ is not prime. Note that $I \not = R$ because
$R \in \mathcal{F}$. Since $I$ is not prime we can find $a, b \in R - I$
with $ab \in I$. It follows that $(I, a) \neq I$ and $(I : a)$ contains
$b \not \in I$ so also $(I : a) \neq I$. Thus $(I : a), (I, a)$ both
strictly contain $I$, so they must belong to $\mathcal{F}$.
By the Oka condition, we have $I \in \mathcal{F}$, a contradiction.
\end{proof}

\noindent
At this point we are able to turn most of the examples above into
a lemma about prime ideals in a ring.

\begin{lemma}
\label{lemma-simple}
Let $R$ be a ring. Let $S$ be a multiplicative subset of $R$.
An ideal $I \subset R$ which is maximal with respect to the property
that $I \cap S = \emptyset$ is prime.
\end{lemma}

\begin{proof}
This is the example discussed in the introduction to this section.
For an alternative proof, combine
Example \ref{example-oka-family-not-meet-multiplicative-set}
with
Proposition \ref{proposition-oka}.
\end{proof}

\begin{lemma}
\label{lemma-cohen}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal $I \subset R$ maximal with respect to not being
finitely generated is prime.
\item If every prime ideal of $R$ is
finitely generated, then
every ideal of $R$ is finitely generated\footnote{Later we will say
that $R$ is Noetherian.}.
\end{enumerate}
\end{lemma}

\begin{proof}
The first assertion is an immediate consequence of
Example \ref{example-oka-family-finitely-generated} and
Proposition \ref{proposition-oka}. For the second,
suppose that there exists an ideal $I \subset R$ which is not finitely
generated. The union of a totally ordered chain $\left\{I_\alpha\right\}$
of ideals that are not finitely generated is not finitely generated;
indeed, if $I = \bigcup I_\alpha$ were generated by
$a_1, \ldots, a_n$, then all the generators would belong to some
$I_\alpha $ and would consequently generate it.
By Zorn's lemma, there is an ideal maximal with respect to being not finitely
generated. By the first part this ideal is prime.
\end{proof}

\begin{lemma}
\label{lemma-primes-principal}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal $I \subset R$ maximal with respect to not being
principal is prime.
\item If every prime ideal of $R$ is principal, then
every ideal of $R$ is principal.
\end{enumerate}
\end{lemma}

\begin{proof}
The first part follows from
Example \ref{example-oka-family-principal} and
Proposition \ref{proposition-oka}.
For the second, suppose that there exists an ideal $I \subset R$
which is not principal. The union of a totally ordered chain
$\left\{I_\alpha\right\}$ of ideals that not principal is not principal;
indeed, if $I = \bigcup I_\alpha$ were generated by
$a$, then $a$ would belong to some $I_\alpha $ and $a$ would generate it.
By Zorn's lemma, there is an ideal maximal with respect to not being
principal. This ideal is necessarily prime by the first part.
\end{proof}

\begin{lemma}
\label{lemma-characterize-domain}
Let $R$ be a ring.
\begin{enumerate}
\item An ideal maximal among the ideals which do not contain a
nonzerodivisor is prime.
\item If $R$ is nonzero and every nonzero prime ideal in $R$
contains a nonzerodivisor, then $R$ is a domain.
\end{enumerate}
\end{lemma}

\begin{proof}
Consider the set $S$ of nonzerodivisors. It is a multiplicative
subset of $R$. Hence any ideal maximal with respect to not intersecting
$S$ is prime, see
Lemma \ref{lemma-simple}.
Thus, if every nonzero prime ideal contains a nonzerodivisor, then
$(0)$ is prime, i.e., $R$ is a domain.
\end{proof}

\begin{remark}
\label{remark-cohen-bound-cardinality}
Let $R$ be a ring. Let $\kappa$ be an infinite cardinal.
By applying
Example \ref{example-oka-family-bound-cardinality} and
Proposition \ref{proposition-oka}
we see that any ideal maximal with respect to the property of not being
generated by $\kappa$ elements is prime. This result is not so
useful because there exists a ring for which every prime ideal
of $R$ can be generated by $\aleph_0$ elements, but some
ideal cannot. Namely, let $k$ be a field, let $T$ be a set whose
cardinality is greater than $\aleph_0$ and let
$$
R = k[\{x_n\}_{n \geq 1}, \{z_{t, n}\}_{t \in T, n \geq 0}]/
(x_n^2, z_{t, n}^2, x_n z_{t, n} - z_{t, n - 1})
$$
This is a local ring with unique prime ideal
$\mathfrak m = (x_n)$. But the ideal $(z_{t, n})$ cannot
be generated by countably many elements.
\end{remark}

\begin{example}
\label{example-noetherian-topology-on-spec}
\begin{reference}
Comment by Lukas Heger of November 12, 2020.
\end{reference}
Let $R$ be a ring and $X = \Spec(R)$. Since closed subsets of $X$ correspond to
radical ideas of $R$ (Lemma \ref{lemma-Zariski-topology}) we see that $X$ is a
Noetherian topological space if and only if we have ACC for radical ideals.
This holds if and only if every radical ideal is the radical of a finitely
generated ideal (details omitted). Let
$$
\mathcal{F} = \{I \subset R \mid
\sqrt{I} = \sqrt{(f_1, \ldots, f_n)}\text{ for some }n
\text{ and }f_1, \ldots, f_n \in R\}.
$$
The reader can show that $\mathcal{F}$ is an Oka family by using the identity
$$
\sqrt{I} = \sqrt{(I, a)(I : a)}
$$
which holds for any ideal $I \subset R$ and any element $a \in R$.
On the other hand, if we have a totally ordered chain of ideals
$\{I_\alpha\}$ none of which are in $\mathcal{F}$, then the union
$I = \bigcup I_\alpha$ cannot be in $\mathcal{F}$ either. Otherwise
$\sqrt{I} = \sqrt{(f_1, \ldots, f_n)}$, then $f_i^e \in I$ for some $e$,
then $f_i^e \in I_\alpha$ for some $\alpha$ independent of $i$, then
$\sqrt{I_\alpha} = \sqrt{(f_1, \ldots, f_n)}$, contradiction.
Thus if the set of ideals not in $\mathcal{F}$ is nonempty, then it
has maximal elements and
exactly as in Lemma \ref{lemma-cohen} we conclude that $X$ is a
Noetherian topological space if and only if every prime ideal of $R$
is equal to $\sqrt{(f_1, \ldots, f_n)}$ for some $f_1, \ldots, f_n \in R$.
If we ever need this result we will carefully state and prove this
result here.
\end{example}








\section{Images of ring maps of finite presentation}
\label{section-images-finite-presentation}

\noindent
In this section we prove some results on the
topology of maps $\Spec(S) \to \Spec(R)$
induced by ring maps $R \to S$, mainly Chevalley's Theorem.
In order to do this we will use the notions of constructible sets,
quasi-compact sets, retrocompact sets, and so on
which are defined in Topology, Section \ref{topology-section-constructible}.

\begin{lemma}
\label{lemma-qc-open}
Let $U \subset \Spec(R)$ be open. The following
are equivalent:
\begin{enumerate}
\item $U$ is retrocompact in $\Spec(R)$,
\item $U$ is quasi-compact,
\item $U$ is a finite union of standard opens, and
\item there exists a finitely generated ideal $I \subset R$ such
that $X \setminus V(I) = U$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have (1) $\Rightarrow$ (2) because $\Spec(R)$ is quasi-compact, see
Lemma \ref{lemma-quasi-compact}. We have (2) $\Rightarrow$ (3) because
standard opens form a basis for the topology. Proof of (3) $\Rightarrow$ (1).
Let $U = \bigcup_{i = 1\ldots n} D(f_i)$. To show that $U$ is retrocompact
in $\Spec(R)$ it suffices to show that $U \cap V$ is quasi-compact for any
quasi-compact open $V$ of $\Spec(R)$. Write
$V = \bigcup_{j = 1\ldots m} D(g_j)$ which is possible by (2) $\Rightarrow$
(3). Each standard open is homeomorphic to the spectrum of a ring and hence
quasi-compact, see Lemmas \ref{lemma-standard-open} and
\ref{lemma-quasi-compact}. Thus
$U \cap V =
(\bigcup_{i = 1\ldots n} D(f_i)) \cap (\bigcup_{j = 1\ldots m} D(g_j))
= \bigcup_{i, j} D(f_i g_j)$ is a finite union of quasi-compact opens
hence quasi-compact. To finish the proof note
that (4) is equivalent to (3) by 
Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-affine-map-quasi-compact}
Let $\varphi : R \to S$ be a ring map.
The induced continuous map $f : \Spec(S) \to \Spec(R)$
is quasi-compact. For any constructible set $E \subset \Spec(R)$
the inverse image $f^{-1}(E)$ is constructible in $\Spec(S)$.
\end{lemma}

\begin{proof}
We first show that the inverse image of any quasi-compact
open $U \subset \Spec(R)$ is quasi-compact. By
Lemma \ref{lemma-qc-open} we may write $U$ as a finite
open of standard opens. Thus by Lemma \ref{lemma-spec-functorial}
we see that $f^{-1}(U)$ is a finite union of standard opens.
Hence $f^{-1}(U)$ is quasi-compact by Lemma \ref{lemma-qc-open} again.
The second assertion now follows from Topology, Lemma
\ref{topology-lemma-inverse-images-constructibles}.
\end{proof}

\begin{lemma}
\label{lemma-constructible}
Let $R$ be a ring. A subset of $\Spec(R)$ is constructible if and only
if it can be written as a finite union of subsets of the form
$D(f) \cap V(g_1, \ldots, g_m)$ for $f, g_1, \ldots, g_m \in R$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-qc-open} the subset $D(f)$ and the complement of
$V(g_1, \ldots, g_m)$ are retro-compact open. Hence
$D(f) \cap V(g_1, \ldots, g_m)$ is a constructible subset and so is
any finite union of such. Conversely, let $T \subset \Spec(R)$ be
constructible. By Topology, Definition \ref{topology-definition-constructible},
we may assume that $T = U \cap V^c$, where $U, V \subset \Spec(R)$
are retrocompact open. By Lemma \ref{lemma-qc-open} we may write
$U = \bigcup_{i = 1, \ldots, n} D(f_i)$ and
$V = \bigcup_{j = 1, \ldots, m} D(g_j)$. Then
$T = \bigcup_{i = 1, \ldots, n} \big(D(f_i) \cap V(g_1, \ldots, g_m)\big)$.
\end{proof}

\begin{lemma}
\label{lemma-constructible-is-image}
Let $R$ be a ring and let $T \subset \Spec(R)$
be constructible. Then there exists a ring map $R \to S$ of
finite presentation such that $T$ is the image of
$\Spec(S)$ in $\Spec(R)$.
\end{lemma}

\begin{proof}
The spectrum of a finite product of rings
is the disjoint union of the spectra, see
Lemma \ref{lemma-spec-product}. Hence if $T = T_1 \cup T_2$
and the result holds for $T_1$ and $T_2$, then the
result holds for $T$.
By Lemma \ref{lemma-constructible} we may assume
that $T = D(f) \cap V(g_1, \ldots, g_m)$.
In this case $T$ is the image of the map
$\Spec((R/(g_1, \ldots, g_m))_f) \to \Spec(R)$, see Lemmas
\ref{lemma-standard-open} and \ref{lemma-spec-closed}.
\end{proof}

\begin{lemma}
\label{lemma-open-fp}
Let $R$ be a ring.
Let $f$ be an element of $R$.
Let $S = R_f$.
Then the image of a constructible subset of $\Spec(S)$
is constructible in $\Spec(R)$.
\end{lemma}

\begin{proof}
We repeatedly use Lemma \ref{lemma-qc-open} without mention.
Let $U, V$ be quasi-compact open in $\Spec(S)$.
We will show that the image of $U \cap V^c$ is constructible.
Under the identification
$\Spec(S) = D(f)$ of Lemma \ref{lemma-standard-open}
the sets $U, V$ correspond to quasi-compact opens
$U', V'$ of $\Spec(R)$.
Hence it suffices to show that $U' \cap (V')^c$
is constructible in $\Spec(R)$ which is clear.
\end{proof}

\begin{lemma}
\label{lemma-closed-fp}
Let $R$ be a ring.
Let $I$ be a finitely generated ideal of $R$.
Let $S = R/I$.
Then the image of a constructible subset of $\Spec(S)$
is constructible in $\Spec(R)$.
\end{lemma}

\begin{proof}
If $I = (f_1, \ldots, f_m)$, then we see that
$V(I)$ is the complement of $\bigcup D(f_i)$,
see Lemma \ref{lemma-Zariski-topology}.
Hence it is constructible, by Lemma \ref{lemma-qc-open}.
Denote the map $R \to S$ by $f \mapsto \overline{f}$.
We have to show that if $\overline{U}, \overline{V}$
are retrocompact opens of $\Spec(S)$, then the
image of $\overline{U} \cap \overline{V}^c$
in $\Spec(R)$ is constructible.
By Lemma \ref{lemma-qc-open} we may write
$\overline{U} = \bigcup D(\overline{g_i})$.
Setting $U = \bigcup D({g_i})$ we see $\overline{U}$
has image $U \cap V(I)$ which is constructible in
$\Spec(R)$. Similarly the image of $\overline{V}$ equals
$V \cap V(I)$ for some retrocompact open $V$ of $\Spec(R)$.
Hence the image of $\overline{U} \cap \overline{V}^c$
equals $U \cap V(I) \cap V^c$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-affineline-open}
Let $R$ be a ring. The map $\Spec(R[x]) \to \Spec(R)$
is open, and the image of any standard open is a quasi-compact
open.
\end{lemma}

\begin{proof}
It suffices to show that the image of a standard open
$D(f)$, $f\in R[x]$ is quasi-compact open.
The image of $D(f)$ is the image of
$\Spec(R[x]_f) \to \Spec(R)$.
Let $\mathfrak p \subset R$ be a prime ideal.
Let $\overline{f}$ be the image of $f$ in
$\kappa(\mathfrak p)[x]$.
Recall, see Lemma \ref{lemma-in-image},
that $\mathfrak p$ is in the image
if and only if $R[x]_f \otimes_R \kappa(\mathfrak p) =
\kappa(\mathfrak p)[x]_{\overline{f}}$ is not the
zero ring. This is exactly the condition that $f$ does not map
to zero in $\kappa(\mathfrak p)[x]$, in other words, that
some coefficient of $f$ is not in $\mathfrak p$.
Hence we see: if $f = a_d x^d + \ldots + a_0$, then
the image of $D(f)$ is $D(a_d) \cup \ldots \cup D(a_0)$.
\end{proof}

\noindent
We prove a property of characteristic polynomials which
will be used below.

\begin{lemma}
\label{lemma-characteristic-polynomial-prime}
Let $R \to A$ be a ring homomorphism.
Assume $A \cong R^{\oplus n}$ as an $R$-module.
Let $f \in A$. The multiplication map $m_f: A
\to A$ is $R$-linear and hence
has a characteristic polynomial
$P(T) = T^n + r_{n-1}T^{n-1} + \ldots + r_0 \in R[T]$.
For any prime
$\mathfrak{p} \in \Spec(R)$, $f$ acts nilpotently on $A
\otimes_R \kappa(\mathfrak{p})$ if and only if $\mathfrak p \in
V(r_0, \ldots, r_{n-1})$.
\end{lemma}

\begin{proof}
This follows quite easily once we prove that the characteristic
polynomial $\bar P(T) \in \kappa(\mathfrak p)[T]$ of the
multiplication map $m_{\bar f}: A \otimes_R \kappa(\mathfrak p) \to
A \otimes_R \kappa(\mathfrak p)$ which multiplies elements of $A
\otimes_R \kappa(\mathfrak p)$ by $\bar f$, the image of $f$ viewed in
$\kappa(\mathfrak p)$, is just the image of $P(T)$ in
$\kappa(\mathfrak p)[T]$. Let $(a_{ij})$ be the matrix of the map
$m_f$ with entries in $R$, using a basis $e_1, \ldots, e_n$
of $A$ as an $R$-module.
Then, $A \otimes_R \kappa(\mathfrak p) \cong (R \otimes_R
\kappa(\mathfrak p))^{\oplus n} = \kappa(\mathfrak p)^n$, which is
an $n$-dimensional vector space over $\kappa(\mathfrak p)$ with
basis $e_1 \otimes 1, \ldots, e_n \otimes 1$. The image $\bar f = f
\otimes 1$, and so the multiplication map $m_{\bar f}$ has matrix
$(a_{ij} \otimes 1)$. Thus, the characteristic polynomial is
precisely the image of $P(T)$.

\medskip\noindent
From linear algebra, we know that a linear transformation acts
nilpotently on an $n$-dimensional vector space if and only if the
characteristic polynomial is $T^n$ (since the characteristic
polynomial divides some power of the minimal polynomial). Hence,
$f$ acts nilpotently on $A \otimes_R \kappa(\mathfrak p)$ if and
only if $\bar P(T) = T^n$. This occurs if and only if $r_i \in
\mathfrak p$ for all $0 \leq i \leq n - 1$, that is when $\mathfrak p \in
V(r_0, \ldots, r_{n - 1}).$
\end{proof}

\begin{lemma}
\label{lemma-affineline-special}
Let $R$ be a ring. Let $f, g \in R[x]$ be polynomials.
Assume the leading coefficient of $g$ is a unit of $R$.
There exists elements $r_i\in R$, $i = 1\ldots, n$ such that
the image of $D(f) \cap V(g)$ in $\Spec(R)$ is
$\bigcup_{i = 1, \ldots, n} D(r_i)$.
\end{lemma}

\begin{proof}
Write $g = ux^d + a_{d-1}x^{d-1} + \ldots + a_0$, where
$d$ is the degree of $g$, and hence $u \in R^*$.
Consider the ring $A = R[x]/(g)$.
It is, as an $R$-module, finite free with basis the images
of $1, x, \ldots, x^{d-1}$. Consider multiplication
by (the image of) $f$ on $A$. This is an $R$-module map.
Hence we can let $P(T) \in R[T]$ be the characteristic polynomial
of this map. Write $P(T) = T^d + r_{d-1} T^{d-1} + \ldots + r_0$.
We claim that $r_0, \ldots, r_{d-1}$ have the desired property.
We will use below the property of characteristic polynomials
that
$$
\mathfrak p \in V(r_0, \ldots, r_{d-1})
\Leftrightarrow
\text{multiplication by }f\text{ is nilpotent on }
A \otimes_R \kappa(\mathfrak p).
$$
This was proved in Lemma \ref{lemma-characteristic-polynomial-prime}.

\medskip\noindent
Suppose $\mathfrak q\in D(f) \cap V(g)$, and let
$\mathfrak p = \mathfrak q \cap R$. Then there is a nonzero map
$A \otimes_R \kappa(\mathfrak p) \to \kappa(\mathfrak q)$ which
is compatible with multiplication by $f$.
And $f$ acts as a unit on $\kappa(\mathfrak q)$.
Thus we conclude $\mathfrak p \not \in  V(r_0, \ldots, r_{d-1})$.

\medskip\noindent
On the other hand, suppose that $r_i \not\in \mathfrak p$ for some
prime $\mathfrak p$ of $R$ and some $0 \leq i \leq d - 1$.
Then multiplication by $f$ is not nilpotent on the algebra
$A \otimes_R \kappa(\mathfrak p)$.
Hence there exists a prime ideal $\overline{\mathfrak q} \subset
A \otimes_R \kappa(\mathfrak p)$ not containing the image of $f$.
The inverse image of $\overline{\mathfrak q}$ in $R[x]$
is an element of $D(f) \cap V(g)$ mapping to $\mathfrak p$.
\end{proof}

\begin{theorem}[Chevalley's Theorem]
\label{theorem-chevalley}
Suppose that $R \to S$ is of finite presentation.
The image of a constructible subset of
$\Spec(S)$ in $\Spec(R)$ is constructible.
\end{theorem}

\begin{proof}
Write $S = R[x_1, \ldots, x_n]/(f_1, \ldots, f_m)$.
We may factor $R \to S$ as $R \to R[x_1] \to R[x_1, x_2]
\to \ldots \to R[x_1, \ldots, x_{n-1}] \to S$. Hence
we may assume that $S = R[x]/(f_1, \ldots, f_m)$.
In this case we factor the map as $R \to R[x] \to S$,
and by Lemma \ref{lemma-closed-fp} we reduce to
the case $S = R[x]$. By Lemma \ref{lemma-qc-open} suffices
to show that if
$T = (\bigcup_{i = 1\ldots n} D(f_i)) \cap V(g_1, \ldots, g_m)$
for $f_i , g_j \in R[x]$ then the image in $\Spec(R)$ is
constructible. Since finite unions of constructible sets
are constructible, it suffices to deal with the case $n = 1$,
i.e., when $T = D(f) \cap V(g_1, \ldots, g_m)$.

\medskip\noindent
Note that if $c \in R$, then we have
$$
\Spec(R) =
V(c) \amalg D(c) =
\Spec(R/(c)) \amalg \Spec(R_c),
$$
and correspondingly $\Spec(R[x]) =
V(c) \amalg D(c) = \Spec(R/(c)[x]) \amalg
\Spec(R_c[x])$. The intersection of $T = D(f) \cap V(g_1, \ldots, g_m)$
with each part still has the same shape, with $f$, $g_i$ replaced
by their images in $R/(c)[x]$, respectively $R_c[x]$.
Note that the image of $T$
in $\Spec(R)$ is the union of the image of
$T \cap V(c)$ and $T \cap D(c)$. Using Lemmas \ref{lemma-open-fp}
and \ref{lemma-closed-fp} it suffices to prove the images of both
parts are constructible in $\Spec(R/(c))$, respectively
$\Spec(R_c)$.

\medskip\noindent
Let us assume we have $T = D(f) \cap V(g_1, \ldots, g_m)$
as above, with $\deg(g_1) \leq \deg(g_2) \leq \ldots \leq \deg(g_m)$.
We are going to use induction on $m$, and on the
degrees of the $g_i$. Let $d_1 = \deg(g_1)$, i.e., $g_1 = c x^{d_1} + l.o.t$
with $c \in R$ not zero. Cutting $R$ up into the pieces
$R/(c)$ and $R_c$ we either lower the degree of $g_1$ (and this
is covered by induction)
or we reduce to the case where $c$ is invertible.
If $c$ is invertible, and $m > 1$, then write
$g_2 = c' x^{d_2} + l.o.t$. In this case consider
$g_2' = g_2 - (c'/c) x^{d_2 - d_1} g_1$. Since the ideals
$(g_1, g_2, \ldots, g_m)$ and $(g_1, g_2', g_3, \ldots, g_m)$
are equal we see that $T = D(f) \cap V(g_1, g_2', g_3\ldots, g_m)$.
But here the degree of $g_2'$ is strictly less than the degree
of $g_2$ and hence this case is covered by induction.

\medskip\noindent
The bases case for the induction above are the cases
(a) $T = D(f) \cap V(g)$ where the leading coefficient
of $g$ is invertible, and (b) $T = D(f)$. These two cases
are dealt with in Lemmas \ref{lemma-affineline-special}
and \ref{lemma-affineline-open}.
\end{proof}











\section{More on images}
\label{section-more-images}

\noindent
In this section we collect a few additional lemmas concerning the image
on $\Spec$ for ring maps. See also Section \ref{section-going-up}
for example.

\begin{lemma}
\label{lemma-generic-finite-presentation}
Let $R \subset S$ be an inclusion of domains.
Assume that $R \to S$ is of finite type.
There exists a nonzero $f \in R$, and a nonzero $g \in S$
such that $R_f \to S_{fg}$ is of finite presentation.
\end{lemma}

\begin{proof}
By induction on the number of generators of $S$ over $R$.
During the proof we may replace $R$ by $R_f$ and $S$ by $S_f$
for some nonzero $f \in R$.

\medskip\noindent
Suppose that $S$ is generated by a single element
over $R$. Then $S = R[x]/\mathfrak q$ for some
prime ideal $\mathfrak q \subset R[x]$. If $\mathfrak q = (0)$
there is nothing to prove. If $\mathfrak q \not = (0)$,
then let $h \in \mathfrak q$ be a nonzero element with minimal
degree in $x$. Write $h = f x^d + a_{d - 1} x^{d - 1} + \ldots + a_0$
with $a_i \in R$ and $f \not = 0$. After inverting $f$
in $R$ and $S$ we may assume that $h$ is monic. We obtain
a surjective $R$-algebra map $R[x]/(h) \to S$.
We have $R[x]/(h) = R \oplus Rx \oplus \ldots \oplus Rx^{d - 1}$
as an $R$-module and by minimality of $d$ we see that
$R[x]/(h)$ maps injectively into $S$. Thus $R[x]/(h) \cong S$
is finitely presented over $R$.

\medskip\noindent
Suppose that $S$ is generated by $n > 1$ elements over $R$.
Say $x_1, \ldots, x_n \in S$ generate $S$. Denote $S' \subset S$
the subring generated by $x_1, \ldots, x_{n-1}$. By induction
hypothesis we see that there exist $f\in R$ and $g \in S'$
nonzero such that $R_f \to S'_{fg}$ is of finite presentation.
Next we apply the induction hypothesis to $S'_{fg} \to S_{fg}$
to see that there exist $f' \in S'_{fg}$ and
$g' \in S_{fg}$ such that $S'_{fgf'} \to S_{fgf'g'}$
is of finite presentation. We leave it to the reader to conclude.
\end{proof}

\begin{lemma}
\label{lemma-characterize-image-finite-type}
Let $R \to S$ be a finite type ring map.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \Spec(S)$ be a
constructible set.
If a point $\xi \in X$ is in $f(E)$, then
$\overline{\{\xi\}} \cap f(E)$ contains an open
dense subset of $\overline{\{\xi\}}$.
\end{lemma}

\begin{proof}
Let $\xi \in X$ be a point of $f(E)$. Choose a point $\eta \in E$
mapping to $\xi$. Let $\mathfrak p \subset R$ be the prime
corresponding to $\xi$ and let $\mathfrak q \subset S$ be the
prime corresponding to $\eta$. Consider the diagram
$$
\xymatrix{
\eta \ar[r] \ar@{|->}[d] & E \cap Y' \ar[r] \ar[d] &
Y' = \Spec(S/\mathfrak q) \ar[r] \ar[d] &
Y \ar[d] \\
\xi \ar[r] & f(E) \cap X' \ar[r] &
X' = \Spec(R/\mathfrak p) \ar[r] &
X
}
$$
By Lemma \ref{lemma-affine-map-quasi-compact} the set $E \cap Y'$
is constructible in $Y'$.
It follows that we may replace $X$ by $X'$ and
$Y$ by $Y'$. Hence we may assume that $R \subset S$ is an
inclusion of domains, $\xi$ is the generic
point of $X$, and $\eta$ is the generic point of $Y$.
By Lemma \ref{lemma-generic-finite-presentation}
combined with Chevalley's theorem
(Theorem \ref{theorem-chevalley})
we see that there exist dense opens $U \subset X$,
$V \subset Y$ such that $f(V) \subset U$ and
such that $f : V \to U$ maps constructible sets
to constructible sets. Note that $E \cap V$ is
constructible in $V$, see Topology,
Lemma \ref{topology-lemma-open-immersion-constructible-inverse-image}.
Hence $f(E \cap V)$ is constructible in $U$ and contains $\xi$.
By Topology, Lemma \ref{topology-lemma-generic-point-in-constructible}
we see that $f(E \cap V)$ contains a dense open $U' \subset U$.
\end{proof}

\noindent
At the end of this section we present a few more results on
images of maps on Spectra that have nothing to do with constructible
sets.

\begin{lemma}
\label{lemma-surjective-spec-radical-ideal}
Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The map $\Spec(S) \to \Spec(R)$ is surjective.
\item For any ideal $I \subset R$
the inverse image of $\sqrt{IS}$ in $R$ is equal to $\sqrt{I}$.
\item For any radical ideal $I \subset R$ the inverse image
of $IS$ in $R$ is equal to $I$.
\item For every prime $\mathfrak p$ of $R$ the inverse
image of $\mathfrak p S$ in $R$ is $\mathfrak p$.
\end{enumerate}
In this case the same is true after any base change: Given a ring map
$R \to R'$ the ring map $R' \to R' \otimes_R S$ has the equivalent
properties (1), (2), (3) as well.
\end{lemma}

\begin{proof}
If $J \subset S$ is an ideal, then
$\sqrt{\varphi^{-1}(J)} = \varphi^{-1}(\sqrt{J})$. This shows that (2)
and (3) are equivalent.
The implication (3) $\Rightarrow$ (4) is immediate.
If $I \subset R$ is a radical ideal, then
Lemma \ref{lemma-Zariski-topology}
guarantees that $I = \bigcap_{I \subset \mathfrak p} \mathfrak p$.
Hence (4) $\Rightarrow$ (2). By
Lemma \ref{lemma-in-image}
we have $\mathfrak p = \varphi^{-1}(\mathfrak p S)$ if and only if
$\mathfrak p$ is in the image. Hence (1) $\Leftrightarrow$ (4).
Thus (1), (2), (3), and (4) are equivalent.

\medskip\noindent
Assume (1) holds. Let $R \to R'$ be a ring map. Let
$\mathfrak p' \subset R'$ be a prime ideal lying over the prime
$\mathfrak p$ of $R$. To see that $\mathfrak p'$ is in the image
of $\Spec(R' \otimes_R S) \to \Spec(R')$ we have to show
that $(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p')$ is not zero, see
Lemma \ref{lemma-in-image}.
But we have
$$
(R' \otimes_R S) \otimes_{R'} \kappa(\mathfrak p') =
S \otimes_R \kappa(\mathfrak p)
\otimes_{\kappa(\mathfrak p)} \kappa(\mathfrak p')
$$
which is not zero as $S \otimes_R \kappa(\mathfrak p)$ is not zero
by assumption and $\kappa(\mathfrak p) \to \kappa(\mathfrak p')$ is
an extension of fields.
\end{proof}

\begin{lemma}
\label{lemma-domain-image-dense-set-points-generic-point}
Let $R$ be a domain. Let $\varphi : R \to S$ be a ring map.
The following are equivalent:
\begin{enumerate}
\item The ring map $R \to S$ is injective.
\item The image $\Spec(S) \to \Spec(R)$
contains a dense set of points.
\item There exists a prime ideal $\mathfrak q \subset S$
whose inverse image in $R$ is $(0)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $K$ be the field of fractions of the domain $R$.
Assume that $R \to S$ is injective. Since localization
is exact we see that $K \to S \otimes_R K$ is injective.
Hence there is a prime mapping to $(0)$ by
Lemma \ref{lemma-in-image}.

\medskip\noindent
Note that $(0)$ is dense in $\Spec(R)$, so that the
last condition implies the second.

\medskip\noindent
Suppose the second condition holds. Let $f \in R$,
$f \not = 0$. As $R$ is a domain we see that $V(f)$
is a proper closed subset of $R$. By assumption
there exists a prime $\mathfrak q$
of $S$ such that $\varphi(f) \not \in \mathfrak q$.
Hence $\varphi(f) \not = 0$.
Hence $R \to S$ is injective.
\end{proof}

\begin{lemma}
\label{lemma-injective-minimal-primes-in-image}
Let $R \subset S$ be an injective ring map.
Then $\Spec(S) \to \Spec(R)$
hits all the minimal primes.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a minimal prime.
In this case $R_{\mathfrak p}$ has a unique prime ideal.
Hence it suffices to show that $S_{\mathfrak p}$ is not zero.
And this follows from the fact that localization is exact,
see Proposition \ref{proposition-localization-exact}.
\end{proof}

\begin{lemma}
\label{lemma-image-dense-generic-points}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item The kernel of $R \to S$ consists of nilpotent elements.
\item The minimal primes of $R$ are in the image of
$\Spec(S) \to \Spec(R)$.
\item The image of $\Spec(S) \to \Spec(R)$ is dense
in $\Spec(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $I = \Ker(R \to S)$. Note that
$\sqrt{(0)} = \bigcap_{\mathfrak q \subset S} \mathfrak q$, see
Lemma \ref{lemma-Zariski-topology}.
Hence $\sqrt{I} = \bigcap_{\mathfrak q \subset S} R \cap \mathfrak q$.
Thus $V(I) = V(\sqrt{I})$ is the closure of the image of
$\Spec(S) \to \Spec(R)$.
This shows that (1) is equivalent to (3). It is clear that
(2) implies (3). Finally, assume (1). We may replace
$R$ by $R/I$ and $S$ by $S/IS$ without affecting the topology
of the spectra and the map. Hence the implication (1) $\Rightarrow$ (2)
follows from Lemma \ref{lemma-injective-minimal-primes-in-image}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-prime-image-minimal-prime}
Let $R \to S$ be a ring map. If a minimal prime $\mathfrak p \subset R$
is in the image of $\Spec(S) \to \Spec(R)$, then it is the image
of a minimal prime.
\end{lemma}

\begin{proof}
Say $\mathfrak p = \mathfrak q \cap R$. Then choose a minimal
prime $\mathfrak r \subset S$ with $\mathfrak r \subset \mathfrak q$, see
Lemma \ref{lemma-Zariski-topology}.
By minimality of $\mathfrak p$ we see that
$\mathfrak p = \mathfrak r \cap R$.
\end{proof}







\section{Noetherian rings}
\label{section-Noetherian}

\noindent
A ring $R$ is {\it Noetherian} if any ideal of $R$ is finitely generated.
This is clearly equivalent to the ascending chain condition for ideals of $R$.
By
Lemma \ref{lemma-cohen}
it suffices to check that every prime ideal of $R$ is finitely generated.

\begin{lemma}
\label{lemma-Noetherian-permanence}
\begin{slogan}
Noetherian property is stable by passage to finite type extension
and localization.
\end{slogan}
Any finitely generated ring over a Noetherian ring
is Noetherian. Any localization of a Noetherian ring
is Noetherian.
\end{lemma}

\begin{proof}
The statement on localizations follows from the fact
that any ideal $J \subset S^{-1}R$ is of the form
$I \cdot S^{-1}R$. Any quotient $R/I$ of a Noetherian
ring $R$ is Noetherian because any ideal $\overline{J} \subset R/I$
is of the form $J/I$ for some ideal $I \subset J \subset R$.
Thus it suffices to show that if $R$ is Noetherian so
is $R[X]$. Suppose $J_1 \subset J_2 \subset \ldots$ is an
ascending chain of ideals in $R[X]$. Consider the ideals $I_{i, d}$
defined as the ideal of elements of $R$ which occur as leading
coefficients of degree $d$ polynomials in $J_i$.
Clearly $I_{i, d} \subset I_{i', d'}$ whenever
$i \leq i'$ and $d \leq d'$. By the ascending chain condition
in $R$ there are at most finitely many distinct ideals among all of
the $I_{i, d}$.
(Hint: Any infinite set of elements of
$\mathbf{N} \times \mathbf{N}$ contains an increasing
infinite sequence.)
Take $i_0$ so large that $I_{i, d} = I_{i_0, d}$
for all $i \geq i_0$ and all $d$. Suppose $f \in J_i$ for some $i \geq i_0$.
By induction on the degree $d = \deg(f)$ we show that $f \in J_{i_0}$.
Namely, there exists a $g\in J_{i_0}$ whose degree is $d$ and which
has the same leading coefficient as $f$. By induction
$f - g \in J_{i_0}$ and we win.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power-series}
If $R$ is a Noetherian ring, then so is the formal power
series ring $R[[x_1, \ldots, x_n]]$.
\end{lemma}

\begin{proof}
Since $R[[x_1, \ldots, x_{n + 1}]] \cong R[[x_1, \ldots, x_n]][[x_{n + 1}]]$
it suffices to prove the statement that $R[[x]]$ is Noetherian if
$R$ is Noetherian. Let $I \subset R[[x]]$ be a ideal.
We have to show that $I$ is a finitely generated ideal.
For each integer
$d$ denote $I_d = \{a \in R \mid ax^d + \text{h.o.t.} \in I\}$.
Then we see that $I_0 \subset I_1 \subset \ldots$ stabilizes as $R$
is Noetherian. Choose $d_0$ such that $I_{d_0} = I_{d_0 + 1} = \ldots$.
For each $d \leq d_0$ choose elements $f_{d, j} \in I \cap (x^d)$,
$j = 1, \ldots, n_d$ such that if we write
$f_{d, j} = a_{d, j}x^d + \text{h.o.t}$ then $I_d = (a_{d, j})$.
Denote $I' = (\{f_{d, j}\}_{d = 0, \ldots, d_0, j = 1, \ldots, n_d})$.
Then it is clear that $I' \subset I$. Pick $f \in I$.
First we may choose $c_{d, i} \in R$ such that
$$
f - \sum c_{d, i} f_{d, i} \in (x^{d_0 + 1}) \cap I.
$$
Next, we can choose $c_{i, 1} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i} \in (x^{d_0 + 2}) \cap I.
$$
Next, we can choose $c_{i, 2} \in R$, $i = 1, \ldots, n_{d_0}$ such that
$$
f - \sum c_{d, i} f_{d, i} - \sum c_{i, 1}xf_{d_0, i}
- \sum c_{i, 2}x^2f_{d_0, i}
\in (x^{d_0 + 3}) \cap I.
$$
And so on. In the end we see that
$$
f = \sum c_{d, i} f_{d, i} +
\sum\nolimits_i (\sum\nolimits_e c_{i, e} x^e)f_{d_0, i}
$$
is contained in $I'$ as desired.
\end{proof}

\noindent
The following lemma, although easy, is useful because
finite type $\mathbf{Z}$-algebras come up quite often in
a technique called ``absolute Noetherian reduction''.

\begin{lemma}
\label{lemma-obvious-Noetherian}
Any finite type algebra over a field is Noetherian.
Any finite type algebra over $\mathbf{Z}$ is Noetherian.
\end{lemma}

\begin{proof}
This is immediate from Lemma \ref{lemma-Noetherian-permanence}
and the fact that fields are Noetherian rings and that
$\mathbf{Z}$ is Noetherian ring (because it is a
principal ideal domain).
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-finite-type-is-finite-presentation}
Let $R$ be a Noetherian ring.
\begin{enumerate}
\item Any finite $R$-module is of finite presentation.
\item Any submodule of a finite $R$-module is finite.
\item Any finite type $R$-algebra is of finite presentation over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $M$ be a finite $R$-module. By
Lemma \ref{lemma-trivial-filter-finite-module}
we can find a finite filtration of $M$ whose successive quotients are
of the form $R/I$. Since any ideal is finitely generated, each of
the quotients $R/I$ is finitely presented. Hence $M$ is finitely
presented by
Lemma \ref{lemma-extension}.
This proves (1).

\medskip\noindent
Let $N \subset M$ be a submodule. As $M$ is finite, the quotient
$M/N$ is finite. Thus $M/N$ is of finite presentation by part (1).
Thus we see that $N$ is finite by Lemma \ref{lemma-extension} part (5).
This proves part (2).

\medskip\noindent
To see (3) note that any ideal of
$R[x_1, \ldots, x_n]$ is finitely generated by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-topology}
If $R$ is a Noetherian ring then $\Spec(R)$
is a Noetherian topological space, see Topology,
Definition \ref{topology-definition-noetherian}.
\end{lemma}

\begin{proof}
This is because any closed subset of $\Spec(R)$
is uniquely of the form $V(I)$ with $I$ a radical ideal,
see Lemma \ref{lemma-Zariski-topology}.
And this correspondence is inclusion reversing.
Thus the result follows from the definitions.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-irreducible-components}
\begin{slogan}
A Noetherian affine scheme has finitely many generic points.
\end{slogan}
If $R$ is a Noetherian ring then $\Spec(R)$
has finitely many irreducible components. In other words
$R$ has finitely many minimal primes.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-Noetherian-topology} and
Topology, Lemma \ref{topology-lemma-Noetherian}
we see there are finitely many irreducible components.
By Lemma \ref{lemma-irreducible} these correspond to
minimal primes of $R$.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-base-change-finite-type}
Let $R \to S$ be a ring map. Let $R \to R'$ be of finite type.
If $S$ is Noetherian, then the base change $S' = R' \otimes_R S$
is Noetherian.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-base-change-finiteness} finite type is stable under
base change. Thus $S \to S'$ is of finite type. Since $S$ is Noetherian we
can apply Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-field-extension}
Let $k$ be a field and let $R$ be a Noetherian $k$-algebra.
If $K/k$ is a finitely generated field extension then
$K \otimes_k R$ is Noetherian.
\end{lemma}

\begin{proof}
Since $K/k$ is a finitely generated field extension, there exists
a finitely generated $k$-algebra $B \subset K$ such that $K$ is
the fraction field of $B$. In other words, $K = S^{-1}B$
with $S = B \setminus \{0\}$. Then $K \otimes_k R = S^{-1}(B \otimes_k R)$.
Then $B \otimes_k R$ is Noetherian by
Lemma \ref{lemma-Noetherian-base-change-finite-type}.
Finally, $K \otimes_k R = S^{-1}(B \otimes_k R)$ is Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
\end{proof}

\noindent
Here are some fun lemmas that are sometimes useful.

\begin{lemma}
\label{lemma-subring-of-local-ring}
Let $R$ be a ring and $\mathfrak p \subset R$ be a prime.
There exists an $f \in R$, $f \not \in \mathfrak p$ such
that $R_f \to R_\mathfrak p$ is injective in each of the
following cases
\begin{enumerate}
\item $R$ is a domain,
\item $R$ is Noetherian, or
\item $R$ is reduced and has finitely many minimal primes.
\end{enumerate}
\end{lemma}

\begin{proof}
If $R$ is a domain, then $R \subset R_\mathfrak p$, hence $f = 1$ works.
If $R$ is Noetherian, then the kernel $I$ of $R \to R_\mathfrak p$
is a finitely generated ideal and we can find
$f \in R$, $f \not \in \mathfrak p$ such that $IR_f = 0$.
For this $f$ the map $R_f \to R_\mathfrak p$ is injective
and $f$ works. If $R$ is reduced with finitely
many minimal primes $\mathfrak p_1, \ldots, \mathfrak p_n$,
then we can choose
$f \in \bigcap_{\mathfrak p_i \not \subset \mathfrak p} \mathfrak p_i$,
$f \not \in \mathfrak p$. Indeed, if $\mathfrak{p}_i\not\subset
\mathfrak{p}$ then there exist $f_i \in \mathfrak{p}_i$,
$f_i \not\in \mathfrak{p}$ and $f = \prod f_i$ works.
For this $f$ we have $R_f \subset R_\mathfrak p$ because the minimal
primes of $R_f$ correspond to minimal primes of $R_\mathfrak p$
and we can apply Lemma \ref{lemma-reduced-ring-sub-product-fields}
(some details omitted).
\end{proof}

\begin{lemma}
\label{lemma-surjective-endo-noetherian-ring-is-iso}
Any surjective endomorphism of a Noetherian ring is an isomorphism.
\end{lemma}

\begin{proof}
If $f : R \to R$ were such an endomorphism but not injective, then
$$
\Ker(f) \subset \Ker(f \circ f) \subset
\Ker(f \circ f \circ f) \subset \ldots
$$
would be a strictly increasing chain of ideals.
\end{proof}







\section{Locally nilpotent ideals}
\label{section-locally-nilpotent}

\noindent
Here is the definition.

\begin{definition}
\label{definition-locally-nilpotent-ideal}
Let $R$ be a ring. Let $I \subset R$ be an ideal.
We say $I$ is {\it locally nilpotent} if for every
$x \in I$ there exists an $n \in \mathbf{N}$ such
that $x^n = 0$. We say $I$ is {\it nilpotent} if
there exists an $n \in \mathbf{N}$ such that $I^n = 0$.
\end{definition}

\begin{example}
\label{example-locally-nilpotent-not-nilpotent}
Let $R = k[x_n | n \in \mathbf{N}]$ be the polynomial ring in infinitely
many variables over a field $k$. Let $I$ be the ideal generated by
the elements $x_n^n$ for $n \in \mathbf{N}$ and $S = R/I$. Then the ideal
$J \subset S$ generated by the images of $x_n$, $n \in \mathbf{N}$
is locally nilpotent, but not nilpotent. Indeed, since $S$-linear
combinations of nilpotents are nilpotent, to prove that $J$ is locally
nilpotent it is enough to observe that all its generators are nilpotent
(which they obviously are). On the other hand, for each $n \in \mathbf{N}$
it holds that $x_{n + 1}^n \not \in I$, so that $J^n \not = 0$.
It follows that $J$ is not nilpotent.
\end{example}

\begin{lemma}
\label{lemma-locally-nilpotent}
Let $R \to R'$ be a ring map and let $I \subset R$ be a locally nilpotent
ideal. Then $IR'$ is a locally nilpotent ideal of $R'$.
\end{lemma}

\begin{proof}
This follows from the fact that if $x, y \in R'$ are nilpotent, then
$x + y$ is nilpotent too. Namely, if $x^n = 0$ and $y^m = 0$, then
$(x + y)^{n + m - 1} = 0$.
\end{proof}

\begin{lemma}
\label{lemma-locally-nilpotent-unit}
Let $R$ be a ring and let $I \subset R$ be a locally nilpotent
ideal.
An element $x$ of $R$ is a unit if and only if the image of $x$
in $R/I$ is a unit.
\end{lemma}

\begin{proof}
If $x$ is a unit in $R$, then its image is clearly a unit in $R/I$.
It remains to prove the converse.
Assume the image of $y \in R$ in $R/I$ is the inverse of the image of $x$.
Then $xy = 1 - z$ for some $z \in I$.
This means that $1\equiv z$ modulo $xR$.
Since $z$ lies in the locally nilpotent ideal
$I$, we have $z^N = 0$ for some sufficiently large $N$.
It follows that $1 = 1^N \equiv z^N = 0$ modulo $xR$.
In other words, $x$ divides $1$ and is hence a unit.
\end{proof}

\begin{lemma}
\label{lemma-Noetherian-power}
\begin{slogan}
An ideal in a Noetherian ring is nilpotent if each element
of the ideal is nilpotent.
\end{slogan}
Let $R$ be a Noetherian ring. Let $I, J$ be ideals of $R$.
Suppose $J \subset \sqrt{I}$. Then $J^n \subset I$ for some $n$.
In particular, in a Noetherian ring the notions of
``locally nilpotent ideal''
and ``nilpotent ideal'' coincide.
\end{lemma}

\begin{proof}
Say $J = (f_1, \ldots, f_s)$.
By assumption $f_i^{d_i} \in I$.
Take $n = d_1 + d_2 + \ldots + d_s + 1$.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Then $R \to R/I$ induces a bijection on idempotents.
\end{lemma}

\begin{proof}[First proof of Lemma \ref{lemma-lift-idempotents}]
As $I$ is locally nilpotent it is contained in every prime ideal.
Hence $\Spec(R/I) = V(I) = \Spec(R)$. Hence the
lemma follows from Lemma \ref{lemma-disjoint-decomposition}.
\end{proof}

\begin{proof}[Second proof of Lemma \ref{lemma-lift-idempotents}]
Suppose $\overline{e} \in R/I$ is an idempotent.
We have to lift $\overline{e}$ to an idempotent of $R$.

\medskip\noindent
First, choose any lift $f \in R$ of $\overline{e}$, and set
$x = f^2 - f$. Then, $x \in I$, so $x$ is nilpotent (since $I$
is locally nilpotent). Let now $J$ be the ideal of $R$ generated
by $x$. Then, $J$ is nilpotent (not just locally nilpotent),
since it is generated by the nilpotent $x$.

\medskip\noindent
Now, assume that we have found a lift $e \in R$ of $\overline{e}$
such that $e^2 - e \in J^k$ for some $k \geq 1$.
Let $e' = e - (2e - 1)(e^2 - e) = 3e^2 - 2e^3$, which is another
lift of $\overline{e}$ (since the idempotency of $\overline{e}$
yields $e^2 - e \in I$). Then
$$
(e')^2 - e' = (4e^2 - 4e - 3)(e^2 - e)^2 \in J^{2k}
$$
by a simple computation.

\medskip\noindent
We thus have started with a lift $e$ of $\overline{e}$ such
that $e^2 - e \in J^k$, and obtained a lift $e'$ of
$\overline{e}$ such that $(e')^2 - e' \in J^{2k}$.
This way we can successively improve the approximation
(starting with $e = f$, which fits the bill for $k = 1$).
Eventually, we reach a stage where $J^k = 0$, and at that
stage we have a lift $e$ of $\overline{e}$ such that
$e^2 - e \in J^k = 0$, that is, this $e$ is idempotent.

\medskip\noindent
We thus have seen that if $\overline{e} \in R/I$ is any
idempotent, then there exists a lift of $\overline{e}$
which is an idempotent of $R$.
It remains to prove that this lift is unique. Indeed, let
$e_1$ and $e_2$ be two such lifts. We
need to show that $e_1 = e_2$.

\medskip\noindent
By definition of $e_1$ and $e_2$, we have $e_1 \equiv e_2
\mod I$, and both $e_1$ and $e_2$ are idempotent. From
$e_1 \equiv e_2 \mod I$, we see that $e_1 - e_2 \in I$,
so that $e_1 - e_2$ is nilpotent (since $I$ is locally nilpotent).
A straightforward
computation (using the idempotency of $e_1$ and $e_2$)
reveals that $(e_1 - e_2)^3 = e_1 - e_2$. Using this and
induction, we obtain $(e_1 - e_2)^k = e_1 - e_2$ for any
positive odd integer $k$. Since all high enough $k$ satisfy
$(e_1 - e_2)^k = 0$ (since $e_1 - e_2$ is nilpotent),
this shows $e_1 - e_2 = 0$, so that $e_1 = e_2$, which
completes our proof.
\end{proof}

\begin{lemma}
\label{lemma-lift-idempotents-noncommutative}
Let $A$ be a possibly noncommutative algebra.
Let $e \in A$ be an element such that $x = e^2 - e$ is nilpotent.
Then there exists an idempotent of the form
$e' = e + x(\sum a_{i, j}e^ix^j) \in A$
with $a_{i, j} \in \mathbf{Z}$.
\end{lemma}

\begin{proof}
Consider the ring $R_n = \mathbf{Z}[e]/((e^2 - e)^n)$. It is clear that
if we can prove the result for each $R_n$ then the lemma follows.
In $R_n$ consider the ideal $I = (e^2 - e)$ and apply
Lemma \ref{lemma-lift-idempotents}.
\end{proof}

\begin{lemma}
\label{lemma-lift-nth-roots}
Let $R$ be a ring. Let $I \subset R$ be a locally nilpotent ideal.
Let $n \geq 1$ be an integer which is invertible in $R/I$. Then
\begin{enumerate}
\item the $n$th power map $1 + I \to 1 + I$, $1 + x \mapsto (1 + x)^n$
is a bijection,
\item a unit of $R$ is a $n$th power if and only if its image in $R/I$
is an $n$th power.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $a \in R$ be a unit whose image in $R/I$ is the same as the image
of $b^n$ with $b \in R$. Then $b$ is a unit
(Lemma \ref{lemma-locally-nilpotent-unit}) and
$ab^{-n} = 1 + x$ for some $x \in I$. Hence $ab^{-n} = c^n$ by
part (1). Thus (2) follows from (1).

\medskip\noindent
Proof of (1). This is true because there is an inverse to the
map $1 + x \mapsto (1 + x)^n$. Namely, we can consider the map
which sends $1 + x$ to
\begin{align*}
(1 + x)^{1/n}
& =
1 + {1/n \choose 1}x +
{1/n \choose 2}x^2 +
{1/n \choose 3}x^3 + \ldots \\
& =
1 + \frac{1}{n} x + \frac{1 - n}{2n^2}x^2 +
\frac{(1 - n)(1 - 2n)}{6n^3}x^3 + \ldots
\end{align*}
as in elementary calculus. This makes sense because the series is finite
as $x^k = 0$ for all $k \gg 0$ and each coefficient
${1/n \choose k} \in \mathbf{Z}[1/n]$ (details omitted; observe that
$n$ is invertible in $R$ by Lemma \ref{lemma-locally-nilpotent-unit}).
\end{proof}






\section{Curiosity}
\label{section-curiosity}

\noindent
Lemma \ref{lemma-disjoint-implies-product}
explains what happens if $V(I)$ is open for some ideal $I \subset R$.
But what if $\Spec(S^{-1}R)$ is closed in $\Spec(R)$?
The next two lemmas give a partial answer. For more information see
Section \ref{section-pure-ideals}.

\begin{lemma}
\label{lemma-invert-closed-quotient}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$
is closed. Then $S^{-1}R \cong R/I$ for some ideal $I \subset R$.
\end{lemma}

\begin{proof}
Let $I = \Ker(R \to S^{-1}R)$ so that $V(I)$ contains the image.
Say the image is the closed subset $V(I') \subset \Spec(R)$ for
some ideal $I' \subset R$. So $V(I') \subset V(I)$.
For $f \in I'$ we see that $f/1 \in S^{-1}R$
is contained in every prime ideal. Hence $f^n$ maps to zero in $S^{-1}R$
for some $n \geq 1$ (Lemma \ref{lemma-Zariski-topology}).
Hence $V(I') = V(I)$.
Then this implies every $g \in S$ is invertible mod $I$.
Hence we get ring maps $R/I \to S^{-1}R$ and $S^{-1}R \to R/I$.
The first map is injective by choice of $I$.
The second is the map $S^{-1}R \to S^{-1}(R/I) = R/I$ which
has kernel $S^{-1}I$ because localization is exact.
Since $S^{-1}I = 0$ we see also the second map is injective.
Hence $S^{-1}R \cong R/I$.
\end{proof}

\begin{lemma}
\label{lemma-invert-closed-split}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
Assume the image of the map $\Spec(S^{-1}R) \to \Spec(R)$
is closed. If $R$ is Noetherian, or $\Spec(R)$ is a
Noetherian topological space, or $S$ is finitely generated as a monoid,
then $R \cong S^{-1}R \times R'$ for some ring $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-invert-closed-quotient} we have $S^{-1}R \cong R/I$
for some ideal $I \subset R$. By Lemma \ref{lemma-disjoint-implies-product}
it suffices to show that $V(I)$ is open.
If $R$ is Noetherian then $\Spec(R)$ is a Noetherian
topological space, see Lemma \ref{lemma-Noetherian-topology}.
If $\Spec(R)$ is a Noetherian topological space,
then the complement $\Spec(R) \setminus V(I)$ is quasi-compact, see
Topology, Lemma \ref{topology-lemma-Noetherian-quasi-compact}.
Hence there exist finitely many $f_1, \ldots, f_n \in I$ such
that $V(I) = V(f_1, \ldots, f_n)$.
Since each $f_i$ maps to zero in $S^{-1}R$
there exists a $g \in S$ such that $gf_i = 0$ for
$i = 1, \ldots, n$. Hence $D(g) = V(I)$ as desired.
In case $S$ is finitely generated as a monoid, say $S$ is generated
by $g_1, \ldots, g_m$, then $S^{-1}R \cong R_{g_1 \ldots g_m}$
and we conclude that $V(I) = D(g_1 \ldots g_m)$.
\end{proof}














\section{Hilbert Nullstellensatz}
\label{section-nullstellensatz}

\begin{theorem}[Hilbert Nullstellensatz]
\label{theorem-nullstellensatz}
Let $k$ be a field.
\begin{enumerate}
\item
\label{item-finite-kappa}
For any maximal ideal $\mathfrak m \subset k[x_1, \ldots, x_n]$
the field extension $\kappa(\mathfrak m)/k$ is finite.
\item
\label{item-polynomial-ring-Jacobson}
Any radical ideal $I \subset k[x_1, \ldots, x_n]$
is the intersection of maximal ideals containing it.
\end{enumerate}
The same is true in any finite type $k$-algebra.
\end{theorem}

\begin{proof}
It is enough to prove part (\ref{item-finite-kappa}) of
the theorem for the case of a polynomial
algebra $k[x_1, \ldots, x_n]$, because any finitely generated
$k$-algebra is a quotient of such a polynomial algebra.
We prove this by induction on $n$. The case $n = 0$ is clear.
Suppose that $\mathfrak m$ is a maximal ideal in $k[x_1, \ldots, x_n]$.
Let $\mathfrak p \subset k[x_n]$ be the intersection
of $\mathfrak m$ with $k[x_n]$.

\medskip\noindent
If $\mathfrak p \not = (0)$,
then $\mathfrak p$ is maximal and generated by an irreducible
monic polynomial $P$ (because of the Euclidean algorithm
in $k[x_n]$). Then
$k' = k[x_n]/\mathfrak p$ is a finite field extension of $k$
and contained in $\kappa(\mathfrak m)$. In this case
we get a surjection
$$
k'[x_1, \ldots, x_{n-1}]
\to
k'[x_1, \ldots, x_n] =
k' \otimes_k k[x_1, \ldots, x_n]
\longrightarrow
\kappa(\mathfrak m)
$$
and hence we see that $\kappa(\mathfrak m)$ is a finite
extension  of $k'$ by induction hypothesis. Thus $\kappa(\mathfrak m)$
is finite over $k$ as well.

\medskip\noindent
If $\mathfrak p = (0)$ we consider the ring
extension $k[x_n] \subset k[x_1, \ldots, x_n]/\mathfrak m$.
This is a finitely generated ring extension, hence
of finite presentation by
Lemmas \ref{lemma-obvious-Noetherian} and
\ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of $\Spec(k[x_1, \ldots, x_n]/\mathfrak m)$
in $\Spec(k[x_n])$ is constructible by
Theorem \ref{theorem-chevalley}. Since the image
contains $(0)$ we conclude that it contains a standard
open $D(f)$ for some $f\in k[x_n]$ nonzero. Since clearly
$D(f)$ is infinite we get a contradiction with the
assumption that $k[x_1, \ldots, x_n]/\mathfrak m$ is
a field (and hence has a spectrum consisting of one point).

\medskip\noindent
Proof of (\ref{item-polynomial-ring-Jacobson}). Let
$I \subset R$ be a radical ideal, with $R$ of finite type over $k$.
Let $f \in R$, $f \not \in I$. We have to find a maximal ideal
$\mathfrak m \subset R$ with $I \subset \mathfrak m$ and
$f \not \in \mathfrak m$. The ring $(R/I)_f$ is nonzero, since
$1 = 0$ in this ring would mean $f^n \in I$ and since $I$ is
radical this would mean $f \in I$ contrary to our assumption on $f$.
Thus we may choose a maximal ideal $\mathfrak m'$
in $(R/I)_f$, see Lemma \ref{lemma-Zariski-topology}.
Let $\mathfrak m \subset R$
be the inverse image of $\mathfrak m'$ in $R$. We see that
$I \subset \mathfrak m$
and $f \not \in \mathfrak m$. If we show that $\mathfrak m$ is a maximal
ideal of $R$, then we are done. We clearly have
$$
k \subset R/\mathfrak m \subset \kappa(\mathfrak m').
$$
By part (\ref{item-finite-kappa}) the field extension
$\kappa(\mathfrak m')/k$ is finite. Hence
$R/\mathfrak m$ is a field by Fields, Lemma
\ref{fields-lemma-subalgebra-algebraic-extension-field}.
Thus $\mathfrak m$ is maximal and the proof is complete.
\end{proof}

\begin{lemma}
\label{lemma-field-finite-type-over-domain}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is of finite type over $R$,
then there exists an $f \in R$ such that $R_f$ is a field,
and $K/R_f$ is a finite field extension.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-characterize-image-finite-type} there
exist a nonempty open $U \subset \Spec(R)$
contained in the image $\{(0)\}$ of $\Spec(K) \to \Spec(R)$.
Choose $f \in R$, $f \not = 0$ such that $D(f) \subset U$, i.e.,
$D(f) = \{(0)\}$. Then $R_f$ is a domain whose spectrum has exactly one
point and $R_f$ is a field. Then $K$ is a finitely generated algebra
over the field $R_f$ and hence a finite field extension of
$R_f$ by the Hilbert Nullstellensatz (Theorem \ref{theorem-nullstellensatz}).
\end{proof}





















\section{Jacobson rings}
\label{section-ring-jacobson}

\noindent
Let $R$ be a ring. The closed points of $\Spec(R)$ are the
maximal ideals of $R$. Often rings which occur naturally in algebraic
geometry have lots of maximal ideals. For example finite type algebras
over a field or over $\mathbf{Z}$. We will show that these
are examples of Jacobson rings.

\begin{definition}
\label{definition-ring-jacobson}
Let $R$ be a ring. We say that $R$ is a
{\it Jacobson ring} if every radical
ideal $I$ is the intersection of the
maximal ideals containing it.
\end{definition}

\begin{lemma}
\label{lemma-finite-type-field-Jacobson}
Any algebra of finite type over a field is Jacobson.
\end{lemma}

\begin{proof}
This follows from Theorem \ref{theorem-nullstellensatz}
and Definition \ref{definition-ring-jacobson}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson-prime}
Let $R$ be a ring. If every prime ideal of $R$ is the
intersection of the maximal ideals containing it,
then $R$ is Jacobson.
\end{lemma}

\begin{proof}
This is immediately clear from the fact that
every radical ideal $I \subset R$ is the
intersection of the primes containing it.
See Lemma \ref{lemma-Zariski-topology}.
\end{proof}

\begin{lemma}
\label{lemma-jacobson}
A ring $R$ is Jacobson if and only if $\Spec(R)$
is Jacobson, see Topology,
Definition \ref{topology-definition-space-jacobson}.
\end{lemma}

\begin{proof}
Suppose $R$ is Jacobson. Let $Z \subset \Spec(R)$
be a closed subset. We have to show that the set of closed
points in $Z$ is dense in $Z$. Let $U \subset \Spec(R)$
be an open such that $U \cap Z$ is nonempty.
We have to show $Z \cap U$ contains a closed point
of $\Spec(R)$. We may
assume $U = D(f)$ as standard opens form a basis for the
topology on $\Spec(R)$. According to
Lemma \ref{lemma-Zariski-topology} we may assume that
$Z = V(I)$, where $I$ is a radical ideal. We see also
that $f \not \in I$. By assumption, there exists a
maximal ideal $\mathfrak m \subset R$ such that
$I \subset \mathfrak m$ but $f \not\in \mathfrak m$.
Hence $\mathfrak m \in D(f) \cap V(I) = U \cap Z$ as desired.

\medskip\noindent
Conversely, suppose that $\Spec(R)$ is Jacobson.
Let $I \subset R$ be a radical ideal. Let
$J = \cap_{I \subset \mathfrak m} \mathfrak m$
be the intersection of the maximal ideals containing $I$.
Clearly $J$ is a radical ideal, $V(J) \subset V(I)$, and
$V(J)$ is the smallest closed subset of $V(I)$ containing
all the closed points of $V(I)$. By assumption we see that
$V(J) = V(I)$. But Lemma \ref{lemma-Zariski-topology}
shows there is a bijection between Zariski closed
sets and radical ideals, hence $I = J$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-characterize-jacobson}
Let $R$ be a ring. If $R$ is not Jacobson there exist
a prime $\mathfrak p \subset R$, an element $f \in R$
such that the following hold
\begin{enumerate}
\item $\mathfrak p$ is not a maximal ideal,
\item $f \not \in \mathfrak p$,
\item $V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, and
\item $(R/\mathfrak p)_f$ is a field.
\end{enumerate}
On the other hand, if $R$ is Jacobson, then for any pair $(\mathfrak p, f)$
such that (1) and (2) hold the set $V(\mathfrak p) \cap D(f)$ is
infinite.
\end{lemma}

\begin{proof}
Assume $R$ is not Jacobson.
By Lemma \ref{lemma-jacobson} this means there exists an
closed subset $T \subset \Spec(R)$
whose set $T_0 \subset T$ of closed points is not dense in $T$.
Choose an $f \in R$ such that $T_0 \subset V(f)$ but
$T \not \subset V(f)$. Note that $T \cap D(f)$
is homeomorphic to $\Spec((R/I)_f)$ if $T = V(I)$, see
Lemmas \ref{lemma-spec-closed} and \ref{lemma-standard-open}.
As any ring has a maximal ideal
(Lemma \ref{lemma-Zariski-topology}) we can choose a closed point $t$ of
space $T \cap D(f)$. Then $t$ corresponds to a prime ideal
$\mathfrak p \subset R$ which is not maximal (as $t \not \in T_0$).
Thus (1) holds. By construction $f \not \in \mathfrak p$, hence (2).
As $t$ is a closed point of $T \cap D(f)$ we see that
$V(\mathfrak p) \cap D(f) = \{\mathfrak p\}$, i.e., (3) holds. Hence we
conclude that $(R/\mathfrak p)_f$ is a domain whose
spectrum has one point, hence (4) holds
(for example combine Lemmas \ref{lemma-characterize-local-ring} and
\ref{lemma-minimal-prime-reduced-ring}).

\medskip\noindent
Conversely, suppose that $R$ is Jacobson and $(\mathfrak p, f)$
satisfy (1) and (2). If
$V(\mathfrak p) \cap D(f) =
\{\mathfrak p, \mathfrak q_1, \ldots, \mathfrak q_t\}$
then $\mathfrak p \not = \mathfrak q_i$
implies there exists an element $g \in R$ such that $g \not \in \mathfrak p$
but $g \in \mathfrak q_i$ for all $i$. Hence
$V(\mathfrak p) \cap D(fg) = \{\mathfrak p\}$ which
is impossible since each locally closed subset of $\Spec(R)$
contains at least one closed point as $\Spec(R)$ is
a Jacobson topological space.
\end{proof}

\begin{lemma}
\label{lemma-pid-jacobson}
The ring $\mathbf{Z}$ is a Jacobson ring.
More generally, let $R$ be a ring such that
\begin{enumerate}
\item $R$ is a domain,
\item $R$ is Noetherian,
\item any nonzero prime ideal is a maximal ideal, and
\item $R$ has infinitely many maximal ideals.
\end{enumerate}
Then $R$ is a Jacobson ring.
\end{lemma}

\begin{proof}
Let $R$ satisfy (1), (2), (3) and (4). The statement
means that $(0) = \bigcap_{\mathfrak m \subset R} \mathfrak m$.
Since $R$ has infinitely many maximal ideals it suffices to
show that any nonzero $x \in R$ is contained in at most
finitely many maximal ideals, in other words that $V(x)$ is finite.
By Lemma \ref{lemma-spec-closed}
we see that $V(x)$ is homeomorphic to $\Spec(R/xR)$.
By assumption (3) every prime of $R/xR$ is minimal and hence
corresponds to an irreducible component of $\Spec(R/xR)$
(Lemma \ref{lemma-irreducible}).
As $R/xR$ is Noetherian, the topological space $\Spec(R/xR)$
is Noetherian (Lemma \ref{lemma-Noetherian-topology})
and has finitely many irreducible components
(Topology, Lemma \ref{topology-lemma-Noetherian}).
Thus $V(x)$ is finite as desired.
\end{proof}

\begin{example}
\label{example-infinite-product-fields-jacobson}
Let $A$ be an infinite set.
For each $\alpha \in A$, let $k_\alpha$ be a field.
We claim that $R = \prod_{\alpha\in A} k_\alpha$ is Jacobson.
First, note that any element $f \in R$ has the form
$f = ue$, with $u \in R$ a unit and $e\in R$ an idempotent
(left to the reader).
Hence $D(f) = D(e)$, and $R_f = R_e = R/(1-e)$ is a quotient of $R$.
Actually, any ring with this property is Jacobson.
Namely, say $\mathfrak p \subset R$ is a prime ideal
and $f \in R$, $f \not \in \mathfrak p$. We have to find
a maximal ideal $\mathfrak m$ of $R$ such that
$\mathfrak p \subset \mathfrak m$ and $f \not\in \mathfrak m$.
Because $R_f$ is a quotient of $R$ we see that any maximal
ideal of $R_f$ corresponds to a maximal ideal of $R$
not containing $f$. Hence the result follows
by choosing a maximal ideal of $R_f$ containing $\mathfrak p R_f$.
\end{example}

\begin{example}
\label{example-not-jacobson}
A domain $R$ with finitely many maximal ideals
$\mathfrak m_i$, $i = 1, \ldots, n$ is not a
Jacobson ring, except when it is a field.
Namely, in this case $(0)$ is not the intersection
of the maximal ideals $(0) \not =
\mathfrak m_1 \cap \mathfrak m_2 \cap \ldots \cap \mathfrak m_n
\supset \mathfrak m_1 \cdot \mathfrak m_2 \cdot \ldots
\cdot \mathfrak m_n \not = 0$.
In particular a discrete valuation ring, or any local ring with
at least two prime ideals is not a Jacobson
ring.
\end{example}

\begin{lemma}
\label{lemma-finite-residue-extension-closed}
Let $R \to S$ be a ring map.
Let $\mathfrak m \subset R$ be a maximal ideal.
Let $\mathfrak q \subset S$ be a prime ideal
lying over $\mathfrak m$ such that $\kappa(\mathfrak q)/\kappa(\mathfrak m)$
is an algebraic field extension.
Then $\mathfrak q$ is a maximal ideal of $S$.
\end{lemma}

\begin{proof}
Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak q \ar[r] & \kappa(\mathfrak q) \\
R \ar[r] \ar[u] & R/\mathfrak m \ar[u]
}
$$
We see that $\kappa(\mathfrak m) \subset S/\mathfrak q \subset
\kappa(\mathfrak q)$. Because the field extension
$\kappa(\mathfrak m) \subset \kappa(\mathfrak q)$
is algebraic, any ring between $\kappa(\mathfrak m)$
and $\kappa(\mathfrak q)$ is a field
(Fields, Lemma \ref{fields-lemma-subalgebra-algebraic-extension-field}).
Thus $S/\mathfrak q$ is a field, and a posteriori equal
to $\kappa(\mathfrak q)$.
\end{proof}

\begin{lemma}
\label{lemma-dimension}
Suppose that $k$ is a field and suppose that $V$ is a nonzero vector
space over $k$. Assume the dimension of $V$ (which is a cardinal number)
is smaller than the cardinality of $k$. Then for any linear operator
$T : V \to V$ there exists some monic polynomial $P(t) \in k[t]$ such that
$P(T)$ is not invertible.
\end{lemma}

\begin{proof}
If not then $V$ inherits the structure of a vector space over
the field $k(t)$. But the dimension of $k(t)$ over $k$ is
at least the cardinality of $k$ for example due to the fact that the elements
$\frac{1}{t - \lambda}$ are $k$-linearly independent.
\end{proof}

\noindent
Here is another version of Hilbert's Nullstellensatz.

\begin{theorem}
\label{theorem-uncountable-nullstellensatz}
Let $k$ be a field. Let $S$ be a $k$-algebra generated over $k$
by the elements $\{x_i\}_{i \in I}$. Assume the cardinality of $I$
is smaller than the cardinality of $k$. Then
\begin{enumerate}
\item for all maximal ideals $\mathfrak m \subset S$ the field
extension $\kappa(\mathfrak m)/k$
is algebraic, and
\item $S$ is a Jacobson ring.
\end{enumerate}
\end{theorem}

\begin{proof}
If $I$ is finite then the result follows from the Hilbert Nullstellensatz,
Theorem \ref{theorem-nullstellensatz}. In the rest of the proof we assume
$I$ is infinite. It suffices to prove the result for
$\mathfrak m \subset k[\{x_i\}_{i \in I}]$ maximal in the polynomial
ring on variables $x_i$, since $S$ is a quotient of this.
As $I$ is infinite the set
of monomials $x_{i_1}^{e_1} \ldots x_{i_r}^{e_r}$, $i_1, \ldots, i_r \in I$
and $e_1, \ldots, e_r \geq 0$ has cardinality at most equal to the
cardinality of $I$. Because the cardinality of $I \times \ldots \times I$
is the cardinality of $I$, and also the cardinality of
$\bigcup_{n \geq 0} I^n$ has the same cardinality.
(If $I$ is finite, then this is not true and
in that case this proof only works if $k$ is uncountable.)

\medskip\noindent
To arrive at a contradiction pick $T \in \kappa(\mathfrak m)$ transcendental
over $k$. Note that the $k$-linear map
$T : \kappa(\mathfrak m) \to \kappa(\mathfrak m)$
given by multiplication by $T$ has the property that $P(T)$ is invertible
for all monic polynomials $P(t) \in k[t]$.
Also, $\kappa(\mathfrak m)$ has dimension at most the cardinality of $I$
over $k$ since it is a quotient of the vector space
$k[\{x_i\}_{i \in I}]$ over $k$ (whose dimension is $\# I$ as we saw above).
This is impossible by Lemma \ref{lemma-dimension}.

\medskip\noindent
To show that $S$ is Jacobson we argue as follows. If not then
there exists a prime $\mathfrak q \subset S$ and an element $f \in S$,
$f \not \in \mathfrak q$ such that $\mathfrak q$ is not maximal
and $(S/\mathfrak q)_f$ is a field, see
Lemma \ref{lemma-characterize-jacobson}.
But note that $(S/\mathfrak q)_f$ is generated by at most $\# I + 1$ elements.
Hence the field extension $(S/\mathfrak q)_f/k$ is algebraic
(by the first part of the proof).
This implies that $\kappa(\mathfrak q)$ is an algebraic extension of $k$
hence $\mathfrak q$ is maximal by
Lemma \ref{lemma-finite-residue-extension-closed}. This contradiction
finishes the proof.
\end{proof}

\begin{lemma}
\label{lemma-base-change-Jacobson}
Let $k$ be a field. Let $S$ be a $k$-algebra.
For any field extension $K/k$ whose cardinality is larger
than the cardinality of $S$ we have
\begin{enumerate}
\item for every maximal ideal $\mathfrak m$ of $S_K$ the field
$\kappa(\mathfrak m)$ is algebraic over $K$, and
\item $S_K$ is a Jacobson ring.
\end{enumerate}
\end{lemma}

\begin{proof}
Choose $k \subset K$ such that the cardinality of $K$ is greater
than the cardinality of $S$. Since the elements of $S$ generate
the $K$-algebra $S_K$ we see that
Theorem \ref{theorem-uncountable-nullstellensatz}
applies.
\end{proof}

\begin{example}
\label{example-countable-trick-does-not-work}
The trick in the proof of
Theorem \ref{theorem-uncountable-nullstellensatz}
really does not work if $k$ is a countable field and $I$ is countable too.
Let $k$ be a countable field. Let $x$ be a variable,
and let $k(x)$ be the field of rational functions in $x$.
Consider the polynomial algebra $R = k[x, \{x_f\}_{f \in k[x]-\{0\}}]$.
Let $I = (\{fx_f - 1\}_{f\in k[x] - \{0\}})$. Note that
$I$ is a proper ideal in $R$.
Choose a maximal ideal $I \subset \mathfrak m$.
Then $k \subset R/\mathfrak m$ is isomorphic to
$k(x)$, and is not algebraic over $k$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-invert-element}
Let $R$ be a Jacobson ring. Let $f \in R$. The ring $R_f$ is Jacobson and
maximal ideals of $R_f$ correspond to maximal ideals of $R$ not containing $f$.
\end{lemma}

\begin{proof}
By Topology, Lemma \ref{topology-lemma-jacobson-inherited}
we see that $D(f) = \Spec(R_f)$ is Jacobson and
that closed points of $D(f)$
correspond to closed points in $\Spec(R)$
which happen to lie in $D(f)$. Thus $R_f$ is Jacobson by
Lemma \ref{lemma-jacobson}.
\end{proof}

\begin{example}
\label{example-localize-not-preserve-closed-points}
Here is a simple example that shows Lemma \ref{lemma-Jacobson-invert-element}
to be false if $R$ is not Jacobson.
Consider the ring $R = \mathbf{Z}_{(2)}$, i.e., the localization
of $\mathbf{Z}$ at the prime $(2)$. The localization of $R$ at
the element $2$ is isomorphic to $\mathbf{Q}$, in a formula:
$R_2 \cong \mathbf{Q}$. Clearly the map $R \to R_2$ maps the
closed point of $\Spec(\mathbf{Q})$ to the generic point
of $\Spec(R)$.
\end{example}

\begin{example}
\label{example-infinite-localize-not-preserve-closed-points}
Here is a simple example that shows
Lemma \ref{lemma-Jacobson-invert-element}
is false if $R$ is Jacobson but we localize at infinitely
many elements.
Namely, let $R = \mathbf{Z}$ and consider the localization
$(R \setminus \{0\})^{-1}R \cong \mathbf{Q}$
of $R$ at the set of all nonzero elements.
Clearly the map $\mathbf{Z} \to \mathbf{Q}$ maps the
closed point of $\Spec(\mathbf{Q})$ to the generic point
of $\Spec(\mathbf{Z})$.
\end{example}

\begin{lemma}
\label{lemma-Jacobson-mod-ideal}
Let $R$ be a Jacobson ring. Let $I \subset R$ be an ideal.
The ring $R/I$ is Jacobson and maximal ideals
of $R/I$ correspond to maximal ideals of $R$ containing $I$.
\end{lemma}

\begin{proof}
The proof is the same as the proof of
Lemma \ref{lemma-Jacobson-invert-element}.
\end{proof}

\begin{lemma}
\label{lemma-silly-jacobson}
Let $R$ be a Jacobson ring. Let $K$ be a field. Let $R \subset K$ and
$K$ is of finite type over $R$. Then $R$ is a field and $K/R$
is a finite field extension.
\end{lemma}

\begin{proof}
First note that $R$ is a domain.
By Lemma \ref{lemma-field-finite-type-over-domain}
we see that $R_f$ is a field and $K/R_f$ is a finite field extension
for some nonzero $f \in R$. Hence $(0)$ is a maximal ideal of $R_f$
and by
Lemma \ref{lemma-Jacobson-invert-element}
we conclude $(0)$ is a maximal ideal of $R$.
\end{proof}

\begin{proposition}
\label{proposition-Jacobson-permanence}
Let $R$ be a Jacobson ring. Let $R \to S$ be a
ring map of finite type. Then
\begin{enumerate}
\item The ring $S$ is Jacobson.
\item The map $\Spec(S) \to \Spec(R)$ transforms
closed points to closed points.
\item For $\mathfrak m' \subset S$ maximal lying over $\mathfrak m \subset R$
the field extension $\kappa(\mathfrak m')/\kappa(\mathfrak m)$
is finite.
\end{enumerate}
\end{proposition}

\begin{proof}
Let $\mathfrak m' \subset S$ be a maximal ideal and
$R \cap \mathfrak m' = \mathfrak m$.
Then $R/\mathfrak m \to S/\mathfrak m'$ satisfies
the conditions of Lemma \ref{lemma-silly-jacobson}
by Lemma \ref{lemma-Jacobson-mod-ideal}.
Hence $R/\mathfrak m$ is a field and
$\mathfrak m$ a maximal ideal and the induced
residue field extension is finite. This proves (2) and (3).  

\medskip\noindent
If $S$ is not Jacobson, then by Lemma \ref{lemma-characterize-jacobson} there
exists a non-maximal prime ideal $\mathfrak q$ of $S$ and an
$g \in S$, $g \not\in \mathfrak q$ such that $(S/\mathfrak q)_g$ is a field.
To arrive at a contradiction we show that $\mathfrak q$ is a maximal ideal.
Let $\mathfrak p = \mathfrak q \cap R$. Then
$R/\mathfrak p \to (S/\mathfrak q)_g$ satisfies the conditions of
Lemma \ref{lemma-silly-jacobson} by
Lemma \ref{lemma-Jacobson-mod-ideal}.
Hence $R/\mathfrak p$ is a field and the field extension
$\kappa(\mathfrak p) \to (S/\mathfrak q)_g = \kappa(\mathfrak q)$ is
finite, thus algebraic. Then $\mathfrak q$ is a maximal ideal of $S$ by
Lemma \ref{lemma-finite-residue-extension-closed}. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-corollary-jacobson}
Any finite type algebra over $\mathbf{Z}$ is Jacobson.
\end{lemma}

\begin{proof}
Combine Lemma \ref{lemma-pid-jacobson} and
Proposition \ref{proposition-Jacobson-permanence}.
\end{proof}

\begin{lemma}
\label{lemma-image-finite-type-map-Jacobson-rings}
Let $R \to S$ be a finite type ring map of Jacobson rings.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced
map of spectra. Let $E \subset Y = \Spec(S)$ be a
constructible set. Denote with a subscript ${}_0$ the set
of closed points of a topological space.
\begin{enumerate}
\item We have $f(E)_0 = f(E_0) = X_0 \cap f(E)$.
\item A point $\xi \in X$ is in $f(E)$ if and only if
$\overline{\{\xi\}} \cap f(E_0)$ is dense in $\overline{\{\xi\}}$.
\end{enumerate}
\end{lemma}

\begin{proof}
We have a commutative diagram of continuous maps
$$
\xymatrix{
E \ar[r] \ar[d] & Y \ar[d] \\
f(E) \ar[r] & X
}
$$
Suppose $x \in f(E)$ is closed in $f(E)$. Then $f^{-1}(\{x\})\cap E$
is nonempty and closed in $E$. Applying
Topology, Lemma \ref{topology-lemma-jacobson-inherited}
to both inclusions
$$
f^{-1}(\{x\}) \cap E \subset E \subset Y
$$
we find there exists a point $y \in f^{-1}(\{x\}) \cap E$ which is
closed in $Y$. In other words, there exists $y \in Y_0$ and $y \in E_0$
mapping to $x$. Hence $x \in f(E_0)$.
This proves that $f(E)_0 \subset f(E_0)$.
Proposition \ref{proposition-Jacobson-permanence} implies that
$f(E_0) \subset X_0 \cap f(E)$. The inclusion
$X_0 \cap f(E) \subset f(E)_0$ is trivial. This proves the
first assertion.

\medskip\noindent
Suppose that $\xi \in f(E)$. According to
Lemma \ref{lemma-characterize-image-finite-type}
the set $f(E) \cap \overline{\{\xi\}}$ contains a dense
open subset of $\overline{\{\xi\}}$. Since $X$ is Jacobson
we conclude that $f(E) \cap \overline{\{\xi\}}$ contains a
dense set of closed points, see Topology,
Lemma \ref{topology-lemma-jacobson-inherited}.
We conclude by part (1) of the lemma.

\medskip\noindent
On the other hand, suppose that $\overline{\{\xi\}} \cap f(E_0)$
is dense in $\overline{\{\xi\}}$. By
Lemma \ref{lemma-constructible-is-image}
there exists a ring map $S \to S'$ of finite presentation
such that $E$ is the image of $Y' := \Spec(S') \to Y$.
Then $E_0$ is the image of $Y'_0$ by the first part of the
lemma applied to the ring map $S \to S'$. Thus we may assume that
$E = Y$ by replacing $S$ by $S'$. Suppose $\xi$ corresponds
to $\mathfrak p \subset R$. Consider the diagram
$$
\xymatrix{
S \ar[r] & S/\mathfrak p S \\
R \ar[r] \ar[u] & R/\mathfrak p \ar[u]
}
$$
This diagram and the density of $f(Y_0) \cap V(\mathfrak p)$
in $V(\mathfrak p)$
shows that the morphism $R/\mathfrak p \to S/\mathfrak p S$
satisfies condition (2) of
Lemma \ref{lemma-domain-image-dense-set-points-generic-point}.
Hence we conclude
there exists a prime $\overline{\mathfrak q} \subset S/\mathfrak pS$
mapping to $(0)$. In other words the inverse image $\mathfrak q$
of $\overline{\mathfrak q}$ in $S$ maps to $\mathfrak p$ as desired.
\end{proof}

\noindent
The conclusion of the lemma above is that we can read off
the image of $f$ from the set of closed points of the image.
This is a little nicer in case the map is of finite presentation
because then we know that images of a constructible is constructible.
Before we state it we introduce some notation.
Denote $\text{Constr}(X)$ the set of constructible sets.
Let $R \to S$ be a ring map.
Denote $X = \Spec(R)$ and $Y = \Spec(S)$.
Write $f : Y \to X$ the induced map of spectra.
Denote with a subscript ${}_0$ the set
of closed points of a topological space.


\begin{lemma}
\label{lemma-conclude-jacobson-Noetherian}
With notation as above. Assume that $R$ is a Noetherian Jacobson ring.
Further assume $R \to S$ is of finite type.
There is a commutative diagram
$$
\xymatrix{
\text{Constr}(Y) \ar[r]^{E \mapsto E_0} \ar[d]^{E \mapsto f(E)} &
\text{Constr}(Y_0) \ar[d]^{E \mapsto f(E)} \\
\text{Constr}(X) \ar[r]^{E \mapsto E_0} &
\text{Constr}(X_0)
}
$$
where the horizontal arrows are the bijections from
Topology, Lemma \ref{topology-lemma-jacobson-equivalent-constructible}.
\end{lemma}

\begin{proof}
Since $R \to S$ is of finite type, it is of finite presentation,
see Lemma \ref{lemma-Noetherian-finite-type-is-finite-presentation}.
Thus the image of a constructible set in $X$ is constructible
in $Y$ by Chevalley's theorem
(Theorem \ref{theorem-chevalley}).
Combined with
Lemma \ref{lemma-image-finite-type-map-Jacobson-rings}
the lemma follows.
\end{proof}

\noindent
To illustrate the use of Jacobson rings, we give the following two examples.

\begin{example}
\label{example-product-matrices-zero}
Let $k$ be a field. The space $\Spec(k[x, y]/(xy))$
has two irreducible components: namely the $x$-axis and the
$y$-axis. As a generalization, let
$$
R = k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]/
\mathfrak a,
$$
where $\mathfrak a$ is the ideal in
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}]$
generated by the entries of the $2 \times 2$ product matrix
$$
\left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right)
 \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right).
$$
In this example we will describe $\Spec(R)$.

\medskip\noindent
To prove the statement about $\Spec(k[x, y]/(xy))$ we argue as follows.
If $\mathfrak p \subset k[x, y]$ is any ideal containing $xy$, then either
$x$ or $y$ would be contained in $\mathfrak p$. Hence the minimal such
prime ideals are just $(x)$ and $(y)$. In case $k$ is
algebraically closed, the $\text{max-Spec}$ of these components
can then be visualized as the point sets of $y$- and $x$-axis.

\medskip\noindent
For the generalization, note that we may identify the closed
points of the spectrum of
$k[x_{11}, x_{12}, x_{21}, x_{22}, y_{11}, y_{12}, y_{21}, y_{22}])$
with the space of matrices
$$
\left\{ (X, Y) \in \text{Mat}(2, k)\times \text{Mat}(2, k) \mid
X = \left(
\begin{matrix}
x_{11} & x_{12}\\
x_{21} & x_{22}
\end{matrix}
\right),
Y= \left(
\begin{matrix}
y_{11} & y_{12}\\
y_{21} & y_{22}
\end{matrix}
\right)
\right\}
$$
at least if $k$ is algebraically closed.
Now define a group action of
$\text{GL}(2, k)\times \text{GL}(2, k)\times \text{GL}(2, k)$
on the space of matrices $\{(X, Y)\}$ by
$$
(g_1, g_2, g_3) \times (X, Y) \mapsto ((g_1Xg_2^{-1}, g_2Yg_3^{-1})).
$$
Here, also observe that the algebraic set
$$
\text{GL}(2, k)\times \text{GL}(2, k)\times \text{GL}(2, k) \subset
\text{Mat}(2, k)\times \text{Mat}(2, k) \times \text{Mat}(2, k)
$$
is irreducible since it is the max spectrum of the domain
$$
k[x_{11}, x_{12}, \ldots, z_{21}, z_{22}, (x_{11}x_{22}-x_{12}x_{21})^{-1}
, (y_{11}y_{22}-y_{12}y_{21})^{-1}, (z_{11}z_{22}-z_{12}z_{21})^{-1}].
$$
Since the image of irreducible an algebraic set is still
irreducible, it suffices to classify the orbits of the set
$\{(X, Y)\in \text{Mat}(2, k)\times \text{Mat}(2, k)|XY = 0\}$ and take their
closures. From standard linear algebra, we are reduced to the
following three cases:
\begin{enumerate}
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = I_{2\times 2}$.
Then $Y$ is necessarily $0$, which as an algebraic set is
invariant under the group action. It follows that this orbit is
contained in the irreducible algebraic set defined by the prime
ideal $(y_{11}, y_{12}, y_{21}, y_{22})$. Taking the closure, we see
that $(y_{11}, y_{12}, y_{21}, y_{22})$ is actually a component.
\item $\exists (g_1, g_2)$ such that
$$
g_1Xg_2^{-1} = \left(
\begin{matrix}
1 & 0 \\
0 & 0
\end{matrix}
\right).
$$
This case occurs if and only if $X$ is a rank 1 matrix,
and furthermore, $Y$ is killed by such an $X$ if and only if
$$
x_{11}y_{11}+x_{12}y_{21} = 0; \quad x_{11}y_{12}+x_{12}y_{22} = 0;
$$
$$
x_{21}y_{11}+x_{22}y_{21} = 0; \quad x_{21}y_{12}+x_{22}y_{22} = 0.
$$
Fix a rank 1 $X$, such non zero $Y$'s satisfying the above
equations form an irreducible algebraic set for the following
reason($Y = 0$ is contained the previous case):
$0 = g_1Xg_2^{-1}g_2Y$ implies that
$$
g_2Y = \left(
\begin{matrix}
0 & 0 \\
y_{21}' & y_{22}'
\end{matrix}
\right).
$$
With a further $\text{GL}(2, k)$-action on the right by $g_3$,
$g_2Y$ can be brought into
$$
g_2Yg_3^{-1} = \left(
\begin{matrix}
0 & 0 \\
0 & 1
\end{matrix}
\right),
$$
and thus such $Y$'s form an irreducible algebraic set
isomorphic to the image of $\text{GL}(2, k)$ under this action. Finally,
notice that the ``rank 1" condition for $X$'s forms an open dense
subset of the irreducible algebraic set
$\det X = x_{11}x_{22} - x_{12}x_{21} = 0$.
It now follows that all the five equations define an irreducible component
$(x_{11}y_{11}+x_{12}y_{21}, x_{11}y_{12}+x_{12}y_{22}, x_{21}y_{11}
+x_{22}y_{21}, x_{21}y_{12}+x_{22}y_{22}, x_{11}x_{22}-x_{12}x_{21})$
in the open subset of the space of pairs of nonzero matrices.
It can be shown that the pair of equations
$\det X = 0$, $\det Y = 0$ cuts $\Spec(R)$ in an irreducible component
with the above locus an open dense subset.
\item $\exists (g_1, g_2)$ such that $g_1Xg_2^{-1} = 0$, or
equivalently, $X = 0$. Then $Y$ can be arbitrary and this component
is thus defined by $(x_{11}, x_{12}, x_{21}, x_{22})$.
\end{enumerate}
\end{example}


\begin{example}
\label{example-idempotent-matrices}
For another example, consider
$R = k[\{t_{ij}\}_{i, j = 1}^{n}]/\mathfrak a$, where $\mathfrak a$ is
the ideal generated by the entries of the product matrix $T^2-T$,
$T = (t_{ij})$. From linear algebra, we know that under the
$GL(n, k)$-action defined by $g, T \mapsto gTg^{-1}$, $T$ is
classified by the its rank and each $T$ is conjugate to some
$\text{diag}(1, \ldots, 1, 0, \ldots, 0)$, which has $r$ 1's and $n-r$ 0's.
Thus each orbit of such a $\text{diag}(1, \ldots, 1, 0, \ldots, 0)$ under the
group action forms an irreducible component and every idempotent
matrix is contained in one such orbit. Next we will show that any
two different orbits are necessarily disjoint. For this purpose we
only need to cook up polynomial functions that take different
values on different orbits. In characteristic 0 cases, such a
function can be taken to be
$f(t_{ij}) = trace(T) = \sum_{i = 1}^nt_{ii}$. In positive
characteristic cases, things are slightly more tricky since we
might have $trace(T) = 0$ even if $T \neq 0$. For instance, $char = 3$
$$
trace\left(
\begin{matrix}
1 & & \\
& 1 & \\
& & 1
\end{matrix}
\right) = 3 = 0
$$
Anyway, these components can be separated using other functions.
For instance, in the characteristic 3 case, $tr(\wedge^3T)$ takes
value 1 on the components corresponding to $diag(1, 1, 1)$ and 0 on
other components.
\end{example}





































\section{Finite and integral ring extensions}
\label{section-finite-ring-extensions}

\noindent
Trivial lemmas concerning finite and integral ring maps.
We recall the definition.

\begin{definition}
\label{definition-integral-ring-map}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item An element $s \in S$
is {\it integral over $R$} if there exists a monic
polynomial $P(x) \in R[x]$ such that
$P^\varphi(s) = 0$, where $P^\varphi(x) \in S[x]$
is the image of $P$ under $\varphi : R[x] \to S[x]$.
\item  The ring map $\varphi$ is {\it integral}
if every $s \in S$ is integral over $R$.
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-characterize-integral-element}
Let $\varphi : R \to S$ be a ring map. Let $y \in S$. If there exists a
finite $R$-submodule $M$ of $S$ such that $1 \in M$ and $yM \subset M$,
then $y$ is integral over $R$.
\end{lemma}

\begin{proof}
Consider the map $\varphi : M \to M$, $x \mapsto y \cdot x$.
By Lemma \ref{lemma-charpoly-module} there exists a monic polynomial
$P \in R[T]$ with $P(\varphi) = 0$. In the ring $S$ we get
$P(y) = P(y) \cdot 1 = P(\varphi)(1) = 0$.
\end{proof}

\begin{lemma}
\label{lemma-finite-is-integral}
A finite ring map is integral.
\end{lemma}

\begin{proof}
Let $R \to S$ be finite. Let $y \in S$. Apply
Lemma \ref{lemma-characterize-integral-element}
to $M = S$ to see that $y$ is integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-integral}
Let $\varphi : R \to S$ be a ring map. Let $s_1, \ldots, s_n$
be a finite set of elements of $S$.
In this case $s_i$ is integral over $R$ for all $i = 1, \ldots, n$
if and only if
there exists an $R$-subalgebra $S' \subset S$ finite over $R$
containing all of the $s_i$.
\end{lemma}

\begin{proof}
If each $s_i$ is integral, then the subalgebra
generated by $\varphi(R)$ and the $s_i$ is finite
over $R$. Namely, if $s_i$ satisfies a monic equation
of degree $d_i$ over $R$, then this subalgebra is generated as an
$R$-module by the elements $s_1^{e_1} \ldots s_n^{e_n}$
with $0 \leq e_i \leq d_i - 1$.
Conversely, suppose given a finite $R$-subalgebra
$S'$ containing all the $s_i$. Then all of the
$s_i$ are integral by Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-characterize-finite-in-terms-of-integral}
Let $R \to S$ be a ring map. The following are equivalent
\begin{enumerate}
\item $R \to S$ is finite,
\item $R \to S$ is integral and of finite type, and
\item there exist $x_1, \ldots, x_n \in S$ which generate $S$ as an
algebra over $R$ such that each $x_i$ is integral over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Clear from Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-transitive}
\begin{slogan}
A composition of integral ring maps is integral
\end{slogan}
Suppose that $R \to S$ and $S \to T$ are integral
ring maps. Then $R \to T$ is integral.
\end{lemma}

\begin{proof}
Let $t \in T$. Let $P(x) \in S[x]$ be a
monic polynomial such that $P(t) = 0$.
Apply Lemma \ref{lemma-characterize-integral}
to the finite set of coefficients of $P$.
Hence $t$ is integral over some subalgebra
$S' \subset S$ finite over $R$. Apply Lemma
\ref{lemma-characterize-integral} again to find
a subalgebra $T' \subset T$ finite over $S'$ and
containing $t$. Lemma \ref{lemma-finite-transitive}
applied to $R \to S' \to T'$ shows that $T'$ is finite
over $R$. The integrality of $t$ over $R$
now follows from Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-is-ring}
Let $R \to S$ be a ring homomorphism.
The set
$$
S' = \{s \in S \mid s\text{ is integral over }R\}
$$
is an $R$-subalgebra of $S$.
\end{lemma}

\begin{proof}
This is clear from Lemmas \ref{lemma-characterize-integral}
and \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-finite-product-integral}
Let $R_i\to S_i$ be ring maps $i = 1, \ldots, n$.
Let $R$ and $S$ denote the product of the $R_i$ and $S_i$ respectively.
Then an element $s = (s_1, \ldots, s_n) \in S$ is integral over $R$
if and only if each $s_i$ is integral over $R_i$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{definition}
\label{definition-integral-closure}
Let $R \to S$ be a ring map.
The ring $S' \subset S$ of elements integral over
$R$, see Lemma \ref{lemma-integral-closure-is-ring},
is called the {\it integral closure} of $R$
in $S$. If $R \subset S$ we say that $R$ is
{\it integrally closed} in $S$ if $R = S'$.
\end{definition}

\noindent
In particular, we see that $R \to S$ is integral if and only
if the integral closure of $R$ in $S$ is all of $S$.

\begin{lemma}
\label{lemma-finite-product-integral-closure}
Let $R_i\to S_i$ be ring maps $i = 1, \ldots, n$.
Denote the integral closure of $R_i$ in $S_i$ by $S'_i$.
Further let $R$ and $S$ denote the product of the $R_i$ and $S_i$ respectively.
Then the integral closure of $R$ in $S$
is the product of the $S'_i$. In particular $R \to S$ is
integrally closed if and only if each $R_i \to S_i$ is integrally closed.
\end{lemma}

\begin{proof}
This follows immediately from Lemma \ref{lemma-finite-product-integral}.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-localize}
Integral closure commutes with localization: If $A \to B$ is a ring
map, and $S \subset A$ is a multiplicative subset, then the integral
closure of $S^{-1}A$ in $S^{-1}B$ is $S^{-1}B'$, where $B' \subset B$
is the integral closure of $A$ in $B$.
\end{lemma}

\begin{proof}
Since localization is exact we see that $S^{-1}B' \subset S^{-1}B$.
Suppose $x \in B'$ and $f \in S$. Then
$x^d + \sum_{i = 1, \ldots, d} a_i x^{d - i} = 0$
in $B$ for some $a_i \in A$. Hence also
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} a_i/f^i (x/f)^{d - i} = 0
$$
in $S^{-1}B$. In this way we see that $S^{-1}B'$ is contained in
the integral closure of $S^{-1}A$ in $S^{-1}B$. Conversely, suppose
that $x/f \in S^{-1}B$ is integral over $S^{-1}A$. Then we have
$$
(x/f)^d + \sum\nolimits_{i = 1, \ldots, d} (a_i/f_i) (x/f)^{d - i} = 0
$$
in $S^{-1}B$ for some $a_i \in A$ and $f_i \in S$. This means that
$$
(f'f_1 \ldots f_d x)^d +
\sum\nolimits_{i = 1, \ldots, d}
f^i(f')^if_1^i \ldots f_i^{i - 1} \ldots f_d^i a_i
(f'f_1 \ldots f_dx)^{d - i} = 0
$$
for a suitable $f' \in S$. Hence $f'f_1\ldots f_dx \in B'$ and thus
$x/f \in S^{-1}B'$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-stalks}
\begin{slogan}
An element of an algebra over a ring is integral over the ring
if and only if it is locally integral at every prime ideal of the ring.
\end{slogan}
Let $\varphi : R \to S$ be a ring map.
Let $x \in S$. The following are equivalent:
\begin{enumerate}
\item $x$ is integral over $R$, and
\item for every prime ideal $\mathfrak p \subset R$ the element
$x \in S_{\mathfrak p}$ is integral over $R_{\mathfrak p}$.
\end{enumerate}
\end{lemma}

\begin{proof}
It is clear that (1) implies (2). Assume (2). Consider the $R$-algebra
$S' \subset S$ generated by $\varphi(R)$ and $x$. Let $\mathfrak p$ be
a prime ideal of $R$. Then we know that
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_{\mathfrak p}$ for some $a_i \in R_{\mathfrak p}$. Hence we see,
by looking at which denominators occur, that
for some $f \in R$, $f \not \in \mathfrak p$ we have
$a_i \in R_f$ and
$x^d + \sum_{i = 1, \ldots, d} \varphi(a_i) x^{d - i} = 0$
in $S_f$. This implies that $S'_f$ is finite over $R_f$.
Since $\mathfrak p$ was arbitrary and $\Spec(R)$ is quasi-compact
(Lemma \ref{lemma-quasi-compact}) we can find finitely many elements
$f_1, \ldots, f_n \in R$
which generate the unit ideal of $R$ such that $S'_{f_i}$ is finite
over $R_{f_i}$. Hence we conclude from Lemma \ref{lemma-cover} that
$S'$ is finite over $R$. Hence $x$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral}.
\end{proof}

\begin{lemma}
\label{lemma-base-change-integral}
\begin{slogan}
Integrality and finiteness are preserved under base change.
\end{slogan}
Let $R \to S$ and $R \to R'$ be ring maps.
Set $S' = R' \otimes_R S$.
\begin{enumerate}
\item If $R \to S$ is integral so is $R' \to S'$.
\item If $R \to S$ is finite so is $R' \to S'$.
\end{enumerate}
\end{lemma}

\begin{proof}
We prove (1).
Let $s_i \in S$ be generators for $S$ over $R$.
Each of these satisfies a monic polynomial equation $P_i$
over $R$. Hence the elements $1 \otimes s_i \in S'$ generate
$S'$ over $R'$ and satisfy the corresponding polynomial
$P_i'$ over $R'$. Since these elements generate $S'$ over $R'$
we see that $S'$ is integral over $R'$.
Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-local}
Let $R \to S$ be a ring map.
Let $f_1, \ldots, f_n \in R$ generate the unit ideal.
\begin{enumerate}
\item If each $R_{f_i} \to S_{f_i}$ is integral, so is $R \to S$.
\item If each $R_{f_i} \to S_{f_i}$ is finite, so is $R \to S$.
\end{enumerate}
\end{lemma}

\begin{proof}
Proof of (1).
Let $s \in S$. Consider the ideal $I \subset R[x]$ of
polynomials $P$ such that $P(s) = 0$. Let $J \subset R$
denote the ideal (!) of leading coefficients of elements of $I$.
By assumption and clearing denominators
we see that $f_i^{n_i} \in J$ for all $i$
and certain $n_i \geq 0$. Hence $J$ contains $1$ and we see
$s$ is integral over $R$. Proof of (2) omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-permanence}
Let $A \to B \to C$ be ring maps.
\begin{enumerate}
\item If $A \to C$ is integral so is $B \to C$.
\item If $A \to C$ is finite so is $B \to C$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-closure-transitive}
Let $A \to B \to C$ be ring maps.
Let $B'$ be the integral closure of $A$ in $B$,
let $C'$ be the integral closure of $B'$ in $C$. Then
$C'$ is the integral closure of $A$ in $C$.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-integral-overring-surjective}
Suppose that $R \to S$ is an integral
ring extension with $R \subset S$.
Then $\varphi : \Spec(S) \to \Spec(R)$
is surjective.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
We have to show $\mathfrak pS_{\mathfrak p} \not = S_{\mathfrak p}$, see
Lemma \ref{lemma-in-image}.
The localization $R_{\mathfrak p} \to S_{\mathfrak p}$ is injective
(as localization is exact) and integral by
Lemma \ref{lemma-integral-closure-localize} or
\ref{lemma-base-change-integral}.
Hence we may replace $R$, $S$ by $R_{\mathfrak p}$, $S_{\mathfrak p}$ and
we may assume $R$ is local with maximal ideal $\mathfrak m$ and
it suffices to show that $\mathfrak mS \not = S$.
Suppose $1 = \sum f_i s_i$ with $f_i \in \mathfrak m$
and $s_i \in S$ in order to get a contradiction.
Let $R \subset S' \subset S$
be such that $R \to S'$ is finite and $s_i \in S'$, see
Lemma \ref{lemma-characterize-integral}.
The equation $1 = \sum f_i s_i$ implies that
the finite $R$-module $S'$ satisfies $S' = \mathfrak m S'$. Hence by
Nakayama's Lemma \ref{lemma-NAK}
we see $S' = 0$. Contradiction.
\end{proof}

\begin{lemma}
\label{lemma-integral-under-field}
Let $R$ be a ring. Let $K$ be a field.
If $R \subset K$ and $K$ is integral over $R$,
then $R$ is a field and $K$ is an algebraic extension.
If $R \subset K$ and $K$ is finite over $R$,
then $R$ is a field and $K$ is a finite algebraic extension.
\end{lemma}

\begin{proof}
Assume that $R \subset K$ is integral.
By Lemma \ref{lemma-integral-overring-surjective} we see that
$\Spec(R)$ has $1$ point. Since clearly $R$ is a domain we see
that $R = R_{(0)}$ is a field (Lemma \ref{lemma-minimal-prime-reduced-ring}).
The other assertions are immediate from this.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-field}
Let $k$ be a field. Let $S$ be a $k$-algebra over $k$.
\begin{enumerate}
\item If $S$ is a domain and finite dimensional over $k$,
then $S$ is a field.
\item If $S$ is integral over $k$ and a domain,
then $S$ is a field.
\item If $S$ is integral over $k$ then every prime of
$S$ is a maximal ideal (see
Lemma \ref{lemma-ring-with-only-minimal-primes}
for more consequences).
\end{enumerate}
\end{lemma}

\begin{proof}
The statement on primes follows from the statement
``integral $+$ domain $\Rightarrow$ field''.
Let $S$ integral over $k$ and assume $S$ is a domain,
Take $s \in S$. By Lemma
\ref{lemma-characterize-integral} we may find a
finite dimensional $k$-subalgebra $k \subset S' \subset S$
containing $s$. Hence $S$ is a field if we can prove the
first statement. Assume $S$ finite dimensional
over $k$ and a domain. Pick $s\in S$.
Since $S$ is a domain the multiplication
map $s : S \to S$ is surjective by dimension
reasons. Hence there exists an element $s_1 \in S$
such that $ss_1 = 1$. So $S$ is a field.
\end{proof}

\begin{lemma}
\label{lemma-integral-no-inclusion}
Suppose $R \to S$ is integral.
Let $\mathfrak q, \mathfrak q' \in \Spec(S)$
be distinct primes
having the same image in $\Spec(R)$.
Then neither $\mathfrak q \subset \mathfrak q'$
nor $\mathfrak q' \subset \mathfrak q$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be the image.
By Remark \ref{remark-fundamental-diagram}
the primes $\mathfrak q, \mathfrak q'$
correspond to ideals in
$S \otimes_R \kappa(\mathfrak p)$.
Thus the lemma follows from Lemma \ref{lemma-integral-over-field}.
\end{proof}

\begin{lemma}
\label{lemma-finite-finite-fibres}
Suppose $R \to S$ is finite.
Then the fibres of $\Spec(S) \to \Spec(R)$ are finite.
\end{lemma}

\begin{proof}
By the discussion in
Remark \ref{remark-fundamental-diagram}
the fibres are the spectra of the rings $S \otimes_R \kappa(\mathfrak p)$.
As $R \to S$ is finite, these fibre rings are finite over
$\kappa(\mathfrak p)$ hence Noetherian by
Lemma \ref{lemma-Noetherian-permanence}.
By
Lemma \ref{lemma-integral-no-inclusion}
every prime of $S \otimes_R \kappa(\mathfrak p)$ is a minimal
prime. Hence by
Lemma \ref{lemma-Noetherian-irreducible-components}
there are at most finitely many.
\end{proof}

\begin{lemma}
\label{lemma-integral-going-up}
Let $R \to S$ be a ring map such that
$S$ is integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q$ be a prime of $S$ mapping
to $\mathfrak p$. Then there exists a prime $\mathfrak q'$
with $\mathfrak q \subset \mathfrak q'$
mapping to $\mathfrak p'$.
\end{lemma}

\begin{proof}
We may replace $R$ by $R/\mathfrak p$ and $S$ by $S/\mathfrak q$.
This reduces us to the situation of having an integral
extension of domains $R \subset S$ and a prime $\mathfrak p' \subset R$.
By Lemma \ref{lemma-integral-overring-surjective} we win.
\end{proof}

\noindent
The property expressed in the lemma above is called
the ``going up property'' for the ring map $R \to S$,
see Definition \ref{definition-going-up-down}.

\begin{lemma}
\label{lemma-finite-finitely-presented-extension}
Let $R \to S$ be a finite and finitely presented ring map.
Let $M$ be an $S$-module.
Then $M$ is finitely presented as an $R$-module if and only if
$M$ is finitely presented as an $S$-module.
\end{lemma}

\begin{proof}
One of the implications follows from
Lemma \ref{lemma-finitely-presented-over-subring}.
To see the other assume that $M$ is finitely presented as an $S$-module.
Pick a presentation
$$
S^{\oplus m} \longrightarrow
S^{\oplus n} \longrightarrow
M \longrightarrow 0
$$
As $S$ is finite as an $R$-module, the kernel of
$S^{\oplus n} \to M$ is a finite $R$-module. Thus from
Lemma \ref{lemma-extension}
we see that it suffices to prove that $S$ is finitely presented as an
$R$-module.

\medskip\noindent
Pick $y_1, \ldots, y_n \in S$ such that $y_1, \ldots, y_n$ generate $S$
as an $R$-module. By Lemma \ref{lemma-characterize-integral-element}
each $y_i$ is integral over $R$. Choose monic polynomials
$P_i(x) \in R[x]$ with $P_i(y_i) = 0$. Consider the ring
$$
S' = R[x_1, \ldots, x_n]/(P_1(x_1), \ldots, P_n(x_n))
$$
Then we see that $S$ is of finite presentation as an $S'$-algebra
by Lemma \ref{lemma-compose-finite-type}. Since $S' \to S$ is surjective,
the kernel $J = \Ker(S' \to S)$ is finitely generated as an ideal by
Lemma \ref{lemma-finite-presentation-independent}. Hence $J$ is a finite
$S'$-module (immediate from the definitions).
Thus $S = \Coker(J \to S')$ is  of finite presentation as an $S'$-module
by Lemma \ref{lemma-extension}.
Hence, arguing as in the first paragraph, it suffices to show that $S'$ is
of finite presentation as an $R$-module. Actually, $S'$ is free as an
$R$-module with basis the monomials $x_1^{e_1} \ldots x_n^{e_n}$
for $0 \leq e_i < \deg(P_i)$. Namely, write $R \to S'$ as the composition
$$
R \to R[x_1]/(P_1(x_1)) \to R[x_1, x_2]/(P_1(x_1), P_2(x_2)) \to
\ldots \to S'
$$
This shows that the $i$th ring in this sequence is free as a module over the
$(i - 1)$st one with basis $1, x_i, \ldots, x_i^{\deg(P_i) - 1}$. The result
follows easily from this by induction. Some details omitted.
\end{proof}

\begin{lemma}
\label{lemma-silly-normal}
Let $R$ be a ring. Let $x, y \in R$ be nonzerodivisors.
Let $R[x/y] \subset R_{xy}$ be the $R$-subalgebra generated
by $x/y$, and similarly for the subalgebras $R[y/x]$ and $R[x/y, y/x]$.
If $R$ is integrally closed in $R_x$ or $R_y$, then the sequence
$$
0 \to R \xrightarrow{(-1, 1)} R[x/y] \oplus R[y/x] \xrightarrow{(1, 1)}
R[x/y, y/x] \to 0
$$
is a short exact sequence of $R$-modules.
\end{lemma}

\begin{proof}
Since $x/y \cdot y/x = 1$ it is clear that the map
$R[x/y] \oplus R[y/x] \to R[x/y, y/x]$ is surjective.
Let $\alpha \in R[x/y] \cap R[y/x]$. To show exactness in the middle
we have to prove that $\alpha \in R$. By assumption we may write
$$
\alpha = a_0 + a_1 x/y + \ldots + a_n (x/y)^n =
b_0 + b_1 y/x + \ldots + b_m(y/x)^m
$$
for some $n, m \geq 0$ and $a_i, b_j \in R$.
Pick some $N > \max(n, m)$.
Consider the finite $R$-submodule $M$ of $R_{xy}$ generated by the elements
$$
(x/y)^N, (x/y)^{N - 1}, \ldots, x/y, 1, y/x, \ldots, (y/x)^{N - 1}, (y/x)^N
$$
We claim that $\alpha M \subset M$. Namely, it is clear that
$(x/y)^i (b_0 + b_1 y/x + \ldots + b_m(y/x)^m) \in M$ for
$0 \leq i \leq N$ and that
$(y/x)^i (a_0 + a_1 x/y + \ldots + a_n(x/y)^n) \in M$ for
$0 \leq i \leq N$. Hence $\alpha$ is integral over $R$ by
Lemma \ref{lemma-characterize-integral-element}. Note that
$\alpha \in R_x$, so if $R$ is integrally closed in $R_x$
then $\alpha \in R$ as desired.
\end{proof}







\section{Normal rings}
\label{section-normal-rings}

\noindent
We first introduce the notion of a normal domain, and then we
introduce the (very general) notion of a normal ring.

\begin{definition}
\label{definition-domain-normal}
A domain $R$ is called {\it normal} if it is integrally
closed in its field of fractions.
\end{definition}

\begin{lemma}
\label{lemma-integral-closure-in-normal}
Let $R \to S$ be a ring map.
If $S$ is a normal domain, then the integral closure of $R$
in $S$ is a normal domain.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\noindent
The following notion is occasionally useful when
studying normality.

\begin{definition}
\label{definition-almost-integral}
Let $R$ be a domain.
\begin{enumerate}
\item An element $g$ of the fraction
field of $R$ is called {\it almost integral over $R$}
if there exists an element $r \in R$, $r\not = 0$
such that $rg^n \in R$ for all $n \geq 0$.
\item The domain $R$ is called {\it completely normal} if every
almost integral element of the fraction field of $R$ is
contained in $R$.
\end{enumerate}
\end{definition}

\noindent
The following lemma shows that a Noetherian domain is normal
if and only if it is completely normal.

\begin{lemma}
\label{lemma-almost-integral}
Let $R$ be a domain with fraction field $K$.
If $u, v \in K$ are almost integral over $R$, then so are
$u + v$ and $uv$. Any element $g \in K$ which is integral over $R$
is almost integral over $R$. If $R$ is Noetherian
then the converse holds as well.
\end{lemma}

\begin{proof}
If $ru^n \in R$ for all $n \geq 0$ and
$v^nr' \in R$ for all $n \geq 0$, then
$(uv)^nrr'$ and $(u + v)^nrr'$ are in $R$ for
all $n \geq 0$. Hence the first assertion.
Suppose $g \in K$ is integral over $R$.
In this case there exists an $d > 0$ such that
the ring $R[g]$ is generated by $1, g, \ldots, g^d$ as an $R$-module.
Let $r \in R$ be a common denominator of the elements
$1, g, \ldots, g^d \in K$. It follows that $rR[g] \subset R$,
and hence $g$ is almost integral over $R$.

\medskip\noindent
Suppose $R$ is Noetherian and $g \in K$ is almost integral over $R$.
Let $r \in R$, $r\not = 0$ be as in the definition.
Then $R[g] \subset \frac{1}{r}R$ as an $R$-module.
Since $R$ is Noetherian this implies that $R[g]$ is
finite over $R$. Hence $g$ is integral over $R$, see
Lemma \ref{lemma-finite-is-integral}.
\end{proof}

\begin{lemma}
\label{lemma-localize-normal-domain}
Any localization of a normal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a normal domain, and let $S \subset R$ be
a multiplicative subset. Suppose $g$ is an element
of the fraction field of $R$ which is integral over $S^{-1}R$.
Let $P = x^d + \sum_{j < d} a_j x^j$ be a polynomial
with $a_i \in S^{-1}R$ such that $P(g) = 0$.
Choose $s \in S$ such that $sa_i \in R$ for all $i$.
Then $sg$ satisfies the monic polynomial
$x^d + \sum_{j < d} s^{d-j}a_j x^j$ which has coefficients
$s^{d-j}a_j$ in $R$. Hence $sg \in R$ because $R$ is normal.
Hence $g \in S^{-1}R$.
\end{proof}

\begin{lemma}
\label{lemma-PID-normal}
A principal ideal domain is normal.
\end{lemma}

\begin{proof}
Let $R$ be a principal ideal domain.
Let $g = a/b$ be an element of the fraction field
of $R$ integral over $R$. Because $R$ is a principal ideal domain
we may divide out a common factor of $a$ and $b$
and assume $(a, b) = R$. In this case, any equation
$(a/b)^n + r_{n-1} (a/b)^{n-1} + \ldots + r_0 = 0$
with $r_i \in R$ would imply $a^n \in (b)$. This
contradicts $(a, b) = R$ unless $b$ is a unit in $R$.
\end{proof}

\begin{lemma}
\label{lemma-prepare-polynomial-ring-normal}
Let $R$ be a domain with fraction field $K$.
Suppose $f = \sum \alpha_i x^i$ is an
element of $K[x]$.
\begin{enumerate}
\item If $f$ is integral over $R[x]$
then all $\alpha_i$ are integral over $R$, and
\item If $f$ is almost integral over $R[x]$
then all $\alpha_i$ are almost integral over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
We first prove the second statement.
Write $f = \alpha_0 + \alpha_1 x + \ldots + \alpha_r x^r$
with $\alpha_r \not = 0$.
By assumption there exists $h = b_0 + b_1 x + \ldots + b_s x^s \in R[x]$,
$b_s \not = 0$ such that $f^n h \in R[x]$ for all
$n \geq 0$. This implies that $b_s \alpha_r^n \in R$
for all $n \geq 0$. Hence $\alpha_r$ is almost
integral over $R$. Since the set of almost integral
elements form a subring (Lemma \ref{lemma-almost-integral}) we deduce that
$f - \alpha_r x^r = \alpha_0 + \alpha_1 x + \ldots + \alpha_{r - 1} x^{r - 1}$
is almost integral over $R[x]$. By induction on $r$ we win.

\medskip\noindent
In order to prove the first statement we will use absolute Noetherian
reduction. Namely, write $\alpha_i = a_i / b_i$ and
let $P(t) = t^d + \sum_{j < d} f_j t^j$ be a polynomial
with coefficients $f_j \in R[x]$ such that $P(f) = 0$.
Let $f_j = \sum f_{ji}x^i$. Consider the subring
$R_0 \subset R$ generated by the finite list of elements
$a_i, b_i, f_{ji}$ of $R$. It is a domain; let
$K_0$ be its field of fractions. Since $R_0$ is a finite type
$\mathbf{Z}$-algebra it is Noetherian, see
Lemma \ref{lemma-obvious-Noetherian}. It is still
the case that $f \in K_0[x]$ is integral over $R_0[x]$,
because all the identities in $R$
among the elements $a_i, b_i, f_{ji}$ also hold in $R_0$.
By Lemma \ref{lemma-almost-integral} the element
$f$ is almost integral over $R_0[x]$. By the second statement of
the lemma, the elements $\alpha_i$ are almost integral
over $R_0$. And since $R_0$ is Noetherian, they are
integral over $R_0$, see Lemma \ref{lemma-almost-integral}.
Of course, then they are integral over $R$.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-domain-normal}
Let $R$ be a normal domain.
Then $R[x]$ is a normal domain.
\end{lemma}

\begin{proof}
The result is true if $R$ is a field $K$ because
$K[x]$ is a euclidean domain and hence a principal ideal
domain and hence normal by Lemma \ref{lemma-PID-normal}.
Let $g$ be an element of the fraction field of
$R[x]$ which is integral over $R[x]$. Because $g$
is integral over $K[x]$ where $K$ is the fraction
field of $R$ we may write $g = \alpha_d x^d + \alpha_{d-1}x^{d-1} +
\ldots + \alpha_0$ with $\alpha_i \in K$.
By Lemma \ref{lemma-prepare-polynomial-ring-normal}
the elements $\alpha_i$ are integral over $R$ and
hence are in $R$.
\end{proof}

\begin{lemma}
\label{lemma-power-series-over-Noetherian-normal-domain}
Let $R$ be a Noetherian normal domain. Then $R[[x]]$ is
a Noetherian normal domain.
\end{lemma}

\begin{proof}
The power series ring is Noetherian by
Lemma \ref{lemma-Noetherian-power-series}.
Let $f, g \in R[[x]]$ be nonzero elements such that
$w = f/g$ is integral over $R[[x]]$.
Let $K$ be the fraction field of $R$. Since the ring of Laurent series
$K((x)) = K[[x]][1/x]$ is a field, we can write
$w = a_n x^n + a_{n + 1} x^{n + 1} + \ldots$
for some $n \in \mathbf{Z}$, $a_i \in K$, and $a_n \not = 0$.
By Lemma \ref{lemma-almost-integral} we see there exists a
nonzero element $h = b_m x^m + b_{m + 1} x^{m + 1} + \ldots$
in $R[[x]]$ with $b_m \not = 0$ such that
$w^e h \in R[[x]]$ for all $e \geq 1$. We conclude that $n \geq 0$ and that
$b_m a_n^e \in R$ for all $e \geq 1$.
Since $R$ is Noetherian this implies that $a_n \in R$ by
the same lemma. Now, if $a_n, a_{n + 1}, \ldots, a_{N - 1} \in R$,
then we can apply the same argument to
$w - a_n x^n - \ldots - a_{N - 1} x^{N - 1} = a_N x^N + \ldots$.
In this way we see that all $a_i \in R$ and the lemma is proved.
\end{proof}

\begin{lemma}
\label{lemma-normality-is-local}
Let $R$ be a domain. The following are equivalent:
\begin{enumerate}
\item The domain $R$ is a normal domain,
\item for every prime $\mathfrak p \subset R$ the local ring
$R_{\mathfrak p}$ is a normal domain, and
\item for every maximal ideal $\mathfrak m$ the ring $R_{\mathfrak m}$
is a normal domain.
\end{enumerate}
\end{lemma}

\begin{proof}
We deduce (1) $\Rightarrow$ (2) from Lemma \ref{lemma-localize-normal-domain}.
The implication (2) $\Rightarrow$ (3) is immediate. The implication
(3) $\Rightarrow$ (1) follows from the fact that for any domain $R$ we have
$$
R = \bigcap\nolimits_{\mathfrak m} R_{\mathfrak m}
$$
inside the fraction field of $R$. Namely, if $g$ is an element of
the right hand side then the ideal $I = \{x \in R \mid xg \in R\}$
is not contained in any maximal ideal $\mathfrak m$, whence $I = R$.
\end{proof}

\noindent
Lemma \ref{lemma-normality-is-local} shows that the following definition
is compatible with Definition \ref{definition-domain-normal}. (It is the
definition from EGA -- see \cite[IV, 5.13.5 and 0, 4.1.4]{EGA}.)

\begin{definition}
\label{definition-ring-normal}
A ring $R$ is called {\it normal} if for every prime
$\mathfrak p \subset R$ the localization $R_{\mathfrak p}$ is
a normal domain (see Definition \ref{definition-domain-normal}).
\end{definition}

\noindent
Note that a normal ring is a reduced ring, as $R$ is a subring of the product
of its localizations at all primes (see for example
Lemma \ref{lemma-characterize-zero-local}).

\begin{lemma}
\label{lemma-normal-ring-integrally-closed}
A normal ring is integrally closed in its total ring of fractions.
\end{lemma}

\begin{proof}
Let $R$ be a normal ring. Let $x \in Q(R)$ be an element of the total ring
of fractions of $R$ integral over $R$. Set $I = \{f \in R, fx \in R\}$. Let
$\mathfrak p \subset R$ be a prime. As $R \to R_{\mathfrak p}$ is
flat we see that $R_{\mathfrak p} \subset Q(R) \otimes_R R_{\mathfrak p}$. As
$R_{\mathfrak p}$ is a normal domain we see that $x \otimes 1$ is an element of
$R_{\mathfrak p}$. Hence we can find $a, f \in R$, $f \not \in \mathfrak p$
such that $x \otimes 1 = a \otimes 1/f$. This means that $fx - a$ maps to
zero in $Q(R) \otimes_R R_{\mathfrak p} = Q(R)_{\mathfrak p}$, which
in turn means that there exists an $f' \in R$, $f' \not \in \mathfrak p$
such that $f'fx = f'a$ in $R$. In other words, $ff' \in I$. Thus $I$
is an ideal which isn't contained in any of the prime ideals of $R$, i.e.,
$I = R$ and $x \in R$.
\end{proof}

\begin{lemma}
\label{lemma-localization-normal-ring}
A localization of a normal ring is a normal ring.
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-polynomial-ring-normal}
Let $R$ be a normal ring. Then $R[x]$ is a normal ring.
\end{lemma}

\begin{proof}
Let $\mathfrak q$ be a prime of $R[x]$. Set $\mathfrak p = R \cap \mathfrak q$.
Then we see that $R_{\mathfrak p}[x]$ is a normal domain by
Lemma \ref{lemma-polynomial-domain-normal}.
Hence $(R[x])_{\mathfrak q}$ is a normal domain by
Lemma \ref{lemma-localize-normal-domain}.
\end{proof}

\begin{lemma}
\label{lemma-finite-product-normal}
A finite product of normal rings is normal.
\end{lemma}

\begin{proof}
It suffices to show that the product of two normal rings, say $R$ and $S$, is
normal. By Lemma \ref{lemma-disjoint-decomposition} the prime ideals of
$R\times S$ are of the form $\mathfrak{p}\times S$ and $R\times
\mathfrak{q}$, where $\mathfrak{p}$ and $\mathfrak{q}$ are primes of $R$
and $S$ respectively. Localization yields 
$(R\times S)_{\mathfrak{p}\times S}=R_{\mathfrak{p}}$ which is a normal domain
by assumption. Similarly for $S$.
\end{proof}

\begin{lemma}
\label{lemma-characterize-reduced-ring-normal}
Let $R$ be a ring. Assume $R$ is reduced and has finitely many
minimal primes. Then the following are equivalent:
\begin{enumerate}
\item $R$ is a normal ring,
\item $R$ is integrally closed in its total ring of fractions, and
\item $R$ is a finite product of normal domains.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (1) $\Rightarrow$ (2) and
(3) $\Rightarrow$ (1) hold in general,
see Lemmas \ref{lemma-normal-ring-integrally-closed} and
\ref{lemma-finite-product-normal}.

\medskip\noindent
Let $\mathfrak p_1, \ldots, \mathfrak p_n$ be the minimal primes of $R$.
By Lemmas \ref{lemma-reduced-ring-sub-product-fields} and
\ref{lemma-total-ring-fractions-no-embedded-points} we have
$Q(R) = R_{\mathfrak p_1} \times \ldots \times R_{\mathfrak p_n}$, and
by Lemma \ref{lemma-minimal-prime-reduced-ring} each factor is a field.
Denote $e_i = (0, \ldots, 0, 1, 0, \ldots, 0)$ the $i$th idempotent
of $Q(R)$.

\medskip\noindent
If $R$ is integrally closed in $Q(R)$, then it contains in particular
the idempotents $e_i$, and we see that $R$ is a product of $n$
domains (see Sections \ref{section-connected-components} and
\ref{section-tilde-module-sheaf}). Each factor is of the form
$R/\mathfrak p_i$ with field of fractions $R_{\mathfrak p_i}$. 
By Lemma \ref{lemma-finite-product-integral-closure} each map
$R/\mathfrak p_i \to R_{\mathfrak p_i}$ is integrally closed. 
Hence $R$ is a finite product of normal domains.
\end{proof}

\begin{lemma}
\label{lemma-colimit-normal-ring}
Let $(R_i, \varphi_{ii'})$ be a directed system
(Categories, Definition \ref{definition-directed-system})
of rings. If each $R_i$ is a normal ring so is
$R = \colim_i R_i$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be a prime ideal.
Set $\mathfrak p_i = R_i \cap \mathfrak p$ (usual abuse of notation).
Then we see that
$R_{\mathfrak p} = \colim_i (R_i)_{\mathfrak p_i}$.
Since each $(R_i)_{\mathfrak p_i}$ is a normal domain we
reduce to proving the statement of the lemma for normal
domains. If $a, b \in R$ and $a/b$ satisfies a monic polynomial
$P(T) \in R[T]$, then we can find a (sufficiently large) $i \in I$
such that $a, b$ come from objects $a_i, b_i$ over $R_i$, $P$ comes from a
monic polynomial $P_i\in R_i[T]$ and $P_i(a_i/b_i)=0$. Since $R_i$ is normal we
see $a_i/b_i \in R_i$ and hence also $a/b \in R$.
\end{proof}







\section{Going down for integral over normal}
\label{section-going-down-integral-over-normal}

\noindent
We first play around a little bit with the notion of elements
integral over an ideal, and then we prove the theorem referred
to in the section title.

\begin{definition}
\label{definition-integral-over-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
We say an element $g \in S$ is
{\it integral over $I$} if
there exists a monic
polynomial $P = x^d + \sum_{j < d} a_j x^j$
with coefficients $a_j \in I^{d-j}$ such
that $P^\varphi(g) = 0$ in $S$.
\end{definition}

\noindent
This is mostly used when $\varphi = \text{id}_R : R \to R$.
In this case the set $I'$ of elements integral over $I$ is called
the {\it integral closure of $I$}. We will see that $I'$ is
an ideal of $R$ (and of course $I \subset I'$).

\begin{lemma}
\label{lemma-characterize-integral-ideal}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
Let $A = \sum I^nt^n \subset R[t]$ be the
subring of the polynomial ring
generated by $R \oplus It \subset R[t]$.
An element $s \in S$ is integral over $I$ if
and only if the element $st \in S[t]$
is integral over $A$.
\end{lemma}

\begin{proof}
Suppose $st$ is integral over $A$.
Let $P = x^d + \sum_{j < d} a_j x^j$
be a monic polynomial with coefficients in $A$
such that $P^\varphi(st) = 0$. Let $a_j' \in A$
be the degree $d-j$ part of $a_j$, in other
words $a_j' = a_j'' t^{d-j}$ with $a_j'' \in I^{d-j}$.
For degree reasons we still have
$(st)^d + \sum_{j < d} \varphi(a_j'') t^{d-j} (st)^j = 0$.
Hence $s^d + \sum_{j < d} \varphi(a_j'') s^j = 0$
and we see that $s$ is integral over $I$.

\medskip\noindent
Suppose that $s$ is integral over $I$.
Say $P = x^d + \sum_{j < d} a_j x^j$
with $a_j \in I^{d-j}$. Then we immediately find a
polynomial $Q = x^d + \sum_{j < d} (a_j t^{d-j}) x^j$
with coefficients in $A$ which proves that
$st$ is integral over $A$.
\end{proof}

\begin{lemma}
\label{lemma-integral-over-ideal-is-submodule}
Let $\varphi : R \to S$ be a ring map.
Let $I \subset R$ be an ideal.
The set of elements of $S$ which are integral
over $I$ form a $R$-submodule of $S$.
Furthermore, if $s \in S$ is integral over
$R$, and $s'$ is integral over $I$, then
$ss'$ is integral over $I$.
\end{lemma}

\begin{proof}
Closure under addition is clear from the
characterization of Lemma \ref{lemma-characterize-integral-ideal}.
Any element $s \in S$ which is integral over
$R$ corresponds to the degree $0$ element $s$ of $S[x]$
which is integral over $A$ (because $R \subset A$).
Hence we see that multiplication by $s$ on $S[x]$
preserves the property of being integral over $A$,
by Lemma \ref{lemma-integral-closure-is-ring}.
\end{proof}

\begin{lemma}
\label{lemma-integral-integral-over-ideal}
Suppose $\varphi : R \to S$ is integral.
Suppose $I \subset R$ is an ideal.
Then every element of $IS$ is integral over $I$.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-integral-over-ideal-is-submodule}.
\end{proof}

\begin{lemma}
\label{lemma-polynomials-divide}
Let $K$ be a field. Let $n, m \in \mathbf{N}$ and
$a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1} \in K$.
If the polynomial $x^n + a_{n - 1}x^{n - 1} + \ldots + a_0$
divides the polynomial $x^m + b_{m - 1} x^{m - 1} + \ldots + b_0$
in $K[x]$ then
\begin{enumerate}
\item $a_0, \ldots, a_{n - 1}$ are integral over any subring
$R_0$ of $K$ containing the elements $b_0, \ldots, b_{m - 1}$, and
\item each $a_i$ lies in $\sqrt{(b_0, \ldots, b_{m-1})R}$
for any subring $R \subset K$ containing the elements
$a_0, \ldots, a_{n - 1}, b_0, \ldots, b_{m - 1}$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $L/K$ be a field extension such that we can write
$x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 =
\prod_{i = 1}^m (x - \beta_i)$ with $\beta_i \in L$.
See Fields, Section \ref{fields-section-splitting-fieds}.
Each $\beta_i$ is integral over $R_0$.
Since each $a_i$ is a homogeneous polynomial in $\beta_1, \ldots, \beta_m$
we deduce the same for the $a_i$
(use Lemma \ref{lemma-integral-closure-is-ring}).

\medskip\noindent
Choose $c_0, \ldots, c_{m - n - 1} \in K$ such that
$$
\begin{matrix}
x^m + b_{m - 1} x^{m - 1} + \ldots + b_0 =  \\
(x^n + a_{n - 1}x^{n - 1} + \ldots + a_0)
(x^{m - n} + c_{m - n - 1}x^{m - n - 1}+ \ldots + c_0).
\end{matrix}
$$
By part (1) the elements $c_i$ are integral over $R$. Consider
the integral extension
$$
R \subset R' = R[c_0, \ldots, c_{m - n - 1}] \subset K
$$
By Lemmas \ref{lemma-integral-overring-surjective}
and \ref{lemma-surjective-spec-radical-ideal}
we see that $R \cap \sqrt{(b_0, \ldots, b_{m - 1})R'}
= \sqrt{(b_0, \ldots, b_{m - 1})R}$. Thus we may replace
$R$ by $R'$ and assume $c_i \in R$.
Dividing out the radical $\sqrt{(b_0, \ldots, b_{m - 1})}$
we get a reduced ring $\overline{R}$.
We have to show that the images $\overline{a}_i \in \overline{R}$
are zero. And in
$\overline{R}[x]$ we have the relation
$$
\begin{matrix}
x^m = x^m + \overline{b}_{m - 1} x^{m - 1} + \ldots + \overline{b}_0 = \\
(x^n + \overline{a}_{n - 1}x^{n - 1} + \ldots + \overline{a}_0)
(x^{m - n} + \overline{c}_{m - n - 1}x^{m - n - 1}+ \ldots + \overline{c}_0).
\end{matrix}
$$
It is easy to see that this implies $\overline{a}_i = 0$ for all $i$. Indeed
by Lemma \ref{lemma-minimal-prime-reduced-ring} the localization of
$\overline{R}$ at a minimal prime $\mathfrak{p}$ is a field and
$\overline{R}_{\mathfrak p}[x]$ a UFD. Thus
$f = x^n + \sum \overline{a}_i x^i$
is associated to $x^n$ and since $f$ is monic $f = x^n$
in $\overline{R}_{\mathfrak p}[x]$.
Then there exists an $s \in \overline{R}$, $s \not\in \mathfrak p$
such that $s(f - x^n) = 0$.  Therefore all $\overline{a}_i$ lie
in $\mathfrak p$ and we conclude by
Lemma \ref{lemma-reduced-ring-sub-product-fields}.
\end{proof}

\begin{lemma}
\label{lemma-minimal-polynomial-normal-domain}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal. Let $g \in S$ be integral
over $R$. Then the minimal polynomial of $g$
has coefficients in $R$.
\end{lemma}

\begin{proof}
Let $P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
be a polynomial with coefficients in $R$
such that $P(g) = 0$. Let $Q = x^n + a_{n-1}x^{n-1} + \ldots + a_0$
be the minimal polynomial for $g$ over the fraction field
$K$ of $R$. Then $Q$ divides $P$ in $K[x]$. By Lemma
\ref{lemma-polynomials-divide} we see the $a_i$ are
integral over $R$. Since $R$ is normal this
means they are in $R$.
\end{proof}

\begin{proposition}
\label{proposition-going-down-normal-integral}
Let $R \subset S$ be an inclusion of domains.
Assume $R$ is normal and $S$ integral over $R$.
Let $\mathfrak p \subset \mathfrak p' \subset R$
be primes. Let $\mathfrak q'$ be a prime of $S$
with $\mathfrak p' = R \cap \mathfrak q'$.
Then there exists a prime $\mathfrak q$
with $\mathfrak q \subset \mathfrak q'$
such that $\mathfrak p = R \cap \mathfrak q$. In other words:
the going down property holds for $R \to S$, see
Definition \ref{definition-going-up-down}.
\end{proposition}

\begin{proof}
Let $\mathfrak p$, $\mathfrak p'$ and $\mathfrak q'$
be as in the statement. We have to show there is a prime
$\mathfrak q$, with $\mathfrak q \subset \mathfrak q'$ and
$R \cap \mathfrak q = \mathfrak p$. This is the same
as finding a prime of
$S_{\mathfrak q'}$ mapping to $\mathfrak p$.
According to Lemma \ref{lemma-in-image} we have to show
that $\mathfrak p S_{\mathfrak q'} \cap R
= \mathfrak p$. Pick $z \in \mathfrak p S_{\mathfrak q'} \cap R$.
We may write $z = y/g$ with $y \in \mathfrak pS$ and
$g \in S$, $g \not\in \mathfrak q'$. Written
differently we have $zg = y$.

\medskip\noindent
By Lemma \ref{lemma-integral-integral-over-ideal}
there exists a monic polynomial
$P = x^m + b_{m-1} x^{m-1} + \ldots + b_0$
with $b_i \in \mathfrak p$ such that $P(y) = 0$.

\medskip\noindent
By Lemma \ref{lemma-minimal-polynomial-normal-domain}
the minimal polynomial of $g$ over $K$ has coefficients
in $R$. Write it as $Q = x^n + a_{n-1} x^{n-1} + \ldots
+ a_0$. Note that not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ since that would imply
$g^n = \sum_{j < n} a_j g^j \in \mathfrak pS
\subset \mathfrak p'S
\subset \mathfrak q'$
which is a contradiction.

\medskip\noindent
Since $y = zg$ we see immediately from the above
that $Q' = x^n + za_{n-1} x^{n-1} + \ldots + z^{n}a_0$
is the minimal polynomial for $y$. Hence
$Q'$ divides $P$ and by Lemma \ref{lemma-polynomials-divide}
we see that $z^ja_{n - j} \in \sqrt{(b_0, \ldots, b_{m-1})}
\subset \mathfrak p$, $j =  1, \ldots, n$.
Because not all $a_i$, $i = n-1, \ldots, 0$
are in $\mathfrak p$ we conclude $z \in \mathfrak p$
as desired.
\end{proof}














\section{Flat modules and flat ring maps}
\label{section-flat}

\noindent
One often used result is that if $M = \colim_{i\in \mathcal{I}} M_i$
is a colimit of $R$-modules and if $N$ is an $R$-module then
$$
M \otimes N
=
\colim_{i\in \mathcal{I}} M_i \otimes_R N,
$$
see Lemma \ref{lemma-tensor-products-commute-with-limits}.
This property is usually expressed by saying
that {\it $\otimes$ commutes with colimits}.
Another often used result is that if $0 \to N_1 \to N_2 \to N_3 \to 0$
is an exact sequence and if $M$ is any $R$-module, then
$$
M \otimes_R N_1
\to
M \otimes_R N_2
\to
M \otimes_R N_3
\to
0
$$
is still exact, see Lemma \ref{lemma-tensor-product-exact}.
Both of these properties tell us that the functor
$N \mapsto M \otimes_R N$ {\it is right exact}.
See Categories, Section \ref{categories-section-exact-functor}
and Homology, Section \ref{homology-section-functors}.
An $R$-module $M$ is flat if $N \mapsto N \otimes_R M$ is also left exact,
i.e., if it is exact. Here is the precise definition.

\begin{definition}
\label{definition-flat}
Let $R$ be a ring.
\begin{enumerate}
\item An $R$-module $M$ is called {\it flat} if whenever
$N_1 \to N_2 \to N_3$ is an exact sequence of $R$-modules
the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$
is exact as well.
\item An $R$-module $M$ is called {\it faithfully flat} if the
complex of $R$-modules
$N_1 \to N_2 \to N_3$ is exact if and only if
the sequence $M \otimes_R N_1 \to M \otimes_R N_2 \to M \otimes_R N_3$
is exact.
\item A ring map $R \to S$ is called {\it flat} if
$S$ is flat as an $R$-module.
\item A ring map $R \to S$ is called {\it faithfully flat} if
$S$ is faithfully flat as an $R$-module.
\end{enumerate}
\end{definition}

\noindent
Here is an example of how you can use the flatness condition.

\begin{lemma}
\label{lemma-flat-intersect-ideals}
Let $R$ be a ring. Let $I, J \subset R$ be ideals. Let $M$ be a flat
$R$-module. Then $IM \cap JM = (I \cap J)M$.
\end{lemma}

\begin{proof}
Consider the exact sequence $0 \to I \cap J \to R \to R/I \oplus R/J$.
Tensoring with the flat module $M$ we obtain an exact sequence
$$
0 \to (I \cap J) \otimes_R M \to M \to M/IM \oplus M/JM
$$
Since the kernel of $M \to M/IM \oplus M/JM$ is equal to
$IM \cap JM$ we conclude.
\end{proof}

\begin{lemma}
\label{lemma-colimit-flat}
Let $R$ be a ring. Let $\{M_i, \varphi_{ii'}\}$ be a directed system of
flat $R$-modules. Then $\colim_i M_i$ is a flat $R$-module.
\end{lemma}

\begin{proof}
This follows as $\otimes$ commutes with colimits and because
directed colimits are exact, see
Lemma \ref{lemma-directed-colimit-exact}.
\end{proof}

\begin{lemma}
\label{lemma-composition-flat}
A composition of (faithfully) flat ring maps is
(faithfully) flat.
If $R \to R'$ is (faithfully) flat, and $M'$ is a
(faithfully) flat $R'$-module, then $M'$ is a
(faithfully) flat $R$-module.
\end{lemma}

\begin{proof}
The first statement of the lemma is a particular case of the
second, so it is clearly enough to prove the latter. Let
$R \to R'$ be a flat ring map, and $M'$ a flat $R'$-module.
We need to prove that $M'$ is a flat $R$-module. Let
$N_1 \to N_2 \to N_3$ be an exact complex of $R$-modules.
Then, the complex $R' \otimes_R N_1 \to
R' \otimes_R N_2 \to R' \otimes_R N_3$ is exact (since $R'$
is flat as an $R$-module), and so the complex
$M' \otimes_{R'} \left(R' \otimes_R N_1\right)
\to M' \otimes_{R'} \left(R' \otimes_R N_2\right)
\to M' \otimes_{R'} \left(R' \otimes_R N_3\right)$ is
exact (since $M'$ is a flat $R'$-module). Since
$M' \otimes_{R'} \left(R' \otimes_R N\right)
\cong \left(M' \otimes_{R'} R'\right) \otimes_R N
\cong M' \otimes_R N$ for any $R$-module $N$ functorially
(by Lemmas \ref{lemma-tensor-with-bimodule} and
\ref{lemma-flip-tensor-product}), this complex is isomorphic
to the complex
$M' \otimes_R N_1 \to M' \otimes_R N_2 \to M' \otimes_R N_3$,
which is therefore also exact. This shows that $M'$ is a flat
$R$-module. Tracing this argument backwards, we can show
that if $R \to R'$ is faithfully flat, and if $M'$ is
faithfully flat as an $R'$-module, then $M'$ is faithfully
flat as an $R$-module.
\end{proof}

\begin{lemma}
\label{lemma-flat}
Let $M$ be an $R$-module. The following are equivalent:
\begin{enumerate}
\item
\label{item-flat}
$M$ is flat over $R$.
\item
\label{item-injective}
for every injection of $R$-modules $N \subset N'$
the map $N \otimes_R M \to N'\otimes_R M$ is injective.
\item
\label{item-f-ideal}
for every ideal $I \subset R$ the map
$I \otimes_R M \to R \otimes_R M = M$ is injective.
\item
\label{item-ffg-ideal}
for every finitely generated ideal $I \subset R$
the map $I \otimes_R M \to R \otimes_R M = M$ is injective.
\end{enumerate}
\end{lemma}

\begin{proof}
The implications (\ref{item-flat}) implies (\ref{item-injective})
implies (\ref{item-f-ideal}) implies (\ref{item-ffg-ideal}) are all
trivial. Thus we prove (\ref{item-ffg-ideal}) implies (\ref{item-flat}).
Suppose that $N_1 \to N_2 \to N_3$ is exact.
Let $K = \Ker(N_2 \to N_3)$ and $Q = \Im(N_2 \to N_3)$.
Then we get maps
$$
N_1 \otimes_R M \to
K \otimes_R M \to
N_2 \otimes_R M \to
Q \otimes_R M \to
N_3 \otimes_R M
$$
Observe that the first and third arrows are surjective. Thus if we show
that the second and fourth arrows are injective, then we are
done\footnote{Here is the argument in more detail:
Assume that we know that the second and fourth arrows are
injective. Lemma \ref{lemma-tensor-product-exact} (applied
to the exact sequence $K \to N_2 \to Q \to 0$) yields that
the sequence $K \otimes_R M \to N_2 \otimes_R M \to
Q \otimes_R M \to 0$ is exact. Hence,
$\Ker \left(N_2 \otimes_R M \to Q \otimes_R M\right)
= \Im \left(K \otimes_R M \to N_2 \otimes_R M\right)$.
Since
$\Im \left(K \otimes_R M \to N_2 \otimes_R M\right)
= \Im \left(N_1 \otimes_R M \to N_2 \otimes_R M\right)$
(due to the surjectivity of $N_1 \otimes_R M \to
K \otimes_R M$) and
$\Ker \left(N_2 \otimes_R M \to Q \otimes_R M\right)
= \Ker \left(N_2 \otimes_R M \to N_3 \otimes_R M\right)$
(due to the injectivity of $Q \otimes_R M \to
N_3 \otimes_R M$), this becomes
$\Ker \left(N_2 \otimes_R M \to N_3 \otimes_R M\right)
= \Im \left(N_1 \otimes_R M \to N_2 \otimes_R M\right)$,
which shows that the functor $- \otimes_R M$ is exact,
whence $M$ is flat.}.
Hence it suffices to show that $- \otimes_R M$ transforms
injective $R$-module maps into injective $R$-module maps.

\medskip\noindent
Assume $K \to N$ is an injective $R$-module map and
let $x \in \Ker(K \otimes_R M \to N \otimes_R M)$.
We have to show that $x$ is zero.
The $R$-module $K$ is the union of its finite
$R$-submodules; hence, $K \otimes_R M$ is
the colimit of $R$-modules of the form
$K_i \otimes_R M$ where $K_i$ runs over all finite
$R$-submodules of $K$
(because tensor product commutes with colimits).
Thus, for some $i$ our $x$ comes from an element
$x_i \in K_i \otimes_R M$. Thus we may assume that $K$
is a finite $R$-module. Assume this. We regard the
injection $K \to N$ as an inclusion, so that
$K \subset N$.

\medskip\noindent
The $R$-module $N$ is the union of its finite
$R$-submodules that contain $K$. Hence, $N \otimes_R M$
is the colimit of $R$-modules of the form
$N_i \otimes_R M$ where $N_i$ runs over all finite
$R$-submodules of $N$ that contain $K$
(again since tensor product commutes with colimits).
Notice that this is a colimit over a directed system
(since the sum of two finite submodules of $N$ is
again finite).
Hence, (by Lemma \ref{lemma-zero-directed-limit})
the element $x \in K \otimes_R M$ maps to
zero in at least one of these $R$-modules
$N_i \otimes_R M$ (since $x$ maps to zero
in $N \otimes_R M$).
Thus we may assume $N$ is a finite $R$-module.

\medskip\noindent
Assume $N$ is a finite $R$-module. Write $N = R^{\oplus n}/L$ and $K = L'/L$
for some $L \subset L' \subset R^{\oplus n}$.
For any $R$-submodule $G \subset R^{\oplus n}$,
we have a canonical map $G \otimes_R M \to M^{\oplus n}$
obtained by composing
$G \otimes_R M \to R^n \otimes_R M = M^{\oplus n}$.
It suffices to prove that $L \otimes_R M \to M^{\oplus n}$
and $L' \otimes_R M \to M^{\oplus n}$ are injective.
Namely, if so, then we see that
$K \otimes_R M = L' \otimes_R M/L \otimes_R M \to M^{\oplus n}/L \otimes_R M$
is injective too\footnote{This becomes obvious if we
identify $L' \otimes_R M$ and $L \otimes_R M$ with
submodules of $M^{\oplus n}$ (which is legitimate since
the maps $L \otimes_R M \to M^{\oplus n}$
and $L' \otimes_R M \to M^{\oplus n}$ are injective and
commute with the obvious map $L' \otimes_R M \to L \otimes_R M$).}.

\medskip\noindent
Thus it suffices to show that $L \otimes_R M \to M^{\oplus n}$
is injective when $L \subset R^{\oplus n}$ is an $R$-submodule.
We do this by induction on $n$. The base case $n = 1$ we handle below.
For the induction step assume $n > 1$ and set
$L' = L \cap R \oplus 0^{\oplus n - 1}$. Then $L'' = L/L'$ is a submodule
of $R^{\oplus n - 1}$. We obtain a diagram
$$
\xymatrix{
&
L' \otimes_R M \ar[r] \ar[d] &
L \otimes_R M \ar[r] \ar[d] &
L'' \otimes_R M \ar[r] \ar[d] &
0 \\
0 \ar[r] &
M \ar[r] &
M^{\oplus n} \ar[r] &
M^{\oplus n - 1} \ar[r] & 0
}
$$
By induction hypothesis and the base case the left and right vertical
arrows are injective. The rows are exact. It follows that the middle vertical
arrow is injective too.

\medskip\noindent
The base case of the induction above is when $L \subset R$ is an ideal.
In other words, we have to show that $I \otimes_R M \to M$ is injective
for any ideal $I$ of $R$. We know this is true when $I$ is finitely
generated. However, $I = \bigcup I_\alpha$ is the union of the
finitely generated ideals $I_\alpha$ contained in it. In other words,
$I = \colim I_\alpha$. Since $\otimes$ commutes with colimits we see that
$I \otimes_R M = \colim I_\alpha \otimes_R M$ and since all
the morphisms $I_\alpha \otimes_R M \to M$ are injective by
assumption, the same is true for $I \otimes_R M \to M$.
\end{proof}

\begin{lemma}
\label{lemma-colimit-rings-flat}
Let $\{R_i, \varphi_{ii'}\}$ be a system of rings over the directed set $I$.
Let $R = \colim_i R_i$.
\begin{enumerate}
\item If $M$ is an $R$-module such that $M$ is flat as an $R_i$-module
for all $i$, then $M$ is flat as an $R$-module.
\item For $i \in I$ let $M_i$ be a flat $R_i$-module and
for $i' \geq i$ let $f_{ii'} : M_i \to M_{i'}$ be a $\varphi_{ii'}$-linear
map such that $f_{i' i''} \circ f_{i i'} = f_{i i''}$. Then
$M = \colim_{i \in I} M_i$ is a flat $R$-module.
\end{enumerate}
\end{lemma}

\begin{proof}
Part (1) is a special case of part (2) with $M_i = M$ for all $i$
and $f_{i i'} = \text{id}_M$. Proof of (2).
Let $\mathfrak a \subset R$ be a finitely generated ideal. By
Lemma \ref{lemma-flat}
it suffices to show that $\mathfrak a \otimes_R M \to M$ is
injective. We can find an $i \in I$ and a finitely generated ideal
$\mathfrak a' \subset R_i$ such that $\mathfrak a = \mathfrak a'R$.
Then $\mathfrak a = \colim_{i' \geq i} \mathfrak a'R_{i'}$.
Since $\otimes$ commutes with colimits the map $\mathfrak a \otimes_R M \to M$
is the colimit of the maps
$$
\mathfrak a'R_{i'} \otimes_{R_{i'}} M_{i'} \longrightarrow M_{i'}
$$
These maps are all injective by assumption. Since colimits over $I$
are exact by Lemma \ref{lemma-directed-colimit-exact} we win.
\end{proof}

\begin{lemma}
\label{lemma-flat-base-change}
Suppose that $M$ is (faithfully) flat over $R$, and that $R \to R'$
is a ring map. Then $M \otimes_R R'$ is (faithfully) flat over $R'$.
\end{lemma}

\begin{proof}
For any $R'$-module $N$ we have a canonical
isomorphism $N \otimes_{R'} (R'\otimes_R M)
= N \otimes_R M$. Hence the desired exactness properties of the functor
$-\otimes_{R'}(R'\otimes_R M)$ follow from
the corresponding exactness properties of the functor $-\otimes_R M$.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends}
Let $R \to R'$ be a faithfully flat ring map.
Let $M$ be a module over $R$, and set $M' = R' \otimes_R M$.
Then $M$ is flat over $R$ if and only if $M'$ is flat over $R'$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-base-change} we see that if $M$ is flat
then $M'$ is flat. For the converse, suppose that $M'$ is flat.
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
We want to show that $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We know that
$N_1 \otimes_R R' \to N_2 \otimes_R R' \to N_3 \otimes_R R'$ is
exact, because $R \to R'$ is flat. Flatness of $M'$ implies that
$N_1 \otimes_R R' \otimes_{R'} M'
\to N_2 \otimes_R R' \otimes_{R'} M'
\to N_3 \otimes_R R' \otimes_{R'} M'$ is exact.
We may write this as
$N_1 \otimes_R M \otimes_R R'
\to N_2 \otimes_R M \otimes_R R'
\to N_3 \otimes_R M \otimes_R R'$.
Finally, faithful flatness implies that
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact.
\end{proof}

\begin{lemma}
\label{lemma-flatness-descends-more-general}
Let $R$ be a ring. Let $S \to S'$ be a flat map of $R$-algebras.
Let $M$ be a module over $S$, and set $M' = S' \otimes_S M$.
\begin{enumerate}
\item If $M$ is flat over $R$, then $M'$ is flat over $R$.
\item If $S \to S'$ is faithfully flat, then $M$ is flat
over $R$ if and only if $M'$ is flat over $R$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let $N \to N'$ be an injection of $R$-modules. By the flatness
of $S \to S'$ we have
$$
\Ker(N \otimes_R M \to N' \otimes_R M) \otimes_S S'
=
\Ker(N \otimes_R M' \to N' \otimes_R M')
$$
If $M$ is flat over $R$, then the left hand side is zero and
we find that $M'$ is flat over $R$ by the second characterization
of flatness in Lemma \ref{lemma-flat}.
If $M'$ is flat over $R$ then we have the vanishing of the right hand side
and if in addition $S \to S'$ is faithfully flat, this implies that
$\Ker(N \otimes_R M \to N' \otimes_R M)$ is zero which in turn
shows that $M$ is flat over $R$.
\end{proof}

\begin{lemma}
\label{lemma-flat-permanence}
Let $R \to S$ be a ring map. Let $M$ be an $S$-module.
If $M$ is flat as an $R$-module and faithfully flat as an $S$-module,
then $R \to S$ is flat.
\end{lemma}

\begin{proof}
Let $N_1 \to N_2 \to N_3$ be an exact sequence of $R$-modules.
By assumption $N_1 \otimes_R M \to N_2 \otimes_R M \to N_3 \otimes_R M$
is exact. We may write this as
$$
N_1 \otimes_R S \otimes_S M
\to
N_2 \otimes_R S \otimes_S M
\to
N_3 \otimes_R S \otimes_S M.
$$
By faithful flatness of $M$ over $S$ we conclude that
$N_1 \otimes_R S \to N_2 \otimes_R S \to N_3 \otimes_R S$ is exact.
Hence $R \to S$ is flat.
\end{proof}

\noindent
Let $R$ be a ring.
Let $M$ be an $R$-module.
Let $\sum f_i x_i = 0$ be a relation in $M$.
We say the relation $\sum f_i x_i$
is {\it trivial} if there exist an integer $m \geq 0$,
elements $y_j \in M$, $j = 1, \ldots, m$, and elements $a_{ij} \in R$,
$i = 1, \ldots, n$, $j = 1, \ldots, m$ such that
$$
x_i = \sum\nolimits_j a_{ij} y_j, \forall i,
\quad\text{and}\quad
0 = \sum\nolimits_i f_ia_{ij}, \forall j.
$$

\begin{lemma}[Equational criterion of flatness]
\label{lemma-flat-eq}
A module $M$ over $R$ is flat if and only if
every relation in $M$ is trivial.
\end{lemma}

\begin{proof}
Assume $M$ is flat and let $\sum f_i x_i = 0$ be a relation in $M$.
Let $I = (f_1, \ldots, f_n)$, and let
$K = \Ker(R^n \to I, (a_1, \ldots, a_n) \mapsto \sum_i a_i f_i)$.
So we have the short exact sequence
$0 \to K \to R^n \to I \to 0$. Then $\sum f_i \otimes x_i$
is an element of $I \otimes_R M$ which maps
to zero in $R \otimes_R M = M$. By flatness
$\sum f_i \otimes x_i$ is zero in $I \otimes_R M$.
Thus there exists an element of $K \otimes_R M$ mapping
to $\sum e_i \otimes x_i \in R^n \otimes_R M$ where $e_i$
is the $i$th basis element of $R^n$.
Write this element as $\sum k_j \otimes y_j$
and then write the image of $k_j$ in $R^n$ as
$\sum a_{ij} e_i$ to get the result.

\medskip\noindent
Assume every relation is trivial, let $I$
be a finitely generated ideal, and let $x = \sum f_i \otimes x_i$
be an element of $I \otimes_R M$ mapping to zero in $R \otimes_R M = M$.
This just means exactly that $\sum f_i x_i$ is a relation in
$M$. And the fact that it is trivial implies easily that
$x$ is zero, because
$$
x
=
\sum f_i \otimes x_i
=
\sum f_i \otimes \left(\sum a_{ij}y_j\right)
=
\sum \left(\sum f_i a_{ij}\right) \otimes y_j
=
0
$$
\end{proof}

\begin{lemma}
\label{lemma-flat-tor-zero}
Suppose that $R$ is a ring, $0 \to M'' \to M' \to M \to 0$
a short exact sequence, and $N$ an $R$-module. If $M$ is flat
then $N \otimes_R M'' \to N \otimes_R M'$ is injective, i.e., the
sequence
$$
0 \to N \otimes_R M'' \to N \otimes_R M' \to N \otimes_R M \to 0
$$
is a short exact sequence.
\end{lemma}

\begin{proof}
Let $R^{(I)} \to N$ be a surjection from a free module
onto $N$ with kernel $K$. The result follows
from the snake lemma applied to the following diagram
$$
\begin{matrix}
 & & 0 & & 0 & & 0 & & \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R N & \to & M' \otimes_R N & \to & M \otimes_R N & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
0 & \to & (M'')^{(I)} & \to & (M')^{(I)} & \to & M^{(I)} & \to & 0 \\
 & & \uparrow & & \uparrow & & \uparrow & & \\
 & & M''\otimes_R K & \to & M' \otimes_R K & \to & M \otimes_R K & \to & 0 \\
 & & & & & & \uparrow & & \\
 & & & & & & 0 & &
\end{matrix}
$$
with exact rows and columns. The middle row is exact because tensoring
with the free module $R^{(I)}$ is exact.
\end{proof}


\begin{lemma}
\label{lemma-flat-ses}
Suppose that $0 \to M' \to M \to M'' \to 0$ is
a short exact sequence of $R$-modules.
If $M'$ and $M''$ are flat so is $M$.
If $M$ and $M''$ are flat so is $M'$.
\end{lemma}

\begin{proof}
We will use the criterion that a module $N$ is flat if for
every ideal $I \subset R$ the map $N \otimes_R I \to N$ is injective,
see Lemma \ref{lemma-flat}.
Consider an ideal $I \subset R$.
Consider the diagram
$$
\begin{matrix}
0 & \to & M' & \to & M & \to & M'' & \to & 0 \\
& & \uparrow & & \uparrow & & \uparrow & & \\
& & M'\otimes_R I & \to & M \otimes_R I & \to & M''\otimes_R I & \to & 0
\end{matrix}
$$
with exact rows. This immediately proves the first assertion.
The second follows because if $M''$ is flat then the lower left
horizontal arrow is injective by Lemma \ref{lemma-flat-tor-zero}.
\end{proof}

\begin{lemma}
\label{lemma-easy-ff}
Let $R$ be a ring.
Let $M$ be an $R$-module.
The following are equivalent
\begin{enumerate}
\item $M$ is faithfully flat, and
\item $M$ is flat and for all $R$-module homomorphisms $\alpha : N \to N'$
we have $\alpha = 0$ if and only if $\alpha \otimes \text{id}_M = 0$.
\end{enumerate}
\end{lemma}

\begin{proof}
If $M$ is faithfully flat, then
$0 \to \Ker(\alpha) \to N \to N'$ is exact if and only if the same holds
after tensoring with $M$. This proves (1) implies (2).
For the other, assume (2). Let $N_1 \to N_2 \to N_3$
be a complex, and assume the complex
$N_1 \otimes_R M \to N_2 \otimes_R M \to N_3\otimes_R M$
is exact. Take $x \in \Ker(N_2 \to N_3)$,
and consider the map $\alpha : R \to N_2/\Im(N_1)$,
$r \mapsto rx + \Im(N_1)$. By the exactness
of the complex $-\otimes_R M$ we see that $\alpha \otimes
\text{id}_M$ is zero. By assumption we get that $\alpha$ is
zero. Hence $x $ is in the image of $N_1 \to N_2$.
\end{proof}

\begin{lemma}
\label{lemma-ff}
\begin{slogan}
A flat module is faithfully flat if and only if it has nonzero fibers.
\end{slogan}
Let $M$ be a flat $R$-module.
The following are equivalent:
\begin{enumerate}
\item $M$ is faithfully flat,
\item for every nonzero $R$-module $N$, then tensor product $M \otimes_R N$
is nonzero,
\item for all $\mathfrak p \in \Spec(R)$
the tensor product $M \otimes_R \kappa(\mathfrak p)$ is nonzero, and
\item for all maximal ideals $\mathfrak m$ of $R$
the tensor product $M \otimes_R \kappa(\mathfrak m) = M/{\mathfrak m}M$
is nonzero.
\end{enumerate}
\end{lemma}

\begin{proof}
Assume $M$ faithfully flat and $N \not = 0$. By Lemma \ref{lemma-easy-ff}
the nonzero map $1 : N \to N$ induces a nonzero map
$M \otimes_R N \to M \otimes_R N$, so $M \otimes_R N \not = 0$.
Thus (1) implies (2). The implications (2) $\Rightarrow$ (3) $\Rightarrow$ (4)
are immediate.

\medskip\noindent
Assume (4). Suppose that $N_1 \to N_2 \to N_3$ is a complex and
suppose that $N_1 \otimes_R M \to N_2\otimes_R M \to
N_3\otimes_R M$ is exact. Let $H$ be the cohomology of the complex,
so $H = \Ker(N_2 \to N_3)/\Im(N_1 \to N_2)$. To finish the proof
we will show $H = 0$. By flatness we see that $H \otimes_R M = 0$.
Take $x \in H$ and let $I = \{f \in R \mid fx = 0 \}$
be its annihilator. Since $R/I \subset H$ we get
$M/IM \subset H \otimes_R M = 0$ by flatness of $M$.
If $I \not =  R$ we may choose
a maximal ideal $I \subset \mathfrak m \subset R$.
This immediately gives a contradiction.
\end{proof}

\begin{lemma}
\label{lemma-ff-rings}
Let $R \to S$ be a flat ring map.
The following are equivalent:
\begin{enumerate}
\item $R \to S$ is faithfully flat,
\item the induced map on $\Spec$ is surjective, and
\item any closed point $x \in \Spec(R)$ is
in the image of the map $\Spec(S) \to \Spec(R)$.
\end{enumerate}
\end{lemma}

\begin{proof}
This follows quickly from Lemma \ref{lemma-ff}, because we
saw in Remark \ref{remark-fundamental-diagram}
that $\mathfrak p$ is in the image
if and only if the ring $S \otimes_R \kappa(\mathfrak p)$
is nonzero.
\end{proof}

\begin{lemma}
\label{lemma-local-flat-ff}
A flat local ring homomorphism of local rings is faithfully flat.
\end{lemma}

\begin{proof}
Immediate from Lemma \ref{lemma-ff-rings}.
\end{proof}

\noindent
Flatness meshes well with localization.

\begin{lemma}
\label{lemma-flat-localization}
Let $R$ be a ring. Let $S \subset R$ be a multiplicative subset.
\begin{enumerate}
\item The localization $S^{-1}R$ is a flat $R$-algebra.
\item If $M$ is an $S^{-1}R$-module, then $M$ is a flat $R$-module
if and only if $M$ is a flat $S^{-1}R$-module.
\item Suppose $M$ is an $R$-module. Then
$M$ is a flat $R$-module if and only if $M_{\mathfrak p}$ is a flat
$R_{\mathfrak p}$-module for all primes $\mathfrak p$ of $R$.
\item Suppose $M$ is an $R$-module. Then $M$ is a flat $R$-module if
and only if $M_{\mathfrak m}$ is a flat
$R_{\mathfrak m}$-module for all maximal ideals $\mathfrak m$ of $R$.
\item Suppose $R \to A$ is a ring map, $M$ is an $A$-module,
and $g_1, \ldots, g_m \in A$ are elements generating the unit
ideal of $A$. Then $M$ is flat over $R$ if and only if each localization
$M_{g_i}$ is flat over $R$.
\item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Then $M$ is a flat $R$-module if and only if the localization
$M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module
(with $\mathfrak p$ the prime of $R$ lying under $\mathfrak q$)
for all primes $\mathfrak q$ of $A$.
\item Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Then $M$ is a flat $R$-module if and only if the localization
$M_{\mathfrak m}$ is a flat $R_{\mathfrak p}$-module
(with $\mathfrak p = R \cap \mathfrak m$)
for all maximal ideals $\mathfrak m$ of $A$.
\end{enumerate}
\end{lemma}

\begin{proof}
Let us prove the last statement of the lemma.
In the proof we will use repeatedly that localization is exact
and commutes with tensor product, see Sections \ref{section-localization}
and \ref{section-tensor-product}.

\medskip\noindent
Suppose $R \to A$ is a ring map, and $M$ is an $A$-module.
Assume that $M_{\mathfrak m}$ is a flat $R_{\mathfrak p}$-module
for all maximal ideals $\mathfrak m$ of $A$ (with
$\mathfrak p = R \cap \mathfrak m$). Let $I \subset R$ be an ideal.
We have to show the map $I \otimes_R M \to M$ is injective.
We can think of this as a map of $A$-modules.
By assumption the localization
$(I \otimes_R M)_{\mathfrak m} \to M_{\mathfrak m}$ is injective
because
$(I \otimes_R M)_{\mathfrak m} =
I_{\mathfrak p} \otimes_{R_{\mathfrak p}} M_{\mathfrak m}$.
Hence the kernel of $I \otimes_R M \to M$ is zero by
Lemma \ref{lemma-characterize-zero-local}.
Hence $M$ is flat over $R$.

\medskip\noindent
Conversely, assume $M$ is flat over $R$. Pick a prime $\mathfrak q$
of $A$ lying over the prime $\mathfrak p$ of $R$. Suppose that
$I \subset R_{\mathfrak p}$ is an ideal. We have to show that
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is injective. We can write $I = J_{\mathfrak p}$ for some
ideal $J \subset R$. Then the map
$I \otimes_{R_{\mathfrak p}} M_{\mathfrak q} \to M_{\mathfrak q}$
is just the localization (at $\mathfrak q$) of the map
$J \otimes_R M \to M$ which is injective. Since localization is exact
we see that $M_{\mathfrak q}$ is a flat $R_{\mathfrak p}$-module.

\medskip\noindent
This proves (7) and (6). The other statements follow in a straightforward
way from the last statement (proofs omitted).
\end{proof}

\begin{lemma}
\label{lemma-flat-going-down}
Let $R \to S$ be flat. Let $\mathfrak p \subset \mathfrak p'$
be primes of $R$. Let $\mathfrak q' \subset S$ be a prime of $S$
mapping to $\mathfrak p'$. Then there exists a prime
$\mathfrak q \subset \mathfrak q'$ mapping to $\mathfrak p$.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-flat-localization} the local ring map
$R_{\mathfrak p'} \to S_{\mathfrak q'}$ is flat.
By Lemma \ref{lemma-local-flat-ff} this local ring map is faithfully
flat. By Lemma \ref{lemma-ff-rings} there is a prime mapping to
$\mathfrak p R_{\mathfrak p'}$. The inverse image of this
prime in $S$ does the job.
\end{proof}

\noindent
The property of $R \to S$ described in the lemma is called the
``going down property''. See Definition \ref{definition-going-up-down}.

\begin{lemma}
\label{lemma-colimit-faithfully-flat}
Let $R$ be a ring. Let $\{S_i, \varphi_{ii'}\}$ be a directed system of
faithfully flat $R$-algebras. Then $S = \colim_i S_i$ is a faithfully flat
$R$-algebra.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-colimit-flat} we see that $S$ is flat.
Let $\mathfrak m \subset R$ be a maximal ideal. By
Lemma \ref{lemma-ff-rings}
none of the rings $S_i/\mathfrak m S_i$ is zero.
Hence $S/\mathfrak mS = \colim S_i/\mathfrak mS_i$ is nonzero
as well because $1$ is not equal to zero. Thus the image of
$\Spec(S) \to \Spec(R)$ contains $\mathfrak m$ and we see that $R \to S$
is faithfully flat by Lemma \ref{lemma-ff-rings}.
\end{proof}





\section{Supports and annihilators}
\label{section-supp-and-ann}

\noindent
Some very basic definitions and lemmas.

\begin{definition}
\label{definition-support-module}
Let $R$ be a ring and let $M$ be an $R$-module.
The {\it support of $M$} is the set
$$
\text{Supp}(M)
=
\{
\mathfrak p \in \Spec(R)
\mid
M_{\mathfrak p} \not = 0
\}
$$
\end{definition}

\begin{lemma}
\label{lemma-support-zero}
\begin{slogan}
A module over a ring has empty support if and only if it is the trivial module.
\end{slogan}
Let $R$ be a ring. Let $M$ be an $R$-module. Then
$$
M = (0) \Leftrightarrow \text{Supp}(M) = \emptyset.
$$
\end{lemma}

\begin{proof}
Actually,
Lemma \ref{lemma-characterize-zero-local}
even shows that $\text{Supp}(M)$ always contains a maximal ideal
if $M$ is not zero.
\end{proof}

\begin{definition}
\label{definition-annihilator}
Let $R$ be a ring. Let $M$ be an $R$-module.
\begin{enumerate}
\item Given an element $m \in M$ the {\it annihilator of $m$}
is the ideal
$$
\text{Ann}_R(m) = \text{Ann}(m) = \{f \in R \mid fm = 0\}.
$$
\item The {\it annihilator of $M$}
is the ideal
$$
\text{Ann}_R(M) = \text{Ann}(M) = \{f \in R \mid fm = 0\ \forall m \in M\}.
$$
\end{enumerate}
\end{definition}

\begin{lemma}
\label{lemma-annihilator-flat-base-change}
Let $R \to S$ be a flat ring map. Let $M$ be an $R$-module and
$m \in M$. Then $\text{Ann}_R(m) S = \text{Ann}_S(m \otimes 1)$.
If $M$ is a finite $R$-module, then
$\text{Ann}_R(M) S = \text{Ann}_S(M \otimes_R S)$.
\end{lemma}

\begin{proof}
Set $I = \text{Ann}_R(m)$. By definition there is an exact sequence
$0 \to I \to R \to M$ where the map $R \to M$ sends $f$ to $fm$. Using
flatness we obtain an exact sequence
$0 \to I \otimes_R S \to S \to M \otimes_R S$ which proves the first
assertion. If $m_1, \ldots, m_n$ is a set of generators of $M$
then $\text{Ann}_R(M) = \bigcap \text{Ann}_R(m_i)$. Similarly
$\text{Ann}_S(M \otimes_R S) = \bigcap \text{Ann}_S(m_i \otimes 1)$.
Set $I_i = \text{Ann}_R(m_i)$. Then it suffices to show that
$\bigcap_{i = 1, \ldots, n} (I_i S) = (\bigcap_{i = 1, \ldots, n} I_i)S$.
This is Lemma \ref{lemma-flat-intersect-ideals}.
\end{proof}

\begin{lemma}
\label{lemma-support-closed}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is finite, then $\text{Supp}(M)$ is closed.
More precisely, if $I = \text{Ann}(M)$ is the annihilator of $M$, then
$V(I) = \text{Supp}(M)$.
\end{lemma}

\begin{proof}
We will show that $V(I) = \text{Supp}(M)$.

\medskip\noindent
Suppose $\mathfrak p \in \text{Supp}(M)$. Then $M_{\mathfrak p} \not = 0$.
Choose an element $m \in M$ whose image in $M_\mathfrak p$ is nonzero.
Then the annihilator of $m$ is contained in $\mathfrak p$ by construction
of the localization $M_\mathfrak p$. Hence
a fortiori $I = \text{Ann}(M)$ must be contained in $\mathfrak p$.

\medskip\noindent
Conversely, suppose that $\mathfrak p \not \in \text{Supp}(M)$.
Then $M_{\mathfrak p} = 0$.
Let $x_1, \ldots, x_r \in M$ be generators.
By Lemma \ref{lemma-localization-colimit} there exists
an $f \in R$, $f\not\in \mathfrak p$ such that
$x_i/1 = 0$ in $M_f$. Hence $f^{n_i} x_i = 0$ for some $n_i \geq 1$.
Hence $f^nM = 0$ for $n = \max\{n_i\}$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-support-base-change}
Let $R \to R'$ be a ring map and let $M$ be a finite $R$-module.
Then $\text{Supp}(M \otimes_R R')$ is the inverse image of
$\text{Supp}(M)$.
\end{lemma}

\begin{proof}
Let $\mathfrak p \in \text{Supp}(M)$. By Nakayama's lemma
(Lemma \ref{lemma-NAK}) we see that
$$
M \otimes_R \kappa(\mathfrak p) = M_\mathfrak p/\mathfrak p M_\mathfrak p
$$
is a nonzero $\kappa(\mathfrak p)$ vector space.
Hence for every prime $\mathfrak p' \subset R'$ lying
over $\mathfrak p$ we see that
$$
(M \otimes_R R')_{\mathfrak p'}/\mathfrak p' (M \otimes_R R')_{\mathfrak p'} =
(M \otimes_R R') \otimes_{R'} \kappa(\mathfrak p') =
M \otimes_R \kappa(\mathfrak p) \otimes_{\kappa(\mathfrak p)}
\kappa(\mathfrak p')
$$
is nonzero. This implies $\mathfrak p' \in \text{Supp}(M \otimes_R R')$.
For the converse, if $\mathfrak p' \subset R'$ is a prime lying
over an arbitrary prime $\mathfrak p \subset R$, then
$$
(M \otimes_R R')_{\mathfrak p'} =
M_\mathfrak p \otimes_{R_\mathfrak p} R'_{\mathfrak p'}.
$$
Hence if $\mathfrak p' \in \text{Supp}(M \otimes_R R')$
lies over the prime $\mathfrak p \subset R$, then
$\mathfrak p \in \text{Supp}(M)$.
\end{proof}

\begin{lemma}
\label{lemma-support-element}
Let $R$ be a ring, let $M$ be an $R$-module, and let $m \in M$.
Then $\mathfrak p \in V(\text{Ann}(m))$ if and only if
$m$ does not map to zero in $M_\mathfrak p$.
\end{lemma}

\begin{proof}
We may replace $M$ by $Rm \subset M$. Then (1) $\text{Ann}(m) = \text{Ann}(M)$
and (2) $m$ does not map to zero in $M_\mathfrak p$ if and only if
$\mathfrak p \in \text{Supp}(M)$.
The result now follows from Lemma \ref{lemma-support-closed}.
\end{proof}

\begin{lemma}
\label{lemma-support-finite-presentation-constructible}
Let $R$ be a ring and let $M$ be an $R$-module.
If $M$ is a finitely presented $R$-module, then $\text{Supp}(M)$ is a
closed subset of $\Spec(R)$ whose complement is quasi-compact.
\end{lemma}

\begin{proof}
Choose a presentation
$$
R^{\oplus m} \longrightarrow R^{\oplus n} \longrightarrow M \to 0
$$
Let $A \in \text{Mat}(n \times m, R)$ be the matrix of the first
map. By Nakayama's Lemma \ref{lemma-NAK} we see that
$$
M_{\mathfrak p} \not = 0 \Leftrightarrow
M \otimes \kappa(\mathfrak p) \not = 0 \Leftrightarrow
\text{rank}(A \bmod \mathfrak p) < n.
$$
Hence, if $I$ is the ideal of $R$ generated by the $n \times n$ minors
of $A$, then $\text{Supp}(M) = V(I)$. Since $I$
is finitely generated, say $I = (f_1, \ldots, f_t)$,
we see that $\Spec(R) \setminus V(I)$ is
a finite union of the standard opens $D(f_i)$, hence quasi-compact.
\end{proof}

\begin{lemma}
\label{lemma-support-quotient}
Let $R$ be a ring and let $M$ be an $R$-module.
\begin{enumerate}
\item If $M$ is finite then the support
of $M/IM$ is $\text{Supp}(M) \cap V(I)$.
\item If $N \subset M$, then $\text{Supp}(N) \subset
\text{Supp}(M)$.
\item If $Q$ is a quotient module of $M$ then $\text{Supp}(Q) \subset
\text{Supp}(M)$.
\item If $0 \to N \to M \to Q \to 0$ is a short exact sequence
then $\text{Supp}(M) = \text{Supp}(Q) \cup \text{Supp}(N)$.
\end{enumerate}
\end{lemma}

\begin{proof}
The functors $M \mapsto M_{\mathfrak p}$ are exact. This immediately
implies all but the first assertion. For the first assertion
we need to show that $M_\mathfrak p \not = 0$ and
$I \subset \mathfrak p$ implies $(M/IM)_{\mathfrak p}
= M_\mathfrak p/IM_\mathfrak p \not = 0$. This follows
from Nakayama's Lemma \ref{lemma-NAK}.
\end{proof}





\section{Going up and going down}
\label{section-going-up}

\noindent
Suppose $\mathfrak p$, $\mathfrak p'$ are primes
of the ring $R$. Let $X = \Spec(R)$ with the Zariski
topology. Denote $x \in X$ the point corresponding
to $\mathfrak p$ and $x' \in X$ the point corresponding
to $\mathfrak p'$. Then we have:
$$
x' \leadsto x \Leftrightarrow \mathfrak p' \subset \mathfrak p.
$$
In words: $x$ is a specialization of $x'$ if and
only if $\mathfrak p' \subset \mathfrak p$.
See Topology, Section \ref{topology-section-specialization}
for terminology and notation.

\begin{definition}
\label{definition-going-up-down}
Let $\varphi : R \to S$ be a ring map.
\begin{enumerate}
\item We say a $\varphi : R \to S$ satisfies {\it going up} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q$ in $S$ lying over $\mathfrak p$
there exists a prime $\mathfrak q'$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q'$ lies over $\mathfrak p'$.
\item We say a $\varphi : R \to S$ satisfies {\it going down} if
given primes $\mathfrak p \subset \mathfrak p'$ in $R$
and a prime $\mathfrak q'$ in $S$ lying over $\mathfrak p'$
there exists a prime $\mathfrak q$ of $S$ such that
(a) $\mathfrak q \subset \mathfrak q'$, and (b)
$\mathfrak q$ lies over $\mathfrak p$.
\end{enumerate}
\end{definition}

\noindent
So far we have see the following cases of this:
\begin{enumerate}
\item An integral ring map satisfies going up, see
Lemma \ref{lemma-integral-going-up}.
\item As a special case finite ring maps satisfy going up.
\item As a special case quotient maps $R \to R/I$ satisfy going up.
\item A flat ring map satisfies going down, see
Lemma \ref{lemma-flat-going-down}
\item As a special case any localization satisfies going down.
\item An extension $R \subset S$ of domains, with $R$ normal
and $S$ integral over $R$ satisfies going down, see
Proposition \ref{proposition-going-down-normal-integral}.
\end{enumerate}
Here is another case where going down holds.

\begin{lemma}
\label{lemma-open-going-down}
Let $R \to S$ be a ring map. If the induced map
$\varphi : \Spec(S) \to \Spec(R)$ is open, then
$R \to S$ satisfies going down.
\end{lemma}

\begin{proof}
Suppose that $\mathfrak p \subset \mathfrak p' \subset R$ and
$\mathfrak q' \subset S$ lies over $\mathfrak p'$. As $\varphi$ is open,
for every $g \in S$, $g \not \in \mathfrak q'$ we see that $\mathfrak p$
is in the image of $D(g) \subset \Spec(S)$. In other words
$S_g \otimes_R \kappa(\mathfrak p)$ is not zero. Since $S_{\mathfrak q'}$
is the directed colimit of these $S_g$ this implies
that $S_{\mathfrak q'} \otimes_R \kappa(\mathfrak p)$ is not
zero, see
Lemmas \ref{lemma-localization-colimit} and
\ref{lemma-tensor-products-commute-with-limits}.
Hence $\mathfrak p$ is in the image of
$\Spec(S_{\mathfrak q'}) \to \Spec(R)$ as desired.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-specialization}
Let $R \to S$ be a ring map.
\begin{enumerate}
\item $R \to S$ satisfies going down if and only if
generalizations lift along the map $\Spec(S) \to \Spec(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\item $R \to S$ satisfies going up if and only if
specializations lift along the map $\Spec(S) \to \Spec(R)$,
see Topology, Definition \ref{topology-definition-lift-specializations}.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted.
\end{proof}

\begin{lemma}
\label{lemma-going-up-down-composition}
Suppose $R \to S$ and $S \to T$ are ring maps satisfying
going down. Then so does $R \to T$. Similarly for going up.
\end{lemma}

\begin{proof}
According to Lemma \ref{lemma-going-up-down-specialization}
this follows from
Topology, Lemma \ref{topology-lemma-lift-specialization-composition}
\end{proof}

\begin{lemma}
\label{lemma-image-stable-specialization-closed}
Let $R \to S$ be a ring map. Let $T \subset \Spec(R)$
be the image of $\Spec(S)$. If $T$ is stable under specialization,
then $T$ is closed.
\end{lemma}

\begin{proof}
We give two proofs.

\medskip\noindent
First proof. Let $\mathfrak p \subset R$ be a prime ideal such that
the corresponding point of $\Spec(R)$ is in the closure
of $T$. This means that for every $f \in R$, $f \not \in \mathfrak p$
we have $D(f) \cap T \not = \emptyset$. Note that $D(f) \cap T$
is the image of $\Spec(S_f)$ in $\Spec(R)$. Hence
we conclude that $S_f \not = 0$. In other words, $1 \not = 0$ in
the ring $S_f$. Since $S_{\mathfrak p}$ is the directed colimit
of the rings $S_f$ we conclude that $1 \not = 0$ in
$S_{\mathfrak p}$. In other words, $S_{\mathfrak p} \not = 0$ and
considering the image of $\Spec(S_{\mathfrak p})
\to \Spec(S) \to \Spec(R)$ we see there exists
a $\mathfrak p' \in T$ with $\mathfrak p' \subset \mathfrak p$.
As we assumed $T$ closed under specialization we conclude $\mathfrak p$
is a point of $T$ as desired.

\medskip\noindent
Second proof. Let $I = \Ker(R \to S)$. We may replace $R$ by $R/I$.
In this case the ring map $R \to S$ is injective.
By Lemma \ref{lemma-injective-minimal-primes-in-image}
all the minimal primes of $R$ are contained in the image $T$. Hence
if $T$ is stable under specialization then it contains all primes.
\end{proof}

\begin{lemma}
\label{lemma-going-up-closed}
Let $R \to S$ be a ring map. The following are equivalent:
\begin{enumerate}
\item Going up holds for $R \to S$, and
\item the map $\Spec(S) \to \Spec(R)$ is closed.
\end{enumerate}
\end{lemma}

\begin{proof}
It is a general fact that specializations lift along a
closed map of topological spaces, see
Topology, Lemma \ref{topology-lemma-closed-open-map-specialization}.
Hence the second condition implies the first.

\medskip\noindent
Assume that going up holds for $R \to S$.
Let $V(I) \subset \Spec(S)$ be a closed set.
We want to show that the image of $V(I)$ in $\Spec(R)$ is closed.
The ring map $S \to S/I$ obviously satisfies going up.
Hence $R \to S \to S/I$ satisfies going up,
by Lemma \ref{lemma-going-up-down-composition}.
Replacing $S$ by $S/I$ it suffices to show the image $T$
of $\Spec(S)$ in $\Spec(R)$ is closed.
By Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images} this
image is stable under specialization. Thus the result follows
from Lemma \ref{lemma-image-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-constructible-stable-specialization-closed}
Let $R$ be a ring. Let $E \subset \Spec(R)$ be a constructible subset.
\begin{enumerate}
\item If $E$ is stable under specialization, then $E$ is closed.
\item If $E$ is stable under generalization, then $E$ is open.
\end{enumerate}
\end{lemma}

\begin{proof}
First proof. The first assertion
follows from Lemma \ref{lemma-image-stable-specialization-closed}
combined with Lemma \ref{lemma-constructible-is-image}.
The second follows because the complement of a constructible
set is constructible
(see Topology, Lemma \ref{topology-lemma-constructible}),
the first part of the lemma and Topology,
Lemma \ref{topology-lemma-open-closed-specialization}.

\medskip\noindent
Second proof. Since $\Spec(R)$ is a spectral space by
Lemma \ref{lemma-spec-spectral} this is a special case of
Topology, Lemma
\ref{topology-lemma-constructible-stable-specialization-closed}.
\end{proof}

\begin{proposition}
\label{proposition-fppf-open}
Let $R \to S$ be flat and of finite presentation.
Then $\Spec(S) \to \Spec(R)$ is open.
More generally this holds for any ring map $R \to S$ of
finite presentation which satisfies going down.
\end{proposition}

\begin{proof}
If $R \to S$ is flat, then $R \to S$ satisfies going down by
Lemma \ref{lemma-flat-going-down}. Thus to prove the lemma we may
assume that $R \to S$ has finite presentation and satisfies going down.

\medskip\noindent
Since the standard opens $D(g) \subset \Spec(S)$, $g \in S$
form a basis for the topology, it suffices to prove that the
image of $D(g)$ is open. Recall that $\Spec(S_g) \to \Spec(S)$
is a homeomorphism of $\Spec(S_g)$ onto $D(g)$
(Lemma \ref{lemma-standard-open}).
Since $S \to S_g$ satisfies going down (see above), we see that
$R \to S_g$ satisfies going down by
Lemma \ref{lemma-going-up-down-composition}. Thus after replacing
$S$ by $S_g$ we see it suffices to prove the image is open.
By Chevalley's theorem (Theorem \ref{theorem-chevalley})
the image is a constructible set $E$. And $E$ is stable
under generalization because $R \to S$ satisfies going down,
see Topology, Lemmas \ref{topology-lemma-open-closed-specialization}
and \ref{topology-lemma-lift-specializations-images}.
Hence $E$ is open by
Lemma \ref{lemma-constructible-stable-specialization-closed}.
\end{proof}

\begin{lemma}
\label{lemma-same-image}
Let $k$ be a field, and let $R$, $S$ be $k$-algebras.
Let $S' \subset S$ be a sub $k$-algebra, and let $f \in S' \otimes_k R$.
In the commutative diagram
$$
\xymatrix{
\Spec((S \otimes_k R)_f) \ar[rd] \ar[rr] & &
\Spec((S' \otimes_k R)_f) \ar[ld] \\
& \Spec(R) &
}
$$
the images of the diagonal arrows are the same.
\end{lemma}

\begin{proof}
Let $\mathfrak p \subset R$ be in the image of the south-west
arrow. This means (Lemma \ref{lemma-in-image}) that
$$
(S' \otimes_k R)_f \otimes_R \kappa(\mathfrak p)
=
(S' \otimes_k \kappa(\mathfrak p))_f
$$
is not the zero ring, i.e., $S' \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
The ring map
$S' \otimes_k \kappa(\mathfrak p) \to S \otimes_k \kappa(\mathfrak p)$
is injective. Hence also $S \otimes_k \kappa(\mathfrak p)$
is not the zero ring and the image of $f$ in it is not nilpotent.
Hence $(S \otimes_k R)_f \otimes_R \kappa(\mathfrak p)$
is not the zero ring. Thus (Lemma \ref{lemma-in-image})
we see that $\mathfrak p$ is in the image of the south-east arrow
as desired.
\end{proof}

\begin{lemma}
\label{lemma-map-into-tensor-algebra-open}
Let $k$ be a field.
Let $R$ and $S$ be $k$-algebras.
The map $\Spec(S \otimes_k R) \to \Spec(R)$
is open.
\end{lemma}

\begin{proof}
Let $f \in S \otimes_k R$.
It suffices to prove that the image of the standard open $D(f)$ is open.
Let $S' \subset S$ be a finite type $k$-subalgebra such that
$f \in S' \otimes_k R$. The map $R \to S' \otimes_k R$ is flat
and of finite presentation, hence the image $U$ of
$\Spec((S' \otimes_k R)_f) \to \Spec(R)$ is open
by Proposition \ref{proposition-fppf-open}.
By Lemma \ref{lemma-same-image} this is also the image of $D(f)$ and we win.
\end{proof}

\noindent
Here is a tricky lemma that is sometimes useful.

\begin{lemma}
\label{lemma-unique-prime-over-localize-below}
Let $R \to S$ be a ring map.
Let $\mathfrak p \subset R$ be a prime.
Assume that
\begin{enumerate}
\item there exists a unique prime $\mathfrak q \subset S$ lying over
$\mathfrak p$, and
\item either
\begin{enumerate}
\item going up holds for $R \to S$, or
\item going down holds for $R \to S$ and there is at most one prime
of $S$ above every prime of $R$.
\end{enumerate}
\end{enumerate}
Then $S_{\mathfrak p} = S_{\mathfrak q}$.
\end{lemma}

\begin{proof}
Consider any prime $\mathfrak q' \subset S$ which corresponds to
a point of $\Spec(S_{\mathfrak p})$. This means that
$\mathfrak p' = R \cap \mathfrak q'$ is contained in $\mathfrak p$.
Here is a picture
$$
\xymatrix{
\mathfrak q' \ar@{-}[d] \ar@{-}[r] & ? \ar@{-}[r] \ar@{-}[d] & S \ar@{-}[d] \\
\mathfrak p' \ar@{-}[r] & \mathfrak p \ar@{-}[r] & R
}
$$
Assume (1) and (2)(a).
By going up there exists a prime $\mathfrak q'' \subset S$
with $\mathfrak q' \subset \mathfrak q''$ and $\mathfrak q''$
lying over $\mathfrak p$. By the uniqueness of $\mathfrak q$ we
conclude that $\mathfrak q'' = \mathfrak q$. In other words
$\mathfrak q'$ defines a point of $\Spec(S_{\mathfrak q})$.

\medskip\noindent
Assume (1) and (2)(b).
By going down there exists a prime $\mathfrak q'' \subset \mathfrak q$
lying over $\mathfrak p'$. By the uniqueness of primes lying over
$\mathfrak p'$ we see that $\mathfrak q' = \mathfrak q''$.  In other words
$\mathfrak q'$ defines a point of $\Spec(S_{\mathfrak q})$.

\medskip\noindent
In both cases we conclude that the map
$\Spec(S_{\mathfrak q}) \to \Spec(S_{\mathfrak p})$
is bijective. Clearly this means all the elements of $S - \mathfrak q$
are all invertible in $S_{\mathfrak p}$, in other words
$S_{\mathfrak p} = S_{\mathfrak q}$.
\end{proof}

\noindent
The following lemma is a generalization of going down for
flat ring maps.

\begin{lemma}
\label{lemma-going-down-flat-module}
Let $R \to S$ be a ring map. Let $N$ be a finite $S$-module flat over $R$.
Endow $\text{Supp}(N) \subset \Spec(S)$ with the induced topology.
Then generalizations lift along $\text{Supp}(N) \to \Spec(R)$.
\end{lemma}

\begin{proof}
The meaning of the statement is as follows. Let
$\mathfrak p \subset \mathfrak p' \subset R$ be primes. Let
$\mathfrak q' \subset S$ be a prime $\mathfrak q' \in \text{Supp}(N)$
Then there exists a prime $\mathfrak q \subset \mathfrak q'$,
$\mathfrak q \in \text{Supp}(N)$ lying over $\mathfrak p$.
As $N$ is flat over $R$ we see that $N_{\mathfrak q'}$ is flat
over $R_{\mathfrak p'}$, see Lemma \ref{lemma-flat-localization}.
As $N_{\mathfrak q'}$ is finite over $S_{\mathfrak q'}$
and not zero since $\mathfrak q' \in \text{Supp}(N)$ we see
that $N_{\mathfrak q'} \otimes_{S_{\mathfrak q'}} \kappa(\mathfrak q')$
is nonzero by Nakayama's Lemma \ref{lemma-NAK}.
Thus $N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p')$
is also not zero. We conclude from Lemma \ref{lemma-ff}
that $N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$
is nonzero. Let
$J \subset S_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$
be the annihilator of the finite nonzero module
$N_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)$.
Since $J$ is a proper ideal we can choose a prime $\mathfrak q \subset S$
which corresponds to a prime of
$S_{\mathfrak q'} \otimes_{R_{\mathfrak p'}} \kappa(\mathfrak p)/J$.
This prime is in the support of $N$, lies over $\mathfrak p$, and
is contained in $\mathfrak q'$ as desired.
\end{proof}



\section{Separable extensions}
\label{section-separability}

\noindent
In this section we talk about separability for nonalgebraic field extensions.
This is closely related to the concept of geometrically reduced algebras, see
Definition \ref{definition-geometrically-reduced}.

\begin{definition}
\label{definition-separable-field-extension}
Let $K/k$ be a field extension.
\begin{enumerate}
\item We say $K$ is {\it separably generated over $k$} if there exists
a transcendence basis $\{x_i; i \in I\}$ of $K/k$ such that the extension
$K/k(x_i; i \in I)$ is a separable algebraic extension.
\item We say $K$ is {\it separable over $k$} if for every subextension
$k \subset K' \subset K$ with $K'$ finitely generated
over $k$, the extension $K'/k$ is separably generated.
\end{enumerate}
\end{definition}

\noindent
With this awkward definition it is not clear that
a separably generated field extension is itself separable.
It will turn out that this is the case, see
Lemma \ref{lemma-separably-generated-separable}.

\begin{lemma}
\label{lemma-subextensions-are-separable}
Let $K/k$ be a separable field extension.
For any subextension $K/K'/k$ the field
extension $K'/k$ is separable.
\end{lemma}

\begin{proof}
This is direct from the definition.
\end{proof}

\begin{lemma}
\label{lemma-generating-finitely-generated-separable-field-extensions}
Let $K/k$ be a separably generated, and finitely generated
field extension.
Set $r = \text{trdeg}_k(K)$. Then there exist elements
$x_1, \ldots, x_{r + 1}$ of $K$ such that
\begin{enumerate}
\item $x_1, \ldots, x_r$ is a transcendence basis of $K$ over $k$,
\item $K = k(x_1, \ldots, x_{r + 1})$, and
\item $x_{r + 1}$ is separable over $k(x_1, \ldots, x_r)$.
\end{enumerate}
\end{lemma}

\begin{proof}
Combine the definition with Fields, Lemma \ref{fields-lemma-primitive-element}.
\end{proof}

\begin{lemma}
\label{lemma-make-separably-generated}
Let $K/k$ be a finitely generated field extension.
There exists a diagram
$$
\xymatrix{
K \ar[r] & K' \\
k \ar[u] \ar[r] & k' \ar[u]
}
$$
where $k'/k$, $K'/K$ are finite purely inseparable field
extensions such that $K'/k'$ is a separably generated field extension.
\end{lemma}

\begin{proof}
This lemma is only interesting when the characteristic of $k$ is $p > 0$.
Choose $x_1, \ldots, x_r$ a transcendence basis of $K$ over $k$.
As $K$ is finitely generated over $k$ the extension
$k(x_1, \ldots, x_r) \subset K$ is finite.
Let $K/K_{sep}/k(x_1, \ldots, x_r)$ be the subextension
found in
Fields, Lemma \ref{fields-lemma-separable-first}.
If $K = K_{sep}$ then we are done.
We will use induction on $d = [K : K_{sep}]$.

\medskip\noindent
Assume that $d > 1$. Choose a $\beta \in K$ with
$\alpha = \beta^p \in K_{sep}$ and $\beta \not \in K_{sep}$.
Let $P = T^n + a_1T^{n - 1} + \ldots + a_n$
be the minimal polynomial of $\alpha$ over $k(x_1, \ldots, x_r)$.
Let $k'/k$ be a finite purely inseparable extension
obtained by adjoining $p$th roots such that each $a_i$ is a
$p$th power in $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
Such an extension exists; details omitted.
Let $L$ be a field fitting into the diagram
$$
\xymatrix{
K \ar[r] & L \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u]
}
$$
We may and do assume $L$ is the compositum of $K$ and
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$. Let
$L/L_{sep}/k'(x_1^{1/p}, \ldots, x_r^{1/p})$
be the subextension found in
Fields, Lemma \ref{fields-lemma-separable-first}.
Then $L_{sep}$ is the compositum of
$K_{sep}$ and $k'(x_1^{1/p}, \ldots, x_r^{1/p})$.
The element $\alpha \in L_{sep}$ is a zero of the polynomial
$P$ all of whose coefficients are $p$th powers in
$k'(x_1^{1/p}, \ldots, x_r^{1/p})$ and whose roots are
pairwise distinct. By
Fields, Lemma \ref{fields-lemma-pth-root}
we see that $\alpha = (\alpha')^p$ for some $\alpha' \in L_{sep}$.
Clearly, this means that $\beta$ maps to $\alpha' \in L_{sep}$.
In other words, we get the tower of fields
$$
\xymatrix{
K \ar[r] & L \\
K_{sep}(\beta) \ar[r] \ar[u] & L_{sep} \ar[u] \\
K_{sep} \ar[r] \ar[u] & L_{sep} \ar@{=}[u] \\
k(x_1, \ldots, x_r) \ar[u] \ar[r] & k'(x_1^{1/p}, \ldots, x_r^{1/p}) \ar[u] \\
k \ar[r] \ar[u] & k' \ar[u]
}
$$
Thus this construction leads to a new situation with
$[L : L_{sep}] < [K : K_{sep}]$. By induction we can find
$k' \subset k''$ and $L \subset L'$ as in the lemma for the
extension $L/k'$. Then the extensions $k''/k$ and
$L'/K$ work for the extension $K/k$.
This proves the lemma.
\end{proof}




\section{Geometrically reduced algebras}
\label{section-geometrically-reduced}

\noindent
The main result on geometrically reduced algebras is
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.
We suggest the reader skip to the lemma after reading the definition.

\begin{definition}
\label{definition-geometrically-reduced}
Let $k$ be a field. Let $S$ be a $k$-algebra.
We say $S$ is {\it geometrically reduced over $k$}
if for every field extension $K/k$ the
$K$-algebra $K \otimes_k S$ is reduced.
\end{definition}

\noindent
Let $k$ be a field and let $S$ be a reduced $k$-algebra.
To check that $S$ is geometrically reduced it will suffice
to check that $\overline{k} \otimes_k S$ is reduced (where
$\overline{k}$ denotes the algebraic closure of $k$).
In fact it is enough to check this for finite purely inseparable
field extensions $k'/k$. See
Lemma \ref{lemma-geometrically-reduced-finite-purely-inseparable-extension}.

\begin{lemma}
\label{lemma-subalgebra-separable}
Elementary properties of geometrically reduced algebras.
Let $k$ be a field. Let $S$ be a $k$-algebra.
\begin{enumerate}
\item If $S$ is geometrically reduced over $k$ so is every
$k$-subalgebra.
\item If all finitely generated $k$-subalgebras of $S$ are
geometrically reduced, then $S$ is geometrically reduced.
\item A directed colimit of geometrically reduced $k$-algebras
is geometrically reduced.
\item If $S$ is geometrically reduced over $k$, then any localization
of $S$ is geometrically reduced over $k$.
\end{enumerate}
\end{lemma}

\begin{proof}
Omitted. The second and third property follow from the fact that
tensor product commutes with colimits.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-permanence}
Let $k$ be a field.
If $R$ is geometrically reduced over $k$,
and $S \subset R$ is a multiplicative subset, then the localization
$S^{-1}R$ is geometrically reduced over $k$.
If $R$ is geometrically reduced over $k$, then $R[x]$ is geometrically
reduced over $k$.
\end{lemma}

\begin{proof}
Omitted. Hints: A localization of a reduced ring is reduced, and
localization commutes with tensor products.
\end{proof}

\noindent
In the proofs of the following lemmas we will repeatedly use
the following observation: Suppose that $R' \subset R$ and
$S' \subset S$ are inclusions of $k$-algebras.
Then the map $R' \otimes_k S' \to R \otimes_k S$
is injective.

\begin{lemma}
\label{lemma-limit-argument}
Let $k$ be a field. Let $R$, $S$ be $k$-algebras.
\begin{enumerate}
\item If $R \otimes_k S$ is nonreduced, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ is not reduced.
\item If $R \otimes_k S$ contains a nonzero zerodivisor, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nonzero zerodivisor.
\item If $R \otimes_k S$ contains a nontrivial idempotent, then there exist
finitely generated subalgebras $R' \subset R$,
$S' \subset S$ such that $R' \otimes_k S'$ contains a nontrivial idempotent.
\end{enumerate}
\end{lemma}

\begin{proof}
Suppose $z \in R \otimes_k S$ is nilpotent. We may write
$z = \sum_{i = 1, \ldots, n} x_i \otimes y_i$.
Thus we may take $R'$ the $k$-subalgebra generated by
the $x_i$ and $S'$ the $k$-subalgebra generated by the $y_i$.
The second and third statements are proved in the same way.
\end{proof}

\begin{lemma}
\label{lemma-geometrically-reduced-any-reduced-base-change}
Let $k$ be a field.
Let $S$ be a geometrically reduced $k$-algebra.
Let $R$ be any reduced $k$-algebra.
Then $R \otimes_k S$ is reduced.
\end{lemma}

\begin{proof}
By Lemma \ref{lemma-limit-argument}
we may assume that $R$ is of finite type over $k$.
\input{chapters}

\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}